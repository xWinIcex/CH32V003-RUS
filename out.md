**CH32V003 Reference Manual**

> V1.7

# Overview 

> Серия CH32V003 - это промышленные микроконтроллеры общего назначения,
> разработанные на основе 32-разрядного набора команд и архитектуры
> RISC-V. В них используется ядро QingKe V2A, набор команд RV32EC и
> поддерживается 2 уровня вложенности прерываний. Устройства этой серии
> оснащены широкими периферийными интерфейсами и функциональными
> модулями. Их внутренняя организационная структура соответствует
> сценариям встраиваемых приложений с низкой стоимостью и низким
> энергопотреблением.
>
> Данное руководство содержит подробную информацию об использовании
> серии CH32V003 для разработки пользовательских приложений и применимо
> к продуктам данной серии с различным объемом памяти, функциональными
> ресурсами и пакетами; любые различия будут специально объяснены в
> соответствующих функциональных главах.

Пожалуйста, ознакомьтесь с техническими характеристиками данного
устройства в спецификации *CH32V003DS0*. Для получения информации о
ядре, пожалуйста, обратитесь к руководству *QingKeV2_Processor_Manual*.

## RISC-V обзор версии ядра 

  -------------------------------------------------------------------------------------------------------------
              Набор        кол-во       Уровни       Быстрые     Линий     Модель      Поддержка     Интерфейс
            инструкций   аппаратных   вложенности     каналы     потока   таблицы    инструкций по    отладки
                           стеков     прерываний    прерывания   (Flow    векторов    подключению   
                                                                 Line)    (Vector     расширений    
                                                                           table                    
                                                                           model)                   
  -------- ------------ ------------ ------------- ------------ -------- ---------- --------------- -----------
   QingKe     RV32EC         2             2            2          2     Адреса или  Поддерживаеся    1-wire
    V2A                                                                   команды                   

  -------------------------------------------------------------------------------------------------------------

Abbreviated description of the bit attribute in the register:

  --------------------------------------------------------------------------
   Аббревиатура  Описание свойств
  -------------- -----------------------------------------------------------
        RF       Свойство только для чтения, которое считывает фиксированное
                 значение.

        RO       Атрибут, доступный только для чтения, изменяемый аппаратным
                 обеспечением.

        RZ       Свойство только для чтения, автоматическое удаление бита 0
                 после операции чтения.

        WO       Атрибут только для записи (не читается, значение для чтения
                 неопределенно)

        WA       Атрибут, доступный только для записи в безопасном режиме.

        WZ       Атрибут только для записи, автоматический сброс бита 0
                 после операции записи.

        RW       Читаемый и доступный для записи.

       RWA       Читаемый и доступный для записи в безопасном режиме.

       RW1       Читаемый, запись 1 допустима, запись 0 недопустима.

       RW0       Читаемый, запись 0 допустима, запись 1 недопустима.

       RW1T      Читаемый, запись 0 недопустима, запись 1 инвертирована.
  --------------------------------------------------------------------------

#  Глава 1. Архитектура памяти и шины

## 1.1 Архитектура шины

> Серия CH32V003 разработана на основе набора команд RISC-V, и ее
> архитектура обеспечивает взаимодействие ядра, модуля арбитража, модуля
> DMA, хранилища SRAM и других компонентов через несколько шин. В
> конструкцию встроен универсальный контроллер DMA для снижения нагрузки
> на процессор и повышения эффективности доступа, а также механизмы
> защиты данных, механизмы автоматического переключения тактовых
> импульсов и другие меры для повышения стабильности системы.
> Структурная схема системы показана на рисунке 1.1.
>
> Рисунок 1-1 Структурная схема системы CH32V003
>
> ![](media/image2.png){width="6.138888888888889in"
> height="6.777777777777778in"}
>
> Система оснащена: универсальным контроллером DMA для снижения нагрузки
> на процессор и повышения эффективности; управлением древовидной
> иерархией тактирования для снижения общего энергопотребления
> периферийных устройств, а также механизмами защиты данных, механизмами
> защиты сторожевыми таймерами и другими мерами для повышения
> стабильности системы.

-   Шина команд (I-Code) соединяет ядро с интерфейсом команд FLASH, и
    предварительная выборка выполняется по этой шине.

-   Шина данных (D-Code) соединяет ядро с интерфейсом передачи данных
    FLASH для постоянной загрузки и отладки.

-   Системная шина соединяет ядро с матрицей шин и используется для
    координации доступа к ядру, DMA, SRAM и периферийным устройствам.

-   Шина DMA отвечает за DMA главного интерфейса HB, подключенного к
    матрице шины, доступ к которой осуществляется с помощью флэш-памяти,
    SRAM и периферийных устройств.

-   Матрица шины отвечает за координацию доступа между системной шиной,
    шиной данных, шиной DMA, SRAM и мостом HB.

## 1.2 Образ памяти

> Семейство CH32V003 содержит программную память, память данных,
> основные регистры, периферийные регистры и многое другое, все они
> расположены в линейном пространстве объемом 4 ГБ.
>
> Системное хранилище хранит данные в сокращенном формате, т.е. младшие
> байты хранятся по младшему адресу, а старшие байты хранятся по
> старшему адресу.
>
> Рисунок 1-2 Образ хранилища
>
> ![](media/image3.png){width="6.370138888888889in"
> height="7.9534722222222225in"}

### 1.2.1 Распределение памяти 

> Встроенная память SRAM емкостью 2 КБАЙТ, начальный адрес 0x20000000,
> поддерживает доступ к байтам, полусловам (2 байта) и полному слову (4
> байта).
>
> Встроенная программная флэш-память объемом 16 КБАЙТ (Code Flash) для
> хранения пользовательских приложений.
>
> Встроенная системная память 1920B (bootloader) для хранения системного
> загрузчика (заводской загрузчик).
>
> Встроенное пространство объемом 64 Б для хранения слов конфигурации
> поставщика, отлаженное на заводе-изготовителе и не изменяемое
> пользователями. Встроенное пространство объемом 64 Б для хранения
> пользовательских байт.

# Глава 2 Управление питанием (PWR)

## 2.1 Обзор 

> Рабочее напряжение системы V~DD~ колеблется от 2.7 to 5.5V, а
> встроенный регулятор напряжения обеспечивает рабочее питание,
> необходимое ядру.
>
> Рисунок 2-1 Структурная схема структуры источника питания
>
> ![](media/image4.png){width="3.5430555555555556in"
> height="2.473611111111111in"}

## 2.2 Управление питанием 

### 2.2.1 Сброс при включении питания и Сброс при выключении питания

> Система имеет внутреннюю схему сброса при включении питания и схему
> PDR сброса при выключении питания. Когда напряжение питания микросхемы
> V~DD~ если напряжение падает ниже соответствующего порогового
> значения, система сбрасывается с помощью соответствующей схемы, и
> дополнительная внешняя схема сброса не требуется. Параметры порогового
> напряжения при включении приведены в соответствующем техническом
> описании V~POR~ и пороговое напряжение отключения питания V~PDR~.
>
> Рисунок 2-2 Принципиальная схема работы POR и PDR
>
> ![](media/image5.png){width="4.4631944444444445in"
> height="1.9534722222222223in"}

### 2.2.2 Программируемый датчик напряжения

> Программируемый монитор напряжения, **PVD**, в основном используется
> для отслеживания изменения основного источника питания системы и
> сравнения его с пороговым напряжением, установленным **PLS**\[2:0\] в
> регистре управления питанием **PWR_CTLR**, а при настройке регистра
> внешних прерываний (**EXTI**) он может генерировать соответствующие
> прерывания для своевременного уведомления системы о выполнении
> операций предварительного отключения питания, таких как сохранение
> данных.
>
> Конкретная конфигурация заключается в следующем.

1)  Установите в поле **PLS**\[2:0\] регистра **PWR_CTLR** пороговое
    значение напряжения, которое будет контролироваться.

2)  Дополнительная обработка прерываний. функция **PVD** внутренне
    подключается к настройке запуска нарастающего/спадающего фронта в
    строке 8 модуля **EXTI**, включает это прерывание (настраивает
    **EXTI**) и генерирует прерывание **PVD**, когда **VDD** падает ниже
    порогового значения **PVD** или поднимается выше порогового значения
    **PVD**.

3)  Установите бит **PVDE** в регистре **PWR_CTLR**, чтобы включить
    функцию **PVD**.

4)  Считайте бит **PVD0** регистра состояния **PWR_CSR**, чтобы получить
    текущее значение основного питания системы и соотношение пороговых
    значений настройки **PLS**\[2:0\], и выполните соответствующую
    мягкую обработку. Когда напряжение VDD превышает пороговое значение,
    установленное **PLS**\[2:0\], значение **PVD0** равно 0; когда
    напряжение VDD ниже порогового значения, установленного
    **PLS**\[2:0\], значение **PVD0** равно 1.

> Figure 2-3 Schematic diagram of PVD operation
>
> ![](media/image6.png){width="3.879861111111111in"
> height="1.6479166666666667in"}

## 2.3 Режимы с низким энергопотреблением

> После перезагрузки системы микроконтроллер переходит в нормальное
> рабочее состояние (режим запуска), в котором можно сэкономить
> энергопотребление системы, снизив основную частоту системы, отключив
> неиспользуемые периферийные часы или уменьшив рабочие периферийные
> часы. Если система не должна работать, вы можете перевести ее в режим
> пониженного энергопотребления и позволить системе выйти из этого
> состояния с помощью определенных событий.
>
> В настоящее время микроконтроллеры предлагают 2 режима работы с низким
> энергопотреблением, разделенных с точки зрения различий в работе
> процессоров, периферийных устройств, регуляторов напряжения и т.д.

-   Спящий режим: Ядро перестает работать, а все периферийные устройства
    (включая основные частные периферийные устройства) продолжают
    работать.

-   Режим ожидания: Остановите все часы, проснитесь и переведите часы в
    режим HSI.

> Таблица 2-1 Список режимов низкого энергопотребления

  -----------------------------------------------------------------------------
    Режим      Установки     Источник события     Воздействие на      Регул.
                                пробуждения        тактирование     напряжения
  --------- --------------- ------------------- ------------------ ------------
    Sleep       **WFI**      Любое прерывание       Часы ядра          Вкл
                                                  выключены, не    
                                                 влияет на другие  
                                                     системы       
                                                   тактирования    

                **WFE**       Событие Wake-Up                      

   Standby    Установить       AWU событие\      HSE, HIS, PLL и       Откл
            **SLEEPDEEP** в    *Note: Любое        тактирование    
                  1\           событие может        переферии      
              Установить    вывести систему из      выключено      
             **PDDS** в 1\  сна, но после этого                    
              **WFI** or    вызова Reset нет.*                     
                **WFE**                                            
  -----------------------------------------------------------------------------

*Примечание: Бит **SLEEPDEEP** относится к приватным битам управления
периферийными устройствами ядра, ссылка на регистр **PFIC_SCTLR**
контроллера CH32V003.*

### 2.3.1 Варианты конфигурации с низким энергопотреблением

 WFI и WFE

> WFI: Микроконтроллер включается источником прерывания с ответом
> контроллера прерывания, и функция обслуживания прерывания будет
> выполнена первой после пробуждения системы (за исключением сброса
> микроконтроллера).
>
> WFE: Событие пробуждения запускает микроконтроллер для выхода из
> режима пониженного энергопотребления. К событиям пробуждения
> относятся:

1)  Сконфигурируйте внешнюю или внутреннюю линию EXTI в режиме события,
    когда нет необходимости настраивать контроллер прерываний.

2)  Или настройте источник прерываний, эквивалентный пробуждению WFI,
    при котором система определяет приоритет выполнения функции
    обслуживания прерываний.

3)  Или настройте бит **SLEEPONPEN** так, чтобы он включал включение
    периферийных прерываний, но не включал прерывания в контроллере
    прерываний, и бит ожидания прерывания должен быть сброшен после
    пробуждения системы.

-   **SLEEPONEXIT**

> *Включен*: После выполнения команды WFI или WFE микроконтроллер
> гарантирует, что все ожидающие прерывания службы завершены, а затем
> переходит в режим пониженного энергопотребления.
>
> *Отключен*: Микроконтроллер переходит в режим пониженного
> энергопотребления сразу после выполнения команды WFI или WFE.

-   **SEVONPEND**

> *Включен*: Все прерывания или события пробуждения могут привести к
> снижению энергопотребления, введенного при выполнении WFE.
>
> *Отключен*: Только прерывания или события пробуждения, включенные в
> контроллере прерываний, могут активировать режим низкого
> энергопотребления, введенный при выполнении WFE.

### 2.3.2 Режим сна (SLEEP) 

В этом режиме все контакты ввода-вывода находятся в рабочем состоянии, а
все периферийные устройства работают нормально, поэтому попробуйте
отключить бесполезные периферийные устройства перед переходом в спящий
режим, чтобы снизить энергопотребление. В этом режиме пробуждение
занимает меньше всего времени.

> *Вход в режим*: Сконфигурируйте бит управления базовым регистром
> **SLEEPDEEP**=0, регистр управления питанием **PDDS**=0, выполните WFI
> или WFE, опционально **SEVONPEND** и **SLEEPONEXIT**.
>
> *Выход из режима*: Произвольное прерывание или событие пробуждения.

### 2.3.3 Режим ожидания (STANDBY) 

> Режим ожидания представляет собой комбинацию периферийных механизмов
> управления тактовой частотой, основанных на режиме глубокого сна ядра
> (SLEEP DEEP), и позволяет регулятору напряжения работать с гораздо
> меньшим энергопотреблением. В этом режиме домен высокочастотных
> тактовых импульсов (HSE/HSI/PL) отключен, содержимое SRAM и регистра
> сохранено, а состояние pin-кода ввода-вывода сохранено. Система может
> продолжать работать после выхода из этого режима, и HSI называется
> системными часами по умолчанию.
>
> Если выполняется программирование флэш-памяти, система не перейдет в
> режим ожидания до тех пор, пока не будет завершен доступ к памяти.
>
> В режиме ожидания могут работать модули: независимый сторожевой таймер
> (IWDG), низкочастотные тактовые сигналы (LSI).
>
> *Вход в режим*: Настройте управляющий бит основного регистра
> **SLEEPDEEP**=1, **ODDS**=1 в регистре управления питанием и выполните
> WFI или WFE, необязательно **SEVONPEND** и **SLEEPONEXIT**.
>
> *Выход из режима*:

1)  Любое прерывание/событие (заданное во внешнем регистре прерываний).

2)  Событие AWU, часы переключаются на тактирование от HSI после этого
    пробуждения, система не сбрасывается.

### 2.3.4 Auto-пробуждение (AWU) 

> Может быть реализован автоматический режим пробуждения без внешних
> прерываний. Можно запрограммировать базу времени на периодический
> выход из режима ожидания.
>
> Дополнительный внутренний низкочастотный генератор тактовых импульсов
> LSI частотой 128 кГц используется в качестве основы для
> автоматического подсчета времени пробуждения.
>
> При включении функции прерывания AWU вам необходимо установить триггер
> нарастания/спада фронтов 9-й линии, внутренне подключенной к модулю
> EXTI, и включить это прерывание (конфигурация EXTI).

## 2.4 Описание регистров 

Таблица 2-2 Список регистров, связанных с PWR

  -----------------------------------------------------------------------------
  **Наименование**    **Адрес**   **Описание**                      **Значение
                                                                     сброса**
  ------------------ ------------ -------------------------------- ------------
  R32_PWR_CTLR        0x40007000  Регистр управления питанием       0x00000000

  R32_PWR_CSR         0x40007004  Регулятор питания/регистр         0x00000000
                                  состояния                        

  R32_PWR_AWUCSR      0x40007008  Управление автоматическим         0x00000000
                                  пробуждением /регистрация        
                                  состояния                        

  R32_PWR_AWUWR       0x4000700С  Регистр значений для сравнения в  0x0000003F
                                  окне автоматического пробуждения 

  R32_PWR_AWUPSC      0x40007010  Регистр коэффициента пересечения  0x00000000
                                  с автоматическим включением      
  -----------------------------------------------------------------------------

### 2.4.1 Регистр управления питанием (PWR_CTLR) 

> Смещение адреса: 0x00

  ---------------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24       23       22   21    20      19     18    17       16
  -------- ---- ---- ---- ---- ---- ---- ---- ------------ ---- ---- ------ -------- ---- ------ ----------
   Резерв                                                                                        

     15     14   13   12   11   10   9    8        7        6    5     4       3      2     1        0

   Резерв                                      PLS\[0:2\]             PVDE   Резерв        PDDS    Резерв
  ---------------------------------------------------------------------------------------------------------

+----+-------+------+---+-------------------------------------+-----+
| Б  | Наз   | До   | О |                                     | Зн  |
| ит | вание | ступ | п |                                     | ач. |
|    |       |      | и |                                     | сбр |
|    |       |      | с |                                     | оса |
|    |       |      | а |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | е |                                     |     |
+:==:+:=====:+:====:+:=:+:===================================:+:===:+
| \[ | Res   | RO   | Р |                                     | 0   |
| 31 |       |      | е |                                     |     |
| :8 |       |      | з |                                     |     |
| \] |       |      | е |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | в |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
| \  | PLS\[ | RW   | Н |                                     | 0   |
| [7 | 2:0\] |      | а |                                     |     |
| :5 |       |      | с |                                     |     |
| \] |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | й |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | г |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | ж |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | P |                                     |     |
|    |       |      | V |                                     |     |
|    |       |      | D |                                     |     |
|    |       |      | . |                                     |     |
|    |       |      | П |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | д |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | б |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | ы |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | с |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | у |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | ц |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | в |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | д |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | ы |                                     |     |
|    |       |      | в |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | з |                                     |     |
|    |       |      | д |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | \ |                                     |     |
|    |       |      | " |                                     |     |
|    |       |      | Э |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | ч |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | с |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | х |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | с |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | \ |                                     |     |
|    |       |      | " |                                     |     |
|    |       |      | с |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | ц |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | ф |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | ц |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | и |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | 2.85V восходящий фронт/2.7V         |     |
|    |       |      | 0 | нисходящий фронт                    |     |
|    |       |      | 0 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | 3.05V восходящий фронт/2.9V         |     |
|    |       |      | 0 | нисходящий фронт                    |     |
|    |       |      | 1 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | 3.3V восходящий фронт/3.15V         |     |
|    |       |      | 1 | нисходящий фронт                    |     |
|    |       |      | 0 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | 3.5V восходящий фронт/3.3V          |     |
|    |       |      | 1 | нисходящий фронт                    |     |
|    |       |      | 1 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | 3.7V восходящий фронт/3.5V          |     |
|    |       |      | 0 | нисходящий фронт                    |     |
|    |       |      | 0 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | 3.9V восходящий фронт/3.7V          |     |
|    |       |      | 0 | нисходящий фронт                    |     |
|    |       |      | 1 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | 4.1V восходящий фронт/3.9V          |     |
|    |       |      | 1 | нисходящий фронт                    |     |
|    |       |      | 0 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | 4.4V восходящий фронт/4.2V          |     |
|    |       |      | 1 | нисходящий фронт                    |     |
|    |       |      | 1 |                                     |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
| \  | PVDE  | RW   | Б |                                     | 0   |
| [4 |       |      | и |                                     |     |
| \] |       |      | т |                                     |     |
|    |       |      | ф |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | г |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | в |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | ю |                                     |     |
|    |       |      | ч |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | ф |                                     |     |
|    |       |      | у |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | ц |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | ж |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | я |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | Включить функцию контроля           |     |
|    |       |      | : | напряжения                          |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | Отключить функцию контроля          |     |
|    |       |      | : | напряжения                          |     |
+----+-------+------+---+-------------------------------------+-----+
| \  | Res   | RO   | Р |                                     | 0   |
| [3 |       |      | е |                                     |     |
| :2 |       |      | з |                                     |     |
| \] |       |      | е |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | в |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
| \  | PDDS  | RW   | Б |                                     | 0   |
| [1 |       |      | и |                                     |     |
| \] |       |      | т |                                     |     |
|    |       |      | ф |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | г |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | в |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | ю |                                     |     |
|    |       |      | ч |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | ф |                                     |     |
|    |       |      | у |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | ц |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | к |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | т |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | о |                                     |     |
|    |       |      | л |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | а |                                     |     |
|    |       |      | п |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | я |                                     |     |
|    |       |      | ж |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | н |                                     |     |
|    |       |      | и |                                     |     |
|    |       |      | я |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 1 | Вход в режим ожидания               |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
|    |       |      | 0 | Вход в режим сна                    |     |
|    |       |      | : |                                     |     |
+----+-------+------+---+-------------------------------------+-----+
| \  | Res   | RO   | Р |                                     | 0   |
| [0 |       |      | е |                                     |     |
| \] |       |      | з |                                     |     |
|    |       |      | е |                                     |     |
|    |       |      | р |                                     |     |
|    |       |      | в |                                     |     |
+----+-------+------+---+-------------------------------------+-----+

### 2.4.2 Power Control/Status Register (PWR_CSR) 

> Смещение адреса: 0x04

  ------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21   20   19    18      17        16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ------ -------- -----------
   Резерв                                                                              

     15     14   13   12   11   10   9    8    7    6    5    4    3     2       1          0

   Резерв                                                               PVD0   Резерв  
  ------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------
     Бит      Название   Доступ     Описание                                             Значение
                                                                                          сброса
  ---------- ---------- -------- --------------- -------------------------------------- ----------
   \[31:3\]     Res        RO        Резерв                                                 0

    \[2\]       PVD0       RO       Бит флага                                               0
                                    состояния                                           
                                   вывода PVD.                                          
                                    Этот бит                                            
                                  действителен,                                         
                                 когда значение                                         
                                    PVDE=1 в                                            
                                    регистре                                            
                                    PWR_CTLR                                            

                                       1:         Значения VDD и VDDA ниже порогового   
                                                      значения PVD, установленного      
                                                               PLS\[2:0\]               

                                       0:            Значения VDD и VDDA превышают      
                                                 пороговое значение PVD, установленное  
                                                               PLS\[2:0\]               

   \[1:0\]      Res        RO        Резерв                                                 0
  ------------------------------------------------------------------------------------------------

### 2.4.3 Auto-wakeup Control/Status Register (PWR_AWUCSR) 

> Смещение адреса: 0x08

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21   20   19   18    17        16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ------- -----------
   Резерв                                                                           

     15     14   13   12   11   10   9    8    7    6    5    4    3    2      1         0

   Резерв                                                                    AWUEN    Резерв
  ---------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------
     Бит      Название   Доступ      Описание                                             Значение
                                                                                           сброса
  ---------- ---------- -------- ---------------- -------------------------------------- ----------
   \[31:2\]     Res        RO         Резерв                                                 0

    \[1\]      AWUEN       RW        Включить                                                0
                                  автоматическое                                         
                                   пробуждение                                           

                                        1:              Включение авто пробуждения       

                                        0:                    недостоверный              

    \[0\]       Res        RO         Резерв                                                 0
  -------------------------------------------------------------------------------------------------

### 2.4.4 Auto-wakeup Window Comparison Value Register (PWR_AWUWR) 

> Смещение адреса: 0x0C

  --------------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22        21         20   19   18    17        16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- --------------- ---- ---- ---- ------ ------------
   Резерв                                                                                     

     15     14   13   12   11   10   9    8    7    6          5         4    3    2     1         0

   Резерв                                                AWUUWR\[5:0\]                        
  --------------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ                  Описание                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:6\]     Res        RO                     Резерв                       0

   \[5:0\]     AWUEN       RW               Значение окна AWU:\                0
                                     Значение AWU окна равно входному      
                                                 значению\                 
                                                 AWU + 1;\                 
                                   Значение окна AWARF используется для    
                                               сравнения со\               
                                 значением счетчика вверх. Когда значение  
                                       счетчика равно значению окна,       
                                      генерируется сигнал пробуждения      
  -----------------------------------------------------------------------------------

### 2.4.5 Auto-wakeup Crossover Factor Register (PWR\_ AWUPSC) 

> Смещение адреса: 0x10

  --------------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21   20        19         18    17        16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- --------------- ---- ------ ------------
   Резерв                                                                                     

     15     14   13   12   11   10   9    8    7    6    5    4          3         2     1         0

   Резерв                                                          AWUPSC\[3:0\]              
  --------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------
     Бит      Название   Доступ   Описание                                    Значение
                                                                               сброса
  ---------- ---------- -------- ---------- -------------------------------- ----------
   \[31:4\]     Res        RO      Резерв                                        0

   \[3:0\]     AWUPSC      RW    База счета                                      0
              \[3:0\]             времени                                    

                                   0000:          Прескаллер выключен        

                                   0001:          Прескаллер выключен        

                                   0010:               Делитель 2            

                                   0011:               Делитель 4            

                                   0100:               Делитель 8            

                                   0101:              Делитель 16            

                                   0110:              Делитель 32            

                                   0111:              Делитель 64            

                                   1000:              Делитель 128           

                                   1001:              Делитель 256           

                                   1010:              Делитель 512           

                                   1011:             Делитель 1024           

                                   1100:             Делитель 2048           

                                   1101:             Делитель 4096           

                                   1110:             Делитель 10240          

                                   1111:             Делитель 61440          
  -------------------------------------------------------------------------------------

# Глава 3 Сброс и управление тактовой частотой (RCC)

Контроллер предоставляет различные типов сбросов и настраиваемые
древовидные структуры синхронизации, основанные на разделении областей
электропитания и особенностях управления питанием периферийных устройств
в приложениях. В этом разделе описывается область применения каждой
системы тактирования.

## 3.1 Основные характеристики

-   Несколько типов сброса

-   Несколько источников тактовой частоты, управление тактовой частотой
    шины

-   Встроенная система мониторинга и защиты внешнего источника частоты

-   Независимое управление всеми периферийными часами: сброс, включение,
    выключение

-   Поддержка вывода внутреннего тактирования

## 3.2 Сброс

> Контроллер обеспечивает 2 вида сброса: сброс питания и сброс системы.

### 3.2.1 Сброс питания

Когда происходит сброс питания, все регистры сбрасываются.

Сброс питания генерируется при возникновении следующего события:

-   Сброс настроек включения/выключения питания (**POR**/**PDR**)

### 3.2.2 Сброс системы

> Когда происходит сброс системы, она сбрасывает флаг сброса в
> дополнение к регистру управления/состояния **RCC_RSTSCKR** и всем
> регистрам. Источник события сброса определяется путем просмотра бита
> флага сброса состояния в регистре **RCC_RSTSCKR**.
>
> Сброс системы происходит при возникновении одного из следующих
> событий:

-   Низкий уровень сигнала на выводе **NRST** (внешний сброс)

-   Окончен счет оконного сторожевого таймера (**WWDG** сброс) Окончен
    счет независимого сторожевого таймера (**IWDG** сброс)

-   Программный сброс (**SW** сброс)

-   Сброс от контроллера пониженного напряжения питания

> Сброс оконного/независимого сторожевого таймера: генерируется
> триггером переполнения цикла подсчета периферийного таймера
> оконного/независимого сторожевого таймера, подробное описание которого
> приведено в соответствующем разделе.
>
> Сброс программного обеспечения: Устройство CH32V003 выполняет сброс
> системы с помощью позиции 1 регистра **RSTSYS** конфигурации
> прерываний PFIC\_**CFGR** в программируемом контроллере прерываний
> **PFIC** или позиции **SYSRST** 1 регистра конфигурации **PFIC_SCTLR**
> для сброса системного блока, подробности приведены в соответствующей
> главе.Low Power Management Сброс: Сброс режима ожидания будет
> активирован путем установки значения **STANDBY_RST** в положение 1 в
> выбранном пользователем байте. При этом будет выполнен сброс системы
> вместо перехода в режим ожидания после завершения процесса перехода в
> режим ожидания.

Рисунок 3-1: Структура сброса системыНачало формы

System

Reset

Power Reset

Software Reset

WWDG Reset

IWDG Reset

Low-power Management Reset

R

PU

V

DD

/V

DDA

NRST

## 3.3 Тактирование 

### 3.3.1 Структура системы тактирования

> Таблица 3-2 CH32V003 диаграмма дерева тактирования
>
> ![](media/image7.png){width="6.602656386701662in"
> height="9.217391732283465in"}

### 3.3.2 High-speed Clock (HSI/HSE) 

> HSI - это высокоскоростной тактовый сигнал, генерируемый внутренним
> RC-генератором системы с частотой 24 МГц. RC-генератор HSI может
> обеспечивать синхронизацию системы без каких-либо внешних устройств.
> Он имеет короткое время запуска. ЭТО включается и отключается
> установкой бита HSI в регистре **RCC_CTLR**, а бит **DIRTY**
> указывает, является ли генератор RC HSI стабильным или нет. По
> умолчанию в системе для значений **HSION** и **HSIRDY** установлено
> значение 1 (рекомендуется не отключать их). Если установлен бит
> **HSIRDYIE** в регистре **RCC_INTR**, будет сгенерировано
> соответствующее прерывание.

-   Заводская калибровка: Различия в производственном процессе приводят
    к разной частоте RC-колебаний для каждой микросхемы, поэтому
    калибровка HSI выполняется для каждой микросхемы перед отправкой.
    После сброса системы заводское значение калибровки загружается в
    HSICAL\[7:0\] регистра RCC_CTLR.

-   Пользовательская настройка: В зависимости от различных напряжений
    или температур окружающей среды приложение может регулировать
    частоту HSI, используя биты **HSITRIM**\[4:0\] в регистре
    **RCC_CTLR**.

*Примечание: Если кварцевый генератор HSE выходит из строя, часы HSI
используются в качестве резервного источника тактового сигнала (система
защиты часов).*

> HSE - это внешний высокоскоростной тактовый сигнал, включающий
> генерацию внешнего кристаллического/керамического резонатора или
> внешнюю высокоскоростную подачу тактового сигнала.

-   Внешний керамический резонатор/генератор (HSE Crystal): Внешний
    генератор с частотой 4 - 25 МГц обеспечивает более точный источник
    тактовых импульсов для системы. Дополнительную информацию можно
    найти в разделе \"Электрические характеристики\" спецификации.
    Кристалл HSE можно включать и выключать, установив бит **HSEON** в
    регистре **RCC_CTLR**. Бит **HSERDY** указывает, стабильны ли
    колебания кристалла HSE или нет, и аппаратное обеспечение подает
    тактовый сигнал в систему только после установки **HSERDY** в
    положение 1. Если установлен бит **HSERDYIE** регистра **RCC_INTR**,
    то будет сгенерировано соответствующее прерывание.

> Рисунок 3-3 Схема подключения высокоскоростного внешнего резонатора

OSC_IN

OSC_OUT

C

L1

C

L2

4～25МГц

Нагрузочная емкость

> *Примечание: Нагрузочный конденсатор должен располагаться как можно
> ближе к контакту генератора, а значение емкости должно быть выбрано в
> соответствии с параметрами кристалла.*

-   Внешний высокоскоростной источник тактовой частоты (HSE Bypass): В
    этом режиме источник тактовой частоты подается непосредственно с
    внешнего устройства на вывод **OSC_IN**, при этом вывод **OSC_OUT**
    не подключен. Максимальная поддерживаемая частота составляет 25 МГц.
    Приложению необходимо установить бит **HSEBYP** для включения
    функции обхода HSE с битом **HSEON** равным 0, а затем снова
    установить бит **HSEON**.

> Рисунок 3-3 Схема подключения высокоскоростного внешнего генератора

OSC_IN

**fHSE_ext**

Внешний источник тактирования

OSC_OUT

(Не используется)

### 3.3.3 Низкоскоростные тактовые импульсы (LSI)

> LSI - это низкочастотный тактовый сигнал, генерируемый внутренним
> RC-генератором системы с частотой около 128 кГц. Он может
> поддерживаться в рабочем состоянии в режиме выключения и ожидания и
> обеспечивает синхронизацию для часов RTC, независимого сторожевого
> таймера и блока пробуждения. Более подробную информацию можно найти в
> разделе \"Электрические характеристики\" спецификации. LSI можно
> включать и отключать, устанавливая бит **LSION** в регистре
> **RCC_RSTSCKR**, а затем определяя, стабильны ли RC-колебания LSI,
> запрашивая бит **LSIRDY**, и аппаратное обеспечение подает тактовый
> сигнал только после позиции **LSIRDY** 1. Если установлен бит
> **LSIRDYIE** в регистре **RCC_INTR**, то будет сгенерировано
> соответствующее прерывание.

### 3.3.4 PLL тактирование 

> Настроив регистр **RCC_CFGR0** и расширенный регистр **EXTEND_CTR**,
> внутренние часы PLL могут выбирать 2 источника синхронизации, эти
> настройки необходимо выполнить до включения PLL, после запуска PLL эти
> параметры изменить нельзя. Установите бит **PLLON** в регистре
> **RCC_CTLR** включенным и выключенным, бит **PLLRDY** - для указания
> стабильности синхронизации PLL, а аппаратное обеспечение - для подачи
> синхронизации в систему только после позиции 1 PLL. Если установлен
> бит **PLLRDYIE** регистра **RCC_INTR**, то будет сгенерировано
> соответствующее прерывание.
>
> PLL источник тактирования:

-   HSI тактирование

-   HSE тактирование

### 3.3.5 Тактирование шины/периферии 

#### 3.3.5.1 Системное тактирование (SYSCLK) 

> Настройте источник системных тактовых импульсов, настроив регистр
> **RCC_CFGR0** биты **SW**\[1:0\], **СЕК**\[1:0\] указывает текущий
> источник системных тактовых импульсов.

-   HSI как источник тактов для системы

-   HSE как источник тактов для системы

-   PLL как источник тактов для системы

> После перезагрузки контроллера в качестве системного источника
> тактовых импульсов выбираются часы HSI по умолчанию. Переключение
> между источниками тактовых импульсов должно происходить только тогда,
> когда целевой источник тактовых импульсов готов.

#### 3.3.5.2 HB тактирование шины периферии (HCLK) 

> Тактовые частоты шины HB можно настроить, настроив биты **PRE**\[3:0\]
> регистра **RCC_CFGR0**. Тактовые частоты шины определяют опорную
> частоту доступа к периферийному интерфейсу, которая устанавливается
> под ними. Приложения могут настраивать различные значения, чтобы
> снизить энергопотребление при работе некоторых периферийных устройств.
> Различные разряды в регистрах **RCC_APB1RSTR** и **RCC_APB2PRSTR**
> могут возвращать различные периферийные модули в исходное состояние.
>
> Каждый бит в регистрах **RCC_AHBLPENR**, **RCC_APB1PCENR** и
> **RCC_APB2PCENR** может использоваться для индивидуального включения
> или выключения интерфейса синхронизации связи для различных
> периферийных модулей. При использовании периферийного устройства вам
> сначала необходимо включить его бит включения тактовой частоты, чтобы
> получить доступ к его регистрам.

#### 3.3.5.3 Тактирование независимого сторожевого таймера 

> Если независимый сторожевой таймер был установлен с помощью аппаратной
> конфигурации или запущен с помощью программного обеспечения, генератор
> LSI будет включен принудительно и не может быть выключен. После
> стабилизации генератора LSI тактовый сигнал подается на IWDG.

#### 3.3.5.4 Выход тактирования микроконтроллера (MCO) 

> Микроконтроллер позволяет выводить тактовые сигналы на контакты MCO.
> Следующие 4 тактовых сигнала могут быть выбраны в качестве выходных
> сигналов синхронизации MCO путем настройки режима
> мультиплексированного двухтактного вывода в соответствующих регистрах
> порта GPIO путем настройки битов **MCO**\[2:0\] регистра
> **RCC_CFGR0**.

-   Системный (SYSCLK) вывод тактов

-   HSI вывод тактов

-   HSE вывод тактов

-   PLL вывод тактов

### 3.3.6 Защита системы тактирования 

> Система clock safety system - это механизм оперативной защиты
> контроллера, который переключается на внутреннее тактирование HSI в
> случае сбоя внешнего тактирования HSE и генерирует прерывании,
> позволяющее прикладному программному обеспечению выполнить обработку
> этого события.
>
> Система clock security system активируется установкой **CSSON** в
> положение 1 регистра **RCC_CTLR**. После этого мониторинг часов может
> быть включен после задержки запуска генератора HSE (**HSERDY**=1) и
> будет выключен после отключения часов HSE. Как только часы HSE выйдут
> из строя во время работы системы, генератор HSE будет выключен,
> событие сбоя часов будет отправлено на **TIM1_BKIN** вход таймера
> расширенного управления (TIM1), и будет сгенерировано защитное
> прерывание часов с позицией CSSF 1, и приложение перейдет в
> немаскируемое прерывание NMI. Установив бит **CSSC**, можно снять флаг
> бита **CSSF** и отменить бит ожидания прерывания NMI.
>
> Если в качестве системного тактирования используется текущее значение
> HSE или если текущее значение HSE используется в качестве входных
> тактов для PLL, а PLL используется в качестве системного тактирования,
> система безопасности тактирования автоматически переключит системную
> на генератор HSI и отключит генератор HSE и PLL в случае сбоя HSE.

## 3.4 Описание регистров 

Таблица 3-1 Список регистров, связанных с RCC

  -----------------------------------------------------------------------------
  **Наименование**     **Адрес**   **Описание**                     **Значение
                                                                     сброса**
  ------------------- ------------ ------------------------------- ------------
  R32_RCC_CTLR         0x40021000  Регистр управления               0x0000xx83
                                   тактированием                   

  R32_RCC_CFGR0        0x40021004  Регистр конфигурации             0x00000020
                                   тактирования 0                  

  R32_RCC_INTR         0x40021008  Регистр прерываний тактирования  0x00000000

  R32_RCC_APB2PRSTR    0x4002100C  Регистр сброса периферийной      0x00000000
                                   шины PB2                        

  R32_RCC_APB1PRSTR    0x40021010  Регистр сброса периферийной      0x00000000
                                   шины PB1                        

  R32_RCC_AHBPCENR     0x40021014  Регистр включения тактирования   0x00000004
                                   периферийной шины HB            

  R32_RCC_APB2PCENR    0x40021018  Регистр включения тактирования   0x00000000
                                   периферийной шины PB2           

  R32_RCC_APB1PCENR    0x4002101C  Регистр включения тактирования   0x00000000
                                   периферийной шины PB1           

  R32_RCC_RSTSCKR      0x40021024  Регистр статуса/управления       0x0C000000
  -----------------------------------------------------------------------------

### 3.4.1 Регистр управления тактированием (RCC_CTLR) 

> Смещение адреса: 0x00

  --------------------------------------------------------------------------------------------------------------------
        31         30   29   28   27   26   25    24          23         22   21   20   19      18       17      16
  --------------- ---- ---- ---- ---- ---- ----- ----- ---------------- ---- ---- ---- ----- -------- -------- -------
      Резерв                                PLL   PLL       Резерв                      CSS   HSEBYP   HSERDY   HSEON
                                            RDY   ON                                    ON                     

        15         14   13   12   11   10    9     8          7          6    5    4     3      2        1        0

   HSICAL\[7:0\]                                        HSITRIM\[4:0\]                         Рез.    HSIRDY   HSION
  --------------------------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------------------------
      Бит      Название   Доступ       Описание                                                Знач.
                                                                                               сброса
  ----------- ---------- -------- ------------------- --------------------------------------- --------
   \[31:26\]     Res        RO          Резерв                                                   0

    \[25\]      PLLRDY      RO     Бит готовности к                                              0
                                  блокировке тактовой                                         
                                      частоты PLL                                             

                                          1:                 Частота PLL заблокирована        

                                          0:               Частота PLL не заблокирована       

    \[24\]      PLLON       RW      Управляющий бит                                              0
                                       включения                                              
                                   такттирования PLL                                          

                                          1:                 Включить такрирование PLL        

                                          0:                Отключить такрирование PLL        

   \[23:20\]     Res        RO          Резерв                                                   0

    \[19\]      CSSON       RW       Бит включения                                               0
                                    зищиты системы                                            
                                     тактирования                                             

                                          1:           Включение защиты тактирования. Когда   
                                                       HSE готов (флаг HSERDY=1), аппаратное  
                                                          обеспечение активирует функцию      
                                                        мониторинга тактовой частоты HSE и    
                                                       устанавливает флаг CSSF и прерывание   
                                                       NMI при обнаружении аномалии в работе  
                                                        HSE; когда HSE не готов, аппаратное   
                                                           обеспечение отключает функцию      
                                                         мониторинга тактового сигнала HSE    

                                          0:              Отключение защиты тактирования      

    \[18\]      HSEBYP      RW      Бит управления                                               0
                                   обходом внешнего                                           
                                   высокоскоростного                                          
                                     тактирования                                             

                                          1:                Байпас внешнего кварцевого        
                                                               генератора/резонатора          

                                          0:                      Байпас отключен             

                                   Примечание: этот                                           
                                   бит будет записан                                          
                                      при HSEON=0                                             

    \[17\]      HSERDY      RO      Бит готовности                                               0
                                       внешнего                                               
                                   высокоскоростного                                          
                                       тактового                                              
                                      генератора                                              
                                   (устанавливается                                           
                                      аппаратно)                                              

                                          1:              Стабильное внешнее тактирование     

                                          0:             Внешнее тактирование не стабильно    

                                   Примечание: этот                                           
                                   бит будет записан                                          
                                  при HSEON=0 через 6                                         
                                        тактов                                                

    \[16\]      HSEON       RW      Бит управления                                               0
                                  включением внешнего                                         
                                   высокоскоростного                                          
                                   кристаллического                                           
                                      генератора                                              

                                          1:                 Включить такрирование HSE        

                                          0:                Отключить такрирование HSE        

                                   Примечание: Этот                                           
                                   бит автоматически                                          
                                   сбрасывается в 0                                           
                                      аппаратным                                              
                                  обеспечением после                                          
                                     входа в режим                                            
                                        Standby                                               

   \[15:8\]     HSICAL      RO    Значение калибровки                                           xxh
                                      внутреннего                                             
                                   высокоскоростного                                          
                                       тактового                                              
                                  генератора, которое                                         
                                     автоматически                                            
                                   инициализируется                                           
                                  при запуске системы                                         

    \[7:3\]    HSITRIM      RW    Внутреннее значение                                          10000
                                      регулировки                                             
                                   высокоскоростного                                          
                                       тактового                                              
                                      генератора.                                             
                                  Пользователь может                                          
                                        ввести                                                
                                    корректирующее                                            
                                   значение, которое                                          
                                   будет наложено на                                          
                                       значение                                               
                                    HSICAL\[7:0\],                                            
                                    чтобы настроить                                           
                                  частоту внутреннего                                         
                                  RC-генератора HSI с                                         
                                   учетом изменений                                           
                                     напряжения и                                             
                                    температуры. По                                           
                                       умолчанию                                              
                                      установлено                                             
                                   значение 16, что                                           
                                  позволяет настроить                                         
                                  HSI на 24 МГц ±1%.                                          
                                  Изменение значения                                          
                                  HSICAL регулируется                                         
                                  примерно на 60 кГц                                          
                                        за шаг                                                

     \[2\]       Res        RO          Резерв                                                   0

     \[1\]      HSIRDY      RO      Бит готовности                                               0
                                      внутреннего                                             
                                       тактового                                              
                                  генератора (24MHz)                                          
                                   (устанавливается                                           
                                      аппаратно)                                              

                                          1:            Стабильное внутреннее тактирование    

                                          0:           Внутреннее тактирование не стабильно   

                                   Примечание: этот                                           
                                   бит будет записан                                          
                                  при HSEON=0 через 6                                         
                                        тактов                                                

     \[0\]      HSION       RW      Бит управления                                               0
                                      включением                                              
                                      внутреннего                                             
                                       тактового                                              
                                      генератора                                              

                                          1:                 Включить такрирование HSI        

                                          0:                Отключить такрирование HIS        

                                   Примечание: Этот                                           
                                   бит автоматически                                          
                                   сбрасывается в 0                                           
                                      аппаратным                                              
                                  обеспечением после                                          
                                     входа в режим                                            
                                        Standby                                               
  ----------------------------------------------------------------------------------------------------

### 3.4.2 Регистр конфигурации тактирования 0 (RCC_CFGR0) 

> Смещение адреса: 0x04

  ------------------------------------------------------------------------------------------------------------------------------
        31         30   29   28   27       26       25   24       23        22   21   20       19       18      17      16
  --------------- ---- ---- ---- ---- ------------ ---- ---- ------------- ---- ---- ---- ------------ ---- ----------- --------
      Резерв                           MCO\[2:0\]               Резерв                                                  PLLSRC

        15         14   13   12   11       10       9    8         7        6    5    4        3        2        1      0

   ADCPRE\[4:0\]                         Резерв               HPRE\[3:0\]                  SWS\[1:0\]        SW\[1:0\]  
  ------------------------------------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                                   Знач.
                                                                                                сброса
  ----------- ------------- -------- ------------------- ------------------------------------- --------
   \[31:27\]       Res         RO    Резерв                                                       0

   \[26:24\]   MCO\[2:0\]      RW    Управление                                                   0
                                     тактированием                                             
                                     выхода                                                    
                                     микроконтрроллера                                         
                                     на пин MCO                                                

                                     0xx:                Нет тактирования на выход             

                                     100:                Выход тактируется от системных часов  
                                                         (SYSCLK)                              

                                     101:                Выход тактируется от HSI (24MHz)      

                                     110:                Выход тактируется от внешнего         
                                                         резонатора HSE                        

                                     111:                Выход тактируется от PLL              

   \[23:17\]       Res         RO    Резерв                                                       0

    \[16\]       PLLSRC        RW    Источник входного                                            0
                                     тактового сигнала                                         
                                     для PLL                                                   
                                     (записывается                                             
                                     только при                                                
                                     выключенном PLL)                                          

                                     1:                  HSE подается на PLL без деления       
                                                         частоты                               

                                     0:                  HSI подается на PLL без деления       
                                                         частоты                               

   \[15:11\]     ADCPRE        RW    Управление                                                   0
                 \[4:0\]             предделителем                                             
                                     источника тактовой                                        
                                     частоты АЦП                                               
                                     {13:11,15:14}                                             

                                     000xx:              HBCLK деленное на 2 как тактирование  
                                                         для АЦП                               

                                     010xx:              HBCLK деленное на 4 как тактирование  
                                                         для АЦП                               

                                     100xx:              HBCLK деленное на 6 как тактирование  
                                                         для АЦП                               

                                     110xx:              HBCLK деленное на 8 как тактирование  
                                                         для АЦП                               

                                     00100:              HBCLK деленное на 4 как тактирование  
                                                         для АЦП                               

                                     00101:              HBCLK деленное на 8 как тактирование  
                                                         для АЦП                               

                                     00110:              HBCLK деленное на 16 как тактирование 
                                                         для АЦП                               

                                     00111:              HBCLK деленное на 32 как тактирование 
                                                         для АЦП                               

                                     01100:              HBCLK деленное на 8 как тактирование  
                                                         для АЦП                               

                                     01101:              HBCLK деленное на 16 как тактирование 
                                                         для АЦП                               

                                     01110:              HBCLK деленное на 32 как тактирование 
                                                         для АЦП                               

                                     01111:              HBCLK деленное на 64 как тактирование 
                                                         для АЦП                               

                                     10100:              HBCLK деленное на 12 как тактирование 
                                                         для АЦП                               

                                     10101:              HBCLK деленное на 24 как тактирование 
                                                         для АЦП                               

                                     10110:              HBCLK деленное на 48 как тактирование 
                                                         для АЦП                               

                                     10111:              HBCLK деленное на 96 как тактирование 
                                                         для АЦП                               

                                     11100:              HBCLK деленное на 16 как тактирование 
                                                         для АЦП                               

                                     11101:              HBCLK деленное на 32 как тактирование 
                                                         для АЦП                               

                                     11110:              HBCLK деленное на 64 как тактирование 
                                                         для АЦП                               

                                     11111:              HBCLK деленное на 128 как             
                                                         тактирование для АЦП                  

                                     Примечание:                                               
                                     Тактовая частота                                          
                                     АЦП не должна                                             
                                     превышать                                                 
                                     максимальное                                              
                                     значение 24 МГц                                           

   \[10:8\]        Res         RO    Резерв                                                       0

    \[7:4\]    HPRE\[3:0\]     RW    Управление                                                  0010
                                     предделителем                                             
                                     источника тактовой                                        
                                     частоты HB                                                

                                     0000:               Предделитель отключен                 

                                     0001:               SYSCLK / 2                            

                                     0010:               SYSCLK / 3                            

                                     0011:               SYSCLK / 4                            

                                     0100:               SYSCLK / 5                            

                                     0101:               SYSCLK / 6                            

                                     0110:               SYSCLK / 7                            

                                     0111:               SYSCLK / 8                            

                                     1000:               SYSCLK / 2                            

                                     1001:               SYSCLK / 4                            

                                     1010:               SYSCLK / 8                            

                                     1011:               SYSCLK / 16                           

                                     1100:               SYSCLK / 32                           

                                     1101:               SYSCLK / 64                           

                                     1110:               SYSCLK / 128                          

                                     1111:               SYSCLK / 256                          

                                     Примечание: Если                                          
                                     коэффициент                                               
                                     предделителя                                              
                                     источника тактовой                                        
                                     частоты HB больше                                         
                                     1, необходимо                                             
                                     включить буфер                                            
                                     предварительной                                           
                                     выборки.                                                  

    \[3:2\]    SWS\[1:0\]      RO    Статус системных                                             0
                                     часов (SYSCLK)                                            
                                     (устанавливается                                          
                                     аппаратно)                                                

                                     00:                 Тактирование SYSCLK по тактированию   
                                                         из HSI                                

                                     01:                 Тактирование SYSCLK по тактированию   
                                                         из HSE                                

                                     10:                 Тактирование SYSCLK по тактированию   
                                                         из PLL                                

                                     11:                 Недоступно                            

    \[1:0\]     SW\[1:0\]      RW    Выбор источника                                              0
                                     тактирования для                                          
                                     системных часов                                           
                                     (SYSCLK)                                                  

                                     00:                 Тактирование SYSCLK по тактированию   
                                                         из HSI                                

                                     01:                 Тактирование SYSCLK по тактированию   
                                                         из HSE                                

                                     10:                 Тактирование SYSCLK по тактированию   
                                                         из PLL                                

                                     11:                 Недоступно                            

                                     Примечание: При                                           
                                     включении функции                                         
                                     защиты тактового                                          
                                     сигнала (CSSON=1) в                                       
                                     случае возврата из                                        
                                     режимов Standby и                                         
                                     Stop или при отказе                                       
                                     внешнего генератора                                       
                                     HSE, используемого                                        
                                     в качестве                                                
                                     системного                                                
                                     тактового сигнала,                                        
                                     внутренний                                                
                                     генератор HSI                                             
                                     принудительно                                             
                                     выбирается                                                
                                     аппаратно в                                               
                                     качестве системного                                       
                                     тактового сигнала                                         
  -----------------------------------------------------------------------------------------------------

### 3.4.3 Регистр прерываний тактирования (RCC_INTR) 

> Смещение адреса: 0x08

<table>
<colgroup>
<col style="width: 3%" />
<col style="width: 3%" />
<col style="width: 3%" />
<col style="width: 8%" />
<col style="width: 9%" />
<col style="width: 8%" />
<col style="width: 3%" />
<col style="width: 8%" />
<col style="width: 5%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 3%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="8" style="text-align: center;">Резерв</td>
<td style="text-align: center;">CSSC</td>
<td colspan="2" style="text-align: center;">Резерв</td>
<td style="text-align: center;">PLLRDYC</td>
<td style="text-align: center;">HSERDYC</td>
<td style="text-align: center;">HSIRDYC</td>
<td style="text-align: center;"><p>Ре</p>
<p>з.</p></td>
<td style="text-align: center;">LSIRDYC</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td colspan="3" style="text-align: center;">Резерв</td>
<td style="text-align: center;">PLLEDYIE</td>
<td style="text-align: center;">HSERDYIE</td>
<td style="text-align: center;">HSIRDYIE</td>
<td style="text-align: center;">Ре з.</td>
<td style="text-align: center;">LSIRDYIE</td>
<td style="text-align: center;">CSSF</td>
<td colspan="2" style="text-align: center;">Резерв</td>
<td style="text-align: center;">PLLRDYF</td>
<td style="text-align: center;">HSERDYF</td>
<td style="text-align: center;">HSIRDYF</td>
<td style="text-align: center;">Ре з.</td>
<td style="text-align: center;">LSIRDYF</td>
</tr>
</tbody>
</table>

  ------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                 Знач.
                                                                                           сброса
  ----------- ---------- -------- ----------------- ------------------------------------- --------
   \[31:24\]     Res        RO    Резерв                                                     0

    \[23\]       CSSC       WO    Сбросить флаг                                              0
                                  прерывания                                              
                                  системы                                                 
                                  безопасности                                            
                                  тактового                                               
                                  генератора (CSSF)                                       

                                  1:                Сбросить флаг прерывания CSSF         

                                  0:                Не сбрасывать                         

   \[22:21\]     Res        RO    Резерв                                                     0

    \[20\]     PLLRDYC      WO    Сбросить флаг                                              0
                                  готовности                                              
                                  прерывания PLL                                          

                                  1:                Отчистить флаг прерывания PLLRDYF     

                                  0:                Не сбрасывать                         

    \[19\]     HSERDYC      WO    Сбросить флаг                                              0
                                  готовности                                              
                                  прерывания HSE                                          

                                  1:                Отчистить флаг прерывания HSERDYF     

                                  0:                Не сбрасывать                         

    \[18\]     HSIRDYC      WO    Сбросить флаг                                              0
                                  готовности                                              
                                  прерывания HSI                                          

                                  1:                Отчистить флаг прерывания HSIRDYF     

                                  0:                Не сбрасывать                         

    \[17\]       Res        RO    Резерв                                                     0

    \[16\]     LSIRDYC      WO    Сбросить флаг                                              0
                                  готовности                                              
                                  прерывания LSI                                          

                                  1:                Отчистить флаг прерывания LSIRDYF     

                                  0:                Не сбрасывать                         

   \[15:13\]     Res        RO    Резерв                                                     0

    \[12\]     PLLRDYIE     RW    Бит разрешения                                             0
                                  прерывания по                                           
                                  готовности PLL                                          

                                  1:                Включить прерывание                   

                                  0:                Отключить прерывание                  

    \[11\]     HSERDYIE     RW    Бит разрешения                                             0
                                  прерывания по                                           
                                  готовности HSE                                          

                                  1:                Включить прерывание                   

                                  0:                Отключить прерывание                  

    \[10\]     HSIRDYIE     RW    Бит разрешения                                             0
                                  прерывания по                                           
                                  готовности HSI                                          

                                  1:                Включить прерывание                   

                                  0:                Отключить прерывание                  

     \[9\]       Res        RO    Резерв                                                     0

     \[8\]     LSIRDYIE     RW    Бит разрешения                                             0
                                  прерывания по                                           
                                  готовности LSI                                          

                                  1:                Включить прерывание                   

                                  0:                Отключить прерывание                  

     \[7\]       CSSF       RO    Флаг прерывания                                            0
                                  по системе                                              
                                  безопасности                                            
                                  тактового                                               
                                  генератора                                              

                                  1:                Отказ тактового сигнала HSE, который  
                                                    генерирует прерывание безопасности    
                                                    тактового сигнала CSSI                

                                  0:                Нет прерывания от системы             
                                                    безопасности тактового генератора.    
                                                    Устанавливается аппаратно,            
                                                    программная запись бита CSSC со       
                                                    значением 1 очищает его               

    \[6:5\]      Res        RO    Резерв                                                     0

     \[4\]     PLLRDYF      RO    Флаг блокировки                                            0
                                  прерывания                                              
                                  готовности                                              
                                  тактового сигнала                                       
                                  PLL                                                     

                                  1:                Блокировка тактового сигнала PLL,     
                                                    вызывающая прерывание                 

                                  0:                Нет блокировки прерывания тактового   
                                                    сигнала PLL                           

                                  Устанавливается                                         
                                  аппаратно,                                              
                                  программная                                             
                                  запись бита                                             
                                  PLLRDYC=1 очищает                                       
                                  его                                                     

     \[3\]     HSERDYF      RO    Флаг блокировки                                            0
                                  прерывания                                              
                                  готовности                                              
                                  тактового сигнала                                       
                                  HSE                                                     

                                  1:                Блокировка тактового сигнала HSE,     
                                                    вызывающая прерывание                 

                                  0:                Нет блокировки прерывания тактового   
                                                    сигнала HSE                           

                                  Устанавливается                                         
                                  аппаратно,                                              
                                  программная                                             
                                  запись бита                                             
                                  HSERDYC=1 очищает                                       
                                  его                                                     

     \[2\]     HSIRDYF      RO    Флаг блокировки                                            0
                                  прерывания                                              
                                  готовности                                              
                                  тактового сигнала                                       
                                  HSI                                                     

                                  1:                Блокировка тактового сигнала HSI,     
                                                    вызывающая прерывание                 

                                  0:                Нет блокировки прерывания тактового   
                                                    сигнала HSI                           

                                  Устанавливается                                         
                                  аппаратно,                                              
                                  программная                                             
                                  запись бита                                             
                                  HSIRDYC=1 очищает                                       
                                  его                                                     

     \[1\]       Res        RO    Резерв                                                     0

     \[0\]     LSIRDYF      RO    Флаг блокировки                                            0
                                  прерывания                                              
                                  готовности                                              
                                  тактового сигнала                                       
                                  LSI                                                     

                                  1:                Блокировка тактового сигнала LSI,     
                                                    вызывающая прерывание                 

                                  0:                Нет блокировки прерывания тактового   
                                                    сигнала LSI                           

                                  Устанавливается                                         
                                  аппаратно,                                              
                                  программная                                             
                                  запись бита                                             
                                  LSIRDYC=1 очищает                                       
                                  его                                                     
  ------------------------------------------------------------------------------------------------

### 3.4.4 Регистр сброса периферийной шины PB2 (RCC_APB2PRSTR) 

> Смещение адреса: 0x0С

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 8%" />
<col style="width: 5%" />
<col style="width: 6%" />
<col style="width: 7%" />
<col style="width: 6%" />
<col style="width: 7%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 3%" />
<col style="width: 9%" />
<col style="width: 6%" />
<col style="width: 4%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="16" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>USART</p>
<p>1RST</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>SPI1</p>
<p>RST</p></td>
<td style="text-align: center;"><p>TIM1</p>
<p>RST</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>ADC1</p>
<p>RST</p></td>
<td colspan="3" style="text-align: center;">Резерв</td>
<td style="text-align: center;"><p>IOPD</p>
<p>RST</p></td>
<td style="text-align: center;"><p>IOPC</p>
<p>RST</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>IOPA</p>
<p>RST</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>AFIO</p>
<p>RST</p></td>
</tr>
</tbody>
</table>

  -------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                  Знач.
                                                                                            сброса
  ----------- ---------- -------- ----------------- -------------------------------------- --------
   \[31:15\]     Res        RO    Резерв                                                      0

    \[14\]    USART1 RST    RW    Управление                                                  0
                                  сбросом                                                  
                                  интерфейса USART1                                        

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

    \[15\]       Res        RO    Резерв                                                      0

    \[12\]     SPI1RST      RW    Управление                                                  0
                                  сбросом                                                  
                                  интерфейса SPI1                                          

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

    \[11\]     TIM1RST      RW    Управление                                                  0
                                  сбросом                                                  
                                  интерфейса TIM1                                          

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

    \[10\]       Res        RO    Резерв                                                      0

     \[9\]     ADC1RST      RW    Управление                                                  0
                                  сбросом                                                  
                                  интерфейса ADC1                                          

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

    \[8:6\]      Res        RO    Резерв                                                      0

     \[5\]     IOPDRST      RW    Управление                                                  0
                                  сбросом порта                                            
                                  ввода-вывода D                                           

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

     \[4\]     IOPCRST      RW    Управление                                                  0
                                  сбросом порта                                            
                                  ввода-вывода C                                           

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

     \[3\]       Res        RO    Резерв                                                      0

     \[2\]     IOPARST      RW    Управление                                                  0
                                  сбросом порта                                            
                                  ввода-вывода A                                           

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          

     \[1\]       Res        RO    Резерв                                                      0

     \[0\]     AFIORST      RW    Управление                                                  0
                                  сбросом                                                  
                                  интерфейса                                               
                                  вспомогательных                                          
                                  функций портов                                           
                                  ввода-вывода                                             

                                  1:                Сброс модуля                           

                                  0:                Без изменений                          
  -------------------------------------------------------------------------------------------------

### 3.4.5 Регистр сброса периферийной шины PB1 (RCC_APB1PRSTR) 

> Смещение адреса: 0x10

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 11%" />
<col style="width: 8%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="3" style="text-align: center;">Резерв</td>
<td style="text-align: left;">PWRRST</td>
<td colspan="6" style="text-align: center;">Резерв</td>
<td style="text-align: left;"> </td>
<td colspan="5" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td colspan="4" style="text-align: center;">Резерв</td>
<td style="text-align: center;"><p>WWDG</p>
<p>RST</p></td>
<td colspan="10" style="text-align: center;">Резерв</td>
<td style="text-align: center;"><p>TIM2</p>
<p>RST</p></td>
</tr>
</tbody>
</table>

  -------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                            Знач.
                                                                                      сброса
  ----------- ---------- -------- ------------- ------------------------------------ --------
   \[31:29\]     Res        RO    Резерв                                                0

    \[28\]      PWRRST      RW    Управление                                            0
                                  сбросом                                            
                                  интерфейса                                         
                                  управления                                         
                                  питанием                                           

                                  1:            Сброс модуля                         

                                  0:            Без изменений                        

   \[27:22\]     Res        RO    Резерв                                                0

    \[21\]     I2C1RST      RW    Управление                                            0
                                  сбросом                                            
                                  интерфейса                                         
                                  шины I2C1                                          

                                  1:            Сброс модуля                         

                                  0:            Без изменений                        

   \[20:12\]     Res        RO    Резерв                                                0

    \[11\]     WWDGRST      RW    Управление                                            0
                                  сбросом                                            
                                  интерфейса                                         
                                  оконного                                           
                                  сторожевого                                        
                                  таймера                                            

                                  1:            Сброс модуля                         

                                  0:            Без изменений                        

   \[10:1\]      Res        RO    Резерв                                                0

     \[0\]     TIM2RST      RW    Управление                                            0
                                  сбросом                                            
                                  интерфейса                                         
                                  таймера TIM2                                       

                                  1:            Сброс модуля                         

                                  0:            Без изменений                        
  -------------------------------------------------------------------------------------------

### 3.4.6 Регистр включения тактирования периферийной шины HB (RCC_AHBPCENR) 

> Смещение адреса: 0x14

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 9%" />
<col style="width: 6%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="16" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td colspan="13" style="text-align: center;">Резерв</td>
<td style="text-align: center;"><p>SRAM</p>
<p>EN</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>DMA1</p>
<p>EN</p></td>
</tr>
</tbody>
</table>

  -------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                             Знач.
                                                                                      сброса
  ---------- ---------- -------- ------------ -------------------------------------- --------
   \[31:3\]     Res        RO    Резерв                                                 0

    \[2\]      SRAMEN      RW    Бит                                                    1
                                 включения                                           
                                 тактового                                           
                                 сигнала                                             
                                 модуля                                              
                                 интерфейса                                          
                                 SRAM                                                

                                 1:           Тактовый сигнал модуля интерфейса SRAM 
                                              остается активным во время режима сна  

                                 0:           Тактовый сигнал модуля интерфейса SRAM 
                                              отключается в режиме сна               

    \[1\]       Res        RO    Резерв                                                 0

    \[0\]      DMA1EN      RW    Бит                                                    0
                                 включения                                           
                                 тактового                                           
                                 сигнала                                             
                                 модуля DMA1                                         

                                 1:           Тактовый сигнал модуля включен         

                                 0:           Тактовый сигнал модуля отключен        
  -------------------------------------------------------------------------------------------

### 3.4.7 Регистр включения тактирования периферийной шины PB2 (RCC_APB2PCENR) 

> Смещение адреса: 0x18

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 7%" />
<col style="width: 4%" />
<col style="width: 6%" />
<col style="width: 7%" />
<col style="width: 5%" />
<col style="width: 7%" />
<col style="width: 4%" />
<col style="width: 5%" />
<col style="width: 4%" />
<col style="width: 0%" />
<col style="width: 7%" />
<col style="width: 0%" />
<col style="width: 7%" />
<col style="width: 0%" />
<col style="width: 5%" />
<col style="width: 7%" />
<col style="width: 4%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th colspan="2" style="text-align: center;">21</th>
<th colspan="2" style="text-align: center;">20</th>
<th colspan="2" style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="19" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td colspan="2" style="text-align: center;">5</td>
<td colspan="2" style="text-align: center;">4</td>
<td colspan="2" style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;">USART1EN</td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;">SPI1EN</td>
<td style="text-align: center;">TIM1EN</td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>ADC1</p>
<p>EN</p></td>
<td colspan="4" style="text-align: center;">Резерв</td>
<td colspan="2" style="text-align: center;">IOPDEN</td>
<td colspan="2" style="text-align: center;">IOPCEN</td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;">IOPAEN</td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;">AFIOEN</td>
</tr>
</tbody>
</table>

  ------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                 Знач.
                                                                                           сброса
  ----------- ---------- -------- ----------------- ------------------------------------- --------
   \[31:15\]     Res        RO    Резерв                                                     0

    \[14\]     USART1EN     RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  интерфейса USART1                                       

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

    \[13\]       Res        RO    Резерв                                                     0

    \[12\]      SPI1EN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  интерфейса SPI1                                         

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

    \[11\]     USART1EN     RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  интерфейса TIM1                                         

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

    \[10\]       Res        RO    Резерв                                                     0

     \[9\]      ADC1EN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  интерфейса ADC1                                         

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

    \[8:6\]      Res        RO    Резерв                                                     0

     \[5\]      IOPDEN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  порта I/O D                                             

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

     \[4\]      IOPCEN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  порта I/O C                                             

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

     \[3\]       Res        RO    Резерв                                                     0

     \[2\]      IOPAEN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  порта I/O A                                             

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              

     \[1\]       Res        RO    Резерв                                                     0

     \[0\]      AFIOEN      RW    Бит включения                                              0
                                  тактового сигнала                                       
                                  вспомогательных                                         
                                  функций портов                                          

                                  1:                Тактовый сигнал включен               

                                  0:                Тактовый сигнал отключен              
  ------------------------------------------------------------------------------------------------

### 3.4.8 Регистр включения тактирования периферийной шины PB1 (RCC_APB1PCENR) 

> Смещение адреса: 0x1С

  ----------------------------------------------------------------------------------------------------------
     31     30   29    28       27       26     25   24   23   22     21       20     19   18   17     16
  -------- ---- ---- ------- -------- -------- ---- ---- ---- ---- -------- -------- ---- ---- ---- --------
   Резерв             PWREN   Резерв                                I2C1EN   Резерв                 

     15     14   13    12       11       10     9    8    7    6      5        4      3    2    1      0

   Резерв                     WWDGEN   Резерв                                                        TIM2EN
  ----------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                            Знач.
                                                                                      сброса
  ----------- ---------- -------- ------------ ------------------------------------- --------
   \[31:29\]     Res        RO    Резерв                                                0

    \[28\]      PWREN       RW    Бит                                                   0
                                  включения                                          
                                  тактового                                          
                                  сигнала                                            
                                  интерфейса                                         
                                  управления                                         
                                  питанием                                           

                                  1:           Тактовый сигнал включен               

                                  0:           Тактовый сигнал отключен              

   \[27:22\]     Res        RO    Резерв                                                0

    \[21\]      I2C1EN      RW    Бит                                                   0
                                  включения                                          
                                  тактового                                          
                                  сигнала                                            
                                  интерфейса                                         
                                  I2C1                                               

                                  1:           Тактовый сигнал включен               

                                  0:           Тактовый сигнал отключен              

   \[20:12\]     Res        RO    Резерв                                                0

    \[11\]      WWDGEN      RW    Бит                                                   0
                                  включения                                          
                                  тактового                                          
                                  сигнала                                            
                                  интерфейса                                         
                                  WWGD                                               

                                  1:           Тактовый сигнал включен               

                                  0:           Тактовый сигнал отключен              

   \[10:1\]      Res        RO    Резерв                                                0

     \[0\]      TIM2EN      RW    Бит                                                   0
                                  включения                                          
                                  тактового                                          
                                  сигнала                                            
                                  интерфейса                                         
                                  TIM2                                               

                                  1:           Тактовый сигнал включен               

                                  0:           Тактовый сигнал отключен              
  -------------------------------------------------------------------------------------------

### 3.4.9 Control/Status Register (RCC_RSTSCKR) 

> Смещение адреса: 0x24

<table style="width:100%;">
<colgroup>
<col style="width: 8%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 0%" />
<col style="width: 6%" />
<col style="width: 0%" />
<col style="width: 6%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th style="text-align: center;">19</th>
<th style="text-align: center;">18</th>
<th colspan="3" style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><p>LPWR</p>
<p>RSTF</p></td>
<td style="text-align: center;"><p>WW</p>
<p>DG</p>
<p>RSTF</p></td>
<td style="text-align: center;"><p>IW</p>
<p>DG</p>
<p>RSTF</p></td>
<td style="text-align: center;"><p>SFT</p>
<p>RSTF</p></td>
<td style="text-align: center;"><p>POR</p>
<p>RSTF</p></td>
<td style="text-align: center;"><p>PIN</p>
<p>RSTF</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>RM</p>
<p>VF</p></td>
<td colspan="10" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td colspan="3" style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td colspan="15" style="text-align: center;">Резерв</td>
<td style="text-align: center;"><p>LSI</p>
<p>RDY</p></td>
<td colspan="2" style="text-align: center;"><p>LSI</p>
<p>ON</p></td>
</tr>
</tbody>
</table>

  -----------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                 Знач.
                                                                                          сброса
  ---------- ---------- -------- ----------------- ------------------------------------- --------
    \[31\]    LPWRRSTF     RO    Флаг сброса по                                             0
                                 низкому питанию                                         

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[30\]   WWDG RSTF     RO    Флаг события                                               0
                                 сброса                                                  
                                 сторожевого                                             
                                 таймера окна                                            

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[29\]   IWDG RSTF     RO    Флаг события                                               0
                                 сброса                                                  
                                 сторожевого                                             
                                 таймера                                                 

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[28\]    SFTRSTF      RO    Флаг события                                               0
                                 программного                                            
                                 сброса                                                  

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[27\]    PORRSTF      RO    Флаг события                                               0
                                 сброса                                                  
                                 PowerUp/PowerDn                                         

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[26\]    PINRSTF      RO    Флаг события                                               0
                                 сброса по                                               
                                 внешнему сбросу                                         
                                 (пин NRST)                                              

                                 1:                Событие было                          

                                 0:                События не было                       

                                 Устанавливается в                                       
                                 1 аппаратно при                                         
                                 возникновении                                           
                                 события;                                                
                                 очищается                                               
                                 программной                                             
                                 записью в бит                                           
                                 RMVF                                                    

    \[25\]      Res        RO    Резерв                                                     0

    \[24\]      RMVF       RW    Флаг управляющий                                           0
                                 сбросом флагов                                          
                                 событий                                                 

                                 1:                Сбросить флаги событий                

                                 0:                Нет эффекта                           

   \[23:2\]     Res        RO    Резерв                                                     0

    \[1\]      LSIRDY      RO    Флаг готовности                                            0
                                 низкочастотного                                         
                                 тактового                                               
                                 генератора (LSI)                                        
                                 устанавливается                                         
                                 аппаратно                                               

                                 1:                Генератор LSI стабилен                

                                 0:                Генератор LSI не стабилен             

                                 Примечание: После                                       
                                 сброса LSION,                                           
                                 требуется 3 LSI                                         
                                 такта для сброса                                        
                                 этого флага                                             

    \[0\]      LSION       RW    Бит включения                                              0
                                 низкочастотного                                         
                                 тактирования                                            
                                 (LSI)                                                   

                                 1:                Включить осциллятор LSI (128КГц)      

                                 0:                Отключить осциллятор LSI (128КГц)     
  -----------------------------------------------------------------------------------------------

*Примечание: Флаг очистки сброса может быть очищен за исключением бита
BIT1, который очищается при включении питания.*

# Глава 4 Независимый сторожевой таймер (IWDG) 

> Система оснащена независимым сторожевым таймером (IWDG), который
> предназначен для обнаружения логических ошибок и сбоев программного
> обеспечения, вызванных внешними воздействиями окружающей среды.
> Источник тактового сигнала IWDG берется от низкочастотного генератора
> (LSI) и может работать независимо от основной программы, что делает
> его подходящим для приложений, где не требуется высокая точность.

## 4.1 Основные возможности 

-   **12-битный саморазрядуемый счетчик**

-   **Источник тактовой частоты**: делитель LSI, может работать в режиме
    пониженного энергопотребления.

-   **Условие сброса**: Значение счетчика уменьшается до нуля

## 4.2 Описание функции

## Начало формы

##  4.2.1 Принцип работы и применение

> Независимый сторожевой таймер использует в качестве источника
> тактового сигнала генератор LSI, и его функция продолжает работать
> даже в режимах отключения питания и ожидания. Когда счетчик
> сторожевого таймера самостоятельно уменьшается до нуля, генерируется
> системный сброс, поэтому время ожидания составляет (значение
> перезагрузки + 1) тактовый цикл.

Рисунок 4-1 Блок-схема структуры независимого сторожевого таймераНачало
формы

> ![](media/image10.png){width="5.2868055555555555in"
> height="1.9076388888888889in"}

-   Включить независимый сторожевой таймер

> После системного сброса сторожевой таймер выключен, и запись значения
> 0xCCCC в регистр **IWDG_CTLR** включает его, после чего он не может
> быть снова отключён, если только не произойдёт новый сброс. Если бит
> включения аппаратного независимого сторожевого таймера (**IWDG_SW**)
> установлен в байтах пользовательских опций, то IWDG будет
> автоматически включён после сброса микроконтроллера.

-   Конфигурация сторожевого таймера

Сторожевой таймер представляет собой внутренний 12-битный счётчик,
который работает по принципу уменьшения. Когда значение счётчика
достигает нуля, происходит системный сброс. Чтобы включить функцию IWDG,
необходимо выполнить следующие действия:

1)  **Базовое время счёта:** Источником тактового сигнала IWDG является
    LSI; через регистр **IWDG_PSCR** устанавливается значение деления
    LSI, которое используется в качестве базового времени счёта для
    IWDG. Метод работы заключается в том, чтобы сначала записать
    значение 0x5555 в регистр **IWDG_CTLR**, а затем изменить значение
    деления в регистре **IWDG_PSCR**. Бит **PVU** в регистре состояния
    **IWDG_STATR** указывает статус обновления значения деления, и это
    значение можно изменять и считывать только при завершении
    обновления.

2)  **Значение перезагрузки:** Используется для обновления текущего
    значения счётчика в автономном сторожевом таймере, причём счётчик
    уменьшается на это значение. Бит **RVU** в регистре статуса
    **IWDG_STATR** показывает состояние обновления значения
    перезагрузки, и регистр **IWDG_RLDR** может быть изменён и прочитан
    только при завершённом обновлении.

3)  **Включение сторожевого таймера:** Запись значения 0xCCCC в регистр
    **IWDG_CTLR** активирует функцию сторожевого таймера.

4)  **«Кормление собаки»:** То есть обновление текущего значения
    счётчика перед тем, как счётчик сторожевого таймера уменьшится до
    нуля, чтобы предотвратить системный сброс. Для этого следует
    записать значение 0xAAAA в регистр **IWDG_CTLR**, что позволит
    оборудованию обновить значение регистра **IWDG_RLDR** в счётчике
    сторожевого таймера. Это действие должно выполняться регулярно после
    активации функции сторожевого таймера, иначе произойдёт сброс
    системы по сигналу сторожевого таймера.

### 4.2.2 Режим наладки 

> Когда система переходит в режим отладки, счётчик IWDG может быть
> настроен через регистр модуля отладки таким образом, чтобы продолжать
> работу или останавливаться.

## 4.3 Описание регистров 

Таблица 4-1 Список регистров, связанных с IWDG

  -----------------------------------------------------------------------------
  **Наименование**    **Адрес**    **Описание**                     **Значение
                                                                     сброса**
  ------------------- ------------ ------------------------------- ------------
  R16_IWDG_CTLR       0x40003000   Регистр управления                 0x0000

  R16_IWDG_PSCR       0x40003004   Регистр прескейлера                0x0000

  R16_IWDG_RLDR       0x40003008   Регистр перезагрузки               0x0FFF

  R16_IWDG_STATR      0x4000300C   Регистр статуса                    0x0000
  -----------------------------------------------------------------------------

### 4.3.1 Регистр управления (IWDG_CTLR) 

Адрес смещения: 0x00

  ----------------------------------------------------------------------------------------
       15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0
  ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   KEY\[15:0\]                                                                        

  ----------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                         Значение
                                                                                   сброса
  ---------- ---------- -------- ------------- --------------------------------- ----------
   \[15:0\]     KEY        WO    Используйте                                         0
                                 следующие                                       
                                 ключи:                                          

                                 00xAAAA:      Кормление сторожевого таймера.    
                                               Загрузка значения регистра        
                                               IWDG_RLDR в счетчик независимого  
                                               сторожевого таймера.              

                                 0x5555:       Позволяет модификацию регистров   
                                               R16_IWDG_PSCR и R16_IWDG_RLDR.    

                                 0xCCCC:       Запустите сторожевой таймер, если 
                                               он еще не был запущен с           
                                               использованием пользовательских   
                                               настроек.                         
  -----------------------------------------------------------------------------------------

### 4.3.2 Регистр прескейлера (IWDG_PSCR) 

Адрес смещения: 0x04

  ------------------------------------------------------------------------------------------
     15     14   13   12   11   10   9    8    7    6    5    4    3        2       1    0
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----------- ---- ----
   Резерв                                                               PR\[2:0\]       

  ------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------------
     Бит      Название    Доступ        Описание                                            Значение
                                                                                             сброса
  ---------- ----------- -------- -------------------- ----------------------------------- ----------
   \[15:3\]      Res        RO           Резерв                                                0

   \[2:0\]    PR\[2:0\]     RW    Коэффициент деления                                          0
                                   тактового сигнала                                       
                                      IWDG: перед                                          
                                    изменением этого                                       
                                     поля запишите                                         
                                   значение 0x5555 в                                       
                                      регистр KEY.                                         

                                          000:                     Делитель 4              

                                          001:                     Делитель 8              

                                          010:                     Делитель 16             

                                          011:                     Делитель 32             

                                          100:                     Делитель 64             

                                          101:                    Делитель 128             

                                          110:                    Делитель 256             

                                          111:                    Делитель 256             

                                    Время счета IWDG                                       
                                    основано на базе                                       
                                    LSI, деленной на                                       
                                  коэффициент деления.                                     

                                   *Примечание: Перед                                      
                                    чтением значения                                       
                                       этого поля                                          
                                   убедитесь, что бит                                      
                                   **PVU** в регистре                                      
                                  **IWDG_STATR** равен                                     
                                  0, иначе прочитанное                                     
                                     значение будет                                        
                                   недействительным.*                                      
  ---------------------------------------------------------------------------------------------------

### 4.3.3 Регистр перезагрузки (IWDG_RLDR) 

Адрес смещения: 0x08

  -------------------------------------------------------------------------------------------
     15     14   13   12       11       10   9    8    7    6    5    4    3    2    1    0
  -------- ---- ---- ---- ------------ ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   Резерв                  RL\[11:0\]                                                    

  -------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------
      Бит       Название    Доступ                  Описание                  Значение
                                                                               сброса
  ----------- ------------ -------- ---------------------------------------- ----------
   \[15:12\]      Res         RO                     Резерв                      0

   \[11:0\]    RL\[11:0\]     RW    Значение перезагрузки счетчика. Запишите     0
                                         0x5555 в регистр **KEY** перед      
                                             изменением этого поля.          

                                      Когда в регистр **KEY** записывается   
                                      значение 0xAAAA, значение этого поля   
                                     загружается в счетчик аппаратно, после  
                                      чего счетчик начинает уменьшаться от   
                                                этого значения.              

                                     *Примечание: Перед чтением или записью  
                                     значения этого поля убедитесь, что бит  
                                    **RVU** в регистре **IWDG_STATR** равен  
                                    0, иначе чтение или запись данного поля  
                                            будут недействительны.*          
  -------------------------------------------------------------------------------------

### 4.3.4 Регистр статуса (IWDG_STATR) 

Адрес смещения: 0x0C

  -------------------------------------------------------------------------------------
     15     14   13   12   11   10   9    8    7    6    5    4    3    2   1     0
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----- -----
   Резерв                                                                   RVU   PVU

  -------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------
      Бит      Название   Доступ      Описание                                            Значение
                                                                                           сброса
  ----------- ---------- -------- ----------------- ------------------------------------ ----------
   \[15:12\]     Res        RO         Резерв                                                0

     \[1\]       RVU               Флаг обновления                                           0
                                      значения                                           
                                    перезагрузки.                                        
                                   Устанавливается                                       
                                  или сбрасывается                                       
                                   аппаратно в 0.                                        

                                         1:           Идет процесс обновления значения   
                                                               перезагрузки.             

                                         0:          Завершение обновления перезагрузки  
                                                             (до 5 циклов LSI).          

                                    *Примечание:                                         
                                       Регистр                                           
                                    перезагрузки                                         
                                      значений                                           
                                    **IWDG_RLDR**                                        
                                     может быть                                          
                                    доступен для                                         
                                  чтения или записи                                      
                                    только после                                         
                                    того, как бит                                        
                                    **RVU** будет                                        
                                    очищен до 0.*                                        

     \[0\]       PVU               Флаг обновления                                           0
                                    коэффициента                                         
                                  деления тактовой                                       
                                      частоты.                                           
                                   Устанавливается                                       
                                  или сбрасывается                                       
                                   аппаратно в 0.                                        

                                         1:               Идет обновление значения       
                                                       коэффициента деления тактовой     
                                                                  частоты.               

                                         0:            Завершение обновления значения    
                                                       коэффициента деления тактовой     
                                                         частоты (до 5 циклов LSI).      

                                    *Примечание:                                         
                                       Регистр                                           
                                    коэффициента                                         
                                       деления                                           
                                    **IWDG_PSCR**                                        
                                     может быть                                          
                                    доступен для                                         
                                  чтения или записи                                      
                                    только после                                         
                                    того, как бит                                        
                                    **PVU** будет                                        
                                    очищен до 0.*                                        
  -------------------------------------------------------------------------------------------------

> *Примечание: После обновления значения предделителя или значения
> перезагрузки нет необходимости ждать сброса битов **RVU** или **PVU**,
> и выполнение следующего кода может продолжиться. (Эта операция записи
> будет выполнена до завершения даже в режиме пониженного
> энергопотребления.)*

#  

# Глава 5 Оконный сторожевой таймер Начало формы (WWDG) 

> Оконный сторожевой таймер обычно используется для мониторинга работы
> системы на предмет программных сбоев, таких как внешние помехи,
> непредвиденные логические ошибки и другие условия. Он требует
> обновления счетчика (подачи сторожевого таймера) в пределах
> определенного временного окна (с верхним и нижним пределами); в
> противном случае раньше или позже этого временного окна схема
> сторожевого таймера сгенерирует системный сброс.

## 5.1 Основные характеристики

-   Программируемый 7-битный счетчик с убыванием

-   Двойное условие сброса: значение счетчика меньше 0x40 или значение
    счетчика перезагружается вне временного окна

-   Функция раннего уведомления пробуждения (EWI) для своевременной
    подачи сторожевого таймера, предотвращающей системный сброс

## 5.2 Описание функций

### 5.2.1 Принцип работы и применение

> Работа оконного сторожевого таймера основана на 7-битном счетчике с
> убыванием, который подключен к шине HB и считает частоту деления
> источника тактовой частоты WWDG_CLK (HCLK/4096) с коэффициентом
> деления, установленным в поле WDGTB\[1:0\] регистра конфигурации
> WWDG_CFGR. Счетчик находится в свободном состоянии выполнения, и счет
> продолжается независимо от того, включена функция сторожевого таймера
> или нет. На рисунке 5-1 показана блок-схема внутренней структуры
> оконного сторожевого таймера.

Рисунок 5-1 Блок-схема структуры оконного сторожевого таймера

**-**

**W6**

**W5**

**W4**

**W3**

**W2**

**W1**

**W0**

**WDGA**

**T6**

**T5**

**T4**

**T3**

**T2**

**T1**

**T0**

**/4096**

**WDGTB\[1:0\]**

**HCLK**

**Watchdog control register(WWDG_CTLR)**

**RESET**

**Запись WWDG_CTLR\[6:0\]**

**Регистр конфигурации сторожевого таймера(WWDG_CFGR)**

**T\[6:0\]**

**\>**

**W\[6:0\]**

**WWDG_CLK**

**WWDG enable control, software on**

-   Включение оконного сторожевого таймера

> После системного сброса сторожевой таймер выключен. Установка бита
> **WDGA** в регистре **WWDG_CTLR** включает сторожевой таймер, и после
> этого его нельзя отключить повторно, пока не произойдет сброс.
>
> *Примечание: Функционирование сторожевого таймера можно косвенно
> остановить, установив регистр **RCC_APB1PCENR** для отключения
> источника тактовой частоты WWDG и приостановки счета **WWDG_CLK**,
> либо установив регистр **RCC_APB1PRSTR** для сброса модуля WWDG, что
> эквивалентно роли сброса.*

-   Настройка сторожевого таймера

Сторожевой таймер представляет собой внутренний 7-битный счётчик,
который непрерывно уменьшает своё значение и поддерживает доступ на
чтение и запись. Чтобы воспользоваться функцией сброса сторожевого
таймера, необходимо выполнить следующие действия:

1)  **База времени счёта:** Через битовые поля **WDGTB**\[1:0\] регистра
    **WWDG_CFGR**, обратите внимание, что модуль WWDG блока RCC должен
    быть включен.

2)  **Счётчик окна:** Установите битовые поля **W**\[6:0\] в регистре
    **WWDG_CFGR**. Этот счётчик используется оборудованием для сравнения
    с текущим значением счётчика. Его значение задаётся программным
    обеспечением пользователя и не изменяется. Оно служит максимальным
    пределом для временного окна.

3)  **Включение сторожевого таймера:** Установив бит WDGA в регистре
    **WWGD_CTLR** в значение 1, включаем функцию сторожевого таймера.
    При этом возможно выполнение системного сброса.

4)  **«Кормление собаки»:** То есть обновление текущего значения
    счётчика, для чего необходимо настроить битовые поля **T**\[6:0\]
    регистра **WWGD_CTLR**. Эта операция должна выполняться в рамках
    заданного временного окна после включения функции сторожевого
    таймера. В противном случае произойдёт сброс системы по сигналу
    сторожевого таймера.

-   Временное окно «кормления собаки»

> Как показано на Рисунке 5-2, заштрихованная область --- это зона
> мониторинга оконного сторожевого таймера. Верхнее время t2
> соответствует моменту, когда текущее значение счётчика достигает
> значения окна W\[6:0\], а нижнее время t3 --- моменту, когда текущее
> значение счётчика становится равным 0x3F. В течение этого интервала
> времени t2 \< t \< t3 можно провести операцию «кормления собаки»
> (записать T\[6:0\]), чтобы обновить текущее значение счётчика.
>
> Рисунок 5-2 Режим счёта оконного сторожевого таймера

**RESET**

**T6 bit**

**Обновление запрещено**

**Обновление разрешено**

**0**

**x3F**

**W\[6:0\]**

**Max=0x7F**

**Y\[6:0\] CNT Текущее значение**

**Время**

**t1**

**t2**

**t3**

**Обновление будет сброшено в зоне запрета обновления**

**i**

**[nd]{.underline}**

**o**

**[w]{.underline}**

**ar**

**[ea]{.underline}**

**[W]{.underline}**

**HCLK1**

**Timeout:T \*4096\*2 \*(T\[5:0\]+1\])**

**WDGTB**

**Счетчик будет сброшен, когда значение CNT станет меньше 0x40.**

-   Сброс сторожевого таймера

1)  Когда значение счётчика **T**\[6:0\] меняется с 0x40 на 0x3F из-за
    отсутствия своевременной операции «кормления собаки», произойдёт
    «сброс оконного сторожевого таймера», и будет сгенерирован системный
    сброс. То есть, оборудование обнаруживает, что бит **T6** равен
    нулю, и происходит системный сброс.

> *Примечание: Приложение может установить бит **T6** в ноль программным
> способом, чтобы вызвать системный сброс, что аналогично функции
> программного сброса.*

2)  Когда выполняется действие обновления счётчика в запрещённое для
    «кормления» время, т.е. операция записи битового поля **T**\[6:0\]
    производится в период времени t1 ≤ t ≤ t2, произойдёт «сброс
    оконного сторожевого таймера» и будет выполнен системный сброс.

-   Предварительное пробуждение

> Чтобы предотвратить системный сброс, вызванный несвоевременным
> обновлением счётчика, модуль сторожевого таймера предоставляет
> уведомление о раннем прерывании пробуждения (**EWI**). Когда счётчик
> самостоятельно уменьшается до 0x40, генерируется сигнал раннего
> пробуждения, и флаг **EWIF** устанавливается в 1. Если бит **EWI**
> установлен, одновременно будет вызвано прерывание оконного сторожевого
> таймера. В этот момент остаётся всего один такт счётчика
> (самоуменьшение до 0x3F) до аппаратного сброса, и приложение может
> немедленно выполнить операцию «кормления собаки» в течение этого
> времени.

### 5.2.2 Режим наладки 

> Когда система переходит в режим отладки, счётчик WWDG может быть
> настроен через регистр модуля отладки таким образом, чтобы продолжить
> работу или остановиться.

## 5.3 Описание регистров 

> Таблица 5-1 Список регистров, связанных с WWDG

  -----------------------------------------------------------------------------
  **Наименование**    **Адрес**    **Описание**                    **Значение
                                                                   сброса**
  ------------------- ------------ ------------------------------- ------------
  R16_WWDG_CTLR       0x40002C00   Регистр управления              0x007F

  R16_WWDG_CFGR       0x40002C04   Регистр настройки               0x007F

  R16_WWDG_STATR      0x40002C08   Регистр статуса                 0x0000
  -----------------------------------------------------------------------------

### 5.3.1 Регистр управления (WWDG_CTLR) 

Адрес смещения: 0x00

  ---------------------------------------------------------------------------------------
     15     14   13   12   11   10   9    8   7            6       5   4   3   2   1   0
  -------- ---- ---- ---- ---- ---- ---- ---- -------- ---------- --- --- --- --- --- ---
   Резерв                                     WDGA      T\[6:0\]                      

  ---------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------------
     Бит      Название   Доступ       Описание                                             Значение
                                                                                            сброса
  ---------- ---------- -------- ------------------- ------------------------------------ ----------
   \[15:8\]     Res        RO          Резерв                                                 0

    \[7\]       WDGA       RW      Бит разрешения                                             0
                                 сброса сторожевого                                       
                                    таймера окна.                                         

                                         1:          Включить функцию сторожевого таймера 
                                                     (которая генерирует сигнал сброса).  

                                         0:             Отключить функцию сторожевого     
                                                        таймера. Программная запись 1     
                                                        включена, но только позволяет     
                                                        оборудованию сбросить 0 после     
                                                                   сброса.                

   \[6:0\]    T\[6:0\]     RW         7-битный                                               7Fh
                                  самоуменьшающийся                                       
                                 счетчик уменьшается                                      
                                 на 1 каждые 4096 \*                                      
                                   2\^WDGTB циклов                                        
                                     HCLK. Сброс                                          
                                 сторожевого таймера                                      
                                 генерируется, когда                                      
                                  счетчик уменьшает                                       
                                   свое значение с                                        
                                  0x40 до 0x3F, то                                        
                                   есть, когда T6                                         
                                   переходит к 0.                                         
  --------------------------------------------------------------------------------------------------

### 5.3.2 Регистр конфигурации (WWDG_CFGR) 

Адрес смещения: 0x04

  -------------------------------------------------------------------------------------------------
     15     14   13   12   11   10  9            8          7        6       5   4   3   2   1   0
  -------- ---- ---- ---- ---- ---- ------ -------------- ------ ---------- --- --- --- --- --- ---
   Резерв                           EWI     WDGTB\[1:0\]          W\[6:0\]                      

  -------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------
     Бит      Название   Доступ     Описание                                            Значение
                                                                                         сброса
  ---------- ---------- -------- -------------- -------------------------------------- ----------
   \[15:8\]     Res        RO        Резерв                                                0

    \[9\]       EWI        RW    Бит включения                                             0
                                   прерывания                                          
                                    раннего                                            
                                  пробуждения.                                         
                                 Если этот бит                                         
                                  установлен в                                         
                                       1,                                              
                                  генерируется                                         
                                 прерывание при                                        
                                   достижении                                          
                                   счетчиком                                           
                                 значения 0x40.                                        
                                 Этот бит может                                        
                                 быть сброшен в                                        
                                    0 только                                           
                                   аппаратно                                           
                                 после сброса.                                         

   \[8:7\]     WDGTB       RW        Выбор                                                 0
              \[1:0\]             коэффициента                                         
                                    деления                                            
                                   тактового                                           
                                  сигнала для                                          
                                    оконного                                           
                                  сторожевого                                          
                                    таймера.                                           

                                      00:           Делитель 1, база времени счета     
                                                              =HCLK/4096               

                                      01:           Делитель 2, база времени счета     
                                                             =HCLK/4097/2              

                                      10:           Делитель 4, база времени счета     
                                                             =HCLK/4098/4              

                                      11:           Делитель 8, база времени счета     
                                                             =HCLK/4099/8              

   \[6:0\]    W\[6:0\]     RW    7-битное окно                                            7Fh
                                    оконного                                           
                                  сторожевого                                          
                                    таймера.                                           
                                  Используется                                         
                                 для сравнения                                         
                                  со значением                                         
                                   счетчика.                                           
                                    Операция                                           
                                   кормления                                           
                                  собаки может                                         
                                  выполняться                                          
                                 только тогда,                                         
                                 когда значение                                        
                                    счетчика                                           
                                     меньше                                            
                                 значения окна                                         
                                 и больше 0x3F.                                        
  -----------------------------------------------------------------------------------------------

### 5.3.3 Регистр статуса (WWDG_STATR) 

Адрес смещения: 0x08

  -------------------------------------------------------------------------------------
     15     14   13   12   11   10    9      8      7     6   5   4   3   2   1  0
  -------- ---- ---- ---- ---- ---- ------ ------ ------ --- --- --- --- --- --- ------
   Резерв                                                                        EWIF

  -------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
     Бит      Название   Доступ                   Описание                   Значение
                                                                              сброса
  ---------- ---------- -------- ------------------------------------------ ----------
   \[15:1\]     Res        RO                      Резерв                       0

    \[0\]       EWIF       RW    Флаг прерывания раннего пробуждения. Когда     0
                                 счетчик достигает значения 0x40, этот бит  
                                  устанавливается аппаратно и должен быть   
                                     сброшен в 0 программно; настройка      
                                  пользователя недействительна. Даже если   
                                   EWI не установлен, этот бит все равно    
                                   будет устанавливаться, как обычно, при   
                                           возникновении события.           
  ------------------------------------------------------------------------------------

#  Глава 6 Прерывания и события (PFIC) 

> Серия CH32V003 имеет встроенный программируемый быстрый контроллер
> прерываний (PFIC), поддерживающий до 255 векторов прерываний. Текущая
> система управляет 23 периферийными каналами прерываний и 4 основными
> каналами прерываний, остальные зарезервированы.

## 6.1 Основные возможности 

### 6.1.1 PFIC 

-   23 периферийных прерывания, каждое прерывание имеет независимые биты
    триггера и маски, со специальными битами состояния

-   Программируемое многоуровневое вложение прерываний, максимальная
    глубина вложения 2 уровня, глубина аппаратного стека 2 уровня

-   Быстрая система входа и выхода из прерывания с автоматической
    аппаратной обработкой стека

-   Механизм обработки прерываний Vector Table Free (VTF), прямое
    программирование доступа к адресам вектора прерывания двумя
    способами

## 6.2 Системный таймер 

-   Серия CH32V003

> Ядро оснащено 32-битным суммирующим счётчиком (SysTick), который
> поддерживает HCLK или HCLK/8 в качестве временной базы с высоким
> приоритетом и может использоваться в качестве эталонного времени после
> калибровки.

## 6.3 Таблица векторов прерываний и исключений

> Таблица 6-1 Таблица векторов серии CH32V003

  --------------------------------------------------------------------------------------
    No    Приоритет    Тип       Имя                 Описание              Адрес входа
  ------ ----------- ------- ----------- --------------------------------- -------------
    0        \-        \-        \-                     \-                 0x00000000

    1        \-        \-        \-                     \-                 0x00000004

    2        -2       fixed      NMI         Немаскируемые прерывания      0x00000008

    3        -1       fixed   HardFault        Аномальные прерывания       0x0000000С

   4-11      \-        \-                         Зарезервировано          0x00000010-
                                                                           0x0000002С

    12        0       prog     SysTick     Прерывание системного таймера   0x00000030

    13       \-        \-                         Зарезервировано          0x00000034

    14        1       prog       SW            Програмные прерывания       0x00000038

    15       \-        \-                         Зарезервировано          0x0000003С

    16        2       prog      WWDG        Прерывание таймера оконного    0x00000040
                                                сторожевого таймера        

    17        3       prog       PVD      Прерывание детектора напряжения  0x00000044
                                                  питания (EXTI)           

    18        4       prog      FLASH       Глобальное прерывание Flash    0x00000048

    19        5       prog       RCC     Прерывания сброса и тактирования  0x0000004С

    20        6       prog     EXTI7_0       Прерывания EXTI линии 0-7     0x00000050

    21        7       prog       AWU          Прерывание пробуждения       0x00000054

    22        8       prog     DMA_CH1   Глобальное прерывание DMA1 канал  0x00000058
                                                         1                 

    23        9       prog     DMA_CH2   Глобальное прерывание DMA1 канал  0x0000005С
                                                         2                 

    24       10       prog     DMA_CH3   Глобальное прерывание DMA1 канал  0x00000060
                                                         3                 

    25       11       prog     DMA_CH4   Глобальное прерывание DMA1 канал  0x00000064
                                                         4                 

    26       12       prog     DMA_CH5   Глобальное прерывание DMA1 канал  0x00000068
                                                         5                 

    27       13       prog     DMA_CH6   Глобальное прерывание DMA1 канал  0x0000006С
                                                         6                 

    28       14       prog     DMA_CH7   Глобальное прерывание DMA1 канал  0x00000070
                                                         7                 

    29       15       prog       ADC         Глобальное прерывание АЦП     0x00000074

    30       16       prog     I2C1_EV        Прерывание событий I2C1      0x00000078

    31       17       prog     I2C1_ER        Прерывание ошибок I2C1       0x0000007C

    32       18       prog     USART1      Глобальное прерывание USART1    0x00000080

    33       19       prog      SPI1        Глобальное прерывание SPI1     0x00000084

    34       20       prog     TIM1BRK       Прерывание останова TIM1      0x00000088

    35       21       prog     TIM1UP       Прерывание обновления TIM1     0x0000008С

    36       22       prog     TIM1TRG      Прерывание вызываемое TIM1     0x00000090

    37       23       prog     TIM1CC        Прерывание TIM1 захвата и     0x00000094
                                                     сравнения             

    38       24       prog      TIM2        Глобальное прерывание TIM2     0x00000098
  --------------------------------------------------------------------------------------

## 6.4 Контроллер внешних прерываний и событий (EXTI) 

### 6.4.1 Обзор

Рисунок 6-1 Блок-схема интерфейса внешнего прерывания (EXTI)

**HBbus**

**Интерфейс переферии**

**INTFR**

**INTENR**

**SWIEVR**

**RTENR**

**FTENR**

**HCLK**

**10**

**10**

**10**

**10**

**10**

**Генератор импульсов**

**EVENR**

**Схема детектора фронтов**

**В контроллер прерываний PFIC**

**10**

**10**

**10**

**10**

**10**

**10**

**10**

**10**

**Input**

**Line**

> Как видно из рисунка 6-1, источником запуска внешнего прерывания может
> быть программное прерывание (**SWIEVR**) или реальный внешний канал
> прерывания. Сигнал внешнего канала прерывания сначала пройдет через
> схему детектора фронтов. Как только возникает одно из сигналов
> программного прерывания или внешнего прерывания, оно будет выведено на
> две схемы с вентилем ИЛИ, разрешения события и разрешения прерывания,
> через схему с вентиль ИЛИ на рисунке. Пока разрешено хотя бы одно
> прерывание или событие, будет сгенерировано прерывание или событие.
> Процессор получает доступ к шести регистрам EXTI через интерфейс
> HB.Начало формы

### 6.4.2 Событие пробуждения 

Система может вывести микроконтроллер из режима сна, вызванного командой
WFE, посредством события пробуждения. Событие пробуждения генерируется
одним из двух следующих способов:

-   **Разрешение прерывания в периферийном регистре**, но без разрешения
    этого прерывания в PFIC ядра, и одновременное разрешение бита
    **SEVONPEND** в ядре. Например, в EXTI это означает разрешить
    прерывание EXTI, но не разрешать прерывание EXTI в PFIC, и
    одновременно разрешить бит **SEVONPND**. Когда микроконтроллер
    просыпается от команды WFE, ему нужно сбросить бит флага прерывания
    EXTI и бит ожидания PFIC.

-   **Конфигурация канала EXTI как канала события** устраняет
    необходимость для микроконтроллера сбрасывать бит флага прерывания и
    бит ожидающего состояния PFIC после пробуждения от команды WFE.

### 6.4.3 Описание

Использование внешнего прерывания требует настройки соответствующего
канала внешнего прерывания, то есть выбора соответствующего фронта
срабатывания и разрешения соответствующего прерывания. Когда
установленный фронт срабатывания появляется на канале внешнего
прерывания, генерируется запрос на прерывание, и соответствующий бит
флага прерывания устанавливается. Флаг можно сбросить, записав 1 в бит
флага.

Шаги использования внешних аппаратных прерываний.

1.  Конфигурация операций GPIO.

2.  Настройка бита разрешения прерывания (**EXTI_INTENR**) для
    соответствующего канала внешнего прерывания.

3.  Настройка фронта срабатывания (**EXTI_RTENR** или **EXTI_FTENR**)
    для выбора нарастающего фронта, спадающего фронта или двойного
    фронта.

4.  Настройка прерываний EXTI в PFIC ядра, чтобы обеспечить их
    корректное реагирование.

Шаги для использования внешних аппаратных событий.

1.  Конфигурация операций GPIO.

2.  Настройте бит разрешения события (**EXTI_EVENR**) для
    соответствующего канала внешнего прерывания.

3.  Настройте фронт срабатывания (**EXTI_RTENR** или **EXTI_FTENR**) для
    выбора нарастающего фронта, спадающего фронта или двойного фронта.

Шаги по использованию программного прерывания/события.

1.  Разрешите внешние прерывания (**EXTI_INTENR**) или внешние события
    (**EXTI_EVENR**).

2.  Если используются функции обслуживания прерываний, прерывание EXTI
    необходимо настроить в PFIC ядра.

3.  Установите запуск программного прерывания (**EXTI_SWIEVR**), то есть
    будет сгенерировано прерывание.

### 6.4.4 Внешняя карта событий

> Таблица 6-2 Соответствие прерываний EXTI

+-----------------+----------------------------------------------------+
| Внешние         | Описание таблицы событий                           |
| прерывания/     |                                                    |
| линии событий   |                                                    |
+:===============:+:===================================================+
| EXTI0\~EXTI7    | Контакты Px0--Px7 (где x = A/C/D) могут            |
|                 | использоваться для внешней функции                 |
|                 | прерывания/события. Конфигурация осуществляется    |
|                 | через регистр AFIO_EXTICR.                         |
+-----------------+----------------------------------------------------+
| EXTI8           | Событие PVD: превышение порогового значения        |
|                 | напряжения контроля.Начало формы                   |
|                 |                                                    |
|                 | Конец формы                                        |
+-----------------+----------------------------------------------------+
| EXTI9           | События авто-пробуждения                           |
+-----------------+----------------------------------------------------+

## 6.5 Описание регистров 

### 6.5.1 Регистры EXTI 

> Таблица 6-3 Список регистров, связанных с EXTI

  -----------------------------------------------------------------------------
  **Наименование**     **Адрес**   **Описание**                     **Значение
                                                                     сброса**
  ------------------- ------------ ------------------------------- ------------
  R32_EXTI_INTENR      0x40010400  Регистр включения прерываний     0x00000000

  R32_EXTI_EVENR       0x40010404  Регистр включения событий        0x00000000

  R32_EXTI_RTENR       0x40010408  Регистр включения триггеров      0x00000000
                                   восходящих фронтов              

  R32_EXTI_FTENR       0x4001040C  Регистр включения триггеров      0x00000000
                                   нисходящих фронтов              

  R32_EXTI_SWIEVR      0x40010410  Регистр программного прерывания  0x00000000
                                   события                         

  R32_EXTI_INTFR       0x40010414  Регистр флагов прерываний        0x0000xxxx
  -----------------------------------------------------------------------------

#### 6.5.1.1 Регистр включения прерываний (EXTI_INTENR) 

Адрес смещения: 0x00

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24    23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                                 

     15     14   13   12   11   10    9     8     7     6     5     4     3     2     1     0

   Резерв                            MR9   MR8   MR7   MR6   MR5   MR4   MR3   MR2   MR1   MR0
  ---------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
     Бит      Название   Доступ    Описание                                           Значение
                                                                                       сброса
  ---------- ---------- -------- ------------ -------------------------------------- ----------
   \[15:1\]     Res        RO       Резерв                                               0

   \[9:0\]      MRx        RW     Разрешить                                              0
                                    сигнал                                           
                                   запроса                                           
                                  прерывания                                         
                                 для внешнего                                        
                                    канала                                           
                                  прерываний                                         
                                      x.                                             

                                      1:          Включить прерывание по линии x     

                                      0:        Маскировать прерывание по линии x    
  ---------------------------------------------------------------------------------------------

#### 6.5.1.2 Регистр включения событий (EXTI_EVENR) 

Адрес смещения: 0x04

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24    23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                                 

     15     14   13   12   11   10    9     8     7     6     5     4     3     2     1     0

   Резерв                            MR9   MR8   MR7   MR6   MR5   MR4   MR3   MR2   MR1   MR0
  ---------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
     Бит      Название   Доступ    Описание                                           Значение
                                                                                       сброса
  ---------- ---------- -------- ------------ -------------------------------------- ----------
   \[15:1\]     Res        RO       Резерв                                               0

   \[9:0\]      MRx        RW     Разрешить                                              0
                                    сигнал                                           
                                   запроса                                           
                                 события для                                         
                                   внешнего                                          
                                    канала                                           
                                  прерываний                                         
                                      x.                                             

                                      1:             Событие включает канал x        

                                      0:            Событие отключает канал x        
  ---------------------------------------------------------------------------------------------

#### 6.5.1.3 Регистр разрешения срабатывания по нарастающему фронту (EXTI_RTENR) 

Адрес смещения: 0x08

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24    23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                                 

     15     14   13   12   11   10    9     8     7     6     5     4     3     2     1     0

   Резерв                            TR9   TR8   TR7   TR6   TR5   TR4   TR3   TR2   TR1   TR0
  ---------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------
     Бит      Название   Доступ     Описание                                            Значение
                                                                                         сброса
  ---------- ---------- -------- -------------- -------------------------------------- ----------
   \[15:1\]     Res        RO        Резерв                                                0

   \[9:0\]      TRx        RW      Разрешить                                               0
                                  срабатывание                                         
                                       по                                              
                                  нарастающему                                         
                                     фронту                                            
                                    внешнего                                           
                                     канала                                            
                                 прерывания x.                                         

                                       1:       Разрешить срабатывание по нарастающему 
                                                       фронту для этого канала.        

                                       0:       Отключить срабатывание по нарастающему 
                                                       фронту для этого канала.        
  -----------------------------------------------------------------------------------------------

#### 6.5.1.4 Регистр разрешения срабатывания по спадающему фронту (EXTI_FTENR)

Адрес смещения: 0x0С

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24    23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                                 

     15     14   13   12   11   10    9     8     7     6     5     4     3     2     1     0

   Резерв                            TR9   TR8   TR7   TR6   TR5   TR4   TR3   TR2   TR1   TR0
  ---------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------
     Бит      Название   Доступ     Описание                                            Значение
                                                                                         сброса
  ---------- ---------- -------- -------------- -------------------------------------- ----------
   \[15:1\]     Res        RO        Резерв                                                0

   \[9:0\]      TRx        RW      Разрешить                                               0
                                  срабатывание                                         
                                       по                                              
                                  ниспадающему                                         
                                     фронту                                            
                                    внешнего                                           
                                     канала                                            
                                  прерывания x                                         

                                       1:       Разрешить срабатывание по ниспадающему 
                                                       фронту для этого канала.        

                                       0:       Отключить срабатывание по ниспадающему 
                                                       фронту для этого канала.        
  -----------------------------------------------------------------------------------------------

#### 6.5.1.5 Регистр событий программных прерываний (EXTI_SWIEVR) 

Адрес смещения: 0x10

  ------------------------------------------------------------------------------------------------------------------------------
     31     30   29   28   27   26     25       24       23       22       21       20       19       18       17       16    
  -------- ---- ---- ---- ---- ---- -------- -------- -------- -------- -------- -------- -------- -------- -------- -------- --
   Резерв                                                                                                                     

     15     14   13   12   11   10     9        8        7        6        5        4        3        2        1        0     

   Резерв                            SWIER9   SWIER8   SWIER7   SWIER6   SWIER5   SWIER4   SWIER3   SWIER2   SWIER1   SWIER0  
  ------------------------------------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
      Бит      Название   Доступ                  Описание                   Значение
                                                                              сброса
  ----------- ---------- -------- ----------------------------------------- ----------
   \[15:10\]     Res        RO                     Резерв                       0

    \[9:0\]     SWIERx      RW      Программное прерывание установлено на       0
                                  соответствующий внешний канал прерывания. 
                                  Установка его здесь приводит к тому, что  
                                        флаг прерывания (EXTI_INTFR)        
                                     соответствует биту позиции, и если     
                                   разрешение прерывания (EXTI_INTENR) или  
                                  разрешение события (EXTI_EVENR) включены, 
                                    то будет сгенерировано прерывание или   
                                                  событие.                  
  ------------------------------------------------------------------------------------

#### 6.5.1.6 Регистр флагов прерываний (EXTI_INTFR) 

Адрес смещения: 0x14

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24    23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                                 

     15     14   13   12   11   10    9     8     7     6     5     4     3     2     1     0

   Резерв                            IF9   IF8   IF7   IF6   IF5   IF4   IF3   IF2   IF1   IF0
  ---------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
      Бит      Название   Доступ                  Описание                   Значение
                                                                              сброса
  ----------- ---------- -------- ----------------------------------------- ----------
   \[15:10\]     Res        RO                     Резерв                       0

    \[9:0\]      IFx        RW     Флаг прерывания: данный бит указывает,       0
                                    что произошло соответствующее внешнее   
                                  прерывание. Запись значения \"1\" очищает 
                                                  этот бит.                 
  ------------------------------------------------------------------------------------

### 6.5.2 PFIC Регистры 

Таблица 6-4 Список регистров, связанных с PFIC

+--------------+---------+----------------------------------+---------+
| **На         | **      | **Описание**                     | **З     |
| именование** | Адрес** |                                  | начение |
|              |         |                                  | с       |
|              |         |                                  | броса** |
+:=============+:=======:+:=================================+:=======:+
| R            | 0xE     | Регистр состояния разрешения     | 0x0     |
| 32_PFIC_ISR1 | 000E000 | прерывания PFIC 1                | 000000C |
+--------------+---------+----------------------------------+---------+
| R            | 0xE     | Регистр состояния разрешения     | 0x0     |
| 32_PFIC_ISR2 | 000E004 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R            | 0xE     | Регистр состояния ожидания       | 0x0     |
| 32_PFIC_IPR1 | 000E020 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R            | 0xE     | Регистр состояния ожидания       | 0x0     |
| 32_PFIC_IPR2 | 000E024 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R32_PFIC\_   | 0xE     | Регистр конфигурации порога      | 0x0     |
|              | 000E040 | приоритета прерывания PFIC       | 0000000 |
| ITHRESDR     |         |                                  |         |
+--------------+---------+----------------------------------+---------+
| R            | 0xE     | Регистр конфигурации прерывания  | 0x0     |
| 32_PFIC_CFGR | 000E048 | PFIC                             | 0000000 |
+--------------+---------+----------------------------------+---------+
| R            | 0xE     | Регистр глобального состояния    | 0x0     |
| 32_PFIC_GISR | 000E04C | прерывания PFIC                  | 0000000 |
+--------------+---------+----------------------------------+---------+
| R32          | 0xE     | Регистр конфигурации             | 0x0     |
| _PFIC_VTFIDR | 000E050 | идентификатора VTF прерывания    | 0000000 |
|              |         | PFIC                             |         |
+--------------+---------+----------------------------------+---------+
| R32_PFIC\_   | 0xE     | Регистр смещения адреса          | 0x0     |
|              | 000E060 | прерывания VTF PFIC 0            | 0000000 |
| VTFADDRR0    |         |                                  |         |
+--------------+---------+----------------------------------+---------+
| R32_PFIC\_   | 0xE     | Регистр смещения адреса          | 0x0     |
|              | 000E064 | прерывания VTF PFIC 1            | 0000000 |
| VTFADDRR1    |         |                                  |         |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр установки разрешения     | 0x0     |
| 2_PFIC_IENR1 | 000E100 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр установки разрешения     | 0x0     |
| 2_PFIC_IENR2 | 000E104 | прерывания PFIC 2Начало          | 0000000 |
|              |         | формыКонец формы                 |         |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр очистки разрешения       | 0x0     |
| 2_PFIC_IRER1 | 000E180 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр очистки разрешения       | 0x0     |
| 2_PFIC_IRER2 | 000E184 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр установки ожидания       | 0x0     |
| 2_PFIC_IPSR1 | 000E200 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр установки ожидания       | 0x0     |
| 2_PFIC_IPSR2 | 000E204 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр очистки ожидания         | 0x0     |
| 2_PFIC_IPRR1 | 000E280 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр очистки ожидания         | 0x0     |
| 2_PFIC_IPRR2 | 000E284 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R32          | 0xE     | Регистр состояния активации      | 0x0     |
| _PFIC_IACTR1 | 000E300 | прерывания PFIC 1                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R32          | 0xE     | Регистр состояния активации      | 0x0     |
| _PFIC_IACTR2 | 000E304 | прерывания PFIC 2                | 0000000 |
+--------------+---------+----------------------------------+---------+
| R32_         | 0xE     | Регистр конфигурации приоритета  | 0x0     |
| PFIC_IPRIORx | 000E400 | прерывания PFIC                  | 0000000 |
+--------------+---------+----------------------------------+---------+
| R3           | 0xE     | Регистр управления системой PFIC | 0x0     |
| 2_PFIC_SCTLR | 000ED10 |                                  | 0000000 |
+--------------+---------+----------------------------------+---------+

*Примечание:*

1.  *Значение по умолчанию регистра PFIC_ISR1 равно 0xC, то есть NMI и
    исключение всегда включены по умолчанию.*

2.  *NMI и EXC поддерживают операции очистки и установки ожидания
    прерывания, но не поддерживают операции очистки и установки
    разрешения прерывания.*

#### 6.5.2.1 PFIC Регистр состояния разрешения прерываний 1 (PFIC_ISR1) 

Адрес смещения: 0x00

  ----------------------------------------------------------------------------------------------------------------------------------------
          31               30         29         28         27     26   25   24   23   22   21   20      19          18         17     16
  ------------------- ------------ -------- ------------ -------- ---- ---- ---- ---- ---- ---- ---- ----------- ----------- -------- ----
   INTENSTA\[31:16\]                                                                                                                  

          15               14         13         12         11     10   9    8    7    6    5    4        3           2         1      0

        Резерв         INTENSTA14   Резерв   INTENSTA12   Резерв                                      INTENSTA3   INTENSTA2   SWIER1  
  ----------------------------------------------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                               Значение
                                                                                          сброса
  ----------- ---------- -------- ------------- --------------------------------------- ----------
   \[31:16\]  INT ENSTA     RO    16#-31#                                                   0
                                  Статус                                                
                                  включено ли                                           
                                  конкретное                                            
                                  прерывание                                            
                                  (interrupt) в                                         
                                  данный момент                                         
                                  времени                                               

                                  1:            Если значение равно 1, это означает,    
                                                что данное прерывание включено. То      
                                                есть, когда возникает условие, которое  
                                                должно вызывать это прерывание,         
                                                процессор перейдет к обработке          
                                                соответствующей процедуры обработки     
                                                прерывания                              

                                  0:            Если же значение равно 0, это говорит о 
                                                том, что прерывание в данный            
                                                момент отключено. Даже если условие для 
                                                вызова прерывания возникнет, оно не     
                                                будет обработано процессором            

    \[15\]       Res        RO    Резерв                                                    0

    \[14\]    INT ENSTA     RO    14# Статус                                                0
                                  включено ли                                           
                                  конкретное                                            
                                  прерывание                                            
                                  (interrupt) в                                         
                                  данный момент                                         
                                  времени                                               

                                  1:            Включено                                

                                  0:            Отключено                               

    \[13\]       Res        RO    Резерв                                                    0

    \[12\]    INT ENSTA     RO    12# Статус                                                0
                                  включено ли                                           
                                  конкретное                                            
                                  прерывание                                            
                                  (interrupt) в                                         
                                  данный момент                                         
                                  времени                                               

                                  1:            Включено                                

                                  0:            Отключено                               

   \[11:4\]      Res        RO    Резерв                                                    0

    \[3:2\]   INT ENSTA     RO    2#-#3 Статус                                              0
                                  включено ли                                           
                                  конкретное                                            
                                  прерывание                                            
                                  (interrupt) в                                         
                                  данный момент                                         
                                  времени                                               

                                  1:            Включено                                

                                  0:            Отключено                               

    \[1:0\]      Res        RO    Резерв                                                    0
  ------------------------------------------------------------------------------------------------

#### 6.5.2.2 PFIC Регистр состояния разрешения прерываний 2 (PFIC_ISR2) 

Адрес смещения: 0x04

  ------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23         22          21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ----------------- ---- ---- ---- ---- ---- ----
   Резерв                                                                                     

     15     14   13   12   11   10   9    8    7           6          5    4    3    2    1    0

   Резерв                                           INTENSTA\[6:0\]                           
  ------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
     Бит      Название   Доступ    Описание                                          Значение
                                                                                      сброса
  ---------- ---------- -------- ------------- ------------------------------------ ----------
   \[31:7\]     Res        RO       Резерв                                              0

   \[6:0\]   INT ENSTA     RO       32#-38#                                             0
                                    Статус                                          
                                  включено ли                                       
                                  конкретное                                        
                                  прерывание                                        
                                 (interrupt) в                                      
                                 данный момент                                      
                                    времени                                         

                                      1:                     Включено               

                                      0:                    Отключено               
  --------------------------------------------------------------------------------------------

#### 6.5.2.3 PFIC Регистр состояния ожидающих прерываний 1 (PFIC_IPR1) 

Адрес смещения: 0x20

  -----------------------------------------------------------------------------------------------------------------
          31           30      29      28      27     26   25   24   23   22   21   20    19     18      17     16
  ------------------ ------ -------- ------ -------- ---- ---- ---- ---- ---- ---- ---- ------ ------ -------- ----
   PENDSTA\[31:16\]                                                                                            

          15           14      13      12      11     10   9    8    7    6    5    4     3      2       1      0

        Резерв        PEN\   Резерв   PEN\   Резерв                                      PEN\   PEN\   Резерв  
                      DST\            DST\                                               DST\   DST\           
                      A14             A12                                                 A3     A2            
  -----------------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                            Значение
                                                                                       сброса
  ----------- ---------- -------- ----------- -------------------------------------- ----------
   \[31:16\]  INT ENSTA     RO    16#-31#                                                0
                                  Прервать                                           
                                  текущий                                            
                                  ожидаемый                                          
                                  статус                                             

                                  1:          Текущий номер прерывания находится в   
                                              ожидании                               

                                  0:          Текущий номер прерывания не находится  
                                              в ожидании                             

    \[15\]       Res        RO    Резерв                                                 0

    \[14\]    INT ENSTA     RO    14#                                                    0
                                  Прервать                                           
                                  текущий                                            
                                  ожидаемый                                          
                                  статус                                             

                                  1:          Текущий номер прерывания находится в   
                                              ожидании                               

                                  0:          Текущий номер прерывания не находится  
                                              в ожидании                             

    \[13\]       Res        RO    Резерв                                                 0

    \[12\]    INT ENSTA     RO    12#                                                    0
                                  Прервать                                           
                                  текущий                                            
                                  ожидаемый                                          
                                  статус                                             

                                  1:          Текущий номер прерывания находится в   
                                              ожидании                               

                                  0:          Текущий номер прерывания не находится  
                                              в ожидании                             

   \[11:4\]      Res        RO    Резерв                                                 0

    \[3:2\]   INT ENSTA     RO    2#-3#                                                  0
                                  Прервать                                           
                                  текущий                                            
                                  ожидаемый                                          
                                  статус                                             

                                  1:          Текущий номер прерывания находится в   
                                              ожидании                               

                                  0:          Текущий номер прерывания не находится  
                                              в ожидании                             

    \[1:0\]      Res        RO    Резерв                                                 0
  ---------------------------------------------------------------------------------------------

#### 6.5.2.4 PFIC Регистр состояния ожидающих прерываний 2 (PFIC_IPR2) 

Адрес смещения: 0x24

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23          22          21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10   9    8    7           6           5    4    3    2    1    0

   Резерв                                           PENDSTA\[38:32\]                           
  -------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------
     Бит      Название   Доступ   Описание                                        Значение
                                                                                   сброса
  ---------- ---------- -------- ----------- ----------------------------------- ----------
   \[31:7\]     Res        RO      Резерв                                            0

   \[6:0\]    PENDSTA      RO      32#-38#                                           0
                                  Прервать                                       
                                   текущий                                       
                                  ожидаемый                                      
                                   статус                                        

                                     1:      Текущий номер прерывания находится  
                                                         в ожидании              

                                     0:          Текущий номер прерывания не     
                                                    находится в ожидании         
  -----------------------------------------------------------------------------------------

#### 6.5.2.5 PFIC Регистр конфигурации порога приоритета прерываний (PFIC_ITHRESDR) 

Адрес смещения: 0x40

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24          23          22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10   9    8           7           6    5    4    3    2    1    0

   Резерв                                      THRESHOLD\[7:0\]                                
  -------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------------------
     Бит       Название    Доступ       Описание                                       Значение
                                                                                        сброса
  ---------- ------------ -------- ------------------ ------------------------------- ----------
   \[31:8\]      Res         RO          Резерв                                           0

   \[7:0\]    THRESHOLD\     RO    Значение настройки                                     0
               \[7:0\]             порога приоритета                                  
                                      прерывания.\                                    
                                        Значение                                      
                                       приоритета                                     
                                    прерывания ниже                                   
                                     установленного                                   
                                     значения, при                                    
                                     зависании, не                                    
                                       выполняет                                      
                                      обслуживание                                    
                                    прерывания; этот                                  
                                       регистр со                                     
                                      значением 0                                     
                                     означает, что                                    
                                    функция регистра                                  
                                         порога                                       
                                    недействительна.                                  

                                        \[7:6\]:             порог приоритета.        

                                        \[5:0\]:      зарезервировано, фиксировано на 
                                                        0, запись недействительна.    
  ----------------------------------------------------------------------------------------------

#### 6.5.2.6 PFIC Регистр конфигурации прерываний (PFIC_CFGR) 

Адрес смещения: 0x48

  ------------------------------------------------------------------------------------------------------
         31          30   29   28   27   26   25   24      23        22     21   20   19   18   17   16
  ----------------- ---- ---- ---- ---- ---- ---- ---- ---------- -------- ---- ---- ---- ---- ---- ----
   KEYCODE\[15:0\]                                                                                  

         15          14   13   12   11   10   9    8       7         6      5    4    3    2    1    0

       Резерв                                           RESETSYS   Резерв                           
  ------------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                 Значение
                                                                            сброса
  ----------- ---------- -------- --------------------------------------- ----------
   \[31:16\]   KEYCODE      WO    Соответственно разным битам управления      0
               \[15:0\]           целевым объектом, соответствующие       
                                  данные идентификации безопасности       
                                  доступа необходимо записывать           
                                  одновременно для изменения, а           
                                  считываемые данные фиксированы на 0.\   
                                  KEY1 = 0xFA05\                          
                                  KEY2 = 0xBCAF\                          
                                  KEY3 = 0xBEEF                           

   \[15:8\]      Res        RO    Резерв                                      0

     \[7\]     RESETSYS     WO    Сброс системы (одновременная запись в       0
                                  KEY3). Автоматическая очистка 0. Запись 
                                  1 действительна, запись 0               
                                  недействительна.\                       
                                  *Примечание: та же функция, что и у     
                                  бита **SYSRESET** регистра              
                                  **PFIC_SCTLR**.*                        

    \[6:0\]      Res        RO    Резерв                                      0
  ----------------------------------------------------------------------------------

#### 6.5.2.7 PFIC Глобальный регистр состояния прерываний (PFIC_GISR) 

Адрес смещения: 0x4C

  ----------------------------------------------------------------------------------------------------------
     31     30   29   28   27   26      25        24            23         22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---------- --------- ---------------- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                                               

     15     14   13   12   11   10      9          8            7          6    5    4    3    2    1    0

   Резерв                            GPENDSTA   GACTSTA   NESTSTA\[7:0\]                                
  ----------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
      Бит      Название   Доступ      Описание                                        Значение
                                                                                       сброса
  ----------- ---------- -------- ---------------- --------------------------------- ----------
   \[31:10\]     Res        RO         Резерв                                            0

     \[9\]    GPEND STA     RO        Наличие                                            0
                                    прерываний,                                      
                                     которые в                                       
                                  настоящее время                                    
                                    находятся в                                      
                                     ожидании.                                       

                                         1:                      Есть                

                                         0:                       Нет                

     \[8\]     GACTSTA      RO        Наличие                                            0
                                    прерываний,                                      
                                     которые в                                       
                                  настоящее время                                    
                                    выполняются.                                     

                                         1:                      Есть                

                                         0:                       Нет                

    \[7:0\]    NESTSTA      RO     Текущий статус                                        0
               \[7:0\]              вложенности                                      
                                   прерываний: в                                     
                                  настоящий момент                                   
                                   поддерживается                                    
                                     максимум 2                                      
                                       уровня                                        
                                   вложенности и                                     
                                    максимальная                                     
                                      глубина                                        
                                    аппаратного                                      
                                    стека также                                      
                                    составляет 2                                     
                                      уровня.                                        

                                       0x03:       Идёт обработка прерывания второго 
                                                                уровня               

                                       0x01:       Идёт обработка прерывания первого 
                                                                уровня               

                                       Other:          Прерывания не выполняются     
  ---------------------------------------------------------------------------------------------

#### 6.5.2.8 PFIC Регистр конфигурации идентификатора прерывания VTF (PFIC_VTFIDR) 

Адрес смещения: 0x50

  ---------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24     23     22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- -------- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                            

     15     14   13   12   11   10   9    8      7      6    5    4    3    2    1    0

   VTFID1                                      VTFID0                                
  ---------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
      Бит      Название   Доступ                  Описание                  Значение
                                                                             сброса
  ----------- ---------- -------- ---------------------------------------- ----------
   \[31:16\]     Res        RO                     Резерв                      0

   \[15:8\]     VTFID1      RW       Настройте номер прерывания для VTF        0
                                                прерывание 1               

    \[7:0\]     VTFID0      RW         Настройте номер прерывания для          0
                                               прерывания VTF              
  -----------------------------------------------------------------------------------

#### 6.5.2.9 PFIC Регистр адреса прерывания VTF 0 (PFIC_VTFADDRR0) 

Адрес смещения: 0x60

  ------------------------------------------------------------------------------------------------
         31         30   29   28   27   26   25   24   23   22   21   20   19   18   17     16
  ---------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---------
   ADDR0\[31:16\]                                                                        

         15         14   13   12   11   10   9    8    7    6    5    4    3    2    1       0

   ADDR0\[15:1\]                                                                          VTF0EN
  ------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------------
     Бит        Название      Доступ  Описание                                              Значение
                                                                                             сброса
  ---------- --------------- -------- -------------- ------------------------------------- ----------
   \[31:1\]   ADDR0\[31:1\]     RW    Адрес                                                    0
                                      программы                                            
                                      обслуживания                                         
                                      прерывания VTF                                       
                                      0\                                                   
                                      биты \[31:1\],                                       
                                      бит 0 равен 0                                        

    \[0\]        VTF0EN         RW    Бит разрешения                                           0
                                      прерывания VTF                                       
                                      0                                                    

                                      1:             Разрешить прерывание канала VTF 0     

                                      0:             Отключить                             
  ---------------------------------------------------------------------------------------------------

#### 6.5.2.10 PFIC Регистр адреса прерывания VTF 1 (PFIC_VTFADDRR1) 

Адрес смещения: 0x64

  -----------------------------------------------------------------------------------------------
         31         30   29   28   27   26   25   24   23   22   21   20   19   18   17     16
  ---------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- --------
   ADDR1\[31:16\]                                                                        

         15         14   13   12   11   10   9    8    7    6    5    4    3    2    1      0

   ADDR1\[15:1\]                                                                          VTF1EN
  -----------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------------
     Бит        Название      Доступ  Описание                                             Значение
                                                                                            сброса
  ---------- --------------- -------- -------------- ------------------------------------ ----------
   \[31:1\]   ADDR1\[31:1\]     RW    Адрес                                                   0
                                      программы                                           
                                      обслуживания                                        
                                      прерывания VTF                                      
                                      1\                                                  
                                      биты \[31:1\],                                      
                                      бит 0 равен 0                                       

    \[0\]        VTF1EN         RW    Бит разрешения                                          0
                                      прерывания VTF                                      
                                      1                                                   

                                      1:             Разрешить прерывание канала VTF 1    

                                      0:             Отключить                            
  --------------------------------------------------------------------------------------------------

#### 6.5.2.11 PFIC Регистр установки разрешения прерываний 1 (PFIC_IENR1) 

Адрес смещения: 0x100

  --------------------------------------------------------------------------------------------------------------
         31           30       29      28        27     26   25   24   23   22   21   20   19   18   17    16
  ---------------- --------- ------ --------- -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- -------
   INTEN\[31:16\]                                                                                        

         15           14       13      12        11     10   9    8    7    6    5    4    3    2    1      0

        Рез.        INTEN14   Рез.   INTEN12   Резерв                                                    
  --------------------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                             Значение
                                                                                        сброса
  ----------- ---------- -------- ------------- ------------------------------------- ----------
   \[31:16\]    INTEN       WO    16#-31#                                                 0
                                  Управление                                          
                                  разрешением                                         
                                  прерываний                                          

                                  1:            Разрешение соответствующего номеру    
                                                бита прерывания                       

                                  0:            Нет эффекта                           

   \[31:16\]     Res        RO    Резерв                                                  0

    \[14\]      INTEN       WO    14#                                                     0
                                  Управление                                          
                                  разрешением                                         
                                  прерываний                                          

                                  1:            Разрешение соответствующего номеру    
                                                бита прерывания                       

                                  0:            Нет эффекта                           

    \[13\]       Res        RO    Резерв                                                  0

    \[12\]      INTEN       WO    12#                                                     0
                                  Управление                                          
                                  разрешением                                         
                                  прерываний                                          

                                  1:            Разрешение соответствующего номеру    
                                                бита прерывания                       

                                  0:            Нет эффекта                           

   \[11:0\]      Res        RO    Резерв                                                  0
  ----------------------------------------------------------------------------------------------

> **6.5.2.12 PFIC** **Регистр установки разрешения прерываний 2
> (PFIC_IENR2)**

Адрес смещения: 0x104

  -----------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23         22         21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---------------- ---- ---- ---- ---- ---- ----
   Резерв                                                                                    

     15     14   13   12   11   10   9    8    7          6          5    4    3    2    1    0

   Резерв                                           INTEN\[38:32\]                           
  -----------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                             Значение
                                                                                       сброса
  ---------- ---------- -------- ------------- ------------------------------------- ----------
   \[31:7\]     Res        RO    Резерв                                                  0

   \[6:0\]     INTEN       WO    32#-38#                                                 0
                                 Управление                                          
                                 разрешением                                         
                                 прерываний                                          

                                 1:            Разрешение соответствующего номеру    
                                               бита прерывания                       

                                 0:            Нет эффекта                           
  ---------------------------------------------------------------------------------------------

#### 6.5.2.13 PFIC Регистр очистки разрешения прерываний 1 (PFIC_IRER1) 

Адрес смещения: 0x180

  -----------------------------------------------------------------------------------------------------------------
          31             30        29       28         27     26   25   24   23   22   21   20   19   18   17   16
  ------------------ ----------- ------ ----------- -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   INTRSET\[31:16\]                                                                                            

          15             14        13       12         11     10   9    8    7    6    5    4    3    2    1    0

         Рез.         INTRSET14   Рез.   INTRSET12   Резерв                                                    
  -----------------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                            Значение
                                                                                       сброса
  ----------- ---------- -------- ------------ ------------------------------------- ----------
   \[31:16\]   INTRSET      WO    16#-31#                                                0
                                  Сброс                                              
                                  разрешения                                         
                                  прерывания                                         

                                  1:           Сброс соответствующего номеру бита    
                                               разрешения прерывания                 

                                  0:           Нет эффекта                           

   \[31:16\]     Res        RO    Резерв                                                 0

    \[14\]     INTRSET      WO    14# Сброс                                              0
                                  разрешения                                         
                                  прерывания                                         

                                  1:           Сброс соответствующего номеру бита    
                                               разрешения прерывания                 

                                  0:           Нет эффекта                           

    \[13\]       Res        RO    Резерв                                                 0

    \[12\]     INTRSET      WO    12# Сброс                                              0
                                  разрешения                                         
                                  прерывания                                         

                                  1:           Сброс соответствующего номеру бита    
                                               разрешения прерывания                 

                                  0:           Нет эффекта                           

   \[11:0\]      Res        RO    Резерв                                                 0
  ---------------------------------------------------------------------------------------------

#### 6.5.2.14 PFIC Регистр очистки разрешения прерываний 2 (PFIC_IRER2) 

Адрес смещения: 0x184

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23          22          21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10   9    8    7           6           5    4    3    2    1    0

   Резерв                                           INTRSET\[38:32\]                           
  -------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                            Значение
                                                                                      сброса
  ---------- ---------- -------- ------------ ------------------------------------- ----------
   \[31:7\]     Res        RO    Резерв                                                 0

   \[6:0\]    INTRSET      WO    32#-38#                                                0
               32_38             Сброс                                              
                                 разрешения                                         
                                 прерывания                                         

                                 1:           Сброс соответствующего номеру бита    
                                              разрешения прерывания                 

                                 0:           Нет эффекта                           
  --------------------------------------------------------------------------------------------

#### 6.5.2.15 PFIC Регистр настройки ожидающих прерываний 1 (PFIC_IPSR1) 

Адрес смещения: 0x200

  ---------------------------------------------------------------------------------------------------------------------------------
          31             30        29       28         27     26   25   24   23   22   21   20      19         18        17     16
  ------------------ ----------- ------ ----------- -------- ---- ---- ---- ---- ---- ---- ---- ---------- ---------- -------- ----
   PENDSET\[31:16\]                                                                                                            

          15             14        13       12         11     10   9    8    7    6    5    4       3          2         1      0

         Рез.         PENDSET14   Рез.   PENDSET12   Резерв                                      PENDSET3   PENDSET2   Резерв  
  ---------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                           Значение
                                                                                      сброса
  ----------- ---------- -------- ------------ ------------------------------------ ----------
   \[31:16\]   PENDSET      WO    16#-31#                                               0
                                  Установка                                         
                                  паузы                                             
                                  прерывания                                        

                                  1:           Прерывание с соответствующим номером 
                                               ожидает                              

                                  0:           Нет эффекта                          

    \[15\]       Res        RO    Резерв                                                0

    \[14\]     PENDSET      WO    14#                                                   0
                                  Установка                                         
                                  паузы                                             
                                  прерывания                                        

                                  1:           Прерывание с соответствующим номером 
                                               ожидает                              

                                  0:           Нет эффекта                          

    \[13\]       Res        RO    Резерв                                                0

    \[12\]     PENDSET      WO    12#                                                   0
                                  Установка                                         
                                  паузы                                             
                                  прерывания                                        

                                  1:           Прерывание с соответствующим номером 
                                               ожидает                              

                                  0:           Нет эффекта                          

   \[11:4\]      Res        RO    Резерв                                                0

    \[3:2\]    PENDSET      WO    2#-3#                                                 0
                                  Установка                                         
                                  паузы                                             
                                  прерывания                                        

                                  1:           Прерывание с соответствующим номером 
                                               ожидает                              

                                  0:           Нет эффекта                          

    \[1:0\]      Res        RO    Резерв                                                0
  --------------------------------------------------------------------------------------------

#### 6.5.2.16 PFIC Регистр настройки ожидающих прерываний 2 (PFIC_IPSR2) 

Адрес смещения: 0x204

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23          22          21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10   9    8    7           6           5    4    3    2    1    0

   Резерв                                           PENDSET\[38:32\]                           
  -------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                            Значение
                                                                                      сброса
  ---------- ---------- -------- ------------ ------------------------------------- ----------
   \[31:7\]     Res        RO    Резерв                                                 0

   \[6:0\]    PENDSET      WO    32#-38#                                                0
                                 Установка                                          
                                 ожидания                                           
                                 прерывания                                         

                                 1:           Прерывание с соответствующим номером  
                                              ожидает                               

                                 0:           Нет эффекта                           
  --------------------------------------------------------------------------------------------

#### 6.5.2.17 PFIC Регистр очистки ожидающих прерываний 1 (PFIC_IPRR1) 

Адрес смещения: 0x280

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 10%" />
<col style="width: 4%" />
<col style="width: 13%" />
<col style="width: 4%" />
<col style="width: 3%" />
<col style="width: 3%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 3%" />
<col style="width: 3%" />
<col style="width: 3%" />
<col style="width: 0%" />
<col style="width: 12%" />
<col style="width: 0%" />
<col style="width: 12%" />
<col style="width: 0%" />
<col style="width: 5%" />
<col style="width: 4%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th style="text-align: center;">21</th>
<th style="text-align: center;">20</th>
<th colspan="2" style="text-align: center;">19</th>
<th colspan="2" style="text-align: center;">18</th>
<th colspan="2" style="text-align: center;">17</th>
<th style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td colspan="19" style="text-align: center;">PENDRST[31:16]</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">4</td>
<td colspan="2" style="text-align: center;">3</td>
<td colspan="2" style="text-align: center;">2</td>
<td colspan="2" style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;"><p>PENDRST</p>
<p>14</p></td>
<td style="text-align: center;">Рез.</td>
<td style="text-align: center;">PENDRST12</td>
<td colspan="9" style="text-align: center;">Резерв</td>
<td colspan="2" style="text-align: center;">PENDRST3</td>
<td colspan="2" style="text-align: center;">PENDRST2</td>
<td colspan="2" style="text-align: center;">Резерв</td>
</tr>
</tbody>
</table>

  --------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                           Значение
                                                                                      сброса
  ----------- ---------- -------- ------------ ------------------------------------ ----------
   \[31:16\]   PENDRST      WO    16#-31#                                               0
                                  Сброс паузы                                       
                                  прерывания                                        

                                  1:           Сброс ожидания с прерывания с        
                                               соответствующим номером              

                                  0:           Нет эфекта                           

    \[15\]       Res        RO    Резерв                                                0

    \[14\]     PENDRST      WO    14# Сброс                                             0
                                  паузы                                             
                                  прерывания                                        

                                  1:           Сброс ожидания с прерывания с        
                                               соответствующим номером              

                                  0:           Нет эфекта                           

    \[13\]       Res        RO    Резерв                                                0

    \[12\]     PENDRST      WO    12# Сброс                                             0
                                  паузы                                             
                                  прерывания                                        

                                  1:           Сброс ожидания с прерывания с        
                                               соответствующим номером              

                                  0:           Нет эфекта                           

   \[11:4\]      Res        RO    Резерв                                                0

    \[3:2\]    PENDRST      WO    2#-3# Сброс                                           0
                                  паузы                                             
                                  прерывания                                        

                                  1:           Сброс ожидания с прерывания с        
                                               соответствующим номером              

                                  0:           Нет эфекта                           

    \[1:0\]      Res        RO    Резерв                                                0
  --------------------------------------------------------------------------------------------

#### 6.5.2.18 PFIC Регистр очистки ожидающих прерываний 2 (PFIC_IPRR2) 

Адрес смещения: 0x284

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23          22          21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10   9    8    7           6           5    4    3    2    1    0

   Резерв                                           PENDRST\[38:32\]                           
  -------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                            Значение
                                                                                      сброса
  ---------- ---------- -------- ------------ ------------------------------------- ----------
   \[31:7\]     Res        RO    Резерв                                                 0

   \[6:0\]    PENDRST      WO    32#-38#                                                0
                                 Сброс паузы                                        
                                 прерывания                                         

                                 1:           Сброс ожидания с прерывания с         
                                              соответствующим номером               

                                 0:           Нет эфекта                            
  --------------------------------------------------------------------------------------------

#### 6.5.2.19 PFIC Регистр состояния активации прерывания 1 (PFIC_IACTR1) 

Адрес смещения: 0x300

  -----------------------------------------------------------------------------------------------------------------------
         31           30       29      28        27     26   25   24   23   22   21   20     19       18       17     16
  ---------------- --------- ------ --------- -------- ---- ---- ---- ---- ---- ---- ---- -------- -------- -------- ----
   IACTS\[31:16\]                                                                                                    

         15           14       13      12        11     10   9    8    7    6    5    4      3        2        1      0

        Рез.        IACTS14   Рез.   IACTS12   Резерв                                      IACTS3   IACTS2   Резерв  
  -----------------------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                            Значение
                                                                                       сброса
  ----------- ---------- -------- ------------ ------------------------------------- ----------
   \[31:16\]    IACTS       WO    16#-31#                                                0
                                  Статус                                             
                                  выполнения                                         
                                  прерывания                                         

                                  1:           Прерывание с соответствующим номером  
                                               выполняется                           

                                  0:           Прерывание с соответствующим номером  
                                               не выполняется                        

    \[15\]       Res        RO    Резерв                                                 0

    \[14\]      IACTS       WO    14# Статус                                             0
                                  выполнения                                         
                                  прерывания                                         

                                  1:           Прерывание с соответствующим номером  
                                               выполняется                           

                                  0:           Прерывание с соответствующим номером  
                                               не выполняется                        

    \[13\]       Res        RO    Резерв                                                 0

    \[12\]      IACTS       WO    12# Статус                                             0
                                  выполнения                                         
                                  прерывания                                         

                                  1:           Прерывание с соответствующим номером  
                                               выполняется                           

                                  0:           Прерывание с соответствующим номером  
                                               не выполняется                        

   \[11:4\]      Res        RO    Резерв                                                 0

    \[3:2\]     IACTS       WO    2#-3# Статус                                           0
                                  выполнения                                         
                                  прерывания                                         

                                  1:           Прерывание с соответствующим номером  
                                               выполняется                           

                                  0:           Прерывание с соответствующим номером  
                                               не выполняется                        

    \[1:0\]      Res        RO    Резерв                                                 0
  ---------------------------------------------------------------------------------------------

#### 6.5.2.20 PFIC Регистр состояния активации прерывания 2 (PFIC_IACTR2) 

Адрес смещения: 0x304

  -----------------------------------------------------------------------------------------------------------------------------------------------
      31      30              29   28            27   26                                  25   24   23      22       21   20   19   18   17   16
  ---------- ---- ---------- ---- ---- -------- ---- ---- ------------ ----------------- ---- ---- ---- ----------- ---- ---- ---- ---- ---- ----
    Резерв                                                                                                                                   

      15      14              13   12            11   10                                  9    8    7        6       5    4    3    2    1    0

    Резерв                                                                                                 IACTS                             
                                                                                                         \[38:32\]                           

     Бит           Название             Доступ              Описание                                                                         

   \[31:7\]          Res                  RO                 Резерв                                                                          

   \[6:0\]          IACTS                 RO                32#-38#                                                                          
                                                             Статус                                                                          
                                                           выполнения                                                                        
                                                           прерывания                                                                        

                                                               1:        Прерывание с                                                        
                                                                        соответствующим                                                      
                                                                            номером                                                          
                                                                          выполняется                                                        

                                                               0:        Прерывание с                                                        
                                                                        соответствующим                                                      
                                                                          номером не                                                         
                                                                          выполняется                                                        
  -----------------------------------------------------------------------------------------------------------------------------------------------

#### 6.5.2.21 PFIC Регистр конфигурации приоритета прерываний 

#### (PFIC_IPRIORx) (x=0-63) 

Адрес смещения: 0x400-0x4FF

> Контроллер поддерживает 256 прерываний (от 0 до 255), каждое из
> которых использует 8 бит для установки управляющего приоритета.

  ------------------------------------------------------------------------------------------------------
                   31         24          23         16          15          8          7           0
  ---------- -------------- ------- -------------- ------- -------------- ------- -------------- -------
  IPRIOR63      PRIO_255               PRIO_254               PRIO_253               PRIO_252    

  ...             ...                    ...                    ...                    ...       

  IPRIORx     PRIO\_(4x+3)           PRIO\_(4x+2)           PRIO\_(4x+1)           PRIO\_(4x+0)  

  ...             ...                    ...                    ...                    ...       

  IPRIOR0        PRIO_3                 PRIO_2                 PRIO_1                 PRIO_0     
  ------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------
      **Бит**      **Имя**   **Доступ**             **Описание**              **Значение
                                                                               сброса**
  --------------- --------- ------------ ----------------------------------- ------------
   \[2047:2040\]   IP_255        RW             Такое же что и у IP_0             0

        ...          ...        ...                      ...                     ...

     \[31:24\]      IP_3         RW             Такое же что и у IP_0             0

     \[23:16\]      IP_2         RW             Такое же что и у IP_0             0

     \[15:8\]       IP_1         RW             Такое же что и у IP_0             0

      \[7:0\]       IP_0         RW      Конфигурация приоритета прерывания       0
                                          ноль. \[7:6:4\]: биты управления   
                                                    приоритетом.\            
                                           Если вложенность не настроена,    
                                          отсутствуют биты предварительной   
                                                      выборки.\              
                                           Бит 7 является предварительным    
                                         выбором, если настроены два уровня  
                                                вложенности. \[5:0\]:        
                                         зарезервировано, установлено на 0,  
                                               запись недействительна.       
  ---------------------------------------------------------------------------------------

#### 6.5.2.22 Регистр управления системой PFIC (PFIC_SCTLR) 

Адрес смещения: 0xD10

<table style="width:100%;">
<colgroup>
<col style="width: 9%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 0%" />
<col style="width: 6%" />
<col style="width: 0%" />
<col style="width: 7%" />
<col style="width: 0%" />
<col style="width: 8%" />
<col style="width: 0%" />
<col style="width: 8%" />
<col style="width: 0%" />
<col style="width: 8%" />
<col style="width: 0%" />
<col style="width: 6%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">31</th>
<th style="text-align: center;">30</th>
<th style="text-align: center;">29</th>
<th style="text-align: center;">28</th>
<th style="text-align: center;">27</th>
<th style="text-align: center;">26</th>
<th style="text-align: center;">25</th>
<th style="text-align: center;">24</th>
<th style="text-align: center;">23</th>
<th style="text-align: center;">22</th>
<th colspan="2" style="text-align: center;">21</th>
<th colspan="2" style="text-align: center;">20</th>
<th colspan="2" style="text-align: center;">19</th>
<th colspan="2" style="text-align: center;">18</th>
<th colspan="2" style="text-align: center;">17</th>
<th colspan="2" style="text-align: center;">16</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><p>SYS</p>
<p>RESET</p></td>
<td colspan="21" style="text-align: center;">Резерв</td>
</tr>
<tr>
<td style="text-align: center;">15</td>
<td style="text-align: center;">14</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">12</td>
<td style="text-align: center;">11</td>
<td style="text-align: center;">10</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">6</td>
<td colspan="2" style="text-align: center;">5</td>
<td colspan="2" style="text-align: center;">4</td>
<td colspan="2" style="text-align: center;">3</td>
<td colspan="2" style="text-align: center;">2</td>
<td colspan="2" style="text-align: center;">1</td>
<td colspan="2" style="text-align: center;">0</td>
</tr>
<tr>
<td colspan="11" style="text-align: center;">Резерв</td>
<td colspan="2" style="text-align: left;">SET<br />
EVE<br />
NT</td>
<td colspan="2" style="text-align: center;"><p>SEV<br />
ON</p>
<p>PEND</p></td>
<td colspan="2" style="text-align: left;"><p>WFIT</p>
<p>OWFE</p></td>
<td colspan="2" style="text-align: left;"><p>SLEEP</p>
<p>DEEP</p></td>
<td colspan="2" style="text-align: left;"><p>SLEEP</p>
<p>ON</p>
<p>EXIT</p></td>
<td style="text-align: left;">Рез.</td>
</tr>
</tbody>
</table>

  --------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                  Значение
                                                                                            сброса
  ---------- ---------- -------- ----------------- -------------------------------------- ----------
    \[31\]      Res        WO    Системный сброс.\                                            0
                                 Автоматически                                            
                                 очищается в 0.\                                          
                                 Запись 1 --                                              
                                 сброс, запись 0                                          
                                 --                                                       
                                 недействителен,                                          
                                 эффект такой же,                                         
                                 как у регистра                                           
                                 PFIC_CFGR.                                               

   \[30:6\]     Res        RO    Резерв                                                       0

    \[5\]     SETEVENT     WO    Установить                                                   0
                                 событие для                                              
                                 пробуждения в                                            
                                 случае ожидания                                          
                                 (WFE)                                                    

    \[4\]    SEV ONPEND    RW    Когда происходит                                             0
                                 событие или                                              
                                 возникает                                                
                                 состояние                                                
                                 ожидания                                                 
                                 прерывания,                                              
                                 система может                                            
                                 быть разбужена                                           
                                 после выполнения                                         
                                 инструкции WFE,                                          
                                 либо если                                                
                                 инструкция WFE не                                        
                                 была выполнена,                                          
                                 то система будет                                         
                                 немедленно                                               
                                 разбужена перед                                          
                                 выполнением                                              
                                 следующей                                                
                                 команды.                                                 

                                 1:                разрешенные события и все прерывания   
                                                   (включая неразрешенные прерывания)     
                                                   могут разбудить систему                

                                 0:                только разрешенные события и           
                                                   разрешенные прерывания могут разбудить 
                                                   систему                                

    \[3\]    WFITO WFE     RW    Выполнить команду                                            0
                                 WFI так, как                                             
                                 будто это команда                                        
                                 WFE.                                                     

                                 1:                Обрабатывать следующую команду WFI как 
                                                   команду WFE                            

                                 0:                Нет эффекта                            

    \[2\]    SLEEP DEEP    RW    Режим низкого                                                0
                                 потребления                                              
                                 питания системой                                         
                                 управления                                               

                                 1:                Глубокий сон                           

                                 0:                Сон                                    

    \[1\]      SLEEP       RW    Состояние системы                                            0
               ONEXIT            после выхода                                             
                                 управления из                                            
                                 программы                                                
                                 обработки                                                
                                 прерывания                                               

                                 1:                Система переходит в режим              
                                                   энергосбережения                       

                                 0:                Система переходит в основную программу 

    \[0\]       Res        RO    Резерв                                                       0
  --------------------------------------------------------------------------------------------------

### 6.5.3 Специальные регистры CSR

> Архитектура RISC-V определяет ряд регистров управления и состояния
> (**CSR**), предназначенных для настройки, идентификации или
> регистрации рабочего состояния. Регистры **CSR** являются внутренними
> для ядра и используют выделенное 12-битное адресное пространство;
> микросхема CH32V003 дополнительно содержит несколько регистров,
> определенных производителем, помимо стандартных регистров, описанных в
> документации привилегированной архитектуры RISC-V, к которым требуется
> доступ с использованием инструкции csr.
>
> *Примечание: Эти регистры помечены как \"**MRW**, **MRO**, **MRW1**\"
> и требуют, чтобы система находилась в машинном режиме для доступа к
> ним.*

#### 6.5.3.1 Регистр управления системой прерываний (INTSYSCR)

Адрес смещения: 0x804

  ---------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21   20   19   18     17        16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- --------- ---------
   Резерв                                                                             

     15     14   13   12   11   10   9    8    7    6    5    4    3    2       1         0

   Резерв                                                                    INESTEN   HWSTKEN
  ---------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                            Значение
                                                                                      сброса
  ---------- ---------- -------- ------------- ------------------------------------ ----------
   \[31:2\]     Res       MRO    Резерв                                                 0

    \[1\]     INESTEN     MRO    Разрешение                                             0
                                 вложенных                                          
                                 прерываний                                         

                                 1:            Функция вложенных прерываний         
                                               включена                             

                                 0:            Функция вложенных прерываний         
                                               отключена                            

    \[0\]     HWSTKEN     MRO    Включение                                              0
                                 аппаратного                                        
                                 стека                                              

                                 1:            Функция аппаратного стекирования     
                                               включена                             

                                 0:            Функция аппаратного стекирования     
                                               отключена                            
  --------------------------------------------------------------------------------------------

#### 6.5.3.2 Регистр базовой адресации входа в исключение (MTVEC)

Адрес смещения: 0x305

  ------------------------------------------------------------------------------------------------------
          31           30   29   28   27   26   25   24   23   22   21   20   19   18     17       16
  ------------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- -------- --------
   BASEADDR\[31:16\]                                                                            

          15           14   13   12   11   10   9    8    7    6    5    4    3    2      1        0

   BASEADDR\[15:2\]                                                                     MODE1    MODE0
  ------------------------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------
     Бит      Название    Доступ  Описание                                            Значение
                                                                                       сброса
  ---------- ----------- -------- ------------ ------------------------------------- ----------
   \[31:2\]   BASEADDR\    MRW    Адрес                                                  0
              \[31:2\]            таблицы                                            
                                  векторов                                           
                                  прерываний                                         

    \[1\]       MODE1      MRW    Таблица                                                0
                                  векторов                                           
                                  прерываний                                         
                                  определяет                                         
                                  шаблоны                                            

                                  1:           Идентифицировать по абсолютному       
                                               адресу, поддерживать полный диапазон, 
                                               но необходимо прыгать                 

                                  0:           Идентификация по команде перехода,    
                                               ограниченный диапазон, поддержка      
                                               непрыгающих инструкций                

    \[0\]       MODE0      MRW    Выбор режима                                           0
                                  адреса входа                                       
                                  при                                                
                                  прерывании                                         
                                  или                                                
                                  исключении                                         

                                  1:           Смещение адреса на основе номера      
                                               прерывания, умноженного на 4          

                                  0:           Использование единого адреса входа.   
  ---------------------------------------------------------------------------------------------

### 6.5.4 STK Описание регистров

> Таблица 6-5 Список регистров, связанных со стеком (STK)

  -------------------------------------------------------------------------------
  **Наименование**   **Адрес**    **Описание**                       **Значение
                                                                     сброса**
  ------------------ ------------ ---------------------------------- ------------
  R32_STK_CTLR       0xE000F000   Регистр управления системным       0x00000000
                                  счетчиком                          

  R32_STK_SR         0xE000F004   Регистр состояния системного       0x00000000
                                  счетчика                           

  R32_STK_CNTL       0xE000F008   Регистр системного счетчика        0x00000000

  R32_STK_CMPLR      0xE000F010   Регистр сравнения счета            0x00000000
  -------------------------------------------------------------------------------

#### 6.5.4.1 Регистр управления системным счетчиком (STK_CTLR) 

Адрес смещения: 0x00

  -----------------------------------------------------------------------------------------------
  31          30     29   28   27   26   25   24   23   22   21   20    19     18      17    16
  -------- -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ------ ------- ------ -----
  SWIE      Резерв                                                                          

  15          14     13   12   11   10   9    8    7    6    5    4     3       2      1      0

  Резерв                                                               STRE   STCLK   STIE   STE
  -----------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                  Значение
                                                                                            сброса
  ---------- ---------- -------- ----------------- -------------------------------------- ----------
    \[31\]      SWIE       RW    Разрешение                                                   0
                                 генерации                                                
                                 программного                                             
                                 прерывания (SWI)                                         

                                 1:                Генерация программных прерываний       

                                 0:                Отключить генерацию                    

                                 После входа в                                            
                                 программное                                              
                                 прерывание                                               
                                 требуется                                                
                                 очистить его в 0                                         
                                 программно, иначе                                        
                                 оно будет                                                
                                 непрерывно                                               
                                 вызываться                                               

   \[30:4\]     Res        RO    Резерв                                                       0

    \[3\]       STRE       RW    Бит разрешения                                               0
                                 автоматического                                          
                                 перезагрузки                                             
                                 счетчика                                                 

                                 1:                Повторный счет с нуля после достижения 
                                                   значения сравнения                     

                                 0:                Досчитать до значения сравнения и      
                                                   продолжать счет вверх, досчитать до 0  
                                                   и снова начать считать вниз от         
                                                   максимального значения                 

    \[2\]      STCLK       RW    Бит выбора                                                   0
                                 источника                                                
                                 тактовой частоты                                         
                                 для счетчика                                             

                                 1:                HCLK используется в качестве временной 
                                                   базы                                   

                                 0:                HCLK/8 используется в качестве         
                                                   временной базы                         

    \[1\]       STIE       RW    Бит управления                                               0
                                 разрешением                                              
                                 прерывания от                                            
                                 счетчика                                                 

                                 1:                Разрешить прерывание от счетчика       

                                 0:                Запретить прерывание от счетчика       

    \[0\]       STE        RW    Бит управления                                               0
                                 включением                                               
                                 системного                                               
                                 счетчика                                                 

                                 1:                Включить системный счетчик STK         

                                 0:                Выключить системный счетчик STK, и     
                                                   счет прекращается                      
  --------------------------------------------------------------------------------------------------

#### 6.5.4.2 Регистр состояния системного счетчика (STK_SR) 

Адрес смещения: 0x04

  --------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21   20   19   18   17    16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- -------
   Резерв                                                                        

     15     14   13   12   11   10   9    8    7    6    5    4    3    2    1      0

   Резерв                                                                         CNTIF
  --------------------------------------------------------------------------------------

  ---------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                   Значение
                                                                                             сброса
  ---------- ---------- -------- ------------------ -------------------------------------- ----------
   \[31:1\]     Res        RO    Резерв                                                        0

    \[0\]      MODE1      RW0    Флаг сравнения                                                0
                                 значений счета,                                           
                                 запись 0 очищает                                          
                                 флаг, запись 1                                            
                                 делает его                                                
                                 недействительным                                          

                                 1:                 Значение прямого счета достигло        
                                                    значения сравнения                     

                                 0:                 Значение сравнения не было достигнуто  
  ---------------------------------------------------------------------------------------------------

#### 6.5.4.3 Регистр системного счетчика (STK_CNTL) 

Адрес смещения: 0x08

  -----------------------------------------------------------------------------------------
        31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  -------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   CNT\[31:16\]                                                                        

        15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   CNT\[15:0\]                                                                         
  -----------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:0\]     Res        RW    Текущее значение счетчика сравнения 32        0
                                 бита                                      

  -----------------------------------------------------------------------------------

#### 6.5.4.4 Регистр сравнения счета (STK_CMPLR) 

Адрес смещения: 0x10

  -----------------------------------------------------------------------------------------
        31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  -------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   CMP\[31:16\]                                                                        

        15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   CMP\[15:0\]                                                                         
  -----------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:0\]     Res        RW    Установка значения для сравнения счетчика     0
                                 32 бита                                   

  -----------------------------------------------------------------------------------

#  Глава 7 Общие входы-выходы (GPIO) и их альтернативные функции (GPIO/AFIO) 

> Порт GPIO может быть сконфигурирован для различных режимов ввода или
> вывода, оснащен встроенными подтягивающими или тянущими резисторами,
> которые могут быть отключены, и может быть настроен для выполнения
> функций типа push-pull или open-drain. Порт GPIO также может
> мультиплексироваться для других функций.

## 7.1 Основные характеристики

> Каждый контакт порта может быть настроен на один из нескольких
> режимов:

-   Floating input (вход с плавающим потенциалом)

-   Open drain output (выход с открытым стоком)

-   Pull-up input (вход с подтяжкой вверх)

-   Push-pull output (выход типа push-pull)

-   Dropdown input (вход с подтягиванием вниз)

-   Multiplexing the inputs and outputs of functions
    (мультиплексирование входов и выходов функций)

> Многие контакты имеют возможность мультиплексирования, и многие другие
> периферийные устройства отображают свои выходные и входные каналы на
> эти контакты. Конкретное использование этих мультиплексированных
> контактов должно определяться индивидуально для каждого периферийного
> устройства, а содержание того, мультиплексируются ли эти контакты и
> переназначаются, объясняется в данной главе.

## 7.2 Описание функций 

### 7.2.1 Обзор 

> Рисунок 7-1 Блок-схема базовой структуры модуля GPIO
>
> ![](media/image11.png){width="5.833333333333333in"
> height="3.4631944444444445in"}
>
> *Примечание: (1) VDDx --- это VDD, когда GPIO работает в нормальном
> режиме ввода-вывода, и VDDx --- это VDD_FT, когда GPIO используется в
> режиме FT.*
>
> Как показано на рисунке 7-1 структура порта ввода-вывода, каждый
> контакт имеет две защитные диоды внутри чипа, и порт ввода-вывода
> может быть разделён на модули драйвера ввода и вывода. Из них драйвер
> ввода имеет опциональные слабые подтягивающие и тянущие резисторы,
> которые могут быть подключены к АЦП и другим аналоговым периферийным
> устройствам; если ввод осуществляется на цифровое периферийное
> устройство, то он должен пройти через триггер Шмитта TTL, а затем
> подключиться к регистрам ввода GPIO или другим мультиплексированным
> периферийным устройствам. Драйвер вывода имеет пару МОП-транзисторов,
> и порт ввода-вывода можно настроить на открытый сток или выходной
> сигнал типа push-pull путём настройки того, включены ли верхний и
> нижний МОП-транзисторы; драйвер вывода также может быть настроен
> внутри для управления выводом через GPIO или другие
> мультиплексированные периферийные устройства.

### 7.2.2 Функция инициализации GPIO 

Сразу после сброса порты GPIO работают в начальном состоянии, при
котором большинство портов ввода-вывода находятся в состоянии плавающего
ввода, но существуют также связанные с периферией выводы, такие как HSE,
работающие на функции мультиплексирования периферии. За конкретной
информацией об инициализации обратитесь к главе, связанной с описанием
выводов.

### 7.2.3 Внешние прерывания 

> Все порты GPIO могут быть настроены с внешними каналами ввода
> прерываний, но один внешний канал ввода прерываний может быть
> сопоставлен максимум с одним контактом GPIO, и номер последовательного
> порта внешнего прерывания должен совпадать с номером бита порта GPIO.
> Например, PA1 (или PC1, PD1 и т.д.) может быть сопоставлено только с
> EXTI1, и EXTI1 может принимать только один из PA1, PC1 или PD1 и так
> далее. Отображение обеих сторон является взаимно однозначным.

### 7.2.4 Функции мультиплексирования 

Важно отметить следующее при использовании функции мультиплексирования:

-   Для использования функции мультиплексирования в направлении ввода
    порт должен быть настроен в мультиплексированный режим ввода, а
    настройка подтягивания может быть установлена в соответствии с
    фактическими потребностями.

-   Для использования функции мультиплексирования в направлении вывода
    порт должен быть настроен в мультиплексированный режим вывода, и
    можно выбрать тип push-pull или open-drain в зависимости от реальной
    ситуации.

-   В случае двунаправленного мультиплексирования порт должен быть
    настроен в режим мультиплексированного вывода, а драйвер --- в режим
    плавающего ввода.

Один и тот же порт ввода-вывода может иметь несколько периферийных
устройств, мультиплексируемых на этот контакт, поэтому для максимального
увеличения пространства для каждой периферии мультиплексированные
контакты периферийных устройств могут быть переназначены на другие
контакты в дополнение к контактам по умолчанию, избегая занятых
контактов.

### 7.2.5 Механизм блокировки (

### Locking Mechanism)

> Механизм блокировки фиксирует конфигурацию порта ввода-вывода. После
> определенной последовательности записи конфигурация выбранного
> контакта ввода-вывода будет заблокирована и не сможет изменяться до
> следующего сброса.

### 7.2.6 Настройка входа 

> Рисунок 7-2 Блок-схема структуры конфигурации ввода модуля GPIO
>
> ![](media/image12.png){width="5.2131944444444445in"
> height="2.870138888888889in"}

Когда порт ввода-вывода настроен в режим ввода, выходной драйвер
отключается, подтягивание и опускание ввода выбираются, и никакие
мультиплексированные функции или аналоговые входы не подключаются.
Данные на каждом порту ввода-вывода собираются в регистр данных ввода на
каждом такте HB, и уровень сигнала соответствующего контакта
определяется чтением соответствующего бита регистра данных ввода.

### 7.2.7 Конфигурация выхода 

> Рисунок 7-3 Блок-схема структуры конфигурации вывода модуля GPIO
>
> ![](media/image13.png){width="5.305555555555555in"
> height="2.9444444444444446in"}
>
> Когда порт ввода-вывода настроен на режим вывода, пара
> МОП-транзисторов в выходном драйвере может быть настроена на режим
> push-pull или open-drain в зависимости от необходимости, без
> использования функции мультиплексирования. Подтягивающие и тянущие
> резисторы драйвера ввода отключаются, активируется триггер Шмитта TTL,
> и уровни, появляющиеся на контактах ввода-вывода, будут собираться в
> регистры данных ввода на каждом такте HB. Таким образом, чтение
> регистров данных ввода даст состояние ввода-вывода, а в режиме вывода
> push-pull доступ к регистрам данных вывода даст последнее записанное
> значение.

### 7.2.8 Конфигурация функции мультиплексирования 

> Рисунок 7-4 Структура модуля GPIO при его мультиплексировании другой
> периферией
>
> ![](media/image14.png){width="5.305555555555555in"
> height="2.9444444444444446in"}
>
> При включении мультиплексирования включается выходной драйвер, который
> может быть настроен на режим открытого стока или push-pull в
> зависимости от требований, включается триггер Шмитта, соединяются
> линии ввода и вывода функции мультиплексирования, но отключаются
> регистры выходных данных, и уровни, появляющиеся на контактах
> ввода-вывода, будут собираться в регистры данных ввода на каждом такте
> HB. В режиме открытого стока чтение регистра данных ввода даст текущее
> состояние порта ввода-вывода; в режиме push-pull чтение регистра
> выходных данных даст последнее записанное значение.

### 7.2.9 Конфигурация аналогового входа 

> Рисунок 7-5 Структура конфигурации модуля GPIO в качестве аналогового
> входа
>
> ![](media/image15.png){width="5.305555555555555in"
> height="2.953472222222222in"}

Когда включен аналоговый вход, буфер вывода отключается, вход триггера
Шмитта в драйвере ввода отключается для предотвращения генерации
потребления на порту ввода-вывода, подтягивающие и тянущие резисторы
отключаются, и регистр чтения входных данных всегда будет содержать 0.

### 7.2.10 Настройки GPIO для периферийных устройств

> В следующей таблице рекомендуются соответствующие конфигурации порта
> GPIO для каждого контакта периферийного устройства.

Таблица 7-1. Таймер управления с расширенными функциями (TIM1)

  --------------------------------------------------------------------------
   Пин TIM1   Конфигурация                    GPIO конфигурация
  ----------- ------------------------------- ------------------------------
   TIM1_CHx   Канал x захват входа (Input     Плавающий вход (Floating
              Capture)                        Input)

              Канал x выход сравнения (Output Мультиплексированные выходы с
              Compare)                        push-pull конфигурацией

   TIM1_CHxN  Комплиментарный выход канала x  Мультиплексированные выходы с
                                              push-pull конфигурацией

   TIM1_BKIN  Прерывающий вход (Brake Input)  Плавающий вход (Floating
                                              Input)

   TIM1_ETR   Внешние активируемый вход       Плавающий вход (Floating
              тактирования                    Input)
  --------------------------------------------------------------------------

Таблица 7-2 Универсальный таймер (TIM2)Начало формы

  -------------------------------------------------------------------------
   Пин TIM2  Конфигурация                    GPIO конфигурация
  ---------- ------------------------------- ------------------------------
   TIM2_CHx  Канал x захват входа (Input     Плавающий вход (Floating
             Capture)                        Input)

             Канал x выход сравнения (Output Мультиплексированные выходы с
             Compare)                        push-pull конфигурацией

   TIM1_ETR  Внешние активируемый вход       Плавающий вход (Floating
             тактирования                    Input)
  -------------------------------------------------------------------------

Таблица 7-3 Универсальный синхронно-асинхронный приемопередатчик
(USART)Начало формы

+----------+----------------------------+-----------------------------+
| Пин      | Конфигурация               | GPIO конфигурация           |
| USART    |                            |                             |
+:========:+:===========================+:============================+
| U        | Полнодуплексный режим      | Мультиплексированные выходы |
| SARTx_TX | (Full duplex)              | с push-pull конфигурацией   |
|          |                            |                             |
|          |                            | Начало формы                |
|          |                            |                             |
|          |                            | Конец формы                 |
+----------+----------------------------+-----------------------------+
|          | Полудуплексный режим       | Мультиплексированные выходы |
|          | (Half-duplex)              | с открытым стоком           |
|          |                            |                             |
|          |                            | Начало формы                |
|          |                            |                             |
|          |                            | Конец формы                 |
+----------+----------------------------+-----------------------------+
| U        | Полнодуплексный режим      | Плавающий вход или вход с   |
| SARTx_RX | (Full duplex)              | подтягивающим резистором    |
|          |                            |                             |
|          |                            | Начало формы                |
|          |                            |                             |
|          |                            | Конец формы                 |
+----------+----------------------------+-----------------------------+
|          | Полудуплексный режим       | Не используется             |
|          | (Half-duplex)              |                             |
+----------+----------------------------+-----------------------------+
| U        | Синхронный режим           | Мультиплексированный выход  |
| SARTx_CK |                            | с push-pull конфигурацией   |
+----------+----------------------------+-----------------------------+
| US       | Управление потоком данных  | Мультиплексированный выход  |
| ARTx_RTS | с помощью сигнала RTS      | с push-pull конфигурацией   |
|          | (Request to Send)          |                             |
+----------+----------------------------+-----------------------------+
| US       | Управление потоком данных  | Плавающий вход или вход с   |
| ARTx_CTS | с помощью сигнала CTS      | подтягивающим резистором    |
|          | (Clear to Send)            |                             |
|          |                            | Начало формы                |
|          |                            |                             |
|          |                            | Конец формы                 |
+----------+----------------------------+-----------------------------+

Таблица 7-4 Модули последовательного периферийного интерфейса (SPI)

+----------+-----------------------------+-----------------------------+
| Пин SPI  | Конфигурация                | GPIO конфигурация           |
+:========:+:============================+:============================+
| SPIx_SCK | Режим мастера               | Мультиплексированный выход  |
|          |                             | с push-pull конфигурацией   |
+----------+-----------------------------+-----------------------------+
|          | Режим слейва                | Плавающий вход (Floating    |
|          |                             | Input)                      |
+----------+-----------------------------+-----------------------------+
| S        | Полнодуплексный режим       | Мультиплексированный выход  |
| PIx_MOSI | мастера                     | с push-pull конфигурацией   |
+----------+-----------------------------+-----------------------------+
|          | Полнодуплексный режим       | Плавающий вход или вход с   |
|          | слейва                      | подтягивающим резистором    |
|          |                             |                             |
|          |                             | Начало формы                |
|          |                             |                             |
|          |                             | Конец формы                 |
+----------+-----------------------------+-----------------------------+
|          | Простая двунаправленная     | Мультиплексированные выходы |
|          | линия данных/ режим мастера | с push-pull конфигурацией   |
|          |                             |                             |
|          |                             | Начало формы                |
|          |                             |                             |
|          |                             | Конец формы                 |
+----------+-----------------------------+-----------------------------+
|          | Простая двунаправленная     | Не используется             |
|          | линия данных/ режим слейва  |                             |
+----------+-----------------------------+-----------------------------+
| S        | Полнодуплексный режим       | Плавающий вход или вход с   |
| PIx_MISO | мастера                     | подтягивающим резистором    |
|          |                             |                             |
|          |                             | Начало формы                |
|          |                             |                             |
|          |                             | Конец формы                 |
+----------+-----------------------------+-----------------------------+
|          | Полнодуплексный режим       | Мультиплексированный выход  |
|          | слейва                      | с push-pull конфигурацией   |
+----------+-----------------------------+-----------------------------+
|          | Простая двунаправленная     | Не используется             |
|          | линия данных/ режим мастера |                             |
+----------+-----------------------------+-----------------------------+
|          | Простая двунаправленная     | Мультиплексированный выход  |
|          | линия данных/ режим слейва  | с push-pull конфигурацией   |
+----------+-----------------------------+-----------------------------+
| SPIx_NSS | Аппаратный режим мастера    | Вход с плавающим            |
|          | или слейва                  | состоянием, подтяжкой к     |
|          |                             | питанию или к земле         |
+----------+-----------------------------+-----------------------------+
|          | Аппаратный режим мастера/   | Мультиплексированный выход  |
|          | Режим включения вывода NSS  | с push-pull конфигурацией   |
+----------+-----------------------------+-----------------------------+
|          | Программный режим           | Не используется             |
+----------+-----------------------------+-----------------------------+

Таблица 7-5 Модуль внутренней интегрированной шины (I2C)

  -----------------------------------------------------------------------
  Пин SPI    Конфигурация                  GPIO конфигурация
  ---------- ----------------------------- ------------------------------
  I2C_SCL    Выход тактового синхросигнала Выход с открытым стоком
             шины I2C                      (open-drain)

  I2C_SDA    Выход данных шины I2C         Выход с открытым стоком
                                           (open-drain)
  -----------------------------------------------------------------------

Таблица 7-6 Аналого-цифровые преобразователи (ADC)

  -----------------------------------------------------------------------
   Пин ADC   GPIO конфигурация
  ---------- ------------------------------------------------------------
     ADC     Аналоговый вход

  -----------------------------------------------------------------------

Таблица 7-7 Другие настройки функций ввода/вывода

  -----------------------------------------------------------------------
     Пины    Возможные конфигурации        GPIO конфигурация
  ---------- ----------------------------- ------------------------------
     MCO     Выход тактовых импульсов      Мультиплексированный выход с
                                           push-pull конфигурацией

     EXTI    Вход внешних прерываний       Вход с плавающим состоянием,
                                           подтяжкой к питанию или к
                                           земле

     OPA     Вход операционного усилителя  Плавающий вход (Floating
                                           Input)
  -----------------------------------------------------------------------

### 7.2.11 Конфигурация альтернативных функций GPIOНачало формы

###  7.2.11.1 Timer Alternate Function Remapping 

Таблица 7-8 Переназначение альтернативных функций TIM1

  -------------------------------------------------------------------------
  Alternate\      TIM1_RM=00     TIM1_RM=01     TIM1_RM=10    TIM1_RM=11\
  function         Default        Partial        Partial      Full mapping
                   mapping        mapping        mapping     
  ------------- -------------- -------------- -------------- --------------
  TIM1_ETR           PC5            PC5            PD4            PC2

  TIM1_CH1           PD2            PC6            PD2            PC4

  TIM1_CH2           PA1            PC7            PA1            PC7

  TIM1_CH3           PC3            PC0            PC3            PC5

  TIM1_CH4           PC4            PD3            PC4            PD4

  TIM1_BKIN          PC2            PC1            PC2            PC1

  TIM1_CH1N          PD0            PC3            PD0            PC3

  TIM1_CH2N          PA2            PC4            PA2            PD2

  TIM1_CH3N          PD1            PD1            PD1            PC6
  -------------------------------------------------------------------------

*Примечание: Для функции отображения TIM1_CH1 в таблице условие
следующее: TIM1_1_RM=0. Когда TIM1_1_RM=1, TIM1_CH1 отображается на LSI
(для калибровки LSI).*

Таблица 7-9 Переназначение альтернативных функций TIM2

  -------------------------------------------------------------------------
  Alternate\      TIM2_RM=00     TIM2_RM=01     TIM2_RM=10    TIM2_RM=11\
  function         Default        Partial        Partial      Full mapping
                   mapping        mapping        mapping     
  ------------- -------------- -------------- -------------- --------------
  TIM2_ETR           PD4            PC5            PC1            PC1

  TIM2_CH1           PD4            PC5            PC1            PC1

  TIM2_CH2           PD3            PC2            PD3            PC7

  TIM2_CH3           PC0            PD2            PC0            PD6

  TIM2_CH4           PD7            PC1            PD7            PD5
  -------------------------------------------------------------------------

Начало формы

#### 7.2.11.2 Переназначение альтернативных функций USART

Таблица 7-10 Переназначение альтернативных функций USART1

  -------------------------------------------------------------------------
  Alternate\    USART1_RM=00   USART1_RM=01   USART1_RM=10   USART1_RM=11\
  function        Default        Partial        Partial      Full mapping
                  mapping        mapping        mapping     
  ------------ -------------- -------------- -------------- ---------------
  USART1_CK         PD4            PD7            PD7             PC5

  USART1_TX         PD5            PD0            PD6             PC0

  USART1_RX         PD6            PD1            PD5             PC1

  USART1_CTS        PD3            PC3            PC6             PC6

  USART1_RTS        PC2            PC2            PC7             PC7
  -------------------------------------------------------------------------

Начало формы

####  7.2.11.3 Переназначение альтернативных функций SPIНачало формы

Таблица 7-11 Переназначение альтернативных функций SPI

  ------------------------------------------------------------------------
  Альтернативная функция    SPI1_RM=0 Default       SPI1_RM=1 Remapping
                                 mapping          
  ---------------------- ------------------------ ------------------------
  SPI1_NSS                         PC1                      PC0

  SPI1_SCK                         PC5                      PC5

  SPI1_MISO                        PC7                      PC7

  SPI1_MOSI                        PC6                      PC6
  ------------------------------------------------------------------------

#### 7.2.11.4 Переназначение альтернативных функций I2C

Таблица 7-12 Переназначение альтернативных функций I2C

  -------------------------------------------------------------------------
  Альтернативная   I2C1_RM=00 Default    I2C1_RM=01\        I2C1_RM=1x\
  функция               mapping           Remapping          Remapping
  ---------------- ------------------ ------------------ ------------------
  I2C1_SCL                PC2                PD1                PC5

  I2C1_SDA                PC1                PD0                PC6
  -------------------------------------------------------------------------

#### 7.2.11.4 Переназначение альтернативных функций ADC 

Таблица 7-13 Переназначение альтернативных функций внешнего триггерного
запуска преобразования АЦП

  ----------------------------------------------------------------------------
  Альтернативная функция                  ADC_ETRGINJ_RM=0   ADC_ETRGINJ_RM=1
                                          Default mapping       Remapping
  -------------------------------------- ------------------ ------------------
  Внешний триггерный запуск                     PD1                PA1
  преобразования АЦП                                        

  ----------------------------------------------------------------------------

Таблица 7-14 Переназначение альтернативных функций внешнего триггерного
правила преобразования АЦП

  ----------------------------------------------------------------------------
  Альтернативная функция                  ADC_ETRGINJ_RM=0   ADC_ETRGREG_RM=1
                                          Default mapping       Remapping
  -------------------------------------- ------------------ ------------------
  Внешнее правило триггерного                   PD3                PC2
  преобразования АЦП                                        

  ----------------------------------------------------------------------------

## 7.3 Описание регистров

### 7.3.1 Описание регистров GPIO

> Если не указано иное, регистры GPIO должны оперировать словами
> (выполнять операции с этими регистрами с использованием 32 бит).

Таблица 7-8 Список регистров, связанных с GPIO

+----------------+---------+--------------------------------+---------+
| **             | **      | **Описание**                   | **З     |
| Наименование** | Адрес** |                                | начение |
|                |         |                                | с       |
|                |         |                                | броса** |
+:===============+:=======:+:===============================+:=======:+
| R              | 0x4     | Регистр конфигурации порта PA  | 0x4     |
| 32_GPIOA_CFGLR | 0010800 | младший                        | 4444444 |
+----------------+---------+--------------------------------+---------+
| R              | 0x4     | Регистр конфигурации порта PC  | 0x4     |
| 32_GPIOC_CFGLR | 0011000 | младший                        | 4444444 |
+----------------+---------+--------------------------------+---------+
| R              | 0x4     | Регистр конфигурации порта PD  | 0x4     |
| 32_GPIOD_CFGLR | 0011400 | младший                        | 4444444 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOA_INDR | 0x4     | Регистр приема данных порта PA | 0x0     |
|                | 0010808 |                                | 00000XX |
+----------------+---------+--------------------------------+---------+
| R32_GPIOC_INDR | 0x4     | Регистр приема данных порта PC | 0x0     |
|                | 0011008 |                                | 00000XX |
+----------------+---------+--------------------------------+---------+
| R32_GPIOD_INDR | 0x4     | Регистр приема данных порта PD | 0x0     |
|                | 0011408 |                                | 00000XX |
+----------------+---------+--------------------------------+---------+
| R              | 0x4     | Регистр передачи данных в порт | 0x0     |
| 32_GPIOA_OUTDR | 001080C | PAНачало формы                 | 0000000 |
|                |         |                                |         |
|                |         | Конец формы                    |         |
+----------------+---------+--------------------------------+---------+
| R              | 0x4     | Регистр передачи данных в порт | 0x0     |
| 32_GPIOC_OUTDR | 001100C | PCНачало формы                 | 0000000 |
|                |         |                                |         |
|                |         | Конец формы                    |         |
+----------------+---------+--------------------------------+---------+
| R              | 0x4     | Регистр передачи данных в порт | 0x0     |
| 32_GPIOD_OUTDR | 001140C | PD                             | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOA_BSHR | 0x4     | Регистр установки/сброса порта | 0x0     |
|                | 0010810 | PA                             | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOC_BSHR | 0x4     | Регистр установки/сброса порта | 0x0     |
|                | 0011010 | PC                             | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOD_BSHR | 0x4     | Регистр установки/сброса порта | 0x0     |
|                | 0011410 | PDНачало формы                 | 0000000 |
|                |         |                                |         |
|                |         | Конец формы                    |         |
+----------------+---------+--------------------------------+---------+
| R32_GPIOA_BCR  | 0x4     | Регистр сброса порта PA        | 0x0     |
|                | 0010814 |                                | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOC_BCR  | 0x4     | Регистр сброса порта PCНачало  | 0x0     |
|                | 0011014 | формы                          | 0000000 |
|                |         |                                |         |
|                |         | Конец формы                    |         |
+----------------+---------+--------------------------------+---------+
| R32_GPIOD_BCR  | 0x4     | Регистр сброса порта PD        | 0x0     |
|                | 0011414 |                                | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOA_LCKR | 0x4     | Регистр блокировки             | 0x0     |
|                | 0010818 | конфигурации порта PA          | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOC_LCKR | 0x4     | Регистр блокировки             | 0x0     |
|                | 0011018 | конфигурации порта PC          | 0000000 |
+----------------+---------+--------------------------------+---------+
| R32_GPIOD_LCKR | 0x4     | Регистр блокировки             | 0x0     |
|                | 0011418 | конфигурации порта PDНачало    | 0000000 |
|                |         | формы                          |         |
|                |         |                                |         |
|                |         | Конец формы                    |         |
+----------------+---------+--------------------------------+---------+

#### 7.3.1.1 Младший регистр конфигурации порта (GPIOx_CFGLR) (x=A/C/D)

Смещение адреса: 0x00

Начало формы

  ---------------------------------------------------------------------------------------------------
    31    30    29     28    27    26    25     24    23    22    21     20    19    18    17     16
  ------ ---- ------- ---- ------ ---- ------- ---- ------ ---- ------- ---- ------ ---- ------- ----
   CNF7        MODE7        CNF6        MODE6        CNF5        MODE5        CNF4        MODE4  

    15    14    13     12    11    10     9     8     7     6      5     4     3     2      1     0

   CNF3        MODE3        CNF2        MODE2        CNF1        MODE1        CNF0        MODE0  
  ---------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                                 Значение
                                                                                               сброса
  ----------- ------------- -------- ------------------ ------------------------------------ ----------
   \[31:30\]   CNFy\[1:0\]     RW    (y=0-7), биты                                              01b
                                     конфигурации для                                        
                                     порта x,                                                
                                     посредством                                             
                                     которых                                                 
                                     соответствующий                                         
                                     порт                                                    
                                     конфигурируется.                                        
                                     Когда находится в                                       
                                     режиме ввода                                            
                                     (MODE=00b)                                              

   \[27:26\]                         00:                Режим аналогового входа              

                                     01:                Высокоимпендансный вход              

   \[23:22\]                         10:                С подтяжкой к плюсу или нулю         

                                     11:                Зарезервировано                      

   \[19:18\]                         В режиме ввода при                                      
                                     MODE\>00b                                               

   \[15:14\]                         00:                Универсальный режим выхода с         
                                                        подтяжкой                            

   \[11:10\]                         01:                Универсальный режим выхода с         
                                                        открытым коллектором                 

    \[7:6\]                          10:                Ружим мультиплексированного выхода с 
                                                        push-pull                            

    \[3:2\]                          11:                Ружим мультиплексированного выхода с 
                                                        открытым коллектором                 

    \[29:28   MODEy \[1:0\]    RW    (y=0-7), выбор                                             00b
                                     режима работы                                           
                                     порта X                                                 
                                     осуществляется                                          
                                     настройкой                                              
                                     соответствующих                                         
                                     битов                                                   
                                     конфигурации. Эти                                       
                                     биты позволяют                                          
                                     сконфигурировать                                        
                                     соответствующий                                         
                                     порт.                                                   

   \[25:24\]                                                                                 

   \[21:20\]                                                                                 

   \[17:16\]                                                                                 

   \[13:12\]                         00:                Режим входа                          

    \[9:8\]                          01:                Режим выхода, максимальная скорость  
                                                        10 МГц                               

    \[5:4\]                          10:                Режим выхода, максимальная скорость  
                                                        2 МГц                                

    \[1:0\]                          11:                Режим выхода, максимальная скорость  
                                                        30 МГц                               
  -----------------------------------------------------------------------------------------------------

**\
7.3.1.2 Регистр ввода порта (GPIOx_INDR) (x=A/C/D)**

Смещение адреса: 0x08

  ---------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24    23     22     21     20     19     18     17     16
  -------- ---- ---- ---- ---- ---- ---- ---- ------ ------ ------ ------ ------ ------ ------ ------
   Резерв                                                                                      

     15     14   13   12   11   10   9    8     7      6      5      4      3      2      1      0

   Резерв                                      IDR7   IDR6   IDR5   IDR4   IDR3   IDR2   IDR1   IDR0
  ---------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:8\]     Res        RO    Резерв                                        0

   \[7:0\]      IDRy       RO    (y=0-7) --- это данные ввода порта. Эти       X
                                 биты доступны только для чтения и могут   
                                 быть прочитаны только в 16-битной форме.  
                                 Чтение этих значений представляет собой   
                                 высокий и низкий уровни соответствующего  
                                 бита.                                     
  -----------------------------------------------------------------------------------

**7.3.1.3 Регистр вывода порта (GPIOx_OUTDR) (x=A/C/D)**

**Начало формы**

Смещение адреса: 0x0С

  ---------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24    23     22     21     20     19     18     17     16
  -------- ---- ---- ---- ---- ---- ---- ---- ------ ------ ------ ------ ------ ------ ------ ------
   Резерв                                                                                      

     15     14   13   12   11   10   9    8     7      6      5      4      3      2      1      0

   Резерв                                      ODR7   ODR6   ODR5   ODR4   ODR3   ODR2   ODR1   ODR0
  ---------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                Значение
                                                                                          сброса
  ---------- ---------- -------- --------------- -------------------------------------- ----------
   \[31:8\]     Res        RO    Резерв                                                     0

   \[7:0\]      IDRy       RO    (y=0-7) --- это                                            0
                                 данные,                                                
                                 выводимые                                              
                                 портом. Эти                                            
                                 данные могут                                           
                                 оперироваться                                          
                                 только в                                               
                                 16-битной                                              
                                 форме. Порт                                            
                                 вывода передает                                        
                                 значения этих                                          
                                 регистров                                              
                                 наружу.\                                               
                                 Для режимов с                                          
                                 входами с                                              
                                 подтяжкой вниз.                                        

                                 0:              Вход с подтяжкой к нулю                

                                 1:              Вход с подтяжкой к плюсу               
  ------------------------------------------------------------------------------------------------

**7.3.1.4 Регистр сброса/установки порта (GPIOx_BSHR) (x=A/C/D)**

Смещение адреса: 0x10

  -------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                      BR7   BR6   BR5   BR4   BR3   BR2   BR1   BR0

     15     14   13   12   11   10   9    8     7     6     5     4     3     2     1     0

   Резерв                                      BS7   BS6   BS5   BS4   BS3   BS2   BS1   BS0
  -------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                  Значение
                                                                             сброса
  ----------- ---------- -------- ---------------------------------------- ----------
   \[31:24\]     Res        RO    Резерв                                       0

   \[23:16\]     BRy        WO    (y=0-7), соответствующие                      
                                  биты OUTDR очищаются для этих бит        
                                  местоположения, и запись нуля не         
                                  оказывает никакого эффекта. К этим битам 
                                  можно получить доступ только в 16-битной 
                                  форме. Если оба                          
                                  бита BR и BS установлены, действует      
                                  бит BS.                                  

   \[31:24\]     Res        RO    Резерв                                       0

    \[7:0\]      Bsy        WO    (y=0-7), для которых биты местоположения      
                                  установят соответствующие биты OUTDR в   
                                  указанное положение, запись нуля не      
                                  окажет никакого эффекта. Доступ к этим   
                                  битам возможен только в 16-битной форме. 
                                  Если оба бита BR и BS установлены,       
                                  действует бит BS.                        
  -----------------------------------------------------------------------------------

**7.3.1.5 Регистр сброса порта (GPIOx_BCR) (x=A/C/D)**

Смещение адреса: 0x14

  -------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23    22    21    20    19    18    17    16
  -------- ---- ---- ---- ---- ---- ---- ---- ----- ----- ----- ----- ----- ----- ----- -----
   Резерв                                                                               

     15     14   13   12   11   10   9    8     7     6     5     4     3     2     1     0

   Резерв                                      BR7   BR6   BR5   BR4   BR3   BR2   BR1   BR0
  -------------------------------------------------------------------------------------------

**Начало формы**

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:8\]     Res        RO    Резерв                                        0

   \[7:0\]      Bry        WO    (y=0-7), соответствующие биты OUTDR           0
                                 сбрасываются для этих бит местоположения, 
                                 и запись нуля не оказывает никакого       
                                 эффекта. Доступ к этим битам возможен     
                                 только в 16-битной форме.                 
  -----------------------------------------------------------------------------------

**7.3.1.6 Регистр блокировки конфигурации порта (GPIOx_LCKR) (x=A/C/D)**

Смещение адреса: 0x18

  -----------------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25    24     23     22     21     20     19     18     17     16
  -------- ---- ---- ---- ---- ---- ---- ------ ------ ------ ------ ------ ------ ------ ------ ------
   Резерв                                                                                        

     15     14   13   12   11   10   9     8      7      6      5      4      3      2      1      0

   Резерв                                 LCKK   LCK7   LCK6   LCK5   LCK4   LCK3   LCK2   LCK1   LCK0
  -----------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                   Значение
                                                                             сброса
  ---------- ---------- -------- ----------------------------------------- ----------
   \[31:9\]     Res        RO    Резерв                                        0

    \[8\]       LCKK       RW    Ключ блокировки, который может быть           0
                                 записан в определенной последовательности 
                                 для блокировки, но он может быть считан в 
                                 любое время. Он читается как 0 когда      
                                 блокировка не активна, и 1, когда         
                                 блокировка активна. Последовательность    
                                 записи ключа блокировки следующая:\       
                                 -записать 1\                              
                                 - записать 0\                             
                                 - записать 1\                             
                                 - считать 0\                              
                                 - считать 1.\                             
                                 Последний шаг не является обязательным,   
                                 но может использоваться для подтверждения 
                                 активности ключа блокировки. Любая ошибка 
                                 при записи последовательности не позволит 
                                 активировать блокировку, и значение       
                                 LCK\[7:0\] не может быть изменено во      
                                 время записи последовательности. После    
                                 активации блокировки конфигурация порта   
                                 может быть изменена только после          
                                 следующего сброса.                        

   \[7:0\]      LCKy       RW    (y=0-7), эти биты устанавливаются в 1 для     0
                                 указания блокировки конфигурации          
                                 соответствующего порта. Эти биты могут    
                                 быть изменены только до разблокировки     
                                 LCKK. Заблокированная конфигурация        
                                 относится к регистрам конфигурации        
                                 GPIOx_CFGLR.                              
  -----------------------------------------------------------------------------------

### 7.3.2 Описание регистров AFIO

> Если не указано иное, регистры AFIO должны оперировать словами
> (выполнять операции с этими регистрами с использованием 32 бит)
>
> Table 7-9 List of AFIO-related registers

  ----------------------------------------------------------------------------
  **Наименование**   **Адрес**    **Описание**                    **Значение
                                                                  сброса**
  ------------------ ------------ ------------------------------- ------------
  R32_AFIO_PCFR1     0x40010004   Remap Register 1                0x00000000

  R32_AFIO_EXTICR    0x40010008   External interrupt              0x00000001
                                  configuration register 1        
  ----------------------------------------------------------------------------

**7.3.2.1 Регистр переназначения 1 (AFIO_PCFR1)**

Смещение адреса: 0x00

  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
     31        30     29   28   27   26                    25      24     23                   22                21                    20             19   18                   17                    16             
  --------- -------- ---- ---- ---- ---- -------------- --------- ---- --------- ------------- ---- ------------ -------- ------------ ---- -------- ---- ---- ---------------- ---- ---------------- ---- --------- --
   Резерв                                 SWCFG\[2:0\]                           TIM1_IREMAP        I2C1REMAP1            USART1_RM1         Резерв            ADC_ETRGREG_R\        ADC_ETRGINJ_R\        Рез.      
                                                                                                                                                               M                     M                               

     15        14     13   12   11   10                     9      8       7                   6                 5                     4              3    2                    1                     0              

   PA12_RM   Резерв                                      TIM2_RM        TIM1_RM                                  Резерв                                        USART1_RM             I2C1_RM               SPI1_RM   
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------------
      Бит         Название      Доступ  Описание                                                Значение
                                                                                                 сброса
  ----------- ---------------- -------- --------------------- -------------------------------- ----------
   \[31:9\]         Res           RO    Резерв                                                     0

   \[26:24\]   SWCFG \[2:0\]      RW    Эти биты используются                                      0
                                        для настройки портов                                   
                                        ввода-вывода для                                       
                                        функций SW и                                           
                                        трассировки. SWD                                       
                                        (SDI) --- это                                          
                                        интерфейс отладки для                                  
                                        доступа к ядру. Он                                     
                                        всегда используется в                                  
                                        качестве порта SWD                                     
                                        после системного                                       
                                        сброса.                                                

                                        0xx:                  SWD (SDI) включен                

                                        100:                  Отключить SWD (SDI), пин будет   
                                                              функционировать как GPIO         

                                        другие: не верно                                       

    \[23\]      TIM1_IREMAP       RW    Управление выбором                                         0
                                        канала 1 таймера 1.                                    

                                        0:                    Выбрать внешние пины             

                                        1:                    Выбрать внутренние импульсы LSI  

    \[22\]       I2C1REMAP1       RW    Бит высокого уровня                                        0
                                        переназначения I2C1                                    
                                        (используется                                          
                                        совместно с битом 1                                    
                                        регистра AFIO_PCFR1                                    
                                        I2C1_RM \[22,1\]).                                     

                                        00:                   карта по умолчанию (SCL/PC2,     
                                                              SDA/PC1).                        

                                        01:                   Переназначение (SCL/PD1,         
                                                              SDA/PD0).                        

                                        1x:                   Переназначение (SCL/PC5,         
                                                              SDA/PC6)                         

    \[21\]       USART1_RM1       RW    Конфигурация высокого                                      0
                                        уровня переназначения                                  
                                        USART1 (используется                                   
                                        вместе с битом 2                                       
                                        регистра AFIO PCFR1                                    
                                        USART1RM \[21,2\]).                                    

                                        00:                   По умолчанию (CK/PD4, TX/PD5,    
                                                              RX/PD6, CTS/PD3, RTS/PC2).       

                                        01:                   Переназначение (CK/PD7, TX/PD0,  
                                                              RX/PD1, CTS/PC3, RTS/PC2,        
                                                              SW_RX/PD0).                      

                                        10:                   Переназначение (CK/PD7, TX/PD6,  
                                                              RX/PD5,\                         
                                                              CTS/PC6, RTS/PC7, SW_RX/PD6)     

                                        11:                   Переназначение (CK/PC5, TX/PC0,  
                                                              RX/PC1, CTS/PC6, RTS/PC7,        
                                                              SW_RX/PC0)                       

   \[20:19\]        Res           RO    Резерв                                                     0

    \[18\]     ADC_ETRGREG_R\     RW    Бит переназначения                                         0
                     M                  для правила                                            
                                        преобразования                                         
                                        внешнего триггера                                      
                                        АЦП.                                                   

                                        0:                    Правило преобразования внешнего  
                                                              триггера АЦП подключено к PD3    

                                        1:                    Правило преобразования внешнего  
                                                              триггера АЦП подключено к PC2    

    \[17\]     ADC_ETRGINJ_RM     RW    Бит переназначения                                         0
                                        для правила                                            
                                        преобразования                                         
                                        внешнего триггера                                      
                                        АЦП.                                                   

                                        0:                    Правило преобразования внешнего  
                                                              триггера АЦП подключено к PD3    

                                        1:                    Правило преобразования внешнего  
                                                              триггера АЦП подключено к PC2    

    \[16\]          Res           RO    Резерв                                                     0

    \[15\]        PA12_RM         RW    Бит переназначения                                         0
                                        контактов PA1 и PA2,                                   
                                        этот бит может быть                                    
                                        прочитан или записан                                   
                                        пользователем. Он                                      
                                        контролирует                                           
                                        правильную работу PA1                                  
                                        и PA2 (установлен в                                    
                                        1, когда подключен к                                   
                                        контакту внешней                                       
                                        кварцевой цепи).                                       

                                        0:                    Контакт используется как GPIO и  
                                                              мультиплексируемую функцию.      

                                        1:                    Отсутствие функциональной роли   
                                                              для контактов.                   

   \[14:10\]        Res           RO    Резерв                                                     0

    \[9:8\]   TIM2_RM \[1:0\]     RW    Биты переназначения                                        0
                                        для таймера 2. Эти                                     
                                        биты могут быть                                        
                                        прочитаны и записаны                                   
                                        пользователем. Они                                     
                                        контролируют                                           
                                        отображение каналов                                    
                                        таймера 2 с 1 по 4 и                                   
                                        внешнего триггера                                      
                                        (ETR) на портах GPIO.                                  

                                        00:                   По умолчанию (CH1/ETR/PD4,       
                                                              CH2/PD3,\                        
                                                              CH3/PC0, CH4/PD7)                

                                        01:                   Переназначение (CH1/ETR/PC5,     
                                                              CH2/PC2,\                        
                                                              CH3/PD2, CH4/PC1)                

                                        10:                   Переназначение (CH1/ETR/PC1,     
                                                              CH2/PD3,\                        
                                                              CH3/PC0, CH4/PD7)                

                                        11:                   Переназначение (CH1/ETR/PC1,\    
                                                              CH2/PC7, CH3/PD6, CH4/PD5)       

    \[7:6\]    TIM1_RM\[1:0\]     RW    Биты переназначения                                        0
                                        для таймера 1. Эти                                     
                                        биты могут быть                                        
                                        прочитаны и записаны                                   
                                        пользователем. Они                                     
                                        контролируют                                           
                                        отображение каналов с                                  
                                        1 по 4, 1N по 3N,                                      
                                        внешний триггер (ETR)                                  
                                        и вход тормоза (BKIN)                                  
                                        таймера 1 на портах                                    
                                        GPIO.                                                  

                                        00:                   По умолчанию (ETR/PC5, CH1/PD2,\ 
                                                              CH2/PA1, CH3/PC3, CH4/PC4,       
                                                              BKIN/PC2,\                       
                                                              CH1N/PD0, CH2N/PA2, CH3N/PD1)    

                                        01:                   Переназначение (ETR/PC5,         
                                                              CH1/PC6,\                        
                                                              CH2/PC7, CH3/PC0, CH4/PD3,       
                                                              BKIN/PC1,\                       
                                                              CH1N/PC3, CH2N/PC4, CH3N/PD1)    

                                        10:                   Переназначение (ETR/PD4,         
                                                              CH1/PD2,\                        
                                                              CH2/PA1, CH3/PC3, CH4/PC4,       
                                                              BKIN/PC2,\                       
                                                              CH1N/PD0, CH2N/PA2, CH3N/PD1)    

                                        11:                   Переназначение (ETR/PC2,         
                                                              CH1/PC4,\                        
                                                              CH2/PC7, CH3/PC5, CH4/PD4,       
                                                              BKIN/PC1,\                       
                                                              CH1N/PC3, CH2N/PD2, CH3N/PC6)    

    \[5:3\]         Res           RO    Резерв                                                     0

     \[2\]       USART1_RM        RW    Низкоуровневый бит                                         0
                                        конфигурации                                           
                                        переназначения USART1                                  
                                        (используется                                          
                                        совместно с битом 21                                   
                                        регистра AFIO PCFR1                                    
                                        USART1REMAP1                                           
                                        \[21,2\]).                                             

                                        00:                   По умолчанию (CK/PD4, TX/PD5,\   
                                                              RX/PD6, CTS/PD3, RTS/PC2)        

                                        01:                   Переназначение (CK/PD7, TX/PD0,  
                                                              RX/PD1,\                         
                                                              CTS/PC3, RTS/PC2, SW_RX/PD0)     

                                        10:                   Переназначение (CK/PD7, TX/PD6,  
                                                              RX/PD5,\                         
                                                              CTS/PC6, RTS/PC7, SW_RX/PD6)     

                                        11:                   Переназначение (CK/PC5, TX/PC0,  
                                                              RX/PC1,\                         
                                                              CTS/PC6, RTS/PC7, SW_RX/PC0)     

     \[1\]        I2C1_RM         RW    Низкоуровневый бит                                         0
                                        переназначения I2C1                                    
                                        (используется                                          
                                        совместно с битом 22                                   
                                        регистра AFIO_PCFR1                                    
                                        I2C1_RM1 \[22,1\]).                                    

                                        00:                   По умолчанию (SCL/PC2, SDA/PC1)  

                                        01:                   Переназначение (SCL/ PD1, SDA/   
                                                              PD0)                             

                                        1x:                   Переназначение (SCL/PC5,         
                                                              SDA/PC6)                         

     \[0\]        SPI1_RM         RW    Переназначение SPI1.                                       0
                                        Этот бит может быть                                    
                                        прочитан или записан                                   
                                        пользователем. Он                                      
                                        контролирует                                           
                                        отображение функций                                    
                                        мультиплексирования                                    
                                        NSS, SCK, MISO и MOSI                                  
                                        интерфейса SPI1 на                                     
                                        порты GPIO.                                            

                                        0:                    По умолчанию (NSS/PC1, CK/PC5,\  
                                                              MISO/PC7, MOSI/PC6)              

                                        1:                    Переназначение (NSS/PC0, CK/PC5, 
                                                              MISO/PC7,\                       
                                                              MOSI/PC6)                        
  -------------------------------------------------------------------------------------------------------

**7.3.2.2 Регистр конфигурации внешних прерываний 1 (AFIO_EXTICR)**

Смещение адреса: 0x00

  --------------------------------------------------------------------------------------------------------
     31     30    29     28    27     26    25     24    23     22    21     20    19     18    17     16
  -------- ---- ------- ---- ------- ---- ------- ---- ------- ---- ------- ---- ------- ---- ------- ----
   Резерв                                                                                             

     15     14    13     12    11     10     9     8      7     6      5     4      3     2      1     0

   EXTI7         EXTI6        EXTI5        EXTI4        EXTI3        EXTI2        EXTI1        EXTI0  
  --------------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------
      Бит        Название     Доступ  Описание                                           Значение
                                                                                          сброса
  ----------- -------------- -------- -------------- ---------------------------------- ----------
   \[31:9\]        Res          RO    Резерв                                                0

   \[15:14\]   EXTIx\[1:0\]     RW    (x=0-7), бит                                          0
                                      конфигурации                                      
                                      внешнего                                          
                                      прерывания.                                       
                                      Используется                                      
                                      для                                               
                                      определения, к                                    
                                      каким портам                                      
                                      подключены                                        
                                      контакты                                          
                                      внешнего                                          
                                      прерывания.                                       

   \[13:12\]                                                                            

   \[11:10\]                                                                            

    \[9:8\]                           00:            x пин порта PA                     

    \[7:6\]                           10:            x пин порта PC                     

    \[5:4\]                           11:            x пин порта PB                     

    \[3:2\]                                                                             

    \[1:0\]                                                                             
  ------------------------------------------------------------------------------------------------

#  Глава 8 Управление прямым доступом к памяти (DMA) 

> Контроллер прямого доступа к памяти (DMA) обеспечивает
> высокоскоростной метод передачи данных между периферийными
> устройствами и памятью или между памятью и памятью без вмешательства
> процессора, а данные могут быть быстро перемещены с помощью DMA для
> экономии ресурсов процессора для других операций. Каждый канал
> контроллера DMA предназначен для управления запросами на доступ к
> памяти от одного или нескольких периферийных устройств. Также
> существует арбитр для координации приоритетов между каналами.

## 8.1 Основные характеристики

-   Несколько независимых настраиваемых каналов

-   Каждый канал напрямую подключен к выделенному аппаратному запросу
    DMA и поддерживает программный триггер

-   Управление буфером с поддержкой циклов

-   Приоритет запросов между несколькими каналами может быть установлен
    программированием (очень высокий, высокий, средний и низкий), а при
    равенстве приоритет определяется номером канала (чем ниже номер
    канала, тем выше приоритет)

-   Поддерживает передачу данных \"периферия-память\",
    \"память-периферия\" и \"память-память\"

-   В качестве источников и целей доступа можно использовать
    флеш-память, SRAM, периферийный SRAM и периферии HB

-   Программируемое количество байт для передачи данных: до 65 535

## 8.2 Описание функций

### 8.2.1 Обработка каналов DMA

> **1) Приоритеты арбитража**
>
> Запросы DMA, поступающие от нескольких независимых каналов, поступают
> в контроллер DMA через логическую схему типа \"ИЛИ\", и в любой момент
> времени обслуживается только один из них. Арбитр внутри модуля
> выбирает, какой доступ к периферии или памяти следует инициировать,
> исходя из приоритета поступившего запроса.
>
> С помощью программного управления приложение может настроить уровень
> приоритета для каждого канала индивидуально, установив соответствующие
> значения бит **PL**\[1:0\] в регистре конфигурации DMA
> (**DMA_CFGRx**). Доступны четыре уровня приоритета: самый высокий,
> высокий, средний и низкий. Если уровни приоритета, установленные
> программно, совпадают у нескольких каналов, то выбор между ними
> производится на основании фиксированного аппаратного приоритета: чем
> меньше номер канала, тем выше его приоритет по сравнению с другими
> каналами.
>
> **2) Конфигурация DMA**
>
> Когда контроллер DMA получает сигнал запроса, он обращается к
> запрашиваемой периферии или памяти и устанавливает передачу данных
> между периферией или памятью и памятью. Он состоит из следующих трех
> основных этапов работы.
>
> **4) Статус обработки DMA**

#### Начало формы

-   **Передача половины данных**: Соответствует установке бита **HTIFx**
    в регистре **DMA_INTFR**. Флаг, указывающий на передачу половины
    байтов DMA, будет сгенерирован, когда количество передач DMA
    уменьшится менее чем наполовину от начального установленного
    значения, и если установлен бит **HTIE** в регистре **DMA_CCRx**,
    произойдет прерывание. Аппаратное обеспечение использует этот флаг,
    чтобы предупредить приложение о том, что оно может подготовиться к
    новому циклу передачи данных.

-   **Завершение передачи**: Соответствует настройке бита **TCIFx** в
    регистре **DMA_INTFR**. Когда количество передаваемых байтов DMA
    уменьшается до нуля, генерируется флаг завершения передачи DMA, и,
    если установлен бит **TCIE** в регистре **DMA_CCRx**, происходит
    прерывание.

-   **Ошибка передачи**: Соответствует установленной аппаратуре биту
    **TEIFx** в регистре **DMA_INTFR**. Чтение или запись в
    зарезервированную область адреса приведет к возникновению ошибки
    передачи DMA. Одновременно аппаратное обеспечение модуля
    автоматически сбросит бит **EN** в регистре **DMA_CCRx**
    соответствующего канала, в котором произошла ошибка, и канал будет
    отключен. Если установлен бит **TEIE** в регистре **DMA_CCRx**,
    также произойдет прерывание.

> Когда приложение запрашивает статус канала DMA, оно сначала может
> получить доступ к биту **GIFx** регистра DMA_INTFR, чтобы определить,
> какой канал в настоящее время испытывает событие DMA, а затем
> обработать конкретное содержание события DMA для этого канала.

### 8.2.2 Программируемый общий размер передаваемых данных/ширина битов данных/выравнивание 

> Общий размер данных, передаваемых за один цикл работы канала DMA,
> программируется до 65535 раз, и количество оставшихся байтов для
> передачи указывается в регистре **DMA_CNTRx**. При **EN**=0
> записывается установленное значение, а при **EN**=1, когда канал
> передачи DMA включен, этот регистр становится атрибутом только для
> чтения со значением, уменьшающимся после каждой передачи.
>
> Значение данных, извлекаемое из периферии и памяти, поддерживает
> функцию автоматического увеличения указателя адреса с программируемым
> увеличением указателя. Первый адрес передаваемых данных, к которому
> они обращаются, хранится в регистрах **DMA_PADDRx** и **DMA_MADDRx**.
> Путём установки бита **PINC** или положения **MINC** равным 1 в
> регистре **DMA_CFGRx** соответственно можно включить режим
> автоувеличения адреса периферии или автоувеличения адреса памяти.
> **PSIZE**\[1:0\] задаёт размер данных и размер автоувеличения для
> извлечения адреса периферии. **MSIZE**\[1:0\] задает размер данных для
> извлечения из памяти и размер её автоувеличения, включая три варианта:
> 8-битные, 16-битные и 32-битные. Конкретные методы передачи данных
> перечислены в следующей таблице.
>
> Таблица 8-1 Передача DMA с различной шириной битов данных
> (**PINC**=**MINC**=1)

+------+-----+-----+-----------+-----------+------------------------+
| Раз  | За  | Но  | Источник: | Приемник: | Операции передачи      |
| мерн | дан | мер | адр       | адр       |                        |
| ость | ная | пе  | ес/данные | ес/данные |                        |
| бит  | шир | ред |           |           |                        |
| и    | ина | ачи |           |           |                        |
| сточ | бит |     |           |           |                        |
| ника |     |     |           |           |                        |
+:====:+:===:+:===:+:==========+:==========+========================+
| 8    | 8   | 4   | 0x00/B0\  | 0x00/B0\  | -   Инкремент          |
|      |     |     | 0x01/B1\  | 0x01/B1\  |     исходного адреса   |
|      |     |     | 0x02/B2\  | 0x02/B2\  |     выровнен с шириной |
|      |     |     | 0x03/B3   | 0x03/B3   |     бита данных,       |
|      |     |     |           |           |     установленной в    |
|      |     |     |           |           |     источнике, и       |
|      |     |     |           |           |     принимает          |
|      |     |     |           |           |     значение, равное   |
|      |     |     |           |           |     ширине бита данных |
|      |     |     |           |           |     источника.         |
|      |     |     |           |           |                        |
|      |     |     |           |           | -   Инкрементация      |
|      |     |     |           |           |     целевого адреса    |
|      |     |     |           |           |     выравнивается с    |
|      |     |     |           |           |     шириной бит данных |
|      |     |     |           |           |     целевой настройки  |
|      |     |     |           |           |     и принимает        |
|      |     |     |           |           |     значение, равное   |
|      |     |     |           |           |     ширине бит данных  |
|      |     |     |           |           |     цели.              |
|      |     |     |           |           |                        |
|      |     |     |           |           | -   Передача данных    |
|      |     |     |           |           |     DMA, отправленных  |
|      |     |     |           |           |     на цель, основана  |
|      |     |     |           |           |     на принципе:       |
|      |     |     |           |           |     старший бит        |
|      |     |     |           |           |     размера данных     |
|      |     |     |           |           |     недостаточен для   |
|      |     |     |           |           |     формирования 0,    |
|      |     |     |           |           |     переполнение       |
|      |     |     |           |           |     старшего бита      |
|      |     |     |           |           |     размера данных     |
|      |     |     |           |           |     удаляется.         |
|      |     |     |           |           |                        |
|      |     |     |           |           | -   Режим хранения     |
|      |     |     |           |           |     данных: режим      |
|      |     |     |           |           |     малого конца,      |
|      |     |     |           |           |     низкий адрес       |
|      |     |     |           |           |     хранит младшие     |
|      |     |     |           |           |     байты, высокий     |
|      |     |     |           |           |     адрес хранит       |
|      |     |     |           |           |     старшие байты.     |
+------+-----+-----+-----------+-----------+------------------------+
| 8    | 16  | 4   | 0x00/B0\  | 0         |                        |
|      |     |     | 0x01/B1\  | x00/00B0\ |                        |
|      |     |     | 0x02/B2\  | 0         |                        |
|      |     |     | 0x03/B3   | x02/00B1\ |                        |
|      |     |     |           | 0         |                        |
|      |     |     |           | x04/00B2\ |                        |
|      |     |     |           | 0x06/00B3 |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 8    | 32  | 4   | 0x00/B0\  | 0x00/     |                        |
|      |     |     | 0x01/B1\  | 000000B0\ |                        |
|      |     |     | 0x02/B2\  | 0x04/     |                        |
|      |     |     | 0x03/B3   | 000000B1\ |                        |
|      |     |     |           | 0x08/     |                        |
|      |     |     |           | 000000B2\ |                        |
|      |     |     |           | 0x0C      |                        |
|      |     |     |           | /000000B3 |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 16   | 8   | 4   | 0         | 0x00/B0\  |                        |
|      |     |     | x00/B1B0\ | 0x01/B2\  |                        |
|      |     |     | 0         | 0x02/B4\  |                        |
|      |     |     | x02/B3B2\ | 0x03/B6   |                        |
|      |     |     | 0         |           |                        |
|      |     |     | x04/B5B4\ |           |                        |
|      |     |     | 0x06/B7B6 |           |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 16   | 16  | 4   | 0         | 0         |                        |
|      |     |     | x00/B1B0\ | x00/B1B0\ |                        |
|      |     |     | 0         | 0         |                        |
|      |     |     | x02/B3B2\ | x02/B3B2\ |                        |
|      |     |     | 0         | 0         |                        |
|      |     |     | x04/B5B4\ | x04/B5B4\ |                        |
|      |     |     | 0x06/B7B6 | 0x06/B7B6 |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 16   | 32  | 4   | 0         | 0x00/     |                        |
|      |     |     | x00/B1B0\ | 0000B1B0\ |                        |
|      |     |     | 0         | 0x04/     |                        |
|      |     |     | x02/B3B2\ | 0000B3B2\ |                        |
|      |     |     | 0         | 0x08/     |                        |
|      |     |     | x04/B5B4\ | 0000B5B4\ |                        |
|      |     |     | 0x06/B7B6 | 0x0C      |                        |
|      |     |     |           | /0000B7B6 |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 32   | 8   | 4   | 0x00/     | 0x00/B0\  |                        |
|      |     |     | B3B2B1B0\ | 0x01/B4\  |                        |
|      |     |     | 0x04/     | 0x02/B8\  |                        |
|      |     |     | B7B6B5B4\ | 0x03/BC   |                        |
|      |     |     | 0x08/     |           |                        |
|      |     |     | BBBAB9B8\ |           |                        |
|      |     |     | 0x0C      |           |                        |
|      |     |     | /BFBEBDBC |           |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 32   | 16  | 4   | 0x00/     | 0         |                        |
|      |     |     | B3B2B1B0\ | x00/B1B0\ |                        |
|      |     |     | 0x04/     | 0         |                        |
|      |     |     | B7B6B5B4\ | x02/B5B4\ |                        |
|      |     |     | 0x08/     | 0         |                        |
|      |     |     | BBBAB9B8\ | x04/B9B8\ |                        |
|      |     |     | 0x0C      | 0x06/BDBC |                        |
|      |     |     | /BFBEBDBC |           |                        |
+------+-----+-----+-----------+-----------+------------------------+
| 32   | 32  | 4   | 0x00/     | 0x00/     |                        |
|      |     |     | B3B2B1B0\ | B3B2B1B0\ |                        |
|      |     |     | 0x04/     | 0x04/     |                        |
|      |     |     | B7B6B5B4\ | B7B6B5B4\ |                        |
|      |     |     | 0x08/     | 0x08/     |                        |
|      |     |     | BBBAB9B8\ | BBBAB9B8\ |                        |
|      |     |     | 0x0C      | 0x0C      |                        |
|      |     |     | /BFBEBDBC | /BFBEBDBC |                        |
+------+-----+-----+-----------+-----------+------------------------+

### 8.2.3 Сопоставление запросов DMA (DMA Request Mapping) 

### Контроллер DMA предоставляет семь каналов, каждый из которых соответствует нескольким запросам периферийных устройств. Включать или отключать функцию DMA для каждого периферийного устройства можно независимо, устанавливая соответствующие биты управления DMA в соответствующих регистрах периферийного оборудования. Вот конкретные соответствия. 

> Рисунок 8-1 DMA1 марта запросов
>
> ![](media/image16.png){width="6.361111111111111in"
> height="5.907638888888889in"}
>
> Таблица 8-2 Таблица сопоставления периферийных устройств DMA1 для
> каждого канала

  ------------------------------------------------------------------------------------------
   Переферия   Канал 1    Канал 2    Канал 3     Канал 4     Канал 5    Канал 6    Канал 7
  ----------- ---------- ---------- ---------- ----------- ----------- ---------- ----------
     ADC1        ADC1                                                                  

     SPI1                 SPI1_RX    SPI1_TX                                           

    USART1                                      USART1_TX   USART1_RX                  

     I2C1                                                               I2C1_TX    I2C1_RX

     TIM1                 TIM1_CH1   TIM1_CH2   TIM1_CH4     TIM1_UP    TIM1_CH3       
                                                TIM1_TRIG                         
                                                TIM1_COM                          

     TiIM2     TIM2_CH3   TIM2_UP                           TIM2_CH1               TIM2_CH2
                                                                                   TIM2_CH4
  ------------------------------------------------------------------------------------------

## 8.3 Описание регистров 

> Таблица 8-3 Список регистров, связанных с DMA

  ------------------------------------------------------------------------------
  **Наименование**   **Адрес**    **Описание**                      **Значение
                                                                    сброса**
  ------------------ ------------ --------------------------------- ------------
  R32_DMA_INTFR      0x40020000   Регистр статуса прерываний DMA    0x00000000

  R32_DMA_INTFCR     0x40020004   Регистр флагов сброса прерываний  0x00000000
                                  DMA                               

  R32_DMA_CFGR1      0x40020008   Регистр конфигурации DMA канал 1  0x00000000

  R32_DMA_CNTR1      0x4002000C   Регистр количества данных DMA     0x00000000
                                  канал 1                           

  R32_DMA_PADDR1     0x40020010   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 1                 

  R32_DMA_MADDR1     0x40020014   Регистр адреса памяти DMA канала  0x00000000
                                  1                                 

  R32_DMA_CFGR2      0x4002001C   Регистр конфигурации DMA канал 2  0x00000000

  R32_DMA_CNTR2      0x40020020   Регистр количества данных DMA     0x00000000
                                  канал 2                           

  R32_DMA_PADDR2     0x40020024   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 2                 

  R32_DMA_MADDR2     0x40020028   Регистр адреса памяти DMA канала  0x00000000
                                  2                                 

  R32_DMA_CFGR3      0x40020030   Регистр конфигурации DMA канал 3  0x00000000

  R32_DMA_CNTR3      0x40020034   Регистр количества данных DMA     0x00000000
                                  канал 3                           

  R32_DMA_PADDR3     0x40020038   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 3                 

  R32_DMA_MADDR3     0x4002003C   Регистр адреса памяти DMA канала  0x00000000
                                  3                                 

  R32_DMA_CFGR4      0x40020044   Регистр конфигурации DMA канал 4  0x00000000

  R32_DMA_CNTR4      0x40020048   Регистр количества данных DMA     0x00000000
                                  канал 4                           

  R32_DMA_PADDR4     0x4002004C   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 4                 

  R32_DMA_MADDR4     0x40020050   Регистр адреса памяти DMA канала  0x00000000
                                  4                                 

  R32_DMA_CFGR5      0x40020058   Регистр конфигурации DMA канал 5  0x00000000

  R32_DMA_CNTR5      0x4002005C   Регистр количества данных DMA     0x00000000
                                  канал 5                           

  R32_DMA_PADDR5     0x40020060   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 5                 

  R32_DMA_MADDR5     0x40020064   Регистр адреса памяти DMA канала  0x00000000
                                  5                                 

  R32_DMA_CFGR6      0x4002006C   Регистр конфигурации DMA канал 6  0x00000000

  R32_DMA_CNTR6      0x40020070   Регистр количества данных DMA     0x00000000
                                  канал 6                           

  R32_DMA_PADDR6     0x40020074   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 6                 

  R32_DMA_MADDR6     0x40020078   Регистр адреса памяти DMA канала  0x00000000
                                  6                                 

  R32_DMA_CFGR7      0x40020080   Регистр конфигурации DMA канал 7  0x00000000

  R32_DMA_CNTR7      0x40020084   Регистр количества данных DMA     0x00000000
                                  канал 7                           

  R32_DMA_PADDR7     0x40020088   Регистр адреса периферийного      0x00000000
                                  уст-ва DMA кан. 7                 

  R32_DMA_MADDR7     0x4002008C   Регистр адреса памяти DMA канала  0x00000000
                                  7                                 
  ------------------------------------------------------------------------------

### 8.3.1 Регистр состояния прерывания DMA (DMA_INTFR)

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------------------------------------------
     31      30      29      28   27      26      25      24     23      22      21      20     19      18      17      16
  -------- ------- ------- ------ ------- ------- ------- ------ ------- ------- ------- ------ ------- ------- ------- ------
   Резерв                         TEIF7   HTIF7   TCIF7   GIF7   TEIF6   HTIF6   TCIF6   GIF6   TEIF5   HTIF5   TCIF5   GIF5

     15      14      13      12   11      10      9       8      7       6       5       4      3       2       1       0

   TEIF4    HTIF4   TCIF4   GIF4  TEIF3   HTIF3   TCIF3   GIF3   TEIF2   HTIF2   TCIF2   GIF2   TEIF1   HTIF1   TCIF1   GIF1
  ----------------------------------------------------------------------------------------------------------------------------

+-------+-------+-----+---+------------------------------------+-------+
| Бит   | Наз   | Дос | О |                                    | Зна   |
|       | вание | туп | п |                                    | чение |
|       |       |     | и |                                    | с     |
|       |       |     | с |                                    | броса |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | е |                                    |       |
+:=====:+:=====:+:===:+:==+:===================================+:=====:+
| \[31  | Res   | RO  | Р |                                    | 0     |
| :28\] |       |     | е |                                    |       |
|       |       |     | з |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | в |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
| \[27  | TEIFx | RO  | Ф |                                    | 0     |
| \]/\[ |       |     | л |                                    |       |
| 23\]/ |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
| \[19  |       |     | о |                                    |       |
| \]/\[ |       |     | ш |                                    |       |
| 15\]/ |       |     | и |                                    |       |
|       |       |     | б |                                    |       |
| \[1   |       |     | к |                                    |       |
| 1\]/\ |       |     | и |                                    |       |
| [7\]/ |       |     | п |                                    |       |
|       |       |     | е |                                    |       |
| \[3\] |       |     | р |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | ч |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | к |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | ( |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | = |                                    |       |
|       |       |     | 1 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 2 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 3 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 4 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 5 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 6 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 7 |                                    |       |
|       |       |     | ) |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 1 | Возникла ошибка передачи на канале |       |
|       |       |     | : | x.                                 |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 0 | Нет ошибк передачи на канале x.    |       |
|       |       |     | : |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | Э |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | ф |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | з |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ь |                                    |       |
|       |       |     | ю |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | C |                                    |       |
|       |       |     | T |                                    |       |
|       |       |     | E |                                    |       |
|       |       |     | I |                                    |       |
|       |       |     | F |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
| \[26  | HTIFx | RO  | Ф |                                    | 0     |
| \]/\[ |       |     | л |                                    |       |
| 22\]/ |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
| \[18  |       |     | п |                                    |       |
| \]/\[ |       |     | о |                                    |       |
| 14\]/ |       |     | л |                                    |       |
|       |       |     | о |                                    |       |
| \[1   |       |     | в |                                    |       |
| 0\]/\ |       |     | и |                                    |       |
| [6\]/ |       |     | н |                                    |       |
| \[2\] |       |     | ы |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | ч |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | к |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | ( |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | = |                                    |       |
|       |       |     | 1 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 2 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 3 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 4 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 5 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 6 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 7 |                                    |       |
|       |       |     | ) |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 1 | На канале x произошло событие,     |       |
|       |       |     | : | соответствующее половине передачи. |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 0 | Нет события, соответствующего      |       |
|       |       |     | : | половине передачи, на канале x.    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | Э |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | ф |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | з |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ь |                                    |       |
|       |       |     | ю |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | C |                                    |       |
|       |       |     | H |                                    |       |
|       |       |     | T |                                    |       |
|       |       |     | I |                                    |       |
|       |       |     | F |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
| \[25  | TCIFx | RO  | Ф |                                    | 0     |
| \]/\[ |       |     | л |                                    |       |
| 21\]/ |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
| \[17  |       |     | з |                                    |       |
| \]/\[ |       |     | а |                                    |       |
| 13\]/ |       |     | в |                                    |       |
|       |       |     | е |                                    |       |
| \[    |       |     | р |                                    |       |
| 9\]/\ |       |     | ш |                                    |       |
| [5\]/ |       |     | е |                                    |       |
| \[1\] |       |     | н |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | ч |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | к |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | ( |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | = |                                    |       |
|       |       |     | 1 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 2 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 3 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 4 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 5 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 6 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 7 |                                    |       |
|       |       |     | ) |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 1 | Событие завершения передачи было   |       |
|       |       |     | : | сгенерировано на канале x.         |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 0 | Нет события завершения передачи на |       |
|       |       |     | : | канале x                           |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | Э |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | ф |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | з |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ь |                                    |       |
|       |       |     | ю |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | C |                                    |       |
|       |       |     | T |                                    |       |
|       |       |     | C |                                    |       |
|       |       |     | I |                                    |       |
|       |       |     | F |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
| \[24  | GIFx  | RO  | Г |                                    | 0     |
| \]/\[ |       |     | л |                                    |       |
| 20\]/ |       |     | о |                                    |       |
|       |       |     | б |                                    |       |
| \[16  |       |     | а |                                    |       |
| \]/\[ |       |     | л |                                    |       |
| 12\]/ |       |     | ь |                                    |       |
|       |       |     | н |                                    |       |
| \[    |       |     | ы |                                    |       |
| 8\]/\ |       |     | й |                                    |       |
| [4\]/ |       |     | ф |                                    |       |
| \[0\] |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | д |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | к |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | ( |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | = |                                    |       |
|       |       |     | 1 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 2 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 3 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 4 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 5 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 6 |                                    |       |
|       |       |     | / |                                    |       |
|       |       |     | 7 |                                    |       |
|       |       |     | ) |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 1 | На канале x был сгенерирован флаг  |       |
|       |       |     | : | TEIFx, либо HTIFx, либо TCIFx.     |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | 0 | На канале x не было сгенерировано  |       |
|       |       |     | : | ни флага TEIFx, ни HTIFx, ни       |       |
|       |       |     |   | TCIFx.                             |       |
+-------+-------+-----+---+------------------------------------+-------+
|       |       |     | Э |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | ф |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | л |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | в |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | я |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | о |                                    |       |
|       |       |     | г |                                    |       |
|       |       |     | р |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | н |                                    |       |
|       |       |     | ы |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | у |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | е |                                    |       |
|       |       |     | м |                                    |       |
|       |       |     | з |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | п |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | с |                                    |       |
|       |       |     | ь |                                    |       |
|       |       |     | ю |                                    |       |
|       |       |     | б |                                    |       |
|       |       |     | и |                                    |       |
|       |       |     | т |                                    |       |
|       |       |     | а |                                    |       |
|       |       |     | C |                                    |       |
|       |       |     | G |                                    |       |
|       |       |     | I |                                    |       |
|       |       |     | F |                                    |       |
|       |       |     | x |                                    |       |
|       |       |     | . |                                    |       |
+-------+-------+-----+---+------------------------------------+-------+

### 8.3.2 Регистр очистки флагов прерываний DMA (DMA_INTFCR)

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------------------------------------------------------
     31       30       29      28    27       26       25       24      23       22       21       20      19       18       17       16
  -------- -------- -------- ------- -------- -------- -------- ------- -------- -------- -------- ------- -------- -------- -------- -------
   Резерв                            CTEIF7   CHTIF7   CTCIF7   CGIF7   CTEIF6   CHTIF6   CTCIF6   CGIF6   CTEIF5   CHTIF5   CTCIF5   CGIF5

     15       14       13      12    11       10       9        8       7        6        5        4       3        2        1        0

   CTEIF4   CHTIF4   CTCIF4   CGIF4  CTEIF3   CHTIF3   CTCIF3   CGIF3   CTEIF2   CHTIF2   CTCIF2   CGIF2   CTEIF1   CHTIF1   CTCIF1   CGIF1
  -------------------------------------------------------------------------------------------------------------------------------------------

+--------+-------+-----+---+------------------------------------+-------+
| Бит    | Наз   | Дос | О |                                    | Зна   |
|        | вание | туп | п |                                    | чение |
|        |       |     | и |                                    | с     |
|        |       |     | с |                                    | броса |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | е |                                    |       |
+:======:+:=====:+:===:+:==+:===================================+:=====:+
| \[3    | Res   | RO  | Р |                                    | 0     |
| 1:28\] |       |     | е |                                    |       |
|        |       |     | з |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | в |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
| \[     | C     | WO  | О |                                    | 0     |
| 27\]/\ | TEIFx |     | ч |                                    |       |
| [23\]/ |       |     | и |                                    |       |
|        |       |     | с |                                    |       |
| \[     |       |     | т |                                    |       |
| 19\]/\ |       |     | и |                                    |       |
| [15\]/ |       |     | т |                                    |       |
|        |       |     | ь |                                    |       |
| \      |       |     | ф |                                    |       |
| [11\]/ |       |     | л |                                    |       |
| \[7\]/ |       |     | а |                                    |       |
|        |       |     | г |                                    |       |
| \[3\]  |       |     | о |                                    |       |
|        |       |     | ш |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | б |                                    |       |
|        |       |     | к |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | п |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | ч |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | к |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | ( |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | = |                                    |       |
|        |       |     | 1 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 2 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 3 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 4 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 5 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 6 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 7 |                                    |       |
|        |       |     | ) |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 1 | Очистить флаг TEIFx в регистре     |       |
|        |       |     | : | DMA_INTFR                          |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 0 | Без эффекта.                       |       |
|        |       |     | : |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
| \[     | C     | WO  | О |                                    | 0     |
| 26\]/\ | HTIFx |     | ч |                                    |       |
| [22\]/ |       |     | и |                                    |       |
|        |       |     | с |                                    |       |
| \[     |       |     | т |                                    |       |
| 18\]/\ |       |     | и |                                    |       |
| [14\]/ |       |     | т |                                    |       |
|        |       |     | ь |                                    |       |
| \[10\] |       |     | ф |                                    |       |
| /\[6\] |       |     | л |                                    |       |
| /\[2\] |       |     | а |                                    |       |
|        |       |     | г |                                    |       |
|        |       |     | п |                                    |       |
|        |       |     | о |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | о |                                    |       |
|        |       |     | в |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | ы |                                    |       |
|        |       |     | п |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | ч |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | к |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | ( |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | = |                                    |       |
|        |       |     | 1 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 2 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 3 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 4 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 5 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 6 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 7 |                                    |       |
|        |       |     | ) |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 1 | Очистить флаг HTIFx в регистре     |       |
|        |       |     | : | DMA_INTFR                          |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 0 | Без эффекта.                       |       |
|        |       |     | : |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
| \[     | C     | WO  | О |                                    | 0     |
| 25\]/\ | TCIFx |     | ч |                                    |       |
| [21\]/ |       |     | и |                                    |       |
|        |       |     | с |                                    |       |
| \[     |       |     | т |                                    |       |
| 17\]/\ |       |     | и |                                    |       |
| [13\]/ |       |     | т |                                    |       |
|        |       |     | ь |                                    |       |
| \[9\]  |       |     | ф |                                    |       |
| /\[5\] |       |     | л |                                    |       |
| /\[1\] |       |     | а |                                    |       |
|        |       |     | г |                                    |       |
|        |       |     | з |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | в |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | ш |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | п |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | ч |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | к |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | ( |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | = |                                    |       |
|        |       |     | 1 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 2 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 3 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 4 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 5 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 6 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 7 |                                    |       |
|        |       |     | ) |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 1 | Очистить флаг TCIFx в регистре     |       |
|        |       |     | : | DMA_INTFR                          |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 0 | Без эффекта.                       |       |
|        |       |     | : |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
| \[     | CGIFx | WO  | О |                                    | 0     |
| 24\]/\ |       |     | ч |                                    |       |
| [20\]/ |       |     | и |                                    |       |
|        |       |     | с |                                    |       |
| \[     |       |     | т |                                    |       |
| 16\]/\ |       |     | и |                                    |       |
| [12\]/ |       |     | т |                                    |       |
|        |       |     | ь |                                    |       |
| \[8\]  |       |     | г |                                    |       |
| /\[4\] |       |     | л |                                    |       |
| /\[0\] |       |     | о |                                    |       |
|        |       |     | б |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | ь |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | ы |                                    |       |
|        |       |     | й |                                    |       |
|        |       |     | ф |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | г |                                    |       |
|        |       |     | п |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | е |                                    |       |
|        |       |     | р |                                    |       |
|        |       |     | ы |                                    |       |
|        |       |     | в |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | и |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | д |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | я |                                    |       |
|        |       |     | к |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | н |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | л |                                    |       |
|        |       |     | а |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | ( |                                    |       |
|        |       |     | x |                                    |       |
|        |       |     | = |                                    |       |
|        |       |     | 1 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 2 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 3 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 4 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 5 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 6 |                                    |       |
|        |       |     | / |                                    |       |
|        |       |     | 7 |                                    |       |
|        |       |     | ) |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 1 | Очистить флаги                     |       |
|        |       |     | : | TEIFx/HTIFx/TCIFx/GIFx в регистре  |       |
|        |       |     |   | DMA_INTFR                          |       |
+--------+-------+-----+---+------------------------------------+-------+
|        |       |     | 0 | Без эффекта.                       |       |
|        |       |     | : |                                    |       |
+--------+-------+-----+---+------------------------------------+-------+

### 8.3.3 Регистр конфигурации канала x DMA (DMA_CFGRx) (x=1/2/3/4/5/6/7)

**Начало формы**

Смещение адреса: 0x00

  -----------------------------------------------------------------------------------------------------------
     31       30      29   28    27     26    25     24    23     22     21    20     19     18     17    16
  -------- --------- ---- ---- ------- ---- ------- ---- ------ ------ ------ ----- ------ ------ ------ ----
   Резерв                                                                                                

     15       14      13   12    11     10     9     8     7      6      5      4     3      2      1     0

    Рез.    MEM2MEM   PL        MSIZE        PSIZE        MINC   PINC   CIRC   DIR   TEIE   HTIE   TCIE   EN
  -----------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                 Значение
                                                                                            сброса
  ----------- ---------- -------- ------------------ ------------------------------------ ----------
   \[31:28\]     Res        RO    Резерв                                                      0

    \[14\]     MEM2 MEM     RW    Разрешение режима                                           0
                                  память-память.                                          

                                  1:                 Включить режим передачи данных между 
                                                     памятями.                            

                                  0:                 Отключить режим передачи данных      
                                                     между памятями.                      

   \[13:12\]      PL        RW    Установка                                                   0
                                  приоритета канала.                                      

                                  00:                Низкий                               

                                  01:                Средний                              

                                  10:                Высокий                              

                                  11:                Очень высокий                        

   \[11:10\]    MSIZE       RW    Настройка                                                   0
                                  разрядности данных                                      
                                  адреса памяти.                                          

                                  00:                8 бит                                

                                  01:                16 бит                               

                                  10:                32 бита                              

                                  11:                Зарезервировано                      

    \[9:8\]     PSIZE       RW    Настройка                                                   0
                                  разрядности данных                                      
                                  адреса периферии.                                       

                                  00:                8 бит                                

                                  01:                16 бит                               

                                  10:                32 бита                              

                                  11:                Зарезервировано                      

     \[7\]       MINC       RW    Разрешение                                                  0
                                  инкрементального                                        
                                  режима адреса                                           
                                  памяти                                                  

                                  1:                 Включить операцию инкремента адреса  
                                                     памяти                               

                                  0:                 Адрес памяти остается неизменным     

     \[6\]       PINC       RW    Разрешение                                                  0
                                  инкрементального                                        
                                  режима адреса                                           
                                  периферии                                               

                                  1:                 Включить инкрементальную операцию    
                                                     адреса периферии                     

                                  0:                 Адрес периферии остается неизменным  

     \[5\]       CIRC       RW    Разрешение                                                  0
                                  циклического                                            
                                  режима работы                                           
                                  канала DMA                                              

                                  1:                 Включает циклическую операцию        

                                  0:                 Выполнить однократную операцию       

     \[4\]       DIR        RW    Направление                                                 0
                                  передачи данных                                         

                                  1:                 Чтение из памяти                     

                                  0:                 Чтение с периферии                   

     \[3\]       TEIE       RW    Управление                                                  0
                                  включением                                              
                                  прерывания при                                          
                                  ошибке передачи                                         

                                  1:                 Разрешить прерывание при ошибке      
                                                     передачи                             

                                  0:                 Запретить прерывание при ошибке      
                                                     передачи                             

     \[2\]       HTIE       RW    Управление                                                  0
                                  включением                                              
                                  прерывания при                                          
                                  достижении                                              
                                  половины передачи                                       

                                  1:                 Разрешить прерывание при достижении  
                                                     половины передачи                    

                                  0:                 Запретить прерывание при достижении  
                                                     половины передачи                    

     \[1\]       TCIE       RW    Управление                                                  0
                                  включением                                              
                                  прерывания по                                           
                                  завершению                                              
                                  передачи                                                

                                  1:                 Разрешить прерывание по завершению   
                                                     передачи                             

                                  0:                 Запретить прерывание по завершению   
                                                     передачи                             

     \[0\]        EN        RW    Управление                                                  0
                                  включением канала                                       

                                  1:                 Канал включен                        

                                  0:                 Канал отключен                       

                                  Когда возникает                                         
                                  ошибка передачи                                         
                                  DMA, аппаратное                                         
                                  обеспечение                                             
                                  автоматически                                           
                                  очищает этот бит                                        
                                  до 0 и отключает                                        
                                  канал                                                   
  --------------------------------------------------------------------------------------------------

### 8.3.4 Регистр количества данных канала x DMA (DMA_CNTRx) (x=1/2/3/4/5/6/7)

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------
       31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
     Резерв                                                                           

       15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   NDT\[15:0\]                                                                        
  ----------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:16\]       Res         RO    Резерв                                       0

   \[15:0\]    NDT\[15:0\]     RW    Количество передач данных, диапазон          0
                                     0-65535. Этот регистр может быть записан 
                                     только тогда, когда канал не работает    
                                     (EN=0 для DMA_CFGRx). После включения    
                                     канала этот регистр становится доступным 
                                     только для чтения и указывает количество 
                                     оставшихся ожидающих передач (содержание 
                                     регистра уменьшается после каждой        
                                     передачи DMA). Когда канал находится в   
                                     циклическом режиме, содержимое регистра  
                                     будет автоматически перезагружено к      
                                     ранее настроенному значению.             
  --------------------------------------------------------------------------------------

### 8.3.5 Регистр адреса периферии канала x DMA (DMA_PADDRx) (x=1/2/3/4/5/6/7)

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------
       31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   PA\[31:16\]                                                                        

       15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   PA\[15:0\]                                                                         
  ----------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
     Бит       Название    Доступ  Описание                                  Значение
                                                                              сброса
  ---------- ------------ -------- ---------------------------------------- ----------
   \[31:0\]   PA\[31:0\]     RW    Базовый адрес периферии, который служит      0
                                   исходным или целевым адресом для         
                                   передачи данных периферии. Когда         
                                   PSIZE\[1:0\] = \'01\' (16 бит), модуль   
                                   автоматически игнорирует бит0, и         
                                   операционный адрес автоматически         
                                   выравнивается по границе двух байтов;    
                                   когда PSIZE\[1:0\] = \'10\' (32 бита),   
                                   модуль автоматически игнорирует биты     
                                   \[1:0\], и операционный адрес            
                                   автоматически выравнивается по границе   
                                   четырех байтов.                          

  ------------------------------------------------------------------------------------

> *Note: This register can only be changed when EN=0 and cannot be
> written when EN=1.*

### 8.3.6 Регистр адреса памяти канала x DMA (DMA_MADDRx) (x=1/2/3/4/5/6/7)

### Начало формы

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------
       31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  ------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
   MA\[31:16\]                                                                        

       15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   MA\[15:0\]                                                                         
  ----------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
     Бит       Название    Доступ  Описание                                  Значение
                                                                              сброса
  ---------- ------------ -------- ---------------------------------------- ----------
   \[31:0\]   MA\[31:0\]     RW    Адрес данных памяти, который служит          0
                                   исходным или целевым адресом для         
                                   передачи данных. Когда MSIZE\[1:0\] =    
                                   \'01\' (16 бит), модуль автоматически    
                                   игнорирует бит0, и операционный адрес    
                                   автоматически выравнивается по границе   
                                   двух байтов; когда MSIZE\[1:0\] = \'10\' 
                                   (32 бита), модуль автоматически          
                                   игнорирует биты \[1:0\], и операционный  
                                   адрес автоматически выравнивается по     
                                   границе четырех байтов.                  

  ------------------------------------------------------------------------------------

> *Note: This register can only be changed when EN=0 and cannot be
> written when EN=1.*

# Глава 9 Аналого-цифровой преобразователь (АЦП)

# Начало формы

> Модуль АЦП содержит 10-битный аналого-цифровой преобразователь
> последовательных приближений с входной тактовой частотой до 24 МГц. Он
> поддерживает выборку до 8 внешних каналов и 2 внутренних источников
> сигналов. Можно выполнять одиночное преобразование и непрерывное
> преобразование каналов, автоматическое сканирование между каналами,
> прерывистый режим, режим внешнего запуска, двойную выборку, задержку
> запуска и многое другое. С помощью функции аналогового сторожевого
> таймера можно контролировать напряжение на канале, чтобы убедиться,
> что оно находится в пределах порогового диапазона.

## 9.1 Основные возможности 

-   Разрешение 10 бит

-   Поддержка 8 внешних каналов и 2 внутренних источников сигналов для
    выборки

-   Многочисленные методы преобразования выборок для нескольких каналов:
    однократная, непрерывная, сканирующая, запускаемая, прерывистая и
    т.д.

-   Режимы выравнивания данных: выровненные слева, выровненные справа

-   Время выборки может быть запрограммировано отдельно для каждого
    канала

-   Как обычное, так и инъекционное преобразование поддерживают внешний
    запуск

-   Аналоговый сторожевой таймер для мониторинга напряжения на канале,
    функция самокалибровки

-   Диапазон входного сигнала канала АЦП: 0 ≤ VIN ≤ VDDA

-   Задержка запуска

## 9.2 Описание функциональности

### 9.2.1 Структура модуля 

> Рисунок 9-1 Блок-схема модуля АЦП
>
> ![](media/image17.png){width="6.277777777777778in"
> height="5.9631944444444445in"}

### 9.2.2 Конфигурирование ADC

####  1) Включение модуля

> Бит ADON, установленный в 1 в регистре **ADC_CTLR2**, указывает, что
> модуль АЦП включен. Когда модуль АЦП переходит в состояние включения
> (**ADON**=1) из режима пониженного энергопотребления (**ADON**=0),
> требуется период задержки tSTAB для стабилизации модуля. После этого
> бит **ADON** снова устанавливается в 1 и используется в качестве
> сигнала начала для старта преобразования АЦП программным обеспечением.
> Сбросив бит **ADON**, можно завершить текущее преобразование и
> перевести модуль АЦП в режим пониженного энергопотребления, в котором
> АЦП практически не потребляет энергию.

####  2) Тактирование 

> Работа регистра модуля основана на тактовой частоте **HBCLK** (шина
> HB), а опорная частота его блока преобразования, **ADCCLK**,
> конфигурируется полем **ADCPRE** регистра **RCC_CFGR0** для деления
> частоты. За подробной информацией обратитесь к техническому описанию
> CH32V003DS0.

####  3) Конфигурирование каналов 

> Модуль АЦП предоставляет 10 источников выборки каналов, включая 8
> внешних каналов и 2 внутренних канала. Они могут быть сконфигурированы
> в две группы преобразования: обычные группы и группы инъекции. Это
> позволяет достичь группового преобразования, состоящего из серии
> преобразований в любом порядке на любом количестве каналов.

-   Обычная группа: состоит максимум из 16 преобразований. Каналы
    обычной группы и порядок их преобразования устанавливаются в
    регистре **ADC_RSQRx**. Общее количество преобразований в обычной
    группе должно быть записано в **L**\[3:0\] регистра **ADC_RSQR1**.

-   Группа инъекции: состоит максимально из 4 преобразований. Каналы
    группы инъекции и порядок их преобразований устанавливаются в
    регистре **ADC_ISQR**. Общее число преобразований в группе инъекции
    должно быть указано в **JL**\[1:0\] регистра **ADC_ISQR**.

> *Примечание: Если во время преобразования изменяются регистры
> **ADC_RSQRx** или **ADC_ISQR**, текущее преобразование прекращается, и
> новый стартовый сигнал отправляется в АЦП для преобразования вновь
> выбранной группы.*
>
> 2 внутренних канала.

-   **Внутреннее опорное напряжение Vref**: подключено к каналу ADC_IN8.

-   **Напряжение внутренней калибровки Vcal**: подключено к каналу
    ADC_IN9, выбираемое двумя шагами.

-   Начало формы

####  4) Калибровка 

> АЦП имеет встроенный режим самотестирования. Сеанс калибровки
> значительно снижает погрешность точности, вызванную изменениями в
> банках внутренних конденсаторов. Во время калибровки код коррекции
> ошибок рассчитывается для каждого конденсатора, который используется
> для устранения ошибок, возникающих на каждом конденсаторе в
> последующих преобразованиях. Инициализируйте регистр калибровки,
> установив положение **RSTCAL** в регистре **ADC_CTLR2** в 1, и
> дождитесь, пока аппаратное обеспечение **RSTCAL** очистит 0, что
> указывает на завершение инициализации. Установите бит **CAL**, чтобы
> запустить функцию калибровки. После завершения калибровки аппаратное
> обеспечение автоматически очистит бит **CAL** и сохранит код
> калибровки в **ADC_RDATAR**. После этого можно начинать нормальную
> функцию преобразования. Рекомендуется проводить калибровку АЦП при
> включении модуля АЦП.
>
> *Примечание: Прежде чем приступить к калибровке, необходимо убедиться,
> что модуль АЦП находится во включенном состоянии (**ADON**=1) не менее
> двух полных циклов тактового сигнала АЦП.*

####  5) Программируемое время выборки

> ЦП использует несколько циклов **ADCCLK** для выборки входного
> напряжения. Количество циклов выборки для канала можно изменить,
> используя биты **SMPx**\[2:0\] в регистрах **ADC_SAMPTR1** и
> **ADC_SAMPTR2**.
>
> Каждому каналу можно присвоить отдельное время выборки. Общее время
> преобразования вычисляется следующим образом.Начало формы
>
> T~CONV~ = время выборки + 11T~ADCCLK~
>
> Преобразование каналов по правилам АЦП поддерживает функцию DMA.
> Значение преобразования канала по правилам сохраняется в регистре
> данных **ADC_RDATAR**. Чтобы предотвратить несвоевременное получение
> данных из регистра **ADC_RDATAR** при последовательном преобразовании
> нескольких каналов по правилу, можно включить функцию DMA АЦП.
> Аппаратное обеспечение будет генерировать запрос DMA в конце
> преобразования канала по правилу (установлен **EOC**) и передавать
> преобразованные данные из регистра **ADC_RDATAR** по заданному
> пользователем адресу назначения. После завершения настройки канала
> модуля контроллера DMA запишите позицию DMA в регистре **ADC_CTLR2** в
> 1, чтобы включить функцию DMA для АЦП.
>
> *Примечание: Преобразование группы инъекции не поддерживает функцию
> DMA.*

####  6) Выравнивание данныхНачало формы

### 9.2.3 Источник внешнего запуска

> Начало преобразования АЦП может быть инициировано внешним событием.
> Если установлены биты **EXTTRIG** или **JEXTTRIG** в регистре
> **ADC_CTLR2**, преобразование канала обычной группы или группы
> инъекции может быть запущено внешним событием соответственно. В этом
> случае конфигурация битов **EXTSEL**\[2:0\] и **JEXTSEL**\[2:0\]
> определяет источник внешнего события для обычной группы и группы
> инъекции.
>
> *Примечание: Когда для преобразования АЦП по правилу или инъекции
> выбран внешний сигнал запуска, только его передний фронт может начать
> преобразование.*

Таблица 9-3 Источники внешнего запуска для каналов обычной группы

  ---------------------------------------------------------------------------
   EXTSEL\[2:0\]  Источник триггерного сигнала               Тип
  --------------- ----------------------------- -----------------------------
        000       TRGO событие таймера TIM1         Внутренний сигнал от
                                                  встроенных в чип таймеров

        001       CC1 событие таймера TIM1      

        010       CC2 событие таймера TIM1      

        011       TRGO событие таймера TIM2     

        100       CC1 событие таймера TIM2      

        101       CC2 событие таймера TIM2      

        110       События PD3/PC2                     От внешних пинов

        111       Программный триггер SWSTART    Программно управляемые биты
  ---------------------------------------------------------------------------

Таблица 9-4 Внешние источники триггеров для каналов инъекционной группы

  ---------------------------------------------------------------------------
   JEXTSEL\[2:0\]  Источник триггерного сигнала              Тип
  ---------------- ----------------------------- ----------------------------
        000        СС3 событие таймера TIM1          Внутренний сигнал от
                                                  встроенных в чип таймеров

        001        CC4 событие таймера TIM1      

        010        CC3 событие таймера TIM2      

        011        CC4 событие таймера TIM2      

        100        \-                            

        101        \-                            

        110        События PD1/PA2                     От внешних пинов

        111        Программный триггер JSWSTART  Программно управляемые биты
  ---------------------------------------------------------------------------

### 9.2.4 Режим преобразования

> Таблица 9-5 Комбинации режимов преобразованияНачало формы

+-----+-----+--------------+-----+-------+---------------------------+
| Б   |     |              |     |       | Режим преобразования АЦП  |
| иты |     |              |     |       |                           |
| ADC |     |              |     |       |                           |
| _CT |     |              |     |       |                           |
| LR1 |     |              |     |       |                           |
| и   |     |              |     |       |                           |
| ADC |     |              |     |       |                           |
| _CT |     |              |     |       |                           |
| LR2 |     |              |     |       |                           |
| у   |     |              |     |       |                           |
| пра |     |              |     |       |                           |
| вле |     |              |     |       |                           |
| ния |     |              |     |       |                           |
| ре  |     |              |     |       |                           |
| гис |     |              |     |       |                           |
| тра |     |              |     |       |                           |
+:===:+:===:+:============:+:===:+:=====:+:==========================+
| C   | S   | RDI          | JA  | З     |                           |
| ONT | CAN | SCEN/IDISCEN | UTO | апуск |                           |
|     |     |              |     | со    |                           |
|     |     |              |     | бытия |                           |
+-----+-----+--------------+-----+-------+---------------------------+
| 0   | 0   | 0            | 0   | ADON  | Режим одиночного          |
|     |     |              |     | по    | одноканального            |
|     |     |              |     | зиция | преобразования: Канал     |
|     |     |              |     | 1     | правила выполняет одно    |
|     |     |              |     |       | преобразование            |
+-----+-----+--------------+-----+-------+---------------------------+
|     |     |              |     | Метод | Режим одиночного          |
|     |     |              |     | вне   | одноканального            |
|     |     |              |     | шнего | преобразования: Одно      |
|     |     |              |     | при   | преобразование            |
|     |     |              |     | ггера | выполняется на одном из   |
|     |     |              |     |       | каналов правил или        |
|     |     |              |     |       | каналов инъекции          |
+-----+-----+--------------+-----+-------+---------------------------+
|     | 1   |              |     | ADON  | Режим одиночного          |
|     |     |              |     | по    | сканирования: выполняет   |
|     |     |              |     | зиция | одиночное преобразование  |
|     |     |              |     | 1 или | всех выбранных каналов    |
|     |     |              |     | метод | группы правил (ADC_RSQRx) |
|     |     |              |     | вне   | или всех каналов группы   |
|     |     |              |     | шнего | инъекции (ADC_ISQR)       |
|     |     |              |     | три   | последовательно по        |
|     |     |              |     | ггера | одному. Метод триггерной  |
|     |     |              |     |       | инъекции: Когда процесс   |
|     |     |              |     |       | преобразования каналов    |
|     |     |              |     |       | группы правил может быть  |
|     |     |              |     |       | вставлен во все           |
|     |     |              |     |       | преобразования каналов    |
|     |     |              |     |       | группы инъекции, а затем  |
|     |     |              |     |       | продолжить преобразование |
|     |     |              |     |       | каналов группы правил     |
|     |     |              |     |       | позже; но преобразование  |
|     |     |              |     |       | каналов группы правил не  |
|     |     |              |     |       | будет вставлено при       |
|     |     |              |     |       | преобразовании каналов    |
|     |     |              |     |       | группы инъекции           |
+-----+-----+--------------+-----+-------+---------------------------+
|     |     |              | 1   | ADON  | Режим одиночного          |
|     |     |              |     | по    | сканирования: выполняет   |
|     |     |              |     | зиция | одиночное преобразование  |
|     |     |              |     | 1 или | всех выбранных каналов    |
|     |     |              |     | метод | группы правил (ADC_RSQRx) |
|     |     |              |     | вне   | или всех каналов группы   |
|     |     |              |     | шнего | инъекции (ADC_ISQR)       |
|     |     |              |     | три   | последовательно по        |
|     |     |              |     | ггера | одному. Автоматический    |
|     |     |              |     |       | метод инъекции: После     |
|     |     |              |     |       | того как завершится       |
|     |     |              |     |       | преобразование канала     |
|     |     |              |     |       | группы правил,            |
|     |     |              |     |       | автоматически начнется    |
|     |     |              |     |       | преобразование каналов    |
|     |     |              |     |       | группы инъекции           |
+-----+-----+--------------+-----+-------+---------------------------+
|     | 0   | 1 (RDISCEN и | 0   | Метод | Режим единичной           |
|     |     | IDISCEN не   |     | вне   | прерывистой работы:       |
|     |     | могут        |     | шнего | Каждый раз, когда         |
|     |     | одновременно |     | при   | начинается событие,       |
|     |     | быть равны   |     | ггера | выполняется короткая      |
|     |     | 1)           |     |       | последовательность        |
|     |     |              |     |       | переходов номеров каналов |
|     |     |              |     |       | (количество определено    |
|     |     |              |     |       | DISCNUM\[2:0\]), и ее     |
|     |     |              |     |       | нельзя перезапускать,     |
|     |     |              |     |       | пока не будут завершены   |
|     |     |              |     |       | все выбранные переходы    |
|     |     |              |     |       | каналов.                  |
|     |     |              |     |       |                           |
|     |     |              |     |       | *Примечание: Управляющие  |
|     |     |              |     |       | биты IDISCEN и RDISCEN    |
|     |     |              |     |       | выбираются соответственно |
|     |     |              |     |       | для группы правил и       |
|     |     |              |     |       | группы инъекции, и режим  |
|     |     |              |     |       | прерывистой работы не     |
|     |     |              |     |       | может быть настроен       |
|     |     |              |     |       | одновременно для группы   |
|     |     |              |     |       | правил и группы инъекции* |
+-----+-----+--------------+-----+-------+---------------------------+
|     |     |              | 1   | \-    | Отключение этого режима   |
+-----+-----+--------------+-----+-------+---------------------------+
|     | 1   | 1            | X   | \-    | Такого режима нет         |
+-----+-----+--------------+-----+-------+---------------------------+
| 1   | 0   | 0            | 0   | ADON  | Непрерывный режим одного  |
|     |     |              |     | по    | канала/сканирования:      |
|     |     |              |     | зиция | повторять новый цикл      |
|     |     |              |     | 1 или | переходов в конце каждого |
|     |     |              |     | метод | цикла до тех пор, пока    |
|     |     |              |     | вне   | CONT не очистит 0 для     |
|     |     |              |     | шнего | завершения                |
|     |     |              |     | три   |                           |
|     |     |              |     | ггера |                           |
+-----+-----+--------------+-----+-------+---------------------------+
|     | 1   | 0            | 0   |       |                           |
+-----+-----+--------------+-----+-------+---------------------------+
|     |     |              | 1   |       |                           |
+-----+-----+--------------+-----+-------+---------------------------+

> *Примечание: Внешние события запуска для обычных групп и групп
> инъекции различаются, и бит \'**ACON**\' может инициировать только
> преобразование канала обычной группы, поэтому события инициации для
> преобразования каналов обычной группы и группы инъекции являются
> независимыми.*

####  1) Единичный одноканальный режим преобразования 

> В этом режиме выполняется только одно преобразование для текущего
> канала. Этот режим выполняет преобразование канала, который
> отсортирован первым в обычной группе или группе инъекции, где он
> инициируется установкой бита **ADON** в положении 1 регистра
> **ADC_CTLR2** (только для каналов обычной группы) или может быть
> инициирован внешним запуском (для каналов обычной группы или каналов
> инъекции). После завершения преобразования выбранного канала оно
> завершится. Если преобразование выполняется для канала обычной группы,
> данные преобразования сохраняются в 16-битном регистре **ADC_RDATAR**,
> устанавливается флаг **EOC**, и вызывается прерывание АЦП, если
> установлен бит **EOCIE**. Если преобразование выполняется для канала
> группы инъекции, данные преобразования сохраняются в 16-битном
> регистре **ADC_IDATAR1**, устанавливаются флаги **EOC** и **JEOC**, и
> возникает прерывание АЦП, если установлены биты **JEOCIE** или
> **EOCIE**.

####  2) Преобразование в режиме однократного сканирования

> Режим сканирования АЦП включается путем установки бита **SCAN** в
> регистре **ADC_CTLR1** в 1. Этот режим используется для сканирования
> группы аналоговых каналов и выполнения однократного преобразования для
> всех каналов, выбранных регистром **ADC_RSQRx** (для обычных каналов)
> или **ADC_ISQR** (для каналов инъекции), по одному, и следующий канал
> в той же группе преобразуется автоматически, когда завершается
> преобразование текущего канала. В режиме сканирования существует
> разделение на режимы запуска инъекции и автоматической инъекции в
> зависимости от состояния бита **JAUTO**.

-   **Запуск инъекции**

> Бит **JAUTO** равен 0. Когда во время сканирования каналов обычной
> группы происходит событие запуска преобразования канала группы
> инъекции, текущее преобразование сбрасывается, и последовательность
> каналов инъекции выполняется в одном сканировании, и прерванное
> преобразование последнего канала обычной группы возобновляется после
> завершения сканирующего преобразования всех выбранных каналов группы
> инъекции.
>
> Если во время текущего сканирования последовательности каналов группы
> инъекции происходит событие начала преобразования канала обычной
> группы, преобразование группы инъекции не прерывается, но
> последовательность преобразований правила выполняется повторно после
> завершения последовательности преобразований инъекции.
>
> *Примечание: При использовании преобразований с запуском инъекции
> необходимо обеспечить, чтобы интервал между событиями запуска был
> больше, чем сама последовательность инъекции. Например, если общее
> время, необходимое для завершения преобразования последовательности
> инъекции, составляет 28 **ADCCLK**, то минимальное значение интервала
> событий для запуска канала инъекции равно 29 **ADCCLK**.*

-   **Автоматическая инъекция**

> Бит **JAUTO** установлен в 1, и преобразование выбранного канала
> группы инъекции выполняется автоматически после сканирования всех
> каналов, выбранных для преобразования группой правил. Этот метод
> позволяет преобразовать до 20 последовательностей преобразований в
> регистрах **ADC_RSQRx** и **ADC_ISQR**. В этом режиме внешняя
> активация канала инъекции должна быть отключена (**IEXTTRIG
> JEXTTRIG**=0).
>
> *Примечание: Для коэффициента предварительного масштабирования
> тактовой частоты АЦП (**ADCPRE**\[1:0\]), равного 4--8, автоматически
> вставляется интервал 1 **ADCCLK** при переключении с обычного
> преобразования на последовательность инъекции или с преобразования
> инъекции на последовательность правил; когда коэффициент
> предварительного масштабирования тактовой частоты составляет 2,
> вводится задержка в два интервала **ADCCLK**.*

####  3) Преобразование в режиме единичного прерывистого режима 

> Режимом прерывистой работы для обычной группы или группы инъекции
> управляет установка бита **RDISCEN** или **IDISCEN** в регистре
> **ADC_CTLR1** в 1. Этот режим отличается от сканирования полного
> набора каналов в режиме сканирования, но делит набор каналов на
> несколько коротких последовательностей, и каждое внешнее событие
> запуска выполнит короткую последовательность переходов сканирования.
> Длина короткой последовательности n (n \<= 8) определяется в
> **DISCNUM**\[2:0\] регистра **ADC_CTLR1**, когда **RDISCEN** равно 1,
> это означает прерывающийся режим работы для группы правил, а общая
> длина для преобразования определяется в **L**\[3:0\]. в регистре
> **ADC_RSQR1**; когда **IDISCEN** установлено на 1, это прерывающаяся
> работа для группы инъекции, и общая длина для конвертации определяется
> в **JL**\[1:0\] в регистре **ADC_ISQR**. Невозможно установить оба
> режима для обычной и группы инъекций в прерывистом режиме.
>
> Пример прерывистого режима работы для обычной группы.
>
> **RDISCEN**=1, **DISCNUM**\[2:0\]=3, **L**\[3:0\]=8, каналы для
> преобразования = 1, 3, 2, 5, 8, 2, 7
>
> Первый внешний триггер: последовательность преобразований: 1, 3, 2
>
> Второй внешний триггер: последовательность преобразований: 5, 8, 4
>
> Третий внешний триггер: последовательность преобразований: 10, 6, при
> генерации событий **EOC**
>
> Четвертый внешний триггер: последовательность преобразований: 1, 3, 2
>
> **IDISCEN**=1, **DISCNUM**\[2:0\]=1, **JL**\[1:0\]=3, каналы для
> преобразования: 1, 3, 2
>
> Первый внешний триггер: последовательность преобразований: 1
>
> Второй внешний триггер: последовательность преобразований: 3
>
> Третий внешний триггер: преобразуются каналы: 2, генерируются события
> **EOC** и **JEOC**
>
> Четвертый внешний триггер: начинается новая последовательность
> преобразований: 1
>
> *Примечание:*

1.  *При преобразовании обычной группы или группы инъекции в прерывистом
    режиме последовательность преобразований не начинает автоматически
    начинаться с самого начала после завершения. Когда все подгруппы
    были преобразованы, следующее событие триггера запускает
    преобразование первой подгруппы.*

2.  *Вы не можете одновременно использовать автоинъекцию (**JAUTO**=1) и
    прерывистый режим.*

3.  *Вы не сможете настроить прерываемый режим как для обычных групп,
    так и для групп инъекции, и вы можете использовать прерывистую
    работу только для одной группы преобразований.*

####  4) Непрерывное преобразование 

> В режиме непрерывного преобразования новое преобразование начинается
> сразу после завершения предыдущего преобразования. Преобразование не
> останавливается на последнем канале выбранной группы, а продолжается с
> первого канала выбранной группы. Запускающими событиями в этом режиме
> являются внешние триггерные события, а бит **ADON** устанавливается
> в 1. После настройки запуска бит **CONT** должен быть установлен в 1.
>
> Если производится преобразование обычного канала, данные
> преобразования хранятся в регистре **ADC_RDATAR**, устанавливается
> флаг окончания преобразования **EOC**, и если установлен бит
> **EOCIE**, генерируется прерывание. При преобразовании канала инжекции
> данные преобразования сохраняются в регистре **ADC_IDATARx**,
> устанавливается флажок завершения преобразования **JEOC**, а если
> установлен флаг **JEOCIE**, создается прерывание.

### 9.2.5 Сторожевой таймер АЦП

> Флаг состояния аналогового сторожа (AWD) устанавливается, если
> аналоговое напряжение, которое преобразуется АЦП, ниже низкого порога
> или выше высокого порога. Настройки порогов находятся в десяти младших
> значащих разрядах регистров ADC_WDHTR и ADC_WDLTR. Бит AWDIE в
> регистре ADC_CTLR1 устанавливается для генерации соответствующего
> прерывания.
>
> Рисунок 9-4 Область порога сторожевого таймера АЦП

ADC_WDHTR

ADC_WDLTR

Нижний предупредительный порог

Верхний предупредительный порог

Зона предупреждения

Значения преобразования аналогового напряжения

> Настройте биты **AWDSGL**, **AWDEN**, **JAWDEN** и **AWDCH**\[4:0\] в
> регистре **ADC_CTLR1** для выбора канала для сигнализации аналогового
> сторожа, как показано в следующей таблице.

Таблица 9-6 Выбор канала аналогового сторожевого таймера

  -----------------------------------------------------------------------------
  Имитация канала оповещения        Биты                      
  сторожа                        управления                   
                                 регистром                    
                                 ADC_CTLR1                    
  ----------------------------- ------------ ------- -------- -----------------
                                   AWDSGL     AWDEN   JAWDEN    AWDCH\[4:0\]

  Отсутствие реакции               Ignore       0       0          Ignore

  Все инжектированные каналы         0          0       1          Ignore

  Все обычные каналы                 0          1       0          Ignore

  Все обычные и инжектированные      0          1       1          Ignore
  каналы                                                      

  Один инжектированый канал          1          0       1     Зависит от номера
                                                                   канала

  Один обычный канал                 1          1       0     Зависит от номера
                                                                   канала

  Один инжектированный и             1          1       1     Зависит от номера
  обычный канал                                                    канала
  -----------------------------------------------------------------------------

## 9.3 Описание регистров 

> Таблица 9-7 Список регистров, связанных с АЦП

  --------------------------------------------------------------------------------
  **Наименование**   **Адрес**    **Описание**                        **Значение
                                                                      сброса**
  ------------------ ------------ ----------------------------------- ------------
  R32_ADC_STATR      0x40012400   ADC регистр статуса                 0x00000000

  R32_ADC_CTLR1      0x40012404   ADC регистр управления 1            0x02000000

  R32_ADC_CTLR2      0x40012408   ADC регистр управления 2            0x00000000

  R32_ADC_SAMPTR1    0x4001240C   ADC регистр времени выборки 1       0x00000000

  R32_ADC_SAMPTR2    0x40012410   ADC регистр времени выборки 2       0x00000000

  R32_ADC_IOFR1      0x40012414   ADC регистр смещения данных канала  0x00000000
                                  инъекции 1                          

  R32_ADC_IOFR2      0x40012418   ADC регистр смещения данных канала  0x00000000
                                  инъекции 2                          

  R32_ADC_IOFR3      0x4001241C   ADC регистр смещения данных канала  0x00000000
                                  инъекции 3                          

  R32_ADC_IOFR4      0x40012420   ADC регистр смещения данных канала  0x00000000
                                  инъекции 4                          

  R32_ADC_WDHTR      0x40012424   ADC Регистр верхнего порога         0x000003FF
                                  сторожевого таймера                 

  R32_ADC_WDLTR      0x40012428   ADC Регистр нижнего порога          0x00000000
                                  сторожевого таймера                 

  R32_ADC_RSQR1      0x4001242C   ADC Регистр регулярной              0x00000000
                                  последовательности 1                

  R32_ADC_RSQR2      0x40012430   ADC Регистр регулярной              0x00000000
                                  последовательности 2                

  R32_ADC_RSQR3      0x40012434   ADC Регистр регулярной              0x00000000
                                  последовательности 3                

  R32_ADC_ISQR       0x40012438   ADC Регистр инжектируемой           0x00000000
                                  последовательности                  

  R32_ADC_IDATAR1    0x4001243C   ADC Регистр инжектируемых данных 1  0x00000000

  R32_ADC_IDATAR2    0x40012440   ADC Регистр инжектируемых данных 2  0x00000000

  R32_ADC_IDATAR3    0x40012444   ADC Регистр инжектируемых данных 3  0x00000000

  R32_ADC_IDATAR4    0x40012448   ADC Регистр инжектируемых данных 4  0x00000000

  R32_ADC_RDATAR     0x4001244C   ADC Регистр регулярных данных       0x00000000

  R32_ADC_DLYR       0x40012450   ADC Регистр задержанных данных      0x00000000
  --------------------------------------------------------------------------------

### 9.3.1 ADC Регистр статуса (ADC_STATR) 

Смещение адреса: 0x00

  --------------------------------------------------------------------------------------------
     31     30   29   28   27   26   25   24   23   22   21    20     19      18    17    16
  -------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ------ ------- ------ ----- -----
   Резерв                                                                                

     15     14   13   12   11   10   9    8    7    6    5     4       3      2      1     0

   Резерв                                                     STRT   JSTRT   JEOC   EOC   AWD
  --------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                 Значение
                                                                                           сброса
  ---------- ---------- -------- ------------------ ------------------------------------ ----------
   \[31:5\]     Res        RO    Резерв                                                      0

    \[4\]       STRT      RW0    Состояние начала                                            0
                                 перехода канала                                         
                                 правила                                                 

                                 1:                 Преобразование канала правила было   
                                                    начато                               

                                 0:                 Преобразование канала правила не     
                                                    было начато                          

                                 Этот бит                                                
                                 устанавливается в                                       
                                 1 аппаратурой и                                         
                                 сбрасывается в 0                                        
                                 программно (запись                                      
                                 1 недействительна)                                      

    \[3\]      JSTRT      RW0    Состояние начала                                            0
                                 преобразования                                          
                                 канала инъекции                                         

                                 1:                 Преобразование канала инъекции было  
                                                    начато                               

                                 0:                 Преобразование канала инъекции не    
                                                    было начато                          

                                 Этот бит                                                
                                 устанавливается в                                       
                                 1 аппаратурой и                                         
                                 сбрасывается в 0                                        
                                 программно (запись                                      
                                 1 недействительна)                                      

    \[2\]       JEOC      RW0    Состояние                                                   0
                                 завершения                                              
                                 преобразования                                          
                                 группы каналов                                          
                                 инъекции                                                

                                 1:                 Преобразование завершено             

                                 0:                 Преобразование не завершено          

                                 Этот бит                                                
                                 устанавливается в                                       
                                 1 аппаратурой (все                                      
                                 каналы инъекции                                         
                                 были                                                    
                                 преобразованы) и                                        
                                 сбрасывается в 0                                        
                                 программно (запись                                      
                                 1 недействительна)                                      

    \[1\]       EOC       RW0    Состояние                                                   0
                                 завершения                                              
                                 преобразования                                          

                                 1:                 Преобразование завершено             

                                 0:                 Преобразование не завершено          

                                 Этот бит                                                
                                 устанавливается в                                       
                                 1 аппаратурой                                           
                                 (завершение                                             
                                 преобразования                                          
                                 группы каналов                                          
                                 правил или                                              
                                 инъекции),                                              
                                 сбрасывается в 0                                        
                                 программно (запись                                      
                                 1 недействительна)                                      
                                 или при чтении                                          
                                 ADC_RDATAR.                                             

    \[0\]       AWD       RW0    Бит флага                                                   0
                                 аналогового                                             
                                 сторожевого                                             
                                 таймера                                                 

                                 1:                 Возникновение событий имитируемого   
                                                    сторожевого таймера                  

                                 0:                 Нет события имитируемого сторожевого 
                                                    таймера произошло                    

                                 Этот бит                                                
                                 устанавливается в                                       
                                 1 аппаратурой                                           
                                 (значение                                               
                                 преобразования                                          
                                 выходит за пределы                                      
                                 диапазона                                               
                                 регистров                                               
                                 ADC_WDHTR и                                             
                                 ADC_WDLTR) и                                            
                                 сбрасывается в 0                                        
                                 программно (запись                                      
                                 1 недействительна)                                      
  -------------------------------------------------------------------------------------------------

### 9.3.2 ADC Регистр управления 1 (ADC_CTLR1) 

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------------------------------------
     31      30   29     28        27       26       25      24      23       22       21      20     19   18   17   16
  --------- ---- ---- --------- -------- -------- -------- ------ -------- -------- -------- ------- ---- ---- ---- ----
   Резерв                                 CALVOL            Рез.   AWDEN    JAWDEN   Резерв                         

     15      14   13     12        11       10       9       8       7        6        5        4     3    2    1    0

   DISCNUM             JDISCEN   DISCEN   JAUTO    AWDSGL   SCAN   JEOCIE   AWDIE    EOCIE    AWDCH                 
  ----------------------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                Значение
                                                                                           сброса
  ----------- ---------- -------- ---------------- ------------------------------------- ----------
   \[31:27\]     Res        RO    Резерв                                                     0

   \[26:25\]    CALVOL      RW    Выбор                                                     01b
               \[1:0\]            калибровочного                                         
                                  напряжения                                             

                                  01:              Калибровочное напряжение 2/4 от AVDD  

                                  10:              Калибровочное напряжение 3/4 от AVDD  

                                  XX:              Недопустимо                           

    \[24\]       Res        RO    Резерв                                                     0

      23        AWDEN       RW    Бит включения                                              0
                                  функции                                                
                                  аналогового                                            
                                  сторожевого                                            
                                  таймера на                                             
                                  управляющем                                            
                                  канале                                                 

                                  1:               Включить аналоговый сторожевой таймер 
                                                   на управляющем канале                 

                                  0:               Отключить аналоговый сторожевой       
                                                   таймер на управляющем канале          

    \[22\]      JAWDEN      RW    Бит включения                                              0
                                  функции                                                
                                  аналогового                                            
                                  сторожевого                                            
                                  таймера на                                             
                                  канале инъекции                                        

                                  1:               Включить аналоговый сторожевой таймер 
                                                   на канале инъекции                    

                                  0:               Отключить аналоговый сторожевой       
                                                   таймер на канале инъекции             

    \[24\]       Res        RO    Резерв                                                     0

   \[15:13\]   DISCNUM      RW    Количество                                                 0
               \[2:0\]            управляющих                                            
                                  каналов, которые                                       
                                  будут                                                  
                                  преобразованы                                          
                                  после внешнего                                         
                                  запуска в                                              
                                  прерывистом                                            
                                  режиме                                                 

                                  000:             Канал 1                               

                                  ...                                                    

                                  111:             Канал 8                               

      12       JDISCEN      RW    Бит включения                                              0
                                  прерывистого                                           
                                  режима                                                 
                                  (intermittent                                          
                                  mode) на канале                                        
                                  инъекции                                               

                                  1:               Включить прерывистый режим на канале  
                                                   инъекции                              

                                  0:               Отключить прерывистый режим на канале 
                                                   инъекции                              

    \[11\]      DISCEN      RW    Бит включения                                              0
                                  прерывистого                                           
                                  режима                                                 
                                  (intermittent                                          
                                  mode) на                                               
                                  управляющем                                            
                                  канале                                                 

                                  1:               Включает прерывистый режим на         
                                                   управляющем канале                    

                                  0:               Отключает прерывистый режим на        
                                                   управляющем канале                    

    \[10\]      JAUTO       RW    После завершения                                           0
                                  открытия                                               
                                  управляющего                                           
                                  канала бит                                             
                                  разрешения                                             
                                  группы каналов                                         
                                  инъекции                                               
                                  автоматически                                          
                                  переключается                                          

                                  1:               Разрешить автоматическое переключение 
                                                   группы каналов инъекции               

                                  0:               Запретить автоматическое              
                                                   преобразование группы каналов         
                                                   инъекции                              

                                  *Примечание:                                           
                                  Этот режим                                             
                                  требует                                                
                                  отключения                                             
                                  функции внешнего                                       
                                  триггера для                                           
                                  канала инъекции*                                       

     \[9\]      AWDSGL      RW    В режиме                                                   0
                                  сканирования                                           
                                  используйте бит                                        
                                  включения                                              
                                  аналогового                                            
                                  сторожевого                                            
                                  таймера на одном                                       
                                  канале                                                 

                                  1:               Использовать аналоговый сторожевой    
                                                   таймер на одном канале (выбор         
                                                   AWDCH\[4:0\])                         

                                  0:               Использовать аналоговый сторожевой    
                                                   таймер на всех каналах                

     \[8\]       SCAN       RW    Бит включения                                              0
                                  режима                                                 
                                  сканирования                                           

                                  1:               Включить режим сканирования           
                                                   (непрерывное преобразование всех      
                                                   выбранных каналов ADC_IOFRx и         
                                                   ADC_RSQRx)                            

                                  0:               Отключить режим сканирования          

     \[7\]      JEOCIE      RW    Бит разрешения                                             0
                                  прерывания по                                          
                                  завершению                                             
                                  преобразования                                         
                                  группы каналов                                         
                                  инъекции                                               

                                  1:               Разрешить генерацию прерывания при    
                                                   завершении преобразования группы      
                                                   каналов инъекции (флаг IEOC JEOC)     

                                  0:               Запретить генерацию прерывания        
                                                   завершения преобразования группы      
                                                   каналов инъекции                      

     \[6\]      AWDIE       RW    Бит разрешения                                             0
                                  прерывания                                             
                                  аналогового                                            
                                  сторожевого                                            
                                  таймера                                                

                                  1:               Разрешить прерывание аналогового      
                                                   сторожевого таймера                   

                                  0:               Запретить прерывание аналогового      
                                                   сторожевого таймера                   

                                  *ПРИМЕЧАНИЕ: В                                         
                                  режиме                                                 
                                  сканирования это                                       
                                  прерывание                                             
                                  остановит                                              
                                  сканирование,                                          
                                  если оно                                               
                                  произойдет*                                            

     \[5\]      EOCIE       RW    Бит разрешения                                             0
                                  прерывания по                                          
                                  окончанию                                              
                                  преобразования                                         
                                  (группа каналов                                        
                                  правила или                                            
                                  инъекции)                                              

                                  1:               Разрешить прерывание по окончанию     
                                                   преобразования (флаг EOC)             

                                  0:               Запретить прерывание по окончанию     
                                                   преобразования                        

    \[4:0\]     AWDCH       RW    Биты выбора                                                0
               \[4:0\]            канала                                                 
                                  аналогового                                            
                                  сторожевого                                            
                                  таймера                                                

                                  00000:                                                 
                                  Аналоговый                                             
                                  входной канал 0                                        

                                  \*\*\*                                                 

                                  01111:                                                 
                                  Аналоговый                                             
                                  входной канал 15                                       
  -------------------------------------------------------------------------------------------------

### 9.3.3 ADC Регистр управления 2 (ADC_CTLR2) 

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------------------------------------------
      31        30      29   28    27       26     25   24      23       22         21        20        19     18     17     16
  ---------- --------- ---- ---- ------- -------- ---- ----- -------- --------- ---------- --------- -------- ----- ------ ------
    Резерв                                                             SWSTART   JSWSTART   EXTTRIG   EXTSEL                Рез.

      15        14      13   12    11       10     9     8      7         6         5          4        3       2     1      0

   JEXTTRIG   JEXTSEL             ALIGN   Резерв        DMA   Резерв                                  RSTCAL   CAL   CONT   ADON
  -------------------------------------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                    Значение
                                                                                               сброса
  ----------- ---------- -------- ---------------------- ----------------------------------- ----------
   \[31:23\]     Res        RO    Резерв                                                         0

    \[22\]     SWSTART      RW    Чтобы начать                                                   0
                                  преобразование                                             
                                  управляющего канала,                                       
                                  необходимо установить                                      
                                  программный триггер на                                     

                                  1:                     Инициировать преобразование         
                                                         управляющего канала                 

                                  0:                     Сброс состояния                     

                                  Этот бит                                                   
                                  устанавливается                                            
                                  программно и                                               
                                  сбрасывается аппаратно                                     
                                  до 0, когда начинается                                     
                                  преобразование.                                            

    \[21\]     JSWSTART     RW    Для инициирования                                              0
                                  перехода канала                                            
                                  инъекции установите                                        
                                  программный триггер                                        
                                  на:                                                        

                                  1:                     инициирует переход канала инъекции  

                                  0:                     сброс состояния                     

                                  Этот бит                                                   
                                  устанавливается                                            
                                  программно и                                               
                                  сбрасывается до 0                                          
                                  аппаратно или                                              
                                  программно при начале                                      
                                  преобразования.                                            

    \[20\]     EXTTRIG      RW    Разрешение режима                                              0
                                  перехода по внешнему                                       
                                  триггеру для                                               
                                  управляющего канала                                        

                                  1:                     Использование внешних событий для   
                                                         инициации преобразований            

                                  0:                     Отключение функции активации        
                                                         внешним событием                    

   \[19:17\]    EXTSEL      RW    Выбор внешнего события                                         0
               \[2:0\]            для инициирования                                          
                                  преобразования                                             
                                  управляющего канала                                        

                                  000:                   Событие TRGO таймера 1              

                                  001:                   Событие CC1 таймера 1               

                                  010:                   Событие CC2 таймера 1               

                                  011:                   Событие TRGO таймера 2              

                                  100:                   Событие CC1 таймера 2               

                                  101:                   Событие CC2 таймера 2               

                                  110:                   События PD3/PC2                     

                                  111:                   Программный триггер SWSTART         

    \[16\]       Res        RO    Резерв                                                         0

    \[15\]     JEXTTRIG     RW    Разрешение режима                                              0
                                  перехода по внешнему                                       
                                  триггеру для канала                                        
                                  инъекции                                                   

                                  1:                     Использование внешних событий для   
                                                         инициации преобразований            

                                  0:                     Отключение функции активации        
                                                         внешним событием                    

   \[14:12\]   JEXTSEL      RW    Выбор внешнего события                                         0
               \[2:0\]            для инициирования                                          
                                  преобразования канала                                      
                                  инъекции:                                                  

                                  000:                   Событие CC3 таймера 1               

                                  001:                   Событие CC4 таймера 1               

                                  010:                   Событие CC3 таймера 2               

                                  011:                   Событие CC4 таймера 2               

                                  100:                   Зарезервировано                     

                                  101:                   Зарезервировано                     

                                  110:                   PD1/PA2                             

                                  111:                   Программный триггер JSWSTART        

    \[11\]      ALIGN       RW    Выравнивание данных                                            0

                                  1:                     выравнивание по левому краю         

                                  0:                     выравнивание по правому краю        

   \[10:9\]      Res        RO    Резерв                                                         0

     \[8\]       DMA        RW    Режим прямого доступа                                          0
                                  к памяти (DMA):                                            

                                  1:                     Включить режим DMA                  

                                  0:                     Отключить режим DMA                 

    \[7:4\]      Res        RO    Резерв                                                         0

     \[3\]      RSTCAL      RW    Сброс калибровки: этот                                         0
                                  бит устанавливается                                        
                                  программно и очищается                                     
                                  аппаратно после                                            
                                  завершения сброса.                                         

                                  1:                     Инициализация регистров калибровки. 

                                  0:                     Регистр калибровки инициализирован. 

                                  Примечание: Если                                           
                                  RSTCAL установлен во                                       
                                  время выполнения                                           
                                  преобразования, для                                        
                                  очистки регистра                                           
                                  калибровки требуются                                       
                                  дополнительные циклы.                                      

     \[2\]       CAL        RW    Калибровка АЦП: этот                                           0
                                  бит устанавливается                                        
                                  программно и                                               
                                  сбрасывается аппаратно                                     
                                  в конце калибровки.                                        

                                  1:                     Начало калибровки.                  

                                  0:                     Калибровка завершена.               

     \[1\]       CONT       RW    Разрешение                                                     0
                                  непрерывного                                               
                                  преобразования:                                            

                                  1:                     Режим непрерывного преобразования.  

                                  0:                     Режим однократного преобразования.  

                                  Если этот бит                                              
                                  установлен,                                                
                                  преобразование будет                                       
                                  продолжаться до тех                                        
                                  пор, пока бит не будет                                     
                                  сброшен.                                                   

     \[0\]       ADON       RW    Включение/выключение                                           0
                                  АЦП                                                        

                                  Когда этот бит равен                                       
                                  0, запись 1 выведет                                        
                                  АЦП из режима                                              
                                  энергосбережения;                                          
                                  когда этот бит равен                                       
                                  1, запись 1 запустит                                       
                                  преобразование.                                            

                                  1:                     Включить АЦП и начать               
                                                         преобразование.                     

                                  0:                     Выключить преобразование/калибровку 
                                                         АЦП и перейти в режим               
                                                         энергосбережения.                   

                                  *Примечание:                                               
                                  Преобразование                                             
                                  инициируется только                                        
                                  тогда, когда                                               
                                  изменяется только бит                                      
                                  ADON в регистре, и                                         
                                  новое преобразование                                       
                                  не инициируется, если                                      
                                  изменяются какие-либо                                      
                                  другие биты.*                                              
  -----------------------------------------------------------------------------------------------------

*Примечание: Преобразование инициируется только тогда, когда изменяется
только ADON в регистре, и никакое новое преобразование не инициируется.*

### 9.3.4 ADC Регистр времени выборки 1 (ADC_SAMPTR1) 

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------------------------------------------------------------------
       31            30        29   28        27        26   25        24        23   22        21        20   19        18             17        16
  ------------ -------------- ---- ---- -------------- ---- ---- -------------- ---- ---- -------------- ---- ---- -------------- -------------- -----
     Резерв                                                                                                                        SMP15\[2:1\]  

       15            14        13   12        11        10   9         8         7    6         5         4    3         2              1          0

   SMP15\[0\]   SMP14\[2:0\]             SMP13\[2:0\]             SMP12\[2:0\]             SMP11\[2:0\]             SMP10\[2:0\]                 
  ----------------------------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:18\]       Res         RO    Резерв                                       0

   \[17:0\]    SMPx\[2:0\]     RW    SMPx\[2:0\]: конфигурация времени            0
                                     выборки для канала x.                    

                                     000: 3 цикла; 001: 9 циклов.             

                                     010: 15 циклов; 011: 30 циклов.          

                                     100: 43 цикла; 101: 57 циклов.           

                                     110: 73 цикла; 111: 241 цикл.            

                                     Эти биты используются для независимого   
                                     выбора времени выборки для каждого       
                                     канала, и значение конфигурации канала   
                                     должно оставаться постоянным в течение   
                                     цикла выборки.                           
  --------------------------------------------------------------------------------------

### 9.3.5 ADC Регистр времени выборки 2 (ADC_SAMPTR2) 

Смещение адреса: 0x00

  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      31           30            29        28       27            26        25       24            23        22       21            20        19       18            17        16
  ----------- ------------- ------------- ---- ------------- ------------- ---- ------------- ------------- ---- ------------- ------------- ---- ------------- ------------- -----
    Резерв                   SMP9\[2:0\]                      SMP8\[2:0\]                      SMP7\[2:0\]                      SMP6\[2:0\]                      SMP5\[2:1\]  

      15           14            13        12       11            10        9         8             7        6         5             4        3         2             1         0

   SMP5\[0\]   SMP4\[2:0\]                      SMP3\[2:0\]                      SMP2\[2:0\]                      SMP1\[2:0\]                      SMP0\[2:0\]                
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:30\]       Res         RO    Резерв                                       0

   \[29:0\]    SMPx\[2:0\]     RW    SMPx\[2:0\]: конфигурация времени            0
                                     выборки для канала x.                    

                                     000: 3 цикла; 001: 9 циклов.             

                                     010: 15 циклов; 011: 30 циклов.          

                                     100: 43 цикла; 101: 57 циклов.           

                                     110: 73 цикла; 111: 241 цикл.            

                                     Эти биты используются для независимого   
                                     выбора времени выборки для каждого       
                                     канала, и значение конфигурации канала   
                                     должно оставаться постоянным в течение   
                                     цикла выборки.                           
  --------------------------------------------------------------------------------------

### 9.3.6 ADC Регистр смещения данных инжектируемого канала x (ADC_IOFRx) (x=1/2/3/4) 

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------------
     31     30   29   28   27   26          25          24   23   22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ------------------ ---- ---- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                                      

     15     14   13   12   11   10          9           8    7    6    5    4    3    2    1    0

   Резерв                            JOFFSETx\[11:0\]                                          
  -------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                 Значение
                                                                            сброса
  ----------- ---------- -------- --------------------------------------- ----------
   \[31:10\]     Res        RO    Резерв                                      0

    \[9:0\]    JOFFSETx     RW    Значение смещения данных для канала         0
               \[11:0\]           инъекции x.                             

                                  При преобразовании каналов инъекции это 
                                  значение определяет величину, которая   
                                  вычитается из исходных данных           
                                  преобразования. Результат               
                                  преобразования можно прочитать в        
                                  регистре ADC_IDATARx.                   
  ----------------------------------------------------------------------------------

### 9.3.7 ADC Регистр верхнего порога сторожевого таймера (ADC_WDHTR) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------
     31     30   29   28   27   26      25       24   23   22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ----------- ---- ---- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                               

     15     14   13   12   11   10       9       8    7    6    5    4    3    2    1    0

   Резерв                            HT\[9:0\]                                          
  ------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
      Бит      Название    Доступ  Описание                                  Значение
                                                                              сброса
  ----------- ----------- -------- ---------------------------------------- ----------
   \[31:10\]      Res        RO    Резерв                                       0

    \[9:0\]    HT\[9:0\]     RW    Значение настройки высокого порога          3FFh
                                   аналогового сторожевого таймера          
  ------------------------------------------------------------------------------------

> *Примечание: Вы можете изменять значения WDHTR и WDLTR во время
> процесса преобразования, но они вступят в силу только при следующем
> преобразовании.*

### 9.3.8 ADC Регистр нижнего порога сторожевого таймера (ADC_WDLTR) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------
     31     30   29   28   27   26      25       24   23   22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- ----------- ---- ---- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                               

     15     14   13   12   11   10       9       8    7    6    5    4    3    2    1    0

   Резерв                            LT\[9:0\]                                          
  ------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------
      Бит      Название    Доступ  Описание                                  Значение
                                                                              сброса
  ----------- ----------- -------- ---------------------------------------- ----------
   \[31:10\]      Res        RO    Резерв                                       0

    \[9:0\]    LT\[9:0\]     RW    Значение настройки низкого порога            0
                                   аналогового сторожевого таймера          
  ------------------------------------------------------------------------------------

> *Примечание: Вы можете изменять значения WDHTR и WDLTR во время
> процесса преобразования, но они вступят в силу только при следующем
> преобразовании.*

### 9.3.9 ADC Регистр регулярной последовательности 1(ADC_RSQR1) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------------------------------------------
      31          30       29   28   27   26       25        24      23      22   21       20            19        18   17   16
  ----------- ----------- ---- ---- ---- ---- ------------- ---- ---------- ---- ---- ------------- ------------- ---- ---- ----
    Резерв                                                        L\[3:0\]                           SQ16\[4:1\]            

      15          14       13   12   11   10        9        8       7       6    5         4             3        2    1    0

   SQ16\[0\]   SQ16\[4:0                       SQ14\[4:0\]                             SQ13\[4:0\]                          
  ------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:10\]       Res         RO    Резерв                                       0

   \[23:20\]    L\[3:0\]       RW    Количество каналов, подлежащих               0
                                     преобразованию в обычной                 
                                     последовательности преобразования        
                                     каналов.\                                
                                     0000-1111: 1-16 преобразований.          

   \[19:15\]   SQ16\[4:0\]     RW    Номер 16-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

   \[14:10\]   SQ15\[4:0\]     RW    Номер 15-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

    \[9:5\]    SQ14\[4:0\]     RW    Номер 14-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

    \[4:0\]    SQ13\[4:0\]     RW    Номер 13-го канала преобразования в          0
                                     управляющей последовательности (0-9).    
  --------------------------------------------------------------------------------------

### 9.3.10 ADC Регистр регулярной последовательности 2(ADC_RSQR2) 

Смещение адреса: 0x00

  -----------------------------------------------------------------------------------------------------------------------------------------
      31           30           29        28   27   26       25           24        23   22   21       20           19        18   17   16
  ----------- ------------ ------------- ---- ---- ---- ------------ ------------- ---- ---- ---- ------------ ------------- ---- ---- ----
    Резерв                  SQ12\[4:0\]                               SQ11\[4:0\]                               SQ10\[4:1\]            

      15           14           13        12   11   10       9             8        7    6    5        4             3        2    1    0

   SQ10\[0\]   SQ9\[4:0\]                                SQ8\[4:0\]                                SQ7\[4:0\]                          
  -----------------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:30\]       Res         RO    Резерв                                       0

   \[29:25\]   SQ12\[4:0\]     RW    Номер 12-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

   \[24:20\]   SQ11\[4:0\]     RW    Номер 11-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

   \[19:15\]   SQ10\[4:0\]     RW    Номер 10-го канала преобразования в          0
                                     управляющей последовательности (0-9).    

   \[14:10\]   SQ9\[4:0\]      RW    Номер 9-го канала преобразования в           0
                                     управляющей последовательности (0-9).    

    \[9:5\]    SQ8\[4:0\]      RW    Номер 8-го канала преобразования в           0
                                     управляющей последовательности (0-9).    

    \[4:0\]    SQ7\[4:0\]      RW    Номер 7-го канала преобразования в           0
                                     управляющей последовательности (0-9).    
  --------------------------------------------------------------------------------------

### 9.3.11 ADC Регистр регулярной последовательности 3(ADC_RSQR3) 

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------------------------------------------------
      31          30           29       28   27   26       25           24       23   22   21       20           19       18   17   16
  ---------- ------------ ------------ ---- ---- ---- ------------ ------------ ---- ---- ---- ------------ ------------ ---- ---- ----
    Резерв                 SQ6\[4:0\]                               SQ5\[4:0\]                               SQ4\[4:1\]            

      15          14           13       12   11   10       9            8        7    6    5        4            3        2    1    0

   SQ4\[0\]   SQ3\[4:0\]                               SQ2\[4:0\]                               SQ1\[4:0\]                         
  -------------------------------------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------
      Бит       Название    Доступ  Описание                                  Значение
                                                                               сброса
  ----------- ------------ -------- ---------------------------------------- ----------
   \[31:30\]      Res         RO    Резерв                                       0

   \[29:25\]   SQ6\[4:0\]     RW    Номер 6-го канала преобразования в           0
                                    управляющей последовательности (0-9).    

   \[24:20\]   SQ5\[4:0\]     RW    Номер 5-го канала преобразования в           0
                                    управляющей последовательности (0-9).    

   \[19:15\]   SQ4\[4:0\]     RW    Номер 4-го канала преобразования в           0
                                    управляющей последовательности (0-9).    

   \[14:10\]   SQ3\[4:0\]     RW    Номер 3-го канала преобразования в           0
                                    управляющей последовательности (0-9).    

    \[9:5\]    SQ2\[4:0\]     RW    Номер 2-го канала преобразования в           0
                                    управляющей последовательности (0-9).    

    \[4:0\]    SQ1\[4:0\]     RW    Номер 1-го канала преобразования в           0
                                    управляющей последовательности (0-9).    
  -------------------------------------------------------------------------------------

### 9.3.12 ADC Регистр инжектируемой последовательности (ADC_ISQR) 

Смещение адреса: 0x00

  ---------------------------------------------------------------------------------------------------------------------------------
      31           30        29   28   27   26       25        24   23   22      21           20            19        18   17   16
  ----------- ------------- ---- ---- ---- ---- ------------- ---- ---- ---- ----------- ------------- ------------- ---- ---- ----
    Резерв                                                                    JL\[1:0\]                 JSQ4\[4:1\]            

      15           14        13   12   11   10        9        8    7    6        5            4             3        2    1    0

   ОSQ4\[0\]   JSQ3\[4:0\]                       JSQ2\[4:0\]                              JSQ1\[4:0\]                          
  ---------------------------------------------------------------------------------------------------------------------------------

  --------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                  Значение
                                                                                сброса
  ----------- ------------- -------- ---------------------------------------- ----------
   \[31:22\]       Res         RO    Резерв                                       0

   \[21:20\]    JL\[1:0\]      RW    Количество каналов, подлежащих               0
                                     преобразованию в последовательности      
                                     преобразования каналов инъекции.\        
                                     00-11: 1-4 преобразования.               

   \[19:15\]   JSQ4\[4:0\]     RW    Номер четвертого канала преобразования в     0
                                     последовательности инъекции (0-9).\      
                                     *Примечание: Программное обеспечение     
                                     записывает и назначает номер канала      
                                     (0-9) в качестве четвертого в            
                                     последовательности для преобразования.*  

   \[14:10\]   JSQ3\[4:0\]     RW    Номер третьего канала преобразования в       0
                                     последовательности инъекции (0-9).       

    \[9:5\]    JSQ2\[4:0\]     RW    Номер второго канала преобразования в        0
                                     последовательности инъекции (0-9).       

    \[4:0\]    JSQ1\[4:0\]     RW    Номер первого канала преобразования в        0
                                     последовательности инъекции (0-9).       
  --------------------------------------------------------------------------------------

> *Примечание: В отличие от обычной последовательности преобразований,
> если длина **JL**\[1:0\] меньше 4, порядок преобразования начинается с
> (4 - **JL**).*
>
> *Например, когда **JL**\[1:0\]=3 (4 инжектированных перехода в
> секвенсере), АЦП будет преобразовывать каналы в следующем порядке:
> **JSQ1**\[4:0\], **JSQ2**\[4:0\], **JSQ3**\[4:0\] и **JSQ4**\[4:0\].*
>
> *Когда **JL**\[1:0\]=2 (3 инжектированных перехода в секвенсере), АЦП
> будет преобразовывать каналы в следующем порядке: **JSQ2**\[4:0\],
> **JSQ3**\[4:0\] и **JSQ4**\[4:0\]; Когда **JL**\[1:0\]==1 (два
> инжектированных перехода в секвенсер), АЦП сначала преобразует
> **JSQ3**\[4:0\], а затем **JSQ4**\[4:0\].*
>
> *Когда **JL**\[1:0\] == 0 (одно инжектированное преобразование ввода в
> секвенсере), АЦП будет преобразовывать только каналы **JSQ4**\[4:0\].
> Если **ADCx_ISQR**\[21:0\]=10 00111 00011 00111 00010, АЦП преобразует
> каналы в следующем порядке: **JSQ2**\[4:0\], **JSQ3**\[4:0\], и
> **JSQ4**\[4:0\], указывая, что сканирующие преобразования выполняются
> в следующем порядке каналов: 7, 3, 7.*

### 9.3.13 ADC Регистр инжектируемых данных (ADC_IDATARx) (x=1/2/3/4) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------
        31         30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  --------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
      Резерв                                                                            

        15         14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   JDATA\[15:0\]                                                                        
  ------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                  Значение
                                                                             сброса
  ----------- ---------- -------- ---------------------------------------- ----------
   \[31:16\]     Res        RO    Резерв                                       0

   \[15:0\]     JDATA       RO    Данные преобразования канала инъекции        0
               \[15:0\]           (данные выровнены по левому или правому  
                                  краю).                                   
  -----------------------------------------------------------------------------------

### 9.3.14 ADC Регистр регулярных данных (ADC_RDATAR) 

Смещение адреса: 0x00

  -----------------------------------------------------------------------------------------
        31        30   29   28   27   26   25   24   23   22   21   20   19   18   17   16
  -------------- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ---- ----
      Резерв                                                                           

        15        14   13   12   11   10   9    8    7    6    5    4    3    2    1    0

   DATA\[15:0\]                                                                        
  -----------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                  Значение
                                                                             сброса
  ----------- ---------- -------- ---------------------------------------- ----------
   \[31:16\]     Res        RO    Резерв                                       0

   \[15:0\]      DATA       RO    Данные преобразования управляющего           0
               \[15:0\]           канала (данные выровнены по левому или   
                                  правому краю).                           
  -----------------------------------------------------------------------------------

### 9.3.15 ADC Регистр задержанных данных (ADC_DLYR) 

Смещение адреса: 0x00

  ---------------------------------------------------------------------------------------------------
     31     30   29   28   27   26     25           24         23   22   21   20   19   18   17   16
  -------- ---- ---- ---- ---- ---- --------- --------------- ---- ---- ---- ---- ---- ---- ---- ----
   Резерв                                                                                        

     15     14   13   12   11   10      9            8         7    6    5    4    3    2    1    0

   Резерв                            DLYSRC    DLYVLU\[8:0\]                                     
  ---------------------------------------------------------------------------------------------------

  -----------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                  Значение
                                                                             сброса
  ----------- ---------- -------- ---------------------------------------- ----------
   \[31:10\]     Res        RO    Резерв                                       0

     \[9\]      DLYSRC      RW    Выбор задержки источника внешнего            0
                                  триггера                                 

                                  0: Задержка внешнего триггера            
                                  управляющего канала                      

                                  1: Задержка внешнего триггера канала     
                                  инъекции                                 

    \[8:0\]     DLYVLU      RW    Данные задержки внешнего триггера,           0
               \[8:0\]            конфигурация времени задержки, единица:  
                                  тактовый цикл АЦП                        
  -----------------------------------------------------------------------------------

#  Глава 10. Таймер управления с расширенными функциями (ADTM) 

> Модуль таймера управления с расширенными функциями содержит мощный
> 16-битный таймер с авто перезагрузкой, TIM1, который может
> использоваться для измерения ширины импульса или генерации импульсов,
> ШИМ-сигналов и т.д. Он применяется в управлении двигателями,
> источниках питания и других приложениях.

## 10.1 Основные возможности 

> Основные особенности таймера управления с расширенными функциями TIM1
> включают:.

-   16-битный счетчик с авто перезагрузкой, поддерживающий режимы
    инкрементального режима счета, декрементального режима счёта и
    комбинированного инкрементально-декрементального режима.

-   16-битный прескейлер с динамически настраиваемыми коэффициентами
    деления от 1 до 65536.

-   Поддержка четырех независимых каналов сравнения/захвата.

-   Каждый канал сравнения/захвата поддерживает несколько режимов
    работы, таких как захват входных сигналов, сравнение выходных
    сигналов, генерация ШИМ-сигнала и однократная генерация импульса.

-   Комплементарные выходы с возможностью программирования мертвого
    времени (Dead Time).

-   Возможность управления таймером внешними сигналами.

-   Обновление состояния таймера через заданный интервал времени с
    использованием счетчика повторений.

-   Перезапуск таймера или установка его в состояние \"OK\" с помощью
    сигнала торможения.

-   Поддержка использования DMA в нескольких режимах.

-   Работа с инкрементальными энкодерами.

-   Каскадирование и синхронизация между несколькими таймерами.

## 10.2 Принципы и структура 

> Этот раздел посвящен внутреннему устройству таймеров управления с
> расширенными функциями (Advanced Control Timer).

### 10.2.1 Обзор 

> Как показано на Рисунке 10-1, структура таймера управления с
> расширенными функциями может быть условно разделена на три части: блок
> входного тактового сигнала, ядро счетчика и часть канала
> сравнения/захвата.
>
> Таймер управления с расширенными функциями может получать тактовый
> сигнал от шины HB (**CK_INT**), внешнего входа тактового сигнала
> (**TIMx_ETR**), других таймеров с выходом тактового сигнала (**ITRx**)
> или входа канала сравнения/захвата (**TIMx_CHx**). Эти сигналы после
> различных операций фильтрации и деления преобразуются в сигнал
> **CK_PSC**, который подается на секцию ядра счетчика. Кроме того, эти
> сложные источники тактовых сигналов могут также выводиться как **TRGO
> (Trigger Go)** для других периферийных устройств, таких как таймеры и
> АЦП.
>
> Центральным элементом таймера является 16-битный счетчик (**CNT**), на
> который поступает сигнал **CK_CNT**, полученный путем деления
> **CK_PSC** с помощью предделителя (**PSC**). Вспомогательный счетчик
> подсчитывает количество раз, когда регистр **ATRLR** загружает
> начальное значение в **CNT**, и генерирует определенное событие, когда
> достигнуто число, установленное в регистре повтора (**RPTCR**).
>
> У таймера имеется четыре набора каналов сравнения/захвата, каждый из
> которых может принимать импульсы с отдельных выводов или выводить
> сигналы на выводы, то есть каналы сравнения/захвата поддерживают как
> входной, так и выходной режимы. Вход каждого канала регистра захвата
> поддерживает операции фильтрации, деления и обнаружения фронтов,
> поддерживает взаимную активацию между каналами, а также обеспечивает
> тактовый сигнал для основного счетчика **CNT**. Каждый канал
> сравнения/захвата имеет набор регистров сравнения/захвата
> (**CHxCVR**), которые сравнивают значения с главным счетчиком
> (**CNT**) для формирования импульсных сигналов.
>
> .
>
> Рисунок 10-1. Блок-схема структуры таймера управления с расширенными
> функциями.
>
> ![](media/image20.png){width="6.370138888888889in"
> height="6.592361111111111in"}

###  10.2.2 Вход источника сигнала 

> Рисунок 10-2. Блок-схема источника сигнала **CK_PSC** для таймера
> управления с расширенными функциями.

**Encoder**

**mode**

**External clock**

**mode 1**

**External clock**

**mode 2**

**Internal clock**

**mode**

**CK_PSC**

**TI2F**

**TI1F**

**or**

**or**

**TRGI**

**ETRF**

**CK_INT**

**or**

**)**

**(**

**internal clock**

**TS\[2:0\]**

**TIMx_SMCR**

**xx**

**0**

**100**

**101**

**110**

**111**

**ITRx**

**[TI1_ED]{.underline}**

**[TI1FP1]{.underline}**

**TI2FP2**

**[ETRF]{.underline}**

**0**

**1**

**CC2P**

**TIMx_CCER**

**Edge**

**detector**

**[TI2F_Rising]{.underline}**

**TI2F_Falling**

**Filter**

**ICF\[3:0\]**

**TIMx_CCMR1**

**TI2**

**ETR pin**

**ETP**

**TIMx_SMCR**

**0**

**1**

**ETR**

**Divider**

**/1,/2,/4,/8**

**ETPS\[1:0\]**

**TIMx_SMCR**

**ETF\[3:0\]**

**TIMx_SMCR**

**ETRP**

**f**

**DTS**

**Filter**

**downcounter**

**ECE**

**TIMx_SMCR**

**SMS\[2:0\]**

> Для тактового сигнала **CK_PSC** таймера управления с расширенными
> функциями существует множество источников, которые можно разделить на
> 4 категории:

1.  Маршрут ввода тактового сигнала от внешнего вывода (**ETR**):
    **ETR** → **ETRP** → **ETRF**;

2.  Маршрут ввода внутреннего тактового сигнала APB: **CK_INT**;

3.  Маршрут от вывода канала сравнения/захвата (**TIMx_CHx**):
    **TIMx_CHx** → **TIx** → **TIxFPx**; этот маршрут также используется
    в режиме энкодера;

4.  Вход от других внутренних таймеров: **ITRx**;

> Реальная операция может быть разделена на 4 категории путем
> определения выбора входного импульса для источника **CK_PSC**:

1.  Выбор внутреннего тактового источника (**CK_INT**);

2.  Внешний тактовый источник, режим 1;

3.  Внешний тактовый источник, режим 2;

4.  Режим энкодера.

> Эти 4 операции позволяют выбирать любой из перечисленных выше 4
> источников тактового сигнала.

#### 10.2.2.1 Внутренний источник тактирования (CK_INT) 

> Если поле **SMS** удерживается в состоянии 000b для запуска таймера
> управления с расширенными функциями, то выбирается внутренний тактовый
> источник (**CK_INT**) в качестве тактового сигнала. В этом случае
> **CK_INT** становится **CK_PSC**.

#### 10.2.2.2 Внешний источник тактирования Mode 1 

Когда область **SMS** установлена в 111b, включается внешний тактовый
источник Mode 1. При активации внешнего тактового источника 1, в
качестве источника **CK_PSC** выбирается **TRGI**. Важно отметить, что
источник **TRGI** также должен быть выбран путем конфигурации области
**TS**. Область **TS** может выбрать следующие типы импульсов в качестве
источников тактового сигнала:

1)  Внутренние триггеры (**ITRx**, где x = 0, 1, 2, 3).

2)  Сигнал после прохождения через детектор фронта канала захвата 1
    (**TI1F_ED**).

3)  Сигналы **TI1FP1**, **TI2FP2** канала захвата.

4)  Сигнал **ETRF** от входа внешнего тактового вывода

#### 10.2.2.3 Внешний источник тактирования Mode 2 

> Используйте внешний режим триггера 2 для подсчета на каждом восходящем
> или нисходящем фронте входного сигнала внешнего тактового вывода.
> Когда позиция **ECE** установлена, используется внешний тактовый
> источник режима 2. При использовании внешнего тактового источника
> режима 2, в качестве **CK_PSC** выбирается **ETRF**. Пин **ETR**
> превращается в **ETRP** после прохождения через необязательный
> инвертор (**ETP**), делитель (**ETPS**), а затем в **ETRF** после
> прохождения через фильтр (**ETF**).
>
> При установке битов позиции **ECE** и **SMS** на 111b, это
> эквивалентно выбору **ETRF** в качестве входа областью **TS**

#### 10.2.2.4 Режим энкодера 

> Установка **SMS** на 001b, 010b или 011b включит режим энкодера.
> Включение режима энкодера позволяет выбрать определенный уровень в
> **TI1FP1** и **TI2FP2** для передачи сигнала с другим перепадом фронта
> в качестве сигнала. Этот режим используется при работе с внешним
> энкодером. За подробностями о конкретных функциях обратитесь к разделу
> 10.3.9

### 10.2.3 Счетчики и переферия 

> **CK_PSC** поступает на предделитель (**PSC**) для деления. **PSC**
> является 16-битным, и реальный коэффициент деления равен значению
> **R16_TIMx_PSC** + 1. **CK_PSC** проходит через **PSC** и становится
> **CK_INT**. Изменение значения **R16_TIM1_PSC** не вступает в силу
> немедленно, но обновляется в **PSC** после события обновления.
> Событием обновления является очистка и сброс бита **UG**. Ядро таймера
> представляет собой 16-битный счётчик (**CNT**). В конечном итоге
> **CK_CNT** подаётся на **CNT**, который поддерживает режимы
> инкрементного счёта, декрементного счёта и комбинированного
> инкрементно-декрементного счёта. Также имеется регистр автоматической
> перезагрузки (**ATRLR**), который перезагружает начальное значение для
> **CNT** в конце каждого цикла счёта. Есть также вспомогательный
> счётчик, который отслеживает количество раз, когда **ATRLR**
> перезагружал начальное значение для **CNT**, и может генерировать
> определённое событие, когда достигается количество раз, установленное
> в регистре счётчика повторений (**RPTCR**).

### 10.2.4 Каналы сравнения/захвата и периферии 

> Ядром таймера являются регистры сравнения/захвата, которые дополняются
> цифровой фильтрацией, делением частоты и мультиплексированием между
> каналами в секции входных периферийных компонентов, компаратором и
> управлением выхода в выходной секции.
>
> Рисунок 10-3. Блок-схема структуры канала сравнения/захвата
>
> ![](media/image21.png){width="6.352083333333334in"
> height="8.444444444444445in"}
>
> Блок-схема структуры канала сравнения/захвата показана на рисунке
> 10-3. Сигнал поступает с вывода канала x и опционально формируется как
> **TIx** (источником **TI1** может быть не только **CH1**, см.
> блок-схему структуры таймера 10-1), **TI1** проходит через фильтр
> (**ICF**\[3:0\]), формируя **TI1F**, затем делится на **TI1F_Rising**
> и **TI1FP_Falling** через детектор фронта, эти два сигнала выбираются
> (**CC1P**) для создания **TI1FP1**, **TI1FP1** и **TI2FP1** из второго
> канала отправляются вместе в **CC1S** для выбора и превращаются в
> **IC1**, который отправляется в регистр сравнения/захвата после
> деления **ICPS**.
>
> Регистр сравнения/захвата состоит из регистра предварительной загрузки
> и теневого регистра, а процесс чтения/записи выполняется только над
> регистром предварительной загрузки. В режиме захвата захват происходит
> в теневом регистре, а затем копируется в регистр предварительной
> загрузки; в режиме сравнения содержимое регистра предварительной
> загрузки копируется в теневой регистр, а затем содержимое теневого
> регистра сравнивается с основным счетчиком (**CNT**)

## 10.3 Функциональность и реализация

> Реализация сложных функций таймера управления с расширенными
> возможностями осуществляется посредством работы каналов
> сравнения/захвата таймера, схемы ввода тактового сигнала, счетчика и
> периферийных компонентов. Тактовый сигнал, подаваемый на таймер, может
> поступать из множества источников, включая ввод от канала
> сравнения/захвата. Работа канала сравнения/захвата и выбор источника
> тактового сигнала непосредственно определяют его функциональность.
> Канал сравнения/захвата является двунаправленным и может работать как
> в режиме ввода, так и в режиме вывода.

### 10.3.1 Режим захвата входа (Input Capture) 

> Режим захвата входного сигнала является одной из базовых функций
> таймера. Принцип работы режима захвата входного сигнала заключается в
> том, что событие захвата происходит, когда обнаруживается определенный
> фронт сигнала **ICxPS**, и текущее значение счетчика фиксируется в
> регистре сравнения/захвата (**R16_TIMx_CHCTLRx**). Когда происходит
> событие захвата, устанавливается флаг **CCxIF** (в
> **R16_TIMx_INTFR**), и если разрешено прерывание или DMA, генерируется
> соответствующее прерывание или запрос DMA. Если флаг **CCxIF** уже
> установлен, когда происходит событие захвата, то устанавливается бит
> **CCxOF**. Флаг **CCxIF** может быть сброшен программно или аппаратно
> при чтении регистра сравнения/захвата. Бит **CCxOF** сбрасывается
> программно. Пример использования режима захвата на входе для канала 1
> приведен ниже.

1.  Настройте область **CCxS** для выбора источника сигнала **ICx**.
    Например, установите значение 10b и выберите **TI1FP1** в качестве
    источника **IC1** вместо использования значений по умолчанию, где
    область **CCxS** по умолчанию делает модуль сравнения/захвата
    каналом вывода.

2.  Настройте область **ICxF** для установки цифрового фильтра для
    сигнала **TI**. Цифровой фильтр будет выборочно считывать сигнал с
    определенной частотой указанное количество раз, а затем выдавать
    скачок. Эта частота выборки и количество выборок определяется полем
    **ICxF**.

3.  Настройте бит **CCxP** для установки полярности сигнала **TIxFPx**.
    Например, оставьте бит **CC1P** низким и выберите переходы по
    нарастающему фронту.

4.  Настройте область **ICxPS** для установки коэффициента пересчета
    сигнала **ICx**. Например, оставляйте **ICxPS** равным 00b без
    пересчета.

5.  Настройте бит **CCxE** для разрешения записи значения основного
    счетчика (**CNT**) в регистр сравнения/захвата. Установите бит
    **CC1E**.

6.  Настройте биты **CCxIE** и **CCxDE** по мере необходимости, чтобы
    определить, следует ли разрешить прерывания или DMA. На этом
    завершается конфигурация канала сравнения/захвата.

> Когда захваченный импульс подается на **TI1**, значение основного
> счетчика (**CNT**) записывается в регистр сравнения/захвата,
> устанавливается бит **CC1IF**, и бит **CCIOF** устанавливается, если
> ранее был установлен бит **CC1IF**. Если установлен бит **CC1IE**, то
> генерируется прерывание; если установлен бит **CC1DE**, генерируется
> запрос DMA. Событие захвата на входе может быть сгенерировано
> программно путем записи в регистр генерации событий (**TIMx_SWEVGR**)
>
> .

### 10.3.2 Режимы выходного сравнения (Compare Output)

Режим выходного сравнения является одной из основных функций таймера.
Принцип работы этого режима заключается в том, что при совпадении
значения основного счетчика (**CNT**) со значением регистра
сравнения/захвата на выходе формируется конкретное изменение или волна.
Поле **OCxM** (в **R16_TIMx_CHCTLRx**) и бит **CCxP** (в
**R16_TIMx_CCER**) определяют, будет ли на выходе зафиксирован высокий
или низкий уровень, или же произойдет смена уровня. Бит **CCxIF** также
устанавливается, когда генерируется событие совпадения сравнения. Если
заранее установлен бит **CCxIE**, генерируется прерывание; если заранее
установлен бит **CCxDE**, генерируется запрос DMA.

Для настройки режима выходного сравнения выполните следующие действия:

4)  Настройте источник тактового сигнала и значение авто перезагрузки
    основного счетчика (**CNT**).

5)  Установите значение для сравнения в регистр сравнения/захвата
    (**R16_TIMx_CHxCVR**).

6)  Если требуется сгенерировать прерывание, установите бит **CCxIE**.

7)  Оставьте **OCxPE** равным 0, чтобы отключить регистр предварительной
    загрузки регистра сравнения.

8)  Настройте режим вывода, установив поле **OCxM** и бит **CCxP**.

9)  Включите вывод, установив бит **CCxE**.

10) Установите бит **CEN** для запуска таймера.

### 10.3.3 Режим принудительного вывода (Forced Output) 

> Шаблон вывода канала сравнения/захвата таймера может быть
> принудительно изменен программным обеспечением для вывода
> определенного уровня без необходимости сравнивать теневой регистр
> регистра сравнения/захвата с основным счетчиком. Для этого нужно
> установить **OCxM** в значение 100b, что приведет к принудительному
> снижению уровня **OCxREF**, или установить **OCxM** в 101b, чтобы
> принудительно повысить уровень **OCxREF**.
>
> Обратите внимание, что при принудительном установлении **OCxM**
> на 100b или 101b процесс сравнения внутренних основных счетчиков и
> регистров сравнения/захвата все равно продолжается, соответствующие
> флаги устанавливаются, и продолжают генерироваться прерывания и
> запросы DMA.

### 10.3.4 Режим входа ШИМ (PWM Input) 

> Режим ввода ШИМ используется для измерения коэффициента заполнения и
> частоты сигнала ШИМ и является специальным случаем режима захвата
> входного сигнала. Операция аналогична режиму захвата входного сигнала,
> за исключением следующих отличий: ШИМ занимает два канала
> сравнения/захвата, и полярность ввода этих двух каналов установлена
> противоположной, один из сигналов настроен как вход триггера, а
> **SMS** установлен в режим сброса.
>
> Например, чтобы измерить период и частоту входящего сигнала ШИМ от
> **TI1**, необходимы следующие операции.

1.  Установите **TI1** (**TI1FP1**) в качестве входа сигнала **IC1**.
    Установите **CC1S** на 01b.

2.  Установите **TI1FP1** на активный передний фронт. Держите **CC1P**
    на нуле.

3.  Установите **TI1** (**TI1FP2**) в качестве входа для сигнала
    **IC2**. Установите **CC2S** на 10b.

4.  Выберите **TI1FP2** для активного заднего фронта. Установите
    **CC2P** на 1.

5.  Выберите **TI1FP1** в качестве источника тактового сигнала.
    Установите **TS** на 101b.

6.  Установите **SMS** в режим сброса, то есть 100b.

7.  Разрешите захват входного сигнала. Устанавливайте **cc1e** и
    **cc2e**.

> Таким образом, значение регистра сравнения/захвата 1 является периодом
> ШИМ, а значение регистра сравнения/захвата 2 -- его коэффициентом
> заполнения.

### 10.3.5 Режим выхода ШИМ (PWM Output) 

> Режим вывода ШИМ является одной из базовых функций таймера. Режим
> вывода ШИМ чаще всего используется для определения частоты ШИМ с
> помощью значения перезагрузки и коэффициента заполнения с
> использованием регистра сравнения/захвата. Чтобы использовать режим
> ШИМ 1 или 2, установите 110b или 111b в поле **OCxM**, установите бит
> **OCxPE** для включения регистра предварительной загрузки и, наконец,
> установите бит **ARPE** для разрешения автоматической перезагрузки
> регистра предварительной загрузки. Поскольку значение регистра
> предварительной загрузки может быть отправлено в теневой регистр
> только при возникновении события обновления, необходимо установить бит
> **UG** для инициализации всех регистров перед началом счета основным
> счетчиком. В режиме ШИМ основной счетчик и регистр сравнения/захвата
> всегда находятся в процессе сравнения, и в зависимости от бита **CMS**
> таймер способен выводить сигналы ШИМ, выровненные по краю или центру.
>
> **Выравнивание по краю**
>
> При использовании выравнивания по краю основной счетчик увеличивается
> или уменьшается, и в сценарии режима ШИМ 1 **OCxREF** находится в
> высоком состоянии, когда значение основного счетчика больше, чем у
> регистра сравнения/захвата, и переходит в низкое состояние, когда оно
> меньше (например, когда основной счетчик достигает значения
> **R16_TIMx_ATRLR** и возвращается к нулевым значениям).
>
> **Центровка**
>
> При использовании центрированных режимов основной счетчик работает в
> чередующихся режимах инкрементного и декрементного счета, и **OCxREF**
> совершает подъемы и спады, когда значения основного счетчика и
> регистра сравнения/захвата совпадают. Однако флаги сравнения
> устанавливаются в разное время в трех центральных режимах
> выравнивания. При использовании центрально выровненных режимов
> рекомендуется сгенерировать флаг программного обновления (установить
> бит **UG**) перед запуском основного счетчика.

### 10.3.6 Комплиментарные выходы и мертвые зоны (Complementary Outputs and Dead Zones)

> Канал сравнения/захвата обычно имеет два выходных контакта (у
> четвертого канала сравнения/захвата есть только один выходной
> контакт), и он может выводить два комплементарных сигнала (**OCx** и
> **OCxN**). Для **OCx** и **OCxN** можно независимо настроить
> полярность с помощью битов **CCxP** и **CCxNP**, включить независимый
> вывод с помощью **CCxE** и **CCxNE**, а также независимо управлять
> выводом с помощью бит **MOE**, **OIS**, **OISN**, **OSSI** и **OSSR**
> для контроля мертвого времени и других параметров. Одновременное
> включение выходов **OCx** и **OCxN** вставляет зону задержки, и для
> каждого канала предусмотрен генератор зоны задержки на 10 бит. **OCx**
> и **OCxN** формируются на основе ассоциации с **OCxREF**. Если оба
> сигнала **OCx** и **OCxN** активны на высоком уровне, тогда **OCx**
> совпадает с **OCxREF**, за исключением того, что передний фронт
> **OCx** соответствует задержке относительно **OCxREF**, а **OCxN**
> является обратной величиной **OCxREF** таким образом, что его передний
> фронт будет иметь задержку относительно заднего фронта опорного
> сигнала. Если задержка превышает эффективную ширину выходного сигнала,
> соответствующий импульс не будет сгенерирован. На рис. 10-4 изображены
> отношения между **OCx**, **OCxN** и **OCxREF** с учетом зоны
> задержки.Начало формы
>
> Рисунок 10-4. Комплементарные выходы и зона задержки.Начало формы

### 10.3.7 Сигнал тормоза (Brake Signal)

Когда генерируется сигнал тормоза, сигнал разрешения вывода и
недействительный уровень модифицируются в соответствии с битами **MOE**,
**OIS**, **OISN**, **OSSI** и **OSSR**. Однако ни в какой момент времени
**OCx** и **OCxN** не будут находиться на активном уровне. Источник
события тормоза может исходить от вывода тормозного контакта или это
может быть событие отказа тактового сигнала, которое генерируется
системой безопасности тактового сигнала (**CSS**). После сброса системы
функция тормоза отключается по умолчанию (бит **MOE** установлен на
низкий уровень), а установка бита **BKE** включает функцию тормоза.
Полярность входного тормозного сигнала можно задать, установив **BKP**,
а сигналы **BKE** и **BKP** могут быть записаны одновременно, и перед
реальной записью есть задержка на один такт HB, поэтому вам нужно
подождать один цикл HB, чтобы правильно считать записанное значение. При
наличии выбранного уровня на контакте тормоза система выполнит следующие
действия.

1)  Биту **MOE** присваивается значение \"0\", и вывод устанавливается в
    неактивное, холостое или сбросовое состояние в зависимости от
    настройки бита **SOOI**.

2)  После очистки бита **MOE** каждый выходной канал выводит уровень,
    определяемый битом **OISx**.

3)  При использовании комплементарных выходов выходные данные переходят
    в нулевое состояние в соответствии с полярностью.

4)  Если установлен бит **BIE**, генерируется прерывание, когда
    установлен бит **BIF**; если установлен бит BDE, создается запрос
    DMA.

5)  Если установлено значение **AOE**, бит **MOE** автоматически
    устанавливается при следующем событии обновления **UEV**.

### 10.3.8 Режим одного импульса (Single Pulse) 

> Режим одиночного импульса позволяет микроконтроллеру реагировать на
> определенное событие, генерируя импульс после задержки, при этом длина
> и ширина импульса программируемые. Установка бита **OPM** позволяет
> основному счетчику останавливаться, когда генерируется следующее
> событие обновления **UEV** (счетчик сбрасывается до нуля).
>
> Как показано на Рисунке 10-5, на выходе OC1 необходимо сгенерировать
> положительный импульс длительностью Tpulse после задержки Tdelay при
> обнаружении переднего фронта на входе TI2.
>
> Рисунок 10-5. Генерация одиночного импульса.
>
> ![](media/image32.png){width="4.888888888888889in"
> height="3.092361111111111in"}

1.  Настройте **TI2** как триггер. Установите поле **CC2S** на 01b,
    чтобы сопоставить **TI2FP2** с **TI2**; установите бит **CC2P**
    на 0b, чтобы установить **TI2FP2** на детектирование переднего
    фронта; установите поле **TS** на 110b, чтобы установить **TI2FP2**
    в качестве источника триггера; установите поле **SMS** на 110b для
    использования **TI2FP2** для запуска счетчика.

2.  Задержка Tdelay определяется значением регистра захвата сравнения, а
    длительность Tpulse определяется значениями регистра автоматического
    перезагрузки и регистра захвата/сравнения.

### 10.3.9 Режим энкодера (Encoder) 

> Режим энкодера является типичным применением таймера и может
> использоваться для доступа к выходному сигналу энкодера с двумя
> фазами. Направление счета основного счетчика синхронизируется с
> направлением вращения оси энкодера, и каждый импульс, поступающий от
> энкодера, вызывает увеличение или уменьшение значения основного
> счетчика на единицу. Чтобы использовать энкодер, установите поле
> **SMS** на 001b (подсчёт только по переднему фронту
> **TI2**), 010b (счёт только по переднему фронту **TI1**)
> или 011b (учет обоих фронтов **TI1** и **TI2**). Подключите энкодер к
> входу каналов сравнения/захвата 1 и 2 и установите значение для
> регистра перезагрузки, которое может быть увеличено. В режиме энкодера
> внутренние регистры захвата сравнения, предельное деление, регистр
> повторного счёта и другие компоненты таймера работают нормально. В
> следующей таблице показаны взаимосвязь направления счёта с сигналом
> энкодера.
>
> Таблица 10-1. Взаимосвязь между направлением счёта таймера и сигналом
> энкодера в этом режиме.

  ------------------------------------------------------------------------------------
    Сонфигурация       Уровень        Фронт                     Фронт     
     эфективного     подчиненного    сигнала                   сигнала    
       фронта          сигнала        TI1FP                     TI2FP2    
  ----------------- -------------- ------------ ------------ ------------ ------------
                                    Позитивный   Негативный   Позитивный   Негативный
                                      фронт        фронт        фронт        фронт

   Счет только на      Высокий      Счет вниз    Счет вверх   Нет счета   
     фронте TI1                                                           

                        Низкий      Счет вверх   Счет вниз                

   Счет только на      Высокий      Нет счета                 Счет вверх   Счет вниз
     фронте TI2                                                           

                        Низкий                                Счет вниз    Счет вверх

    Счет по обеим      Высокий      Счет вниз    Счет вверх   Счет вверх   Счет вниз
  фронтам TI1 и TI2                                                       

                        Низкий      Счет вверх   Счет вниз    Счет вниз    Счет вверх
  ------------------------------------------------------------------------------------

### 10.3.10 Режим синхронизации таймеров 

> Таймеры способны генерировать тактовые импульсы (**TRGO**) и принимать
> входы от других таймеров (**ITRx**). Источники **ITRx** (**TRGO** от
> других таймеров) различаются для разных таймеров. Соединения
> внутренних триггеров таймера приведены в Таблице 10-2.
>
> Table 10-2 TIMx подключение внутренних триггеров

  --------------------------------------------------------------------------
  Подчиненный таймер ITR0 (TS=000) ITR0 (TS=001) ITR0 (TS=010) ITR0 (TS=011)
  ------------------ ------------- ------------- ------------- -------------
         TIM1                          TIM2                           

         TIM2            TIM1                                         
  --------------------------------------------------------------------------

### 10.3.11 Режим наладки 

> Когда система входит в режим отладки, таймер продолжает работу или
> останавливается в зависимости от настроек модуля DBG.

## 10.4 Описание регистров 

> Table 10-3 TIM1-related registers list

+----------------+--------+---------------------------------+---------+
| **             | **А    | **Описание**                    | **З     |
| Наименование** | дрес** |                                 | начение |
|                |        |                                 | с       |
|                |        |                                 | броса** |
+:===============+:======:+:================================+:=======:+
| R16_TIM1_CTLR1 | 0x40   | Регистр управления 1            | 0x0000  |
|                | 012C00 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_CTLR2 | 0x40   | Регистр управления 2            | 0x0000  |
|                | 012C04 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Регистр управления режимом      | 0x0000  |
| 16_TIM1_SMCFGR | 012C08 | ведомого устройства             |         |
+----------------+--------+---------------------------------+---------+
| R16_           | 0x40   | Регистр разрешения              | 0x0000  |
| TIM1_DMAINTENR | 012C0C | DMA/прерывания                  |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_INTFR | 0x40   | Регистр статуса прерывания      | 0x0000  |
|                | 012C10 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Регистр генерации событий       | 0x0000  |
| 16_TIM1_SWEVGR | 012C14 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R1             | 0x40   | Регистр управления              | 0x0000  |
| 6_TIM1_CHCTLR1 | 012C18 | сравнением/захватом 1           |         |
+----------------+--------+---------------------------------+---------+
| R1             | 0x40   | Регистр управления              | 0x0000  |
| 6_TIM1_CHCTLR2 | 012C1C | сравнением/захватом 2           |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_CCER  | 0x40   | Регистр разрешения              | 0x0000  |
|                | 012C20 | сравнения/захвата               |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_CNT   | 0x40   | Счётчики                        | 0x0000  |
|                | 012C24 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_PSC   | 0x40   | Прескейлер тактовой частоты     | 0x0000  |
|                | 012C28 | счёта                           |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_ATRLR | 0x40   | Регистр значения авто           | 0xFFFF  |
|                | 012C2C | перезагрузки                    |         |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_RPTCR | 0x40   | Регистра значения счётчика      | 0x0000  |
|                | 012C30 | повторов                        |         |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Регистрация сравнения/захвата 1 | 0x0     |
| 32_TIM1_CH1CVR | 012C34 |                                 | 0000000 |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Реестр сравнения/захвата 2      | 0x0     |
| 32_TIM1_CH2CVR | 012C38 |                                 | 0000000 |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Реал реестра сравнения/захвата  | 0x0     |
| 32_TIM1_CH3CVR | 012C3C | 3                               | 0000000 |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Редактор сравнения/захвата 4    | 0x0     |
| 32_TIM1_CH4CVR | 012C40 |                                 | 0000000 |
+----------------+--------+---------------------------------+---------+
| R16_TIM1_BDTR  | 0x40   | Реквизиты тормоза и мёртвого    | 0x0000  |
|                | 012C44 | времени                         |         |
+----------------+--------+---------------------------------+---------+
| R1             | 0x40   | Запись управления DMA           | 0x0000  |
| 6_TIM1_DMACFGR | 012C48 |                                 |         |
+----------------+--------+---------------------------------+---------+
| R              | 0x40   | Адрес записи DMA для            | 0x0000  |
| 16_TIM1_DMAADR | 012C4C | непрерывного режимаНачало формы |         |
|                |        |                                 |         |
|                |        | Конец формы                     |         |
+----------------+--------+---------------------------------+---------+

### 10.4.1 Регистр управления 1 (TIM1_CTLR1)

Смещение адреса: 0x00

  ----------------------------------------------------------------------------------------------------------------------------
  15       14         13     12   11   10  9            8               7           6        5  4     3     2     1      0
  -------- ------- -------- ---- ---- ---- ------------ --------------- ------ ------------ --- ----- ----- ----- ------ -----
  CAPLVL   CAPOV    Резерв                 CKD\[1:0\]   DLYVLU\[8:0\]   ARPE    CMS\[1:0\]      DIR   OPM   URS   UDIS   CEN

  ----------------------------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------------
      Бит       Название    Доступ  Описание                                                    Значение
                                                                                                 сброса
  ----------- ------------ -------- --------------------- ------------------------------------ ----------
    \[15\]       CAPLVL       RW    В режиме захвата по                                            0
                                    обоим фронтам включен                                      
                                    индикатор уровня                                           
                                    захвата                                                    

                                    0:                    Отключение функции индикации         

                                    1:                    Включение функции индикации          

                                    *Примечание: При                                           
                                    включении, бит \[16\]                                      
                                    регистра CHxCVR                                            
                                    указывает уровень,                                         
                                    соответствующий                                            
                                    захваченному                                               
                                    значению*                                                  

    \[14\]       CAPOV        RW    Конфигурация режима                                            0
                                    значения захвата                                           

                                    0:                    Значением захвата является текущее   
                                                          значение счетчика                    

                                    1:                    Значение CHxCVR равно 0xFFFF, когда  
                                                          переполнение счетчика генерируется   
                                                          до момента захвата                   

   \[13:10\]      Res         RO    Резерв                                                         0

    \[9:8\]    CKD\[1:0\]     RW    Эти два бита                                                   0
                                    определяют                                                 
                                    коэффициент деления                                        
                                    между частотой                                             
                                    тактовой частоты                                           
                                    таймера (CK_INT),                                          
                                    временем мертвого                                          
                                    состояния и тактовой                                       
                                    частотой выборки,                                          
                                    используемой                                               
                                    генератором мертвого                                       
                                    времени и цифровым                                         
                                    фильтром (ETR, TIx)                                        

                                    00:                   Tdts=Tck_int                         

                                    01:                   Tdts=Tck_int x 2                     

                                    10:                   Tdts=Tck_int x 4                     

                                    11:                   Зарезервировано                      

     \[7\]        ARPE        RW    Разряд разрешения                                              0
                                    предзагрузки авто                                          
                                    перезагрузки                                               

                                    1:                    Разрешает регистр автоматического    
                                                          значения перезагрузки (ATRLR)        

                                    0:                    Регистр автоматического значения     
                                                          перезагрузки (ATRLR) отключен        

    \[6:5\]    CMS\[1:0\]     RW    Выбор режима                                                   0
                                    центрального                                               
                                    выравнивания временем                                      
                                    мертвого состояния и                                       
                                    тактовой частотой                                          
                                    выборки, используемой                                      
                                    генератором мертвого                                       
                                    времени и цифровым                                         
                                    фильтром (ETR, TIx)                                        

                                    00:                   Режим выравнивания по краю. Счетчик  
                                                          считает вверх или вниз на основе     
                                                          бита направления (DIR)               

                                    01:                   Центральный режим выравнивания 1.    
                                                          Счетчик попеременно считает вверх и  
                                                          вниз. Флаг прерывания сравнения      
                                                          выхода канала, настроенного как      
                                                          выход (CCxS = 00 в регистре          
                                                          CHCTLRx), устанавливается только     
                                                          тогда, когда счетчик считает вниз    

                                    10:                   Центральный режим выравнивания 2.    
                                                          Счетчик попеременно считает вверх и  
                                                          вниз. Флаг прерывания сравнения      
                                                          выхода канала, настроенного как      
                                                          выход (CCxS = 00 в регистре          
                                                          CHCTLRx), устанавливается только     
                                                          тогда, когда счетчик считает вверх   

                                    11:                   Центральный режим выравнивания 3.    
                                                          Счетчик попеременно считает вверх и  
                                                          вниз. Флаг прерывания сравнения      
                                                          выхода канала, настроенного как      
                                                          выход (CCxS = 00 в регистре          
                                                          CHCTLRx), устанавливается как при    
                                                          счете вверх, так и при счете вниз    

                                    *Примечание: Когда                                         
                                    счетчик включен (CEN                                       
                                    = 1), переход от                                           
                                    режима выравнивания                                        
                                    по краю к центрально                                       
                                    выровненному режиму                                        
                                    не допускается.*                                           

     \[4\]        DIR         RW    Направление счета                                              0

                                    0:                    Режим счета счетчика инкрементальный 

                                    1:                    Режим счёта счётчика десятичный      

                                    *Примечание: Этот бит                                      
                                    недействителен, когда                                      
                                    счетчик настроен в                                         
                                    режиме центрального                                        
                                    выравнивания или                                           
                                    режиме энкодера.*                                          

     \[3\]        OPM         RW    Режим одиночного                                               0
                                    импульса                                                   

                                    1:                    Счётчик останавливается (сбрасывая   
                                                          бит CEN) при наступлении следующего  
                                                          события обновления                   

                                    0:                    Счетчик не останавливается при       
                                                          наступлении следующего события       
                                                          обновления                           

     \[2\]        URS         RW    Источник запроса на                                            0
                                    обновление, которым                                        
                                    программное                                                
                                    обеспечение выбирает                                       
                                    источник события UEV                                       

                                    1:                    Если разрешено прерывание обновления 
                                                          или запрос DMA, то прерывание        
                                                          обновления или запрос DMA            
                                                          генерируются только в случае         
                                                          переполнения/недополнения счетчика   

                                    0:                    Если включено прерывание обновления  
                                                          или запрос DMA, прерывание           
                                                          обновления или запрос DMA могут быть 
                                                          вызваны любым из следующих событий:\ 
                                                          - Переполнение/недополонение         
                                                          счетчика\                            
                                                          - Установка позиции UG\              
                                                          - Обновления, генерируемые в режиме  
                                                          ведомого устройства                  

     \[1\]        UDIS        RW    Отключение                                                     0
                                    обновлений,                                                
                                    программное                                                
                                    обеспечение                                                
                                    разрешает/запрещает                                        
                                    генерацию событий UEV                                      
                                    с помощью этого бита                                       

                                    1:                    UEV отключено. Никакое событие       
                                                          обновления не генерируется, и        
                                                          регистры (ARR, PSC, CCRx) сохраняют  
                                                          свои значения. Если установлен бит   
                                                          UG или аппаратный сброс выдан        
                                                          контроллером режима, счетчики и      
                                                          предварительный делитель             
                                                          сбрасываются                         

                                    0:                    UEV разрешено. События обновления    
                                                          (UEV) генерируются одним из          
                                                          следующих событий:\                  
                                                          - Переполнение/недолив счетчика\     
                                                          - Установка положения UG\            
                                                          - Обновления, управляемые ведомым    
                                                          режимом\                             
                                                          Регистры с кэшированием загружают    
                                                          свои предварительно загруженные      
                                                          значения                             

     \[0\]        CEN         RW    Включение счетчика                                             0

                                    1:                    Включить счетчик                     

                                    0:                    Выключить счетчик                    

                                    *Примечание: Внешний                                       
                                    тактовый сигнал,                                           
                                    режим с пропусканием                                       
                                    тактов и режим                                             
                                    энкодера не будут                                          
                                    работать до тех пор,                                       
                                    пока бит CEN не будет                                      
                                    установлен                                                 
                                    программным                                                
                                    обеспечением. Режим                                        
                                    триггера может                                             
                                    автоматически                                              
                                    установить бит CEN                                         
                                    аппаратно*                                                 
  -------------------------------------------------------------------------------------------------------

### 10.4.2 Регистр управления 2 (TIM1_CTLR2) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------------------------------
  15     14     13      12     11      10     9       8      7           6        5   4  3      2      1      0
  ------ ------ ------- ------ ------- ------ ------- ------ ------ ------------ --- --- ------ ------ ------ ------
  Рез.   OIS4   OIS3N   OIS3   OIS2N   OIS2   OIS1N   OIS1   TI1S    MMS\[2:0\]          CCDS   CCUS   Рез.   CCPC

  ------------------------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------
     Бит      Название    Доступ  Описание                                               Значение
                                                                                          сброса
  --------- ------------ -------- ----------------- ----------------------------------- ----------
   \[15\]       Res         RO    Резерв                                                    0

   \[14\]       OIS4        RW    Состояние покоя                                           0
                                  вывода 4                                              

                                  1:                Когда MOE=0, если реализован OC4N,  
                                                    OC4=1 после мёртвой зоны            

                                  0:                Когда MOE=0, если реализован OC4N,  
                                                    OC4=0 после мёртвой зоны            

                                  *Примечание: Этот                                     
                                  бит нельзя                                            
                                  изменить после                                        
                                  того, как                                             
                                  установлено                                           
                                  значение                                              
                                  блокировки                                            
                                  (регистр                                              
                                  TIMx_BDTR) уровня                                     
                                  1, 2 или 3*                                           

   \[13\]      OIS3N        RW    Состояние покоя                                           0
                                  вывода 3                                              

                                  1:                Когда MOE = 0, OC3N = 1 после       
                                                    мертвой зоны                        

                                  0:                Когда MOE = 0, OC3N = 0 после       
                                                    мертвой зоны                        

                                  *Примечание: Этот                                     
                                  бит невозможно                                        
                                  изменить после                                        
                                  установки уровня                                      
                                  блокировки                                            
                                  (регистр                                              
                                  TIMx_BDTR) 1, 2                                       
                                  или 3.*                                               

   \[12\]       OIS3        RW    Состояние покоя                                           0
                                  вывода 3                                              
                                  аналогично                                            
                                  состоянию покоя                                       
                                  вывода 4 (OIS4).                                      

   \[11\]      OIS2N        RW    Состояние покоя                                           0
                                  вывода 2                                              
                                  аналогично                                            
                                  состоянию покоя                                       
                                  вывода 3 (OIS3N).                                     

   \[10\]       OIS2        RW    Состояние покоя                                           0
                                  вывода 2                                              
                                  аналогично                                            
                                  состоянию покоя                                       
                                  вывода 4 (OIS4).                                      

    \[9\]      OIS1N        RW    Состояние покоя                                           0
                                  вывода 1                                              
                                  аналогично                                            
                                  состоянию покоя                                       
                                  вывода 3 (OIS3N).                                     

    \[8\]       OIS1        RW    Состояние покоя                                           0
                                  вывода 1                                              
                                  аналогично                                            
                                  состоянию покоя                                       
                                  вывода 4 (OIS4).                                      

    \[7\]       TI1S        RW    Выбор TI1                                                 0

                                  1:                Выводы TIMx_CH1, TIMx_CH2 и         
                                                    TIMx_CH3 подключены ко входу TI1    
                                                    после гетеродинирования             

                                  0:                Выход TIMx_CH1 напрямую подключён   
                                                    ко входу TI1                        

   \[6:4\]   MMS\[2:0\]     RW    Выбор главного                                            0
                                  режима: Эти 3                                         
                                  бита используются                                     
                                  для выбора                                            
                                  информации о                                          
                                  синхронизации                                         
                                  (TRGO),                                               
                                  отправляемой                                          
                                  подчиненному                                          
                                  таймеру в главном                                     
                                  режиме. Возможные                                     
                                  комбинации                                            
                                  следующие.                                            

                                  000:              Бит UG регистра сброса TIMx_EGR     
                                                    используется в качестве выходного   
                                                    сигнала триггера (TRGO). В случае   
                                                    сброса, вызванного входным сигналом 
                                                    триггера (от контроллера режима в   
                                                    режиме сброса), существует задержка 
                                                    в сигнале на TRGO относительно      
                                                    реального сброса.                   

                                  001:              Разрешение - Сигнал включения       
                                                    счетчика CNT_EN используется в      
                                                    качестве выходного триггерного      
                                                    сигнала (TRGO). Иногда требуется    
                                                    одновременно запустить несколько    
                                                    таймеров или управлять включением   
                                                    таймеров в течение некоторого       
                                                    периода времени. Сигнал разрешения  
                                                    счетчика формируется логическим ИЛИ 
                                                    сигнала входа триггера в            
                                                    управляющем бите CEN и режиме       
                                                    пропуска. Когда сигнал разрешения   
                                                    счетчика управляется входным        
                                                    триггером, возникает задержка на    
                                                    TRGO, если не выбран                
                                                    главный/подчиненный режим (см.      
                                                    описание бита MSM в регистре        
                                                    TIMx_SMCR).                         

                                  010:              Обновление - Событие обновления     
                                                    выбирается в качестве входного      
                                                    триггерного сигнала (TRGO).         
                                                    Например, часы основного таймера    
                                                    могут использоваться в качестве     
                                                    предварительного делителя для       
                                                    подчиненного таймера.               

                                  011:              Импульс сравнения - при             
                                                    возникновении захвата или успешного 
                                                    сравнения, когда флаг CC1IF должен  
                                                    быть установлен (даже если он уже   
                                                    высок), выходной триггер посылает   
                                                    положительный импульс (TRGO).       

                                  100:              Сигнал сравнения-OC1REF             
                                                    используется в качестве выходного   
                                                    тригга (TRGO).                      

                                  101:              Сигнал сравнения-OC2REF             
                                                    используется в качестве выходного   
                                                    тригтера (TRGO).                    

                                  110:              Сигнал сравнения-OC3REF             
                                                    используется в качестве выходного   
                                                    тригтерного сигнала (TRGO).         

                                  111:              Сигнализация сравнения-OC4REF       
                                                    используется как выходной тригерный 
                                                    сигнал (TRGO).                      

    \[3\]       CCDS        RW    Выбор захвата DMA                                         0
                                  для сравнения                                         

                                  1:                Отправка запроса DMA для CHxCVR при 
                                                    возникновении события обновления.   

                                  0:                Генерировать запрос DMA для CHxCVR, 
                                                    когда происходит CHxCVR.            

    \[2\]       CCUS        RW    Биты выбора                                               0
                                  управления                                            
                                  сравнением                                            
                                  захвата                                               
                                  обновления                                            

                                  1:                Если CCPC установлен, их можно      
                                                    обновить, установив бит COM или     
                                                    нарастающим фронтом на TRGI.        

                                  0:                Если установлен CCPC, они могут     
                                                    быть обновлены только путем         
                                                    установки бита COM.                 

                                  *Примечание: Этот                                     
                                  бит работает                                          
                                  только для                                            
                                  каналов с                                             
                                  дополнительными                                       
                                  выходами.*                                            

    \[1\]       Res         RO    Резерв                                                    0

    \[0\]       CCPC        RW    Биты управления                                           0
                                  предварительным                                       
                                  загрузчиком                                           
                                  сравнения                                             
                                  захвата.                                              

                                  1:                Биты CCxE, CCxNE и OCxM             
                                                    предварительно загружены, и при     
                                                    установке этого бита они            
                                                    обновляются только при установке    
                                                    бита COM.                           

                                  0:                Биты CCxE, CCxNE и OCxM не являются 
                                                    предварительно загруженными.        

                                  *Примечание: Этот                                     
                                  бит работает                                          
                                  только для                                            
                                  каналов с                                             
                                  дополнительными                                       
                                  выходами.*                                            
  ------------------------------------------------------------------------------------------------

### 10.4.3 Регистр управления режимом ведомого устройства (TIM1_SMCFGR) 

Смещение адреса: 0x00

  ------------------------------------------------------------------------------------------------------------------
  15    14         13        12       11       10   9    8   7          6       5   4  3           2        1    0
  ----- ----- ------------- ---- ------------ ---- ---- ---- ----- ----------- --- --- ------ ------------ ---- ----
  ETP   ECE    ETPS\[1:0\]        ETF\[3:0\]                 MSM    TS\[2:0\]          Рез.    SMS\[2:0\]       

  ------------------------------------------------------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                                   Значение
                                                                                                 сброса
  ----------- ------------- -------- ----------------- --------------------------------------- ----------
    \[15\]         ETP         RO    Выбор полярности                                              0
                                     триггера ETR:                                             
                                     этот бит                                                  
                                     выбирает,                                                 
                                     подавать ли                                               
                                     сигнал ETR                                                
                                     напрямую или                                              
                                     использовать его                                          
                                     инвертированное                                           
                                     значение                                                  

                                     1:                Инвертировать ETR, активен при низком   
                                                       уровне или спаде                        

                                     0:                Прямой сигнал ETR, активен при высоком  
                                                       уровне или нарастающем фронте           

    \[14\]         ECE         RW    Выбор включения                                               0
                                     внешнего                                                  
                                     тактового режима                                          
                                     2                                                         

                                     1:                Включает внешний тактовый режим 2       

                                     0:                Отключает внешний тактовый режим 2      

                                     ***Примечание                                             
                                     1**: Режим                                                
                                     ведомого                                                  
                                     устройства может                                          
                                     использоваться                                            
                                     одновременно с                                            
                                     внешним тактовым                                          
                                     режимом 2: режим                                          
                                     сброса, режим с                                           
                                     шиной и режим                                             
                                     запуска; однако,                                          
                                     в этом случае                                             
                                     TRGI не может                                             
                                     быть подключено к                                         
                                     ETRF (бит TS не                                           
                                     может иметь                                               
                                     значение                                                  
                                     \'111\').\                                                
                                     **Примечание 2**:                                         
                                     Когда включены                                            
                                     оба внешних                                               
                                     тактовых режима 1                                         
                                     и 2, вход                                                 
                                     внешнего                                                  
                                     тактового сигнала                                         
                                     будет ETRF.*                                              

   \[13:12\]   ETPS\[1:0\]     RW    Внешний сигнал                                                0
                                     запуска (ETRP)                                            
                                     делит частоту                                             
                                     этого сигнала,                                            
                                     которая не может                                          
                                     превышать                                                 
                                     максимум 1/4                                              
                                     частоты TIMxCLK,                                          
                                     и может быть                                              
                                     преобразована                                             
                                     через эту область                                         

                                     00:               Делитель отключён                       

                                     01:               Частота ETRP делится на 2               

                                     10:               Частота ETRP делится на 4               

                                     11:               Частота ETRP делится на 8               

   \[11:8\]    ETF\[3:0\]      RW    Фильтрация с                                                  0
                                     внешней                                                   
                                     синхронизацией                                            
                                     фактически                                                
                                     представляет                                              
                                     собой счетчик                                             
                                     событий, который                                          
                                     использует                                                
                                     определенную                                              
                                     частоту                                                   
                                     дискретизации для                                         
                                     регистрации до N                                          
                                     событий, а затем                                          
                                     генерирует скачок                                         
                                     на выходе.                                                

                                     0001:             частота дискретизации Fsampling =       
                                                       Fck_int, N = 2                          

                                     0010:             частота дискретизации Fsampling =       
                                                       Fck_int, N = 4                          

                                     0011:             частота дискретизации Fsampling =       
                                                       Fck_int, N = 8                          

                                     0100:             частота дискретизации Fsampling = Fdts  
                                                       / 2, N = 6                              

                                     0101:             частота дискретизации Fsampling = Fdts  
                                                       / 2, N = 8                              

                                     0110:             частота дискретизации Fsampling = Fdts  
                                                       / 4, N = 6                              

                                     0111:             частота дискретизации Fsampling = Fdts  
                                                       / 4, N = 8                              

                                     1000:             частота дискретизации Fsampling = Fdts  
                                                       / 8, N = 6                              

                                     1001:             частота дискретизации Fsampling = Fdts  
                                                       / 8, N = 8                              

                                     1010:             частота дискретизации Fsampling = Fdts  
                                                       / 16, N = 5                             

                                     1011:             частота дискретизации Fsampling = Fdts  
                                                       / 16, N = 6                             

                                     1100:             частота дискретизации Fsampling = Fdts  
                                                       / 16, N = 8                             

                                     1101:             частота дискретизации Fsampling = Fdts  
                                                       / 32, N = 5                             

                                     1110:             частота дискретизации Fsampling = Fdts  
                                                       / 32, N = 6                             

                                     1111:             частота дискретизации Fsampling = Fdts  
                                                       / 32, N = 8                             

     \[7\]         MSM         RW    Выбор режима                                                  0
                                     ведущий/ведомый                                           

                                     1:                Событие на входе запуска (TRGI)         
                                                       задерживается, чтобы обеспечить         
                                                       идеальную синхронизацию между текущим   
                                                       таймером (через TRGO) и его подчиненным 
                                                       таймером. Это полезно, когда требуется  
                                                       синхронизация нескольких таймеров с     
                                                       одним внешним событием                  

                                     0:                Не функционирует                        

    \[6:4\]     TS\[2:0\]      RW    Поле выбора                                                   0
                                     триггера, эти 3                                           
                                     бита выбирают                                             
                                     источник                                                  
                                     триггерного                                               
                                     входа,                                                    
                                     используемый для                                          
                                     синхронизации                                             
                                     счетчика.                                                 

                                     000:              Внутренний триггер 0 (ITR0)             

                                     001:              Внутренний триггер 1 (ITR1)             

                                     010:              Внутренний триггер 2 (ITR2)             

                                     011:              Внутренний триггер 3 (ITR3)             

                                     100:              Детектор фронтов TI1 (TI1F_ED)          

                                     101:              Фильтрованный вход таймера 1 (TI1FP1)   

                                     110:              Фильтрованный вход таймера 2 (TI2FP2)   

                                     111:              Внешний вход триггера (ETRF)            

                                     Изменения                                                 
                                     происходят только                                         
                                     тогда, когда SMS                                          
                                     равен 0.\                                                 
                                     *Примечание:                                              
                                     Подробные                                                 
                                     сведения см. в                                            
                                     таблице 10-2.*                                            

     \[3\]         Res         RO    Резерв                                                        0

    \[2:0\]    SMS\[2:0\]      RW    Поле выбора                                                   0
                                     режима ввода.                                             
                                     Выбирает режим                                            
                                     работы часов и                                            
                                     триггера                                                  
                                     основного                                                 
                                     счетчика.                                                 

                                     000:              работает от внутреннего тактового       
                                                       сигнала CK_INT.                         

                                     001:              режим энкодера 1, где основной счетчик  
                                                       увеличивает или уменьшает счет при      
                                                       переходе TI2FP2 в зависимости от уровня 
                                                       TI1FP1.                                 

                                     010:              режим энкодера 2, где основной счетчик  
                                                       увеличивает или уменьшает счет при      
                                                       переходе TI1FP1 в зависимости от уровня 
                                                       TI2FP2.                                 

                                     011:              режим энкодера 3, где основной счетчик  
                                                       увеличивает и уменьшает счет на         
                                                       переходах TI1FP1 и TI2FP2 в зависимости 
                                                       от уровня другого сигнала.              

                                     100:              режим сброса, где нарастающий фронт     
                                                       триггерного входа (TRGI) инициализирует 
                                                       счетчик и генерирует сигнал для         
                                                       обновления регистров.                   

                                     101:              режим с шиной, когда триггерный вход    
                                                       (TRGI) находится в высоком состоянии,   
                                                       часы счетчика включаются; когда         
                                                       триггерный вход становится низким,      
                                                       счетчик останавливается, и запуск и     
                                                       остановка счетчика контролируются.      

                                     110:              режим запуска, где счетчик начинается   
                                                       по нарастающему фронту триггерного      
                                                       входа TRGI, и контролируется только     
                                                       начало счета.                           

                                     111:              Внешний тактовый режим 1, нарастающий   
                                                       фронт выбранного триггерного входа      
                                                       (TRGI) управляет счетчиком.             
  -------------------------------------------------------------------------------------------------------

**10.4.4 Регистр разрешения DMA/прерывания (TIM1_DMAINTENR)**

Смещение адреса: 0x00

  --------------------------------------------------------------------------------------------------------------------
  15     14    13      12      11      10      9       8     7     6     5       4       3       2       1       0
  ------ ----- ------- ------- ------- ------- ------- ----- ----- ----- ------- ------- ------- ------- ------- -----
  Рез.   TDE   COMDE   CC4DE   CC3DE   CC2DE   CC1DE   UDE   BIE   TIE   COMIE   CC4IE   CC3IE   CC2IE   CC1IE   UIE

  --------------------------------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------------
    Бит     Название   Доступ  Описание                                                        Значение
                                                                                                сброса
  -------- ---------- -------- ------------------- ------------------------------------------ ----------
   \[15\]     Res        RO    Резерв                                                             0

   \[12\]     TDE        RW    Установка бита                                                     0
                               разрешения запроса                                             
                               DMA                                                            

                               1:                  Разрешить генерацию запросов DMA           

                               0:                  Генерация запросов DMA отключена           

   \[13\]    COMDE       RW    Бит разрешения                                                     0
                               запроса DMA для COM                                            

                               1:                  Разрешены запросы DMA для COM              

                               0:                  Запросы DMA для COM отключены              

   \[12\]    CC2DE       RW    Бит разрешения DMA                                                 0
                               для канала 2                                                   
                               захвата сравнеия                                               

                               1:                  Разрешено сравнение запросов DMA для       
                                                   канала захвата 2                           

                               0:                  Сравнение запросов DMA для канала захвата  
                                                   2 запрещено                                

   \[11\]    CC3DE       RW    Бит разрешения DMA                                                 0
                               для канала 3                                                   
                               захвата сравнеия                                               

                               1:                  Разрешено сравнение запросов DMA для       
                                                   канала захвата 3                           

                               0:                  Сравнение запросов DMA для канала захвата  
                                                   3 запрещено                                

   \[10\]    CC2DE       RW    Бит разрешения DMA                                                 0
                               для канала 2                                                   
                               захвата сравнеия                                               

                               1:                  Разрешено сравнение запросов DMA для       
                                                   канала захвата 2                           

                               0:                  Сравнение запросов DMA для канала захвата  
                                                   2 запрещено                                

   \[9\]     CC1DE       RW    Бит разрешения DMA                                                 0
                               для канала 1                                                   
                               захвата сравнеия                                               

                               1:                  Разрешено сравнение запросов DMA для       
                                                   канала захвата 1                           

                               0:                  Сравнение запросов DMA для канала захвата  
                                                   1 запрещено                                

   \[8\]      UDE        RW    Обновлен бит                                                       0
                               разрешения запроса                                             
                               DMA                                                            

                               1:                  Разрешены обновления через DMA-запросы     

                               0:                  Обновления через DMA-запросы отключены     

   \[7\]      BIE        RW    Бит разрешения                                                     0
                               тормоза прерывания                                             

                               1:                  Разрешить прерывание тормозов              

                               0:                  Прерывание тормозов запрещено              

   \[6\]      TIE        RW    Бит разрешения                                                     0
                               прерывания                                                     

                               1:                  Включить возможность вызова прерываний     

                               0:                  Вызов прерываний отключен                  

   \[5\]     COMIE       RW    Бит разрешения                                                     0
                               прерывания COM                                                 

                               1:                  Разрешить прерывания COM                   

                               0:                  Прерывания COM отключены                   

   \[4\]     CC4IE       RW    Бит разрешения                                                     0
                               прерывания для                                                 
                               канала                                                         
                               сравнения-захвата 4                                            

                               1:                  Разрешить сравнение прерываний для канала  
                                                   захвата 4                                  

                               0:                  Отключить сравнение прерываний для канала  
                                                   захвата 4                                  

   \[3\]     CC3IE       RW    Бит разрешения                                                     0
                               прерывания для                                                 
                               канала                                                         
                               сравнения-захвата 3                                            

                               1:                  Разрешить сравнение прерываний для канала  
                                                   захвата 3                                  

                               0:                  Отключить сравнение прерываний для канала  
                                                   захвата 3                                  

   \[2\]     CC2IE       RW    Бит разрешения                                                     0
                               прерывания для                                                 
                               канала                                                         
                               сравнения-захвата 2                                            

                               1:                  Разрешить сравнение прерываний для канала  
                                                   захвата 2                                  

                               0:                  Отключить сравнение прерываний для канала  
                                                   захвата 2                                  

   \[1\]     CC1IE       RW    Бит разрешения                                                     0
                               прерывания для                                                 
                               канала                                                         
                               сравнения-захвата 1                                            

                               1:                  Разрешить сравнение прерываний для канала  
                                                   захвата 1                                  

                               0:                  Отключить сравнение прерываний для канала  
                                                   захвата 1                                  

   \[0\]      UIE        RW    Обновите бит                                                       0
                               разрешения                                                     
                               прерывания                                                     

                               1:                  Разрешить прерывание обновлений            

                               0:                  Прерывание обновлений отключено            
  ------------------------------------------------------------------------------------------------------

### 10.4.5 Регистр статуса прерывания (TIM1_INTFR)

Смещение адреса: 0x00

  -----------------------------------------------------------------------------------------------------------------
    15    14   13  12      11      10      9       8      7     6     5       4       3       2       1       0
  ------ ---- ---- ------- ------- ------- ------- ------ ----- ----- ------- ------- ------- ------- ------- -----
   Рез.            CC4OF   CC3OF   CC2OF   CC1OF   Рез.   BIF   TIF   COMIF   CC4IF   CC3IF   CC2IF   CC1IF   UIF

  -----------------------------------------------------------------------------------------------------------------

  ----------------------------------------------------------------------------------------------------------------
      Бит      Название   Доступ  Описание                                                               Значение
                                                                                                          сброса
  ----------- ---------- -------- ------------------------ -------------------------------------------- ----------
   \[15:13\]     Res        RO    Резерв                                                                    0

    \[12\]      CC4OF      RW0    Захват/сравнение 4 флага                                                  0
                                  переполнения захвата\                                                 
                                  см. описание CC1OF                                                    

    \[11\]      CC3OF      RW0    Захват/сравнение 3 флага                                                  0
                                  переполнения захвата\                                                 
                                  см. описание CC1OF                                                    

    \[10\]      CC2OF      RW0    Захват/сравнение 2 флага                                                  0
                                  переполнения захвата\                                                 
                                  см. описание CC1OF                                                    

     \[9\]      CC1OF      RW0    Флаг переполнения                                                         0
                                  захвата 1Этот флаг                                                    
                                  устанавливается только                                                
                                  аппаратным обеспечением,                                              
                                  когда соответствующий                                                 
                                  канал настроен в режиме                                               
                                  захвата входного                                                      
                                  сигнала. Он сбрасывается                                              
                                  программно путем записи                                               
                                  в него значения \'0\'                                                 

                                  1:                       Значение счетчика было захвачено в регистре  
                                                           TIMx_CCR1, в то время как флаг CC1IF уже был 
                                                           установлен                                   

                                  0:                       Переполнение не обнаружено                   

     \[8\]       Res        RO    Резерв                                                                    0

     \[7\]       BIF       RW0    Бит флага прерывания                                                      0
                                  тормоза, после того как                                               
                                  сигнал на входе тормоза                                               
                                  становится                                                            
                                  действительным, может                                                 
                                  быть очищен программно                                                

                                  1:                       На входе тормозной шины обнаружен допустимый 
                                                           уровень сигнала                              

                                  0:                       Событие торможения не генерируется           

     \[6\]       TIF       RW0    Бит флага прерывания                                                      0
                                  триггера, при                                                         
                                  возникновении события                                                 
                                  триггера,                                                             
                                  устанавливается                                                       
                                  аппаратно для этого бита                                              
                                  и может быть очищен                                                   
                                  программно. События                                                   
                                  триггера включают                                                     
                                  обнаружение допустимого                                               
                                  фронта на входе TRGI в                                                
                                  любом режиме, кроме                                                   
                                  режима с шлюзованием                                                  
                                  (gated), либо любого                                                  
                                  фронта в шлюзуемом                                                    
                                  режиме                                                                

                                  1:                       Генерация события триггера                   

                                  0:                       Событие триггера не генерируется.            

     \[5\]      COMIF      RW0    Бит флага прерывания                                                      0
                                  COM: этот бит                                                         
                                  устанавливается                                                       
                                  аппаратно и сбрасывается                                              
                                  программно после                                                      
                                  генерации события COM.                                                
                                  События COM, включая                                                  
                                  обновления CCxE, CCxNE,                                               
                                  OCxM, происходят                                                      

                                  1:                       Генерация события COM                        

                                  0:                       Событие COM не генерируется.                 

     \[4\]      CC4IF      RW0    Флаг прерывания                                                           0
                                  захвата/сравнения 4\                                                  
                                  смотри описание CC1IF                                                 

     \[3\]      CC3IF      RW0    Флаг прерывания                                                           0
                                  захвата/сравнения 3\                                                  
                                  смотри описание CC1IF                                                 

     \[2\]      CC2IF      RW0    Флаг прерывания                                                           0
                                  захвата/сравнения 2\                                                  
                                  смотри описание CC1IF                                                 

     \[1\]      CC1IF      RW0    Флаг прерывания                                                           0
                                  захвата/сравнения 1\                                                  
                                  Если канал CC1 настроен                                               
                                  как выход: Этот флаг                                                  
                                  устанавливается                                                       
                                  аппаратно, когда                                                      
                                  значение счетчика                                                     
                                  совпадает со значением                                                
                                  сравнения, за                                                         
                                  исключением некоторых                                                 
                                  случаев в                                                             
                                  центре-ориентированном                                                
                                  режиме (см. описание                                                  
                                  битов CMS в регистре                                                  
                                  TIMx_CR1). Он                                                         
                                  сбрасывается программно.                                              
                                  0: Нет совпадений. 1:                                                 
                                  Содержимое счетчика                                                   
                                  TIMx_CNT соответствует                                                
                                  содержимому регистра                                                  
                                  TIMx_CCR1. Когда                                                      
                                  содержимое TIMx_CCR1                                                  
                                  больше содержимого                                                    
                                  TIMx_ARR, бит CC1IF                                                   
                                  устанавливается на                                                    
                                  переполнении счетчика (в                                              
                                  режимах прямого счета и                                               
                                  счета вверх/вниз) или                                                 
                                  при его уменьшении до                                                 
                                  нуля (в режиме обратного                                              
                                  счета).\                                                              
                                  Если канал CC1 настроен                                               
                                  как вход: Этот бит                                                    
                                  устанавливается                                                       
                                  аппаратно при захвате.                                                
                                  Он сбрасывается                                                       
                                  программно или при                                                    
                                  чтении регистра                                                       
                                  TIMx_CCR1                                                             

                                  1:                       Значение счетчика было захвачено в регистр   
                                                           TIMx_CCR1 (Обнаружен фронт на IC1, который   
                                                           соответствует выбранной полярности)          

                                  0:                       Захвата входного сигнала не произошло        

     \[0\]       UIF       RW0    Бит флага прерывания                                                      0
                                  обновления: этот бит                                                  
                                  устанавливается                                                       
                                  аппаратно, когда                                                      
                                  происходит событие                                                    
                                  обновления, и                                                         
                                  сбрасывается программно                                               

                                  1:                       Прерывание по обновлению произошло           

                                  0:                       Событие обновления не произошло. Следующие   
                                                           сценарии вызывают события обновления:\       
                                                           Если UDIS = 0, когда значение повторяющего   
                                                           счетчика переполняется или уменьшается до    
                                                           нуля.\                                       
                                                           Если URS = 0 и UDIS = 0, когда               
                                                           устанавливается бит UG, или когда основной   
                                                           счетчик перезапускается программно.\         
                                                           Если URS = 0 и UDIS = 0, когда счетчик CNT   
                                                           перезагружается событием триггера.           
  ----------------------------------------------------------------------------------------------------------------

### 10.4.6 Регистр генерации событий (TIM1_SWEVGR)

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------
    15    14   13   12   11   10   9   8  7    6    5      4      3      2      1      0
  ------ ---- ---- ---- ---- ---- --- --- ---- ---- ------ ------ ------ ------ ------ ------
   Рез.                                   BG   TG   COMG   CC4G   CC3G   CC2G   CC1G   UG

  -------------------------------------------------------------------------------------------

  ------------------------------------------------------------------------------------------------------
     Бит      Название   Доступ  Описание                                                      Значение
                                                                                                сброса
  ---------- ---------- -------- ---------------------- ------------------------------------- ----------
   \[15:8\]     Res        RO    Резерв                                                           0

    \[7\]        BG        WO    Бит генерации события                                            0
                                 торможения,                                                  
                                 устанавливаемый и                                            
                                 сбрасываемый                                                 
                                 программно,                                                  
                                 используется для                                             
                                 генерации события                                            
                                 торможения                                                   

                                 1:                     енерирует событие торможения. В этом  
                                                        случае MOE=0, BIF=1; если             
                                                        соответствующие прерывание и DMA      
                                                        включены, генерируются                
                                                        соответствующие прерывание и DMA      

                                 0:                     Без действия                          

    \[6\]        TG        WO    Бит генерации события                                            0
                                 триггера,                                                    
                                 устанавливаемый                                              
                                 программно и                                                 
                                 сбрасываемый                                                 
                                 аппаратно,                                                   
                                 используется для                                             
                                 генерации события                                            
                                 триггера                                                     

                                 1:                     Генерирует событие триггера, TIF      
                                                        устанавливается, и соответствующие    
                                                        прерывания и DMA генерируются, если   
                                                        они разрешены                         

                                 0:                     Без действия                          

    \[5\]       COMG       WO    Бит генерации                                                    0
                                 обновления управления                                        
                                 сравнением и захватом.                                       
                                 Генерирует событие                                           
                                 обновления управления                                        
                                 сравнением и захватом.                                       
                                 Этот бит                                                     
                                 устанавливается                                              
                                 программно и                                                 
                                 автоматически                                                
                                 сбрасывается аппаратно                                       

                                 1:                     когда CCPC = 1, разрешить обновление  
                                                        битов CCxE, CCxNE, OCxM               

                                 0:                     Без действия                          

                                 *Примечание: Этот бит                                        
                                 актуален только для                                          
                                 каналов с                                                    
                                 дополнительными                                              
                                 выходами (каналы 1, 2,                                       
                                 3)*                                                          

    \[4\]       CC4G       WO    Бит генерации события                                            0
                                 сравнения-захвата 4.                                         
                                 Генерирует событие                                           
                                 сравнения-захвата 4                                          

    \[3\]       CC3G       WO    Бит генерации события                                            0
                                 сравнения-захвата 3.                                         
                                 Генерирует событие                                           
                                 сравнения-захвата 3                                          

    \[2\]       CC2G       WO    Бит генерации события                                            0
                                 сравнения-захвата 2.                                         
                                 Генерирует событие                                           
                                 сравнения-захвата 2                                          

    \[1\]       CC1G       WO    Бит генерации события                                            0
                                 сравнения-захвата 1.                                         
                                 Генерирует событие                                           
                                 сравнения-захвата 1.\                                        
                                 Этот бит                                                     
                                 устанавливается                                              
                                 программно и                                                 
                                 сбрасывается                                                 
                                 аппаратно. Он                                                
                                 используется для                                             
                                 генерации события                                            
                                 сравнения-захвата.                                           

                                 1:                     Генерирует событие сравнения-захвата  
                                                        на канале сравнения-захвата 1. Если   
                                                        канал сравнения-захвата 1 настроен    
                                                        как выходной: Устанавливает бит       
                                                        CC1IF. Генерирует соответствующие     
                                                        прерывания и DMA, если они включены.  
                                                        Если канал сравнения-захвата 1        
                                                        настроен как входной: Текущее         
                                                        значение основного счетчика           
                                                        захватывается в регистр               
                                                        сравнения-захвата 1; устанавливает    
                                                        бит CC1IF для генерации               
                                                        соответствующих прерываний и DMA,     
                                                        если они включены; если CC1IF уже     
                                                        установлен, устанавливает бит CC1OF   

                                 0:                     Без действия                          

    \[0\]        UG        WO    Бит генерации события                                            0
                                 обновления для                                               
                                 создания события                                             
                                 обновления. Этот бит                                         
                                 устанавливается                                              
                                 программно и                                                 
                                 автоматически                                                
                                 сбрасывается аппаратно                                       

                                 1:                     Инициализировать счетчик и создать    
                                                        событие обновления                    

                                 0:                     Без действия                          

                                 *Примечание:                                                 
                                 Предделительный                                              
                                 счетчик также                                                
                                 обнуляется, но                                               
                                 коэффициент                                                  
                                 предделителя остается                                        
                                 неизменным. Основной                                         
                                 счетчик сбрасывается,                                        
                                 если он находится в                                          
                                 центросимметричном                                           
                                 режиме или                                                   
                                 инкрементном режиме                                          
                                 подсчета; если в                                             
                                 декрементном режиме                                          
                                 подсчета, основной                                           
                                 счетчик принимает                                            
                                 значение регистра                                            
                                 перезагрузки.*                                               
  ------------------------------------------------------------------------------------------------------

### 10.4.7 Регистр управления сравнением/захватом 1 (TIM1_CHCTLR1)

Смещение адреса: 0x00

  -------------------------------------------------------------------------------------------------------------------------------------------------------------
  15                 14        13   12  11              10            9        8  7                   6        5   4  3               2             1        0
  ------------- ------------- ---- ---- --------------- ------- ------------- --- ------------- ------------- --- --- --------------- ------- ------------- ---
  OC2CE          OC2M\[2:0\]            OC2PE           OC2FE    CC2S\[1:0\]      OC1CE          OC1M\[2:0\]          OC1PE           OC1FE    CC1S\[1:0\]  

  IC2F\[3:0\]                           IC2PSC\[1:0\]                             IC1F\[3:0\]                         IC1PSC\[1:0\]                         
  -------------------------------------------------------------------------------------------------------------------------------------------------------------

Режим сравнения (пины используются как выходы)

  --------------------------------------------------------------------------------------------------------
      Бит       Название     Доступ  Описание                                                    Значение
                                                                                                  сброса
  ----------- ------------- -------- ------------------- -------------------------------------- ----------
    \[15\]        OC2CE        RW    Бит разрешения                                                 0
                                     очистки канала                                             
                                     сравнения-захвата 2                                        

                                     1:                  Очищать бит OC2REF при обнаружении     
                                                         высокого уровня на входе ETRF          

                                     0:                  Бит OC2REF не изменяется под           
                                                         воздействием входа ETRF                

   \[14:12\]   OC2M\[2:0\]     RW    Поле настройки                                                 0
                                     режима канала                                              
                                     сравнения-захвата                                          
                                     2\                                                         
                                     Эти 3 бита                                                 
                                     определяют действие                                        
                                     сигнала опорного                                           
                                     выхода OC2REF,                                             
                                     который определяет                                         
                                     значения сигналов                                          
                                     OC2 и OC2N. Сигнал                                         
                                     OC2REF активен                                             
                                     высоким уровнем, а                                         
                                     активные уровни                                            
                                     сигналов OC2 и OC2N                                        
                                     зависят от настроек                                        
                                     битов CC2P и CC2NP                                         

                                     000:                Заморозка. Сравнение значений регистра 
                                                         захвата с ядром счетчиков              
                                                         для OC2REF не работает.                

                                     001:                Принудительно установить на допустимом 
                                                         уровне. Принуждает OC2REF к высокому   
                                                         уровню, когда ядро счетчика имеет      
                                                         такое же значение, что и регистр       
                                                         сравнения-захвата 1.                   

                                     010:                Принудительно установить на            
                                                         недопустимом уровне.                   
                                                         Принуждает OC2REF к низкому уровню,    
                                                         когда значение ядра счетчика равно     
                                                         значению регистра сравнения-захвата 1. 

                                     011:                Переключение. Изменяет уровень OC2REF, 
                                                         когда значение ядра счетчика совпадает 
                                                         со значением регистра                  
                                                         сравнения-захвата 1.                   

                                     100:                Принудительно установить на            
                                                         недопустимом уровне.                   
                                                         Принуждает OC2REF к низкому уровню.    

                                     101:                Принудительно установить на допустимом 
                                                         уровне. Принуждает OC2REF к высокому   
                                                         уровню.                                

                                     110:                Режим ШИМ 1. При увеличении счетчика,  
                                                         канал 2 переходит на недопустимый      
                                                         уровень, когда значение ядра счетчика  
                                                         превышает значение регистра            
                                                         сравнения-захвата, иначе -- на         
                                                         допустимый уровень; при уменьшении     
                                                         счетчика, канал 2 переходит на         
                                                         допустимый уровень, когда значение     
                                                         ядра счетчика превышает значение       
                                                         регистра сравнения-захвата, иначе --   
                                                         на недопустимый уровень.               

                                     111:                Режим ШИМ 2. При увеличении счетчика,  
                                                         канал 2 переходит на допустимый        
                                                         уровень, когда значение ядра счетчика  
                                                         превышает значение регистра            
                                                         сравнения-захвата, иначе -- на         
                                                         недопустимый уровень; при уменьшении   
                                                         счетчика, канал 2 переходит на         
                                                         недопустимый уровень, когда значение   
                                                         ядра счетчика превышает значение       
                                                         регистра сравнения-захвата, иначе --   
                                                         на допустимый уровень (OC2REF=1).      

                                     *Примечание: Эти                                           
                                     биты нельзя                                                
                                     изменить, если                                             
                                     уровень блокировки                                         
                                     (LOCK) установлен                                          
                                     на 3, и CC2S=00b. В                                        
                                     режиме ШИМ 1 или                                           
                                     ШИМ 2 уровень                                              
                                     OC2REF меняется                                            
                                     только тогда, когда                                        
                                     результат сравнения                                        
                                     изменяется или при                                         
                                     переключении из                                            
                                     замороженного                                              
                                     режима в режим ШИМ                                         
                                     в режиме вывода                                            
                                     сравнения.*                                                

    \[11\]        OC2PE        RW    Бит разрешения                                                 0
                                     предварительной                                            
                                     загрузки регистра                                          
                                     сравнения-захвата 2                                        

                                     1:                  Разрешить функцию предварительной      
                                                         загрузки регистра сравнения-захвата 2. 
                                                         Операции чтения и записи работают      
                                                         только с регистрами предварительной    
                                                         загрузки. Предварительное значение     
                                                         регистра сравнения-захвата 2           
                                                         загружается в текущий теневой регистр  
                                                         при наступлении события обновления     

                                     0:                  Отключить функцию предварительной      
                                                         загрузки регистра сравнения-захвата 2. 
                                                         Регистр сравнения-захвата 2 можно      
                                                         записывать в любое время, и новое      
                                                         записанное значение вступает в силу    
                                                         немедленно                             

                                     *Примечание: После                                         
                                     установки уровня                                           
                                     блокировки (LOCK)                                          
                                     на 3 и CC2S=00,                                            
                                     этот бит невозможно                                        
                                     изменить. Режим ШИМ                                        
                                     может                                                      
                                     использоваться                                             
                                     только в                                                   
                                     однократном                                                
                                     импульсном режиме                                          
                                     (OPM=1) без                                                
                                     подтверждения                                              
                                     регистра                                                   
                                     предварительной                                            
                                     загрузки, в                                                
                                     противном случае                                           
                                     его поведение не                                           
                                     определено.*                                               

    \[10\]        OC2FE        RW    Бит быстрого                                                   0
                                     включения канала                                           
                                     сравнения-захвата                                          
                                     2, этот бит                                                
                                     используется для                                           
                                     ускорения реакции                                          
                                     выхода канала                                              
                                     сравнения-захвата                                          
                                     на событие входного                                        
                                     триггера.                                                  

                                     1:                  Активный фронт на входе триггера       
                                                         действует так, как будто произошло     
                                                         сравнение. Таким образом, состояние    
                                                         выхода сравнивающего захвата           
                                                         устанавливается независимо от          
                                                         результата сравнения. Задержка между   
                                                         допустимым фронтом сигнала триггера    
                                                         выборки и выходом канала               
                                                         сравнения-захвата 2 сокращается до 3   
                                                         тактовых циклов                        

                                     0:                  Канал сравнения-захвата 2 работает     
                                                         нормально на основе значений счетчика  
                                                         и регистра сравнения-захвата 1, даже   
                                                         если триггер открыт. Минимальная       
                                                         задержка активации выхода канала       
                                                         сравнения-захвата 2 составляет 5       
                                                         тактовых циклов, когда на входе        
                                                         триггера появляется допустимый фронт   

                                     OC2FE работает                                             
                                     только тогда, когда                                        
                                     канал настроен на                                          
                                     работу в режиме                                            
                                     PWM1 или PWM2                                              

    \[9:8\]    CC2S\[1:0\]     RW    Поля выбора входа                                              0
                                     канала                                                     
                                     сравнения-захвата                                          
                                     2.                                                         

                                     00:                 Канал сравнения-захвата 2 настроен как 
                                                         выход.                                 

                                     01:                 Канал сравнения-захвата 2 настроен как 
                                                         вход, и IC2 отображён на TI2.          

                                     10:                 Канал сравнения-захвата 2 настроен как 
                                                         вход, и IC2 отображён на TI1.          

                                     11:                 Канал сравнения-захвата 2 настроен как 
                                                         вход, и IC2 отображён на TRC. Этот     
                                                         режим работает только при выборе       
                                                         внутреннего входа триггера (по биту    
                                                         TS).                                   

                                     *Примечание: Канал                                         
                                     сравнения-захвата 2                                        
                                     доступен для записи                                        
                                     только тогда, когда                                        
                                     канал выключен                                             
                                     (когда CC2E равен                                          
                                     нулю)*                                                     

     \[7\]        OC1CE        RW    Бит разрешения                                                 0
                                     очистки канала                                             
                                     сравнения-захвата 1                                        

    \[6:4\]       OC1CE        RW    Поле настройки                                                 0
                                     режима канала                                              
                                     сравнения-захвата                                          
                                     1.                                                         

     \[3\]        OC1CE        RW    Бит разрешения                                                 0
                                     предварительной                                            
                                     загрузки регистра                                          
                                     сравнения-захвата                                          
                                     1.                                                         

     \[2\]        OC1CE        RW    Бит быстрого                                                   0
                                     включения канала                                           
                                     сравнения-захвата                                          
                                     1.                                                         

    \[1:0\]       OC1CE        RW    Compare capture                                                0
                                     channel 1 input                                            
                                     selection fields.                                          
  --------------------------------------------------------------------------------------------------------

Режим захвата (пины используются как входа)

  ----------------------------------------------------------------------------------------------------------
      Бит        Название      Доступ  Описание                                                    Значение
                                                                                                    сброса
  ----------- --------------- -------- ------------------- -------------------------------------- ----------
   \[15:12\]    IC2F\[3:0\]      RW    Поле конфигурации                                              0
                                       фильтра захвата                                            
                                       входов 2, эти биты                                         
                                       задают частоту                                             
                                       дискретизации входа                                        
                                       TI1 и длину                                                
                                       цифрового фильтра.                                         
                                       Цифровой фильтр                                            
                                       состоит из счётчика                                        
                                       событий, который                                           
                                       регистрирует N                                             
                                       событий, а затем                                           
                                       генерирует скачок                                          
                                       на выходе.                                                 

                                       0000:               нет фильтра, частота дискретизации     
                                                           равна fDTS.                            

                                       1000:               частота дискретизации Fsampling =      
                                                           Fdts/8, N = 6.                         

                                       0001:               частота дискретизации Fsampling =      
                                                           Fck_int, N = 2.                        

                                       1001:               частота дискретизации Fsampling =      
                                                           Fdts/8, N = 8.                         

                                       0010:               частота дискретизации Fsampling =      
                                                           Fck_int, N = 4.                        

                                       1010:               частота дискретизации Fsampling =      
                                                           Fdts/16, N = 5.                        

                                       0011:               частота дискретизации Fsampling =      
                                                           Fck_int, N = 8.                        

                                       1011:               частота дискретизации Fsampling =      
                                                           Fdts/16, N = 6.                        

                                       0100:               частота дискретизации Fsampling =      
                                                           Fdts/2, N = 6.                         

                                       1100:               частота дискретизации Fsampling =      
                                                           Fdts/16, N = 8.                        

                                       0101:               частота дискретизации Fsampling =      
                                                           Fdts/2, N = 8.                         

                                       1101:               частота дискретизации Fsampling =      
                                                           Fdts/32, N = 5.                        

                                       0110:               частота дискретизации Fsampling =      
                                                           Fdts/4, N = 6.                         

                                       1110:               частота дискретизации Fsampling =      
                                                           Fdts/32, N = 6.                        

                                       0111:               частота дискретизации Fsampling =      
                                                           Fdts/4, N = 8.                         

                                       1111:               частота дискретизации Fsampling =      
                                                           Fdts/32, N = 8.                        

   \[11:10\]   IC2PCS\[1:0\]     RW    Поле конфигурации                                              0
                                       предделителя канала                                        
                                       сравнения-захвата                                          
                                       2, эти два бита                                            
                                       определяют                                                 
                                       коэффициент                                                
                                       предделителя для                                           
                                       канала                                                     
                                       сравнения-захвата                                          
                                       2. Как только CC1E                                         
                                       = 0, предделитель                                          
                                       сбрасывается.                                              

                                       00:                 без предделителя, одно срабатывание    
                                                           захвата инициируется для каждого       
                                                           обнаруженного фронта на входе захвата. 

                                       01:                 захват инициируется каждые 2 события.  

                                       10:                 захват инициируется каждые 4 события.  

                                       11:                 Захват инициируется каждые 8 событий.  

    \[9:8\]     CC2S\[1:0\]      RW    Поле выбора входа                                              0
                                       канала                                                     
                                       сравнения-захвата                                          
                                       2, эти два бита                                            
                                       определяют                                                 
                                       направление канала                                         
                                       (вход/выход) и                                             
                                       выбор контакта                                             
                                       ввода.                                                     

                                       00:                 Канал сравнения-захвата 2 настроен как 
                                                           выход.                                 

                                       01:                 Канал сравнения-захвата 2 настроен как 
                                                           вход, и IC2 отображён на TI1.          

                                       10:                 Канал сравнения-захвата 2 настроен как 
                                                           вход, и IC2 отображён на TI2.          

                                       11:                 Канал сравнения-захвата 2 настроен как 
                                                           вход, и IC2 отображён на TRC. Этот     
                                                           режим работает только при выборе       
                                                           внутреннего входа триггера (по биту    
                                                           TS).                                   

    \[7:4\]     IC1F\[3:0\]      RW    Поле конфигурации                                              0
                                       фильтра захвата                                            
                                       входов 1.                                                  

    \[3:2\]    IC1PSC\[1:0\]     RW    Поле конфигурации                                              0
                                       предделителя канала                                        
                                       сравнения-захвата                                          
                                       1.                                                         

    \[1:0\]     CC1S\[1:0\]      RW    Поля выбора входа                                              0
                                       канала                                                     
                                       сравнения-захвата                                          
                                       1.                                                         
  ----------------------------------------------------------------------------------------------------------

### 10.4.8 Регистр управления сравнением/захватом 2 (TIM1_CHCTLR2)

Смещение адреса: 0x00

### 10.4.9 Регистр разрешения сравнения/захвата 2 (TIM1_CCER)

Смещение адреса: 0x00

### 10.4.10 Счетчик для таймера с расширенным управлением (TIM1_CNT)

Смещение адреса: 0x00

### 10.4.11 Пресейлдер тактовой частоты счета (TIM1_PSC)

Смещение адреса: 0x00

### 10.4.12 Регистр значения автоперезагрузки (TIM1_ATRLR)) 

Смещение адреса: 0x00

### 10.4.13 Регистр значения счетчика повторений (TIM1_RPTCR)

Смещение адреса: 0x00

### 10.4.14 Регистр сравнения/захвата 1 (TIM1_CH1CVR)

Смещение адреса: 0x00

### 10.4.15 Регистр сравнения/захвата 2 (TIM1_CH2CVR)

Смещение адреса: 0x00

### 10.4.16 Регистр сравнения/захвата 3 (TIM1_CH3CVR)

Смещение адреса: 0x00

### 10.4.17 Регистр сравнения/захвата 4 (TIM1_CH4CVR)

Смещение адреса: 0x00

### 10.4.18 Регистр торможения и мертвого времени (TIM1_BDTR)

Смещение адреса: 0x00

### 10.4.19 Регистр управления DMA (TIM1_DMACFGR)

Смещение адреса: 0x00

### 10.4.20 Регистр адреса DMA для непрерывного режима (TIM1_DMAADR)

Смещение адреса: 0x00

# Глава 11: Универсальный таймер общего назначения (GPTM) 

> Модуль универсального таймера содержит 16-битный авто перезагружаемый
> таймер, TIM2, для измерения ширины импульса или генерации импульсов с
> определенной частотой, ШИМ-сигналов и т.д. Он может использоваться в
> системах автоматизации управления, источниках питания и других
> приложениях.

## Основные характеристики 

> Основные особенности универсального таймера включают:

-   **16-битный авто перезагружаемый счетчик**, поддерживает режимы
    инкрементного счёта, декрементного счёта и комбинированного режима
    счёта (инкрементно-декрементный).

-   **16-битный прескейлер** с динамически настраиваемым коэффициентом
    деления от 1 до 65536.

-   **Поддерживает четыре независимых канала сравнения захвата**.

-   Каждый канал сравнения захвата поддерживает несколько режимов
    работы, такие как: захват входных сигналов, сравнение выходов,
    генерацию ШИМ-сигнала и однократную генерацию импульса.

-   Поддерживается управление таймером внешними сигналами.

-   Поддержка DMA в нескольких режимах.

-   Возможны инкрементация кодировки, каскадирование и синхронизация
    между несколькими таймерами.

## 11.2 Принцип работы и структура

Рисунок 11-1. Блок-схема структуры универсального таймера.

**CK_TIM from RCC**

**Internal clock(CK_INT)**

**TRGO**

**To other timers**

**To ADC**

**Reset,**

**Enable,**

**Up, Count**

**AutoReload**

**Register**

**U**

**CK_PSC**

**PSC**

**(**

**prescaler**

**)**

**[CK_CNT]{.underline}**

**CNT**

**)**

**(**

**counter**

**Stop, clear or up**

**U**

**U**

**Trigger**

**controller**

### 11.2.1 Обзор 

> Как показано на рисунке 11-1, структуру универсального таймера можно
> условно разделить на три части: часть входного тактового сигнала,
> основную часть счетчика и часть каналов сравнения-захвата. Тактовый
> сигнал для универсального таймера может поступать от шины HB
> (**CK_INT**), от внешнего входа тактового сигнала (**TIMx_ETR**), от
> других таймеров с выходом тактового сигнала (**ITRx**) и от входа
> канала сравнения-захвата (**TIMx_CHx**). Эти входные тактовые сигналы
> после различных операций фильтрации, деления и т.п. преобразуются в
> тактовые сигналы **CK_PSC** и выводятся в секцию основного счетчика.
> Кроме того, эти сложные источники тактовых сигналов также могут быть
> выведены как **TRGO** для других периферийных устройств, таких как
> таймеры и АЦП. Ядром универсального таймера является 16-битный счетчик
> (**CNT**). Сигнал **CK_PSC** делится с помощью преселектора (**PSC**),
> превращаясь в **CK_CNT**, и затем подается на **CNT**. **CNT**
> поддерживает режимы инкрементного счета, декрементного счета и
> комбинированного инкрементно-декрементного режима, а также имеет
> регистр автоматической перезагрузки (**ATRLR**), который перезагружает
> начальное значение для **CNT** в конце каждого цикла счета.
> Универсальный таймер оснащен четырьмя наборами каналов
> сравнения-защиты, каждый из которых может принимать импульсы от
> эксклюзивных выводов или выводить волновые формы на выводы, то есть
> каналы сравнения-защиты поддерживают как входной, так и выходной
> режимы. Вход каждого канала регистра сравнения-зачата поддерживает
> фильтрацию, деление, обнаружение фронтов и другие операции,
> поддерживает взаимную активацию между каналами и может также
> обеспечивать тактовый сигнал для основного счетчика **CNT**. У каждого
> канала сравнения-зачета имеется набор регистров сравнения-зацета
> (**CHxCVR**), которые поддерживают сравнение с главным счетчиком
> (**CNT**) для выдачи импульсов.

### 11.2.2 Различия между универсальным таймером общего назначения и усовершенствованным таймером управления.

> По сравнению с усовершенствованными таймерами управления,
> универсальные таймеры общего назначения не обладают следующими
> функциями:

1)  Универсальный таймер не имеет регистра повторного счета для подсчета
    циклов счета основного счетчика.

2)  Канал сравнения захвата универсального таймера не обладает функцией
    генерации мертвого времени и не имеет комплементарного выхода.

3)  Универсальный таймер не располагает механизмом тормозного сигнала.

### 11.2.3 Вход тактирования 

> В этом разделе обсуждается источник сигнала CK_PSC. Здесь представлена
> часть общей блок-схемы универсального таймера, относящаяся к источнику
> тактовых сигналов.
>
> Рисунок 11-2. Блок-схема источника сигнала CK_PSC универсального
> таймера.

**Encoder**

**mode**

**External clock**

**mode 1**

**External clock**

**mode 2**

**Internal clock**

**mode**

**CK_PSC**

**TI2F**

**TI1F**

**or**

**or**

**TRGI**

**ETRF**

**CK_INT**

**or**

**)**

**(**

**internal clock**

**TS\[2:0\]**

**TIMx_SMCR**

**xx**

**0**

**100**

**101**

**110**

**111**

**ITRx**

**[TI1_ED]{.underline}**

**[TI1FP1]{.underline}**

**TI2FP2**

**[ETRF]{.underline}**

**0**

**1**

**CC2P**

**TIMx_CCER**

**Edge**

**detector**

**[TI2F_Rising]{.underline}**

**TI2F_Falling**

**Filter**

**ICF\[3:0\]**

**TIMx_CCMR1**

**TI2**

**ETR pin**

**ETP**

**TIMx_SMCR**

**0**

**1**

**ETR**

**Divider**

**/1,/2,/4,/8**

**ETPS\[1:0\]**

**TIMx_SMCR**

**ETF\[3:0\]**

**TIMx_SMCR**

**ETRP**

**f**

**DTS**

**Filter**

**downcounter**

**ECE**

**TIMx_SMCR**

**SMS\[2:0\]**

> Опциональные входные тактовые сигналы могут быть разделены на 4
> категории.

1)  Маршрут ввода внешнего тактового сигнала (**ETR**): **ETR** →
    **ETRP** → **ETRF**.

2)  Маршрут внутреннего тактового сигнала HB: **CK_INT**.

3)  Маршрут от контакта канала сравнения захвата (**TIMx_CHx**):
    **TIMx_CHx** → **TIx** → **TIxFPx**; этот маршрут также используется
    в режиме энкодера.

4)  Вход от других внутренних таймеров: **ITRx**. Фактическая операция
    может быть разделена на 3 категории путем определения выбора
    входного импульса для **SMS** источника **CK_PSC**.

5)  Выбор внутреннего источника тактового сигнала (**CK_INT**).

6)  Режим внешнего тактового источника 1.

7)  Режим внешнего тактового источника 2.

8)  Режим энкодера.

> Все 4 упомянутых выше источника тактовых сигналов могут быть выбраны
> этими 4 операциями.

#### 11.2.3.1 Внутренний источник тактовых сигналов (CK_INT) 

> Если универсальный таймер запускается при удержании поля SMS в
> состоянии 000b, то выбирается внутренний источник тактовых сигналов
> (CK_INT) в качестве тактового сигнала. В этот момент CK_INT становится
> CK_PSC.

#### 11.2.3.2 Режим 1 (Mode 1) внешнего тактового источника 

> Когда область **SMS** установлена на 111b, включается первый режим
> внешнего тактового источника. При включении первого внешнего тактового
> источника в качестве источника для **CK_PSC** выбирается **TRGI**.
> Следует отметить, что пользователь также должен выбрать источник для
> **TRGI**, настроив область **TS**. Область **TS** может выбирать
> следующие типы импульсов в качестве источников тактовых сигналов:

1)  Внутренний триггер (**ITRx**, где x равно 0,1,2,3).

2)  Сравнение сигнала после захвата канала 1 через детектор фронта
    (**TI1F_ED**).

3)  Сравнение сигналов **TI1FP1**, **TI2FP2** канала захвата.

4)  Сигнал **ETRF** от входа внешнего тактового сигнала.

#### 11.2.3.3 Режим 2 (Mode 2) внешнего тактового источника 

> Используйте второй режим внешнего триггера для подсчета на каждом
> восходящем или нисходящем фронте входного сигнала внешнего тактового
> вывода. Когда позиция **ECE** установлена, используется второй режим
> внешнего тактового источника. При использовании второго режима
> внешнего тактового источника в качестве **CK_PSC** выбирается
> **ETRF**. Контакт **ETR** становится **ETRP** после прохождения через
> необязательный инвертор (**ETP**), делитель (**ETPS**), а затем
> **ETRF** после прохождения через фильтр (**ETF**). При установке бита
> позиции **ECE** и **SMS** на 111b это эквивалентно выбору **ETRF** в
> качестве ввода с помощью **TS**.

#### 11.2.3.4 Режим энкодера 

> Установка SMS на 001b, 010b или 011b включит режим энкодера. Включение
> режима энкодера позволяет выбрать определенный уровень в **TI1FP1** и
> **TI2FP2** для передачи сигнала с другим перепадом уровня в качестве
> сигнала. Этот режим используется при применении внешнего энкодера. За
> подробностями о конкретных функциях обратитесь к разделу 11.3.7.

### 11.2.4 Счетчики и переферия 

> **CK_PSC** поступает на предварительный делитель (**PSC**) для
> деления. **PSC** является 16-битным, и реальный коэффициент деления
> равен значению **R16_TIMx_PSC** + 1. **CK_PSC** проходит через **PSC**
> и становится **CK_INT**. Изменение значения **R16_TIM1_PSC** не
> вступает в силу в реальном времени, но обновляется в **PSC** после
> события обновления. Событие обновления включает очистку и сброс бита
> **UG**.

### 11.2.5 Каналы захвата и сравнения 

> Ядром канала сравнения/захвата, который является основой таймера для
> реализации сложных функций, является регистр сравнения/захвата. Он
> дополняется цифровой фильтрацией, делением частоты и межканальным
> мультиплексированием в секции периферийного ввода, а также
> компаратором и управлением вывода в секции вывода. Блок-схема
> структуры канала сравнения/захвата показана на Рисунке 11-3.
>
> Рисунок 11-3. Блок-схема структуры канала сравнения захвата.
>
> ![](media/image33.png){width="6.361111111111111in"
> height="6.888888888888889in"}
>
> Сигнал вводится с контакта канала x и опционально формируется как
> **TIx** (источником **TI1** может быть больше чем CH1, см. блок-схему
> 10-1 таймера), **TI1** проходит через фильтр (**ICF**\[3:0\]), чтобы
> сформировать **TI1F**, а затем делится на **TI1F_Rising** и
> **TI1F_Falling** через детектор фронта, эти два сигнала выбираются
> (**CC1P**) для генерации **TI1FP1**, **TI1FP1** и **TI2FP1** из канала
> 2 отправляются вместе на **CC1S** для выбора и становятся **IC1**,
> который отправляется в регистр сравнения захвата после деления
> **ICPS**. Регистр сравнения захвата состоит из регистра
> предварительной загрузки и теневого регистра, а процесс чтения/записи
> выполняется только на регистре предварительной загрузки. В режиме
> захвата захват происходит на теневом регистре, а затем копируется в
> регистр предварительной загрузки; в режиме сравнения содержимое
> регистра предварительной загрузки копируется в теневой регистр, а
> затем содержимое теневого регистра сравнивается с основным счетчиком
> (**CNT**).

## 11.3 Функциональные возможности и реализация 

> Сложные функции универсального таймера реализуются путем манипуляции
> каналом сравнения захвата таймера, схемой ввода тактового сигнала и
> компонентами счетчика и периферии. Тактовый сигнал, подаваемый на
> таймер, может быть получен из множества источников тактовых сигналов,
> включая вход канала сравнения захвата. Работа основного канала
> сравнения захвата и выбор источника тактовых сигналов непосредственно
> определяют его функцию. Канал сравнения захвата является
> двунаправленным и может работать как в режиме ввода, так и в режиме
> вывода.

### 11.3.1 Режим захвата входа (Input Capture) 

> Режим захвата входного сигнала является одной из базовых функций
> таймера. Принцип работы режима захвата входного сигнала заключается в
> том, что при обнаружении определенного фронта сигнала **ICxPS**
> генерируется событие захвата, и текущее значение счетчика фиксируется
> в регистре сравнения захвата (**R16_TIMx_CHCTLRx**). Бит **CCxIF** (в
> **R16_TIMx_INTFR**) устанавливается при возникновении события захвата,
> и соответствующий прерывание или DMA генерируются, если они включены.
> Если бит **CCxIF** уже установлен при возникновении события захвата,
> то устанавливается бит **CCxOF**. Бит **CCxIF** может быть очищен
> программно или аппаратно путем чтения регистра сравнения захвата. Бит
> **CCxOF** очищается программно. Пример использования режима захвата на
> входе для канала 1 приведен ниже.

1)  Настройте область **CCxS** для выбора источника сигнала **ICx**.
    Например, установите ее на 10b и выберите **TI1FP1** в качестве
    источника **IC1**, не используя настройку по умолчанию. По умолчанию
    область **CCxS** настраивает модуль сравнения захвата как выходной
    канал.

2)  Настройте область **ICxF** для установки цифрового фильтра для
    сигнала **TI**. Цифровой фильтр будет выборочно считывать сигнал с
    определенной частотой определенное количество раз, а затем выдавать
    скачок. Эта частота выборки и количество раз определяются областью
    **ICxF**.

3)  Настройте бит **CCxP** для установки полярности сигнала **TIxFPx**.
    Например, оставьте бит **CC1P** низким и выберите переходы на
    восходящий фронт.

4)  Настройте область **ICxPS** для установки коэффициента перехода
    сигнала **ICx** между **ICxPS**. Например, оставляйте **ICxPS** на
    уровне 00b без перехода.

5)  Настройте бит **CCxE**, чтобы разрешить захват значения основного
    счетчика (**CNT**) в регистр сравнения захвата. Установите бит
    **CC1E**.

6)  Настройте биты **CCxIE** и **CCxDE** по мере необходимости, чтобы
    определить, следует ли разрешать использование прерываний или DMA.
    На этом завершается настройка канала сравнения захвата.

> Когда захваченный импульс подается на **TI1**, значение основного
> счетчика (**CNT**) записывается в регистр сравнения захвата,
> устанавливается бит **CC1IF**, а бит **CCIOF** устанавливается, когда
> бит **CC1IF** был установлен ранее. Если установлен бит **CC1IE**, то
> генерируется прерывание; если установлен бит **CC1DE**, генерируется
> запрос DMA. Событие захвата на входе может быть сгенерировано
> программным способом посредством записи в регистр генерации событий
> (**R16_TIMx_SWEVGR**).

### 11.3.2 Режим сравнения (Compare Mode) 

> Режим сравнения выходов является одной из базовых функций таймера.
> Принцип работы режима сравнения выходов заключается в том, чтобы
> выводить определенное изменение или форму волны, когда значение
> основного счетчика (**CNT**) совпадает со значением регистра сравнения
> захвата. Поле **OCxM** (в **R16_TIMx_CHCTLRx**) и бит **CCxP** (в
> **R16_TIMx_CCER**) определяют, является ли выходной сигнал
> определенным высоким или низким уровнем или переключением уровня. Бит
> **CCxIF** также устанавливается, когда генерируется согласованное
> событие сравнения. Если предварительно установлен бит **CCxIE**, будет
> сгенерировано прерывание; если предварительно установлен бит
> **CCxDE**, будет сформирован запрос DMA. Чтобы настроить режим
> сравнения выходов, выполните следующие шаги:

4)  Настройка источника тактового сигнала и значения автоперезагрузки
    основного счетчика (CNT).

5)  Установка значения для сравнения с регистром сравнения захвата
    (R16_TIMx_CHxCVR).

6)  Установка бита CCxIE, если необходимо сгенерировать прерывание.

7)  Оставьте OCxPE равным 0, чтобы отключить регистр предварительной
    загрузки для регистра сравнения захвата.

8)  Установка режима вывода, установка поля OCxM и бита CCxP.

9)  Включите вывод, установив бит CCxE.

10) Установка бита CEN для запуска таймера.

### 11.3.3 Режим принудительного вывода (Forced Output Mode) 

> Выходной шаблон канала сравнения захвата таймера может быть
> принудительно изменен программным обеспечением для вывода
> определенного уровня без необходимости сравнения теневого регистра
> регистра сравнения захвата с основным счетчиком. Это делается путем
> установки OCxM на 100b, что вынуждает OCxREF опускаться до низкого
> уровня, или путем установки OCxM на 101b, что заставляет OCxREF
> подниматься до высокого уровня. Обратите внимание, что принудительная
> установка OCxM в положение 100b или 101b все еще продолжается процесс
> сравнения между внутренним основным счетчиком и регистром сравнения
> захвата, соответствующие флаги все еще устанавливаются, и все еще
> генерируются прерывания и запросы DMA.

### 11.3.4 Режим измерения ШИМ (PWM Input Mode) 

> Режим ввода ШИМ используется для измерения коэффициента заполнения и
> частоты ШИМ и является особым случаем режима захвата на входе.
> Операции аналогичны режиму захвата на входе, за исключением следующих
> отличий: ШИМ занимает два канала сравнения захвата, и полярность ввода
> двух каналов установлена противоположная, один из сигналов установлен
> как вход триггера, а **SMS** установлен в режим сброса. Например,
> чтобы измерить период и частоту входящего сигнала ШИМ от **TI1**,
> требуются следующие операции.

1)  Установите TI1 (TI1FP1) в качестве входа сигнала IC1. Установите
    CC1S на 01b.

2)  Установите TI1FP1 на активный фронт нарастания. Держите CC1P на
    нуле.

3)  Установите TI1 (TI1FP2) в качестве входного сигнала IC2. Установите
    CC2S на 10b.

4)  Выберите TI1FP2 для активации спадающего фронта. Установите CC2P на
    1.

5)  Выберите TI1FP1 в качестве источника тактового сигнала. Установите
    TS на 101b.

6)  Выберите режим сброса для SMS, то есть 100b.

7)  Включите захват на входе. Устанавливаются cc1e и cc2e.

### 11.3.5 Режим генерации ШИМ (PWM Output Mode) 

> ежим вывода ШИМ является одной из основных функций таймера. Режим
> вывода ШИМ чаще всего используется для определения частоты ШИМ с
> использованием значения перезагрузки и коэффициента заполнения с
> использованием регистра сравнения захвата. Установите 110b или 111b в
> поле **OCxM** для использования режима ШИМ 1 или режима 2, установите
> бит **OCxPE** для включения регистра предварительной загрузки и,
> наконец, установите бит ARPE для разрешения автоматического
> перезагрузки регистра предварительной загрузки. Значение регистра
> предварительной загрузки может быть отправлено в теневой регистр
> только тогда, когда происходит событие обновления, поэтому бит **UG**
> необходимо установить для инициализации всех регистров перед началом
> счета основного счетчика. В режиме ШИМ основной счетчик и регистр
> сравнения захвата всегда находятся в сравнении, и в зависимости от
> бита **CMS** таймер способен выводить сигналы ШИМ, выровненные по краю
> или центру.

-   Выравнивание по краю

> При выравнивании по краю основной счетчик увеличивается или
> уменьшается, и в сценарии режима ШИМ 1, когда значение основного
> счетчика превышает значение регистра сравнения захвата, **OCxREF**
> поднимается до высокого уровня; когда значение главного счетчика
> меньше значения регистра сравнения (например, когда главный счетчик
> растет до значения **R16_TIMx_ATRLR** и возвращается к полному нулю),
> **OCxREF** падает до низкого уровня. Выравнивание по центру При
> использовании режима центрированного выравнивания основной счетчик
> работает в чередовании режимов инкрементного и декрементального счета,
> и **OCxREF** выполняет подъемы и падения, когда значения основного
> счетчика и регистра сравнения совпадают. Тем не менее, флажки
> сравнения устанавливаются в разное время в трех режимах центрального
> выравнивания. При использовании режимов центрального выравнивания
> рекомендуется сгенерировать флаг программного обновления (установить
> бит **UG**) перед запуском основного счетчика.

### 11.3.6 Режим одного импульса (Single Pulse Mode) 

> Режим одиночного импульса может реагировать на конкретное событие,
> генерируя импульс после задержки с программируемыми задержкой и
> шириной импульса. Установка бита **OPM** останавливает основной
> счетчик, когда генерируется следующее событие обновления **UEV**
> (счетчик переходит в ноль).
>
> Рисунок 11-4. Генерация событий и реакция на импульс
>
> ![](media/image34.png){width="4.629861111111111in"
> height="2.9256944444444444in"}
>
> Как показано на Рисунке 11-4, на выводе OC1 необходимо сгенерировать
> положительный импульс длиной Tpulse после задержки Tdelay в начале
> растущего фронта, обнаруженного на выводе **TI2**. Для этого требуется
> выполнить следующие шаги:

1)  Настройки для генерации триггера. В поле **CC2S** установлено
    значение 01b, которое отображает **TI2FP2** как **TI2**; бит
    **CC2P** установлен на 0b, что устанавливает **TI2FP2** для
    обнаружения растущего края; поле **TS** установлено на 110b,
    устанавливающее **TI2FP2** в качестве триггерного источника; поле
    **SMS** установлено на значение 110b для установки **TI2FP2**,
    используемого для запуска счетчика.

2)  Задержка Tdelay определяется значением регистра сравнения захвата, а
    ширина импульса Tpulse определяется значениями регистра
    автоперезагрузки и регистра сравнения захвата.

### 11.3.7 Режим энкодера (Encoder Mode) 

> Режим энкодера является типичным применением таймера и может
> использоваться для получения фазового выхода энкодера. Направление
> счёта основного счётчика синхронизируется с направлением вращения оси
> энкодера, и каждое импульс, исходящий от энкодера, увеличит или
> уменьшит значение основного счётчика на единицу. Чтобы использовать
> энкодер, установите поле **SMS** на 001b (подсчёт только по краю
> **TI2**), 010b (счёт только на краю **TI1**) или 011b (Счёт на краях
> **TI1** и **TI2**). Подключите энкодер к входам каналов сравнения
> захвата 1 и 2, и установите значение счётчика перегрузки, которое
> может быть установлено на большее значение. В режиме энкодера
> внутренние регистры сравнения захвата, пресет-счётчик, счётчик
> повторяющихся чисел и т.д. таймера работают нормально. В следующей
> таблице показаны отношения между направлением счёта и сигналом
> энкодера.
>
> Таблица 11-1 Связь между направлением счёта и сигналом энкодера в
> режиме энкодера таймера

### 11.3.8 Режим синхронизации таймера (Timer Synchronization Mode)

> Таймеры способны генерировать тактовые импульсы (TRGO) и получать
> входы от других таймеров (ITRx). Источник ITRx (TRGO от других
> таймеров) различается для разных таймеров. Соединения внутренней связи
> триггеров таймера показаны в Таблице 11-2.
>
> Таблица 11-2 Подключение внутренних GTPM триггеров таймера

  -------------------------------------------------------------------------
  От таймера    ITR0(TS=000)   ITR0(TS=001)   ITR0(TS=010)   ITR0(TS=011)
  ------------- -------------- -------------- -------------- --------------
  TIM2          TIM1                                          

  TIM1                         TIM2                           
  -------------------------------------------------------------------------

### 11.3.9 Режим наладки 

> Когда система входит в режим отладки, таймер может продолжать
> выполнение команд или остановиться в зависимости от настроек модуля
> DBG.

## 11.4 Описание регистров 

> Table 11-3 TIM2-related registers list

### 11.4.1 Control Register 1 (TIM2_CTLR1) 

### 11.4.2 Control Register 2 (TIM2_CTLR2) 

> Offset address: 0x04

### 11.4.3 Slave Mode Control Register (TIM2_SMCFGR) 

> Offset address: 0x08

**11.4.4 TIM2 DMA/Interrupt Enable Register (TIM2_DMAINTENR)**

### 11.4.5 Interrupt Status Register (TIM2_INTFR) 

> Offset address: 0x10

### 11.4.6 TIM2 Event Generation Register (TIM2_SWEVGR) 

> Offset address: 0x14

### 11.4.7 Compare/Capture Control Register 1 (TIM2_CHCTLR1) 

> Offset address: 0x18
>
> Канал может использоваться в режиме ввода (режим захвата) или вывода
> (режим сравнения), а направление канала задаётся соответствующим битом
> **CCxS**. Другие биты этого регистра выполняют разные функции в
> режимах ввода и вывода. Биты **OCxx** описывают функциональность
> канала в режиме вывода, а биты **ICxx** описывают функциональность
> канала в режиме ввода.

### 11.4.8 Compare/Capture Control Register 2 (TIM2_CHCTLR2) 

> Offset address: 0x1C

Канал может быть использован в режиме ввода (режим захвата) или вывода
(режим сравнения), а направление канала определяется соответствующим
битом **CCxS**. Остальные биты этого регистра служат различными целями в
режимах ввода и вывода. Биты **OCxx** описывают функцию канала в режиме
вывода, а биты **ICxx** описывают функцию канала в режиме ввода.

### 11.4.9 Compare/Capture Enable Register (TIM2_CCER) 

> Offset address: 0x20

### 11.4.10 Counter for General-purpose Timer (TIM2_CNT) 

### 11.4.11 Counting Clock Prescaler (TIM2_PSC) 

### 11.4.12 Auto-reload Value Register (TIM2_ATRLR) 

### 11.4.13 Compare/capture Register 1 (TIM2_CH1CVR) 

> Offset address: 0x34

### 11.4.14 Compare/capture Register 2 (TIM2_CH2CVR) 

### 11.4.15 Compare/capture Register 3 (TIM2_CH3CVR) 

### 11.4.16 Compare/capture Register 4 (TIM2_CH4CVR) 

### 11.4.17 DMA Control Register (TIM2_DMACFGR) 

> Offset address: 0x48

### 11.4.18 DMA Address Register for Continuous Mode (TIM2_DMAADR) 

# Глава 12: Универсальный синхронно-асинхронный приёмопередатчик (USART) 

> Модуль включает в себя универсальный синхронно-асинхронный
> приемопередатчик USART1.

## 12.1 Основные характеристики

-   Полнодуплексная или полудуплексная синхронная или асинхронная связь

-   Формат данных NRZ

-   Генератор дробной скорости до 3 Mbps

-   Программируемая длина данных

-   Конфигурация стоповых битов

-   Поддержка протоколов LIN, кодировщиков IrDA, смарт-карт

-   Поддержка DMA

-   Множество источников пререрываний

## 12.2 Обзор 

> Рисунок 12-1. Блок-диаграмма универсального синхронно-асинхронного
> приемопередатчика
>
> ![](media/image35.png){width="5.2965277777777775in"
> height="5.592361111111111in"}
>
> Когда бит **TE** (бит разрешения передачи) установлен, данные из
> регистра сдвига передачи выводятся на пин TX, а тактовый сигнал
> передается на пина CK. При передаче данных таймер выводит самый
> незначимый бит (**LSB**) из сдвигового регистра на пину TX, и каждая
> передача данных начинается с низкоуровневого стартового бита. Передача
> данных осуществляется передачей 8-битового или 9-битового слова данных
> в зависимости от настройки бита **M** (длины слова). После завершения
> передачи данных и установки бита **TE**, передатчик передает кадр
> начала, содержащий низкий стартовый бит, а затем 8 или 9 бит данных, в
> зависимости от установки битов **M**. В случае наличия бита проверки
> на четность, последний бит данных служит битами проверки. После
> отправки кадра, при установке бита **TE**, посылается кадр «idle»,
> состоящий из 10 или 11 высоких битов, за которыми следует бит
> остановки. Кадр отключения содержит 10 или 10 бит низких данных, за
> которым следует бит останова.

## 12.3 Тактирование генератора битрейта передачи (Baud Rate Generator)

> Скорость передачи данных передатчика рассчитывается по формуле
> BaudRate = Fbaud, где Fbaud -- это частота передачи данных, а **HCLK**
> -- это тактовая частота шины HB. Значение **USARTDIV** определяется
> двумя полями, **DIV_M** и **DIV_F** в регистре **USART_BRR**. Формула
> расчета выглядит следующим образом:
>
> $$BaudRate = \frac{HCLK}{16*USARTDIV\ }$$
>
> Где **HCLK** --- это частота тактового генератора шины HB, а
> **USARTDIV** --- это значение, определяемое полями **DIV_M** and
> **DIV_F**. Отсюда:
>
> $$USARTDIV\  = \ {DIV}_{M} + \left( \frac{{DIV}_{F}}{16} \right)$$
>
> Важно отметить, что скорость передачи битов, генерируемая генератором
> скорости передачи символов (baud rate), может не всегда точно
> соответствовать требуемой пользователем скорости передачи данных, и
> возможны отклонения. Помимо выбора максимально близкого значения,
> одним из способов уменьшения отклонений является увеличение частоты
> тактового генератора HB. Например, если вы установите скорость
> передачи данных 115200 бит/с, значение **USARTDIV** будет установлено
> равным 39,0625, что даст вам точную скорость передачи 115200 бит/с при
> максимальной частоте, но если вам нужна скорость передачи данных
> 921600 бит/с, рассчитанное значение **USARTDIV** составляет 4,88,
> однако ближайшее значение, которое можно установить в **USART_BRR**,
> фактически равно только 4,875. При значении 4,875 реальная скорость
> передачи составит 923076 бит/с с ошибкой 0,16%. Когда последовательный
> сигнал, отправленный передатчиком, передается приемнику, между
> скоростью передачи приемника и передатчика могут возникать некоторые
> ошибки. Ошибка возникает по трем основным причинам: действительная
> скорость передачи приемника отличается от таковой у передатчика; часы
> приемника и передатчика имеют погрешности; изменения, возникающие в
> сигнале линии. Приемник периферийного модуля имеет определенную
> допустимую погрешность приема, когда сумма всех трех вышеуказанных
> отклонений меньше предела допуска модуля, суммарное отклонение не
> влияет на передачу и прием. Предел допуска модуля зависит от
> использования дробной скорости передачи и длины слова данных (Mбит),
> использование дробной скорости передачи данных и длина поля данных в 9
> бит уменьшают предел допуска, но он не должен быть менее 3%.Начало
> формы

## 12.4 Синхронный режим (Synchronous Mode)

## Режим синхронизации позволяет системе выдавать сигнал синхронизации при использовании модуля USART. Когда включается синхронный режим для передачи данных во внешнюю среду, контакт CK одновременно начнет выдавать внешний тактовый сигнал.

## Чтобы включить синхронный режим, необходимо установить бит CLKEN в контрольном регистре 2 (R16_USARTx_CTLR2). Также требуется отключить режимы LIN, смарт-карты, инфракрасный и полудуплексный режимы, то есть убедиться, что биты SCEN, HDSEL и IREN сброшены. Эти три бита находятся в контрольном регистре 3 (R16_USARTx_CTLR3).Начало формы

## Ключевой момент при использовании синхронного режима -- это управление выходом тактового сигнала. Следует учесть несколько важных аспектов:

## Режим синхронизации модуля USART работает только в основном режиме, то есть контакт CK выдает только тактовый сигнал и не принимает входных данных. 

## Тактовый сигнал выдается только тогда, когда данные отправляются через контакт TX. 

## Бит LBCL определяет, будет ли выдаваться тактовый сигнал после отправки последнего бита данных, бит CPOL задает полярность тактового сигнала, а бит CPHA --- его фазу. Эти три бита расположены в контрольном регистре 2 (R16_USARTx_CTLR2) и должны быть настроены до активации режимов TE и RE. Различия между этими настройками показаны на Рисунке 12-2. 

## Приемник будет производить выборку данных только по выходному тактовому сигналу в синхронном режиме, требуя определенного времени нарастания и удержания сигнала от устройства, как показано на Рисунке 12-3. 

Рисунок 12-2 Пример временных характеристик тактового сигнала USART
(M=0)

> ![](media/image36.png){width="6.361111111111111in"
> height="4.154411636045494in"}
>
> Рисунок 12-3 Время удержания выборки данных

**CK (capture strobe on CK**

**rising edge in this example)**

**Data on RX**

**from slave**

**)**

**(**

**valid DATA bit**

**t**

**SETUP**

**t**

**HOLD**

**t**

**SETUP**

**=**

**t**

**HOLD**

**1**

**/16 bit time**

## 12.5 Однопроводный полудуплексный режим (1-Wire Half-duplex Mode)

> Полудуплексный режим поддерживает использование одного контакта
> (только TX) для приёма и передачи данных, при этом контакты TX и RX
> соединяются внутри чипа.
>
> Для включения полудуплексного режима необходимо установить бит
> **HDSEL** в позиции регистра управления 3 (**R16_USARTx_CTLR3**), но
> также необходимо отключить режим LIN, режим смарт-карты, ИК-режим и
> синхронный режим, то есть обеспечить сброс битов **SCEN**, **CLKEN** и
> **IREN**, находящихся в регистрах управления 2 и 3
> (**R16_USARTx_CTLR2** и **R16_USARTx_CTLR3**).
>
> После установки в полудуплексный режим необходимо настроить порт
> ввода-вывода TX на работу в режиме открытого стока с высоким уровнем
> выхода. При установке **TE** данные будут отправляться сразу же после
> записи их в регистр данных. Особое внимание следует уделить тому
> факту, что полудуплексный режим может привести к конфликтам шины при
> использовании нескольких устройств одной шины для отправки и получения
> данных, чего пользователь должен избегать программными средствами.

## 12.6 Режим смарткарт (Smart Card)

> Режим смарт-карты поддерживает доступ к контроллерам смарт-карт по
> протоколу ISO7816-3.
>
> Для включения режима смарт-карта необходимо установить бит **SCEN** в
> позиции регистра управления 3 (**R16_USARTx_CTLR3**), но также
> необходимо отключить режим LIN, полудуплексный режим и ИК-режим, то
> есть обеспечить сброс битов **LINEN**, **HDSEL** и **IREN**, но
> **CLKEN** может быть включён для вывода тактового сигнала, эти биты
> находятся в регистрах управления 2 и 3 (**R16_USARTx_CTLR2** и
> **R16_USARTx_CTLR3**).
>
> Для поддержки режима смарт-карточек USART должен быть установлен на 8
> бит данных плюс 1 бит чётности, а стоп-бит рекомендуется настраивать
> на 1,5 бита как для передачи, так и для приёма. Режим смарткарты
> представляет собой полудуплексный протокол с использованием одной
> линии связи, где используется линия TX для обмена данными и должна
> быть сконфигурирована как выходной каскад с открытым стоком плюс
> подтягивающий резистор. Когда приёмник получает кадр данных и
> обнаруживает ошибку чётности, он посылает сигнал NACK, то есть активно
> притягивает линию TX вниз на один цикл во время стоп-бита, а
> отправитель обнаруживает сигнал NACK и генерирует ошибку кадра,
> благодаря чему приложение может повторно передать данные. На рис. 17-4
> показаны формы сигналов на контакте TX в нормальном случае и в случае
> ошибки чётности. Флаг **TC** (флаг завершения передачи) USART может
> задержать генерацию **GT** (время защиты) на один такт, и приёмник не
> распознаёт установленный им сигнал NACK как стартовый бит.
>
> Рисунок 12-4 Диаграмма (не)возникновения ошибки чётности
>
> ![](media/image37.png){width="5.259027777777778in"
> height="2.290074365704287in"}
>
> В режиме смарт-карты форма сигнала, выводимого контактом CK при
> включении, никак не связана с коммуникацией; она просто подаёт
> тактовый сигнал на смарт-карту со значением тактового сигнала AHB,
> разделённого на пять бит (в два раза больше значения **PSC**, вплоть
> до 62 делений).

## 12.7 IrDA 

> Модуль USART поддерживает управление инфракрасными трансиверами IrDA
> для физической коммуникации. Для использования IrDA необходимо
> сбросить биты **LINEN**, **STOP**, **CLKEN**, **SCEN** и **HDSEL**.
> Между модулем USART и физическим уровнем SIR (инфракрасный трансивер)
> используется кодирование **NRZ** (без возврата к нулю), поддерживаемое
> до скоростей 115200 бод.
>
> IrDA является полудуплексным протоколом. Если USART передает данные
> физическому уровню **SIR**, декодер IrDA игнорирует вновь поступающий
> инфракрасный сигнал. Если USART принимает данные от **SIR**, то
> **SIR** не примет сигнал от USART. Логика уровней USART для **SIR** и
> **SIR** для USART различается. В логике приема **SIR** высокий уровень
> соответствует 1, а низкий --- 0, но в логике передачи SIR высокий
> уровень равен 0, а низкий --- 1.

## 12.8 Прямой доступ к памяти (DMA) 

> Модуль USART поддерживает функцию DMA, которая может использоваться
> для достижения быстрой и непрерывной передачи и приема данных. Когда
> DMA активирован, DMA записывает данные из заданного пространства
> памяти в буфер передачи, когда установлен флаг **TXE**. При
> использовании DMA для приема данных, каждый раз, когда устанавливается
> флаг **RXNE**, DMA переносит данные из буфера приема в определенное
> пространство памяти.

## 12.9 Прерывания 

> Модуль USART поддерживает различные источники прерываний, включая
> пустоту регистра передачи данных (**TXE**), CTS, завершение передачи
> (**TC**), готовность принимаемых данных (**RXNE**), переполнение
> данных (**ORE**), неактивную линию (IDLE), ошибку четности (**PE**),
> флаг отключения (**LBD**), шум (**NE**), переполнение для
> многобуферной связи (**ORT**) и ошибку кадра (**FE**), среди прочих.
>
> Таблица 12-1 Соотношение между прерываниями и соответствующими битами
> разрешения

## 12.10 Описание регистров 

> Таблица 12-2 Список регистров, связанных с USART
>
> Начало формы

### 12.10.1 USART Status Register (USART_STATR) 

### 

### 12.10.2 USART Data Register (USART_DATAR) 

### 12.10.3 USART Baud Rate Register (USART_BRR) 

### 12.10.4 USART Control Register 1 (USART_CTLR1) 

### 

### 12.10.5 USART Control Register 2 (USART_CTLR2) 

### 12.10.6 USART Control Register 3 (USART_CTLR3) 

### 12.10.7 USART Guard Time and Prescaler Register (USART_GPR) 

# Глава 13 Интерфейс межмикросхемной связи (I2C) 

> Шина внутренней микросхемы (I2C) широко применяется для связи
> микроконтроллеров с датчиками и другими внекристальными модулями. Она
> поддерживает режимы с несколькими ведущими и несколькими ведомыми
> устройствами и может обеспечивать связь на скоростях 100 КГц
> (стандартная) и 400 КГц (быстрая) всего лишь двумя линиями (SDA и
> SCL). Поддерживаются функции тайминга и DMA, а также функция проверки
> контрольной суммы CRC.

## 13.1 Основные характеристики 

-   Поддержка режимов мастера и слейва

-   Поддержка 7-битных и 10-битных адресов

-   Устройства-слейвы поддерживают двойные 7-битные адреса

-   Поддержка двух скоростных режимов: 100 КГц и 400 КГц

-   Множество состояний и множество флагов ошибок

-   Поддержка расширенных функций часов

-   Два вектора прерываний

-   Поддержка DMA

-   Поддержка PEC

-   Совместимость с SMBus

## 13.2 Обзор

> I2C представляет собой полудуплексную шину, которая может работать
> только в одном из следующих четырех режимов одновременно: режим
> передачи ведущего устройства, режим приема ведущего устройства, режим
> передачи ведомого устройства и режим приема ведомого устройства.
> Модуль I2C по умолчанию работает в режиме слейва и автоматически
> переключается в режим мастера при генерации условия старта и в режим
> слейва при потере арбитража или генерации сигнала остановки. Модуль
> I2C поддерживает функциональность с несколькими мастерами. Работая в
> режиме мастера, модуль I2C активно излучает данные и адреса. Как
> данные, так и адрес передаются блоками по 8 бит, причем старший бит
> идет первым, а младший --- последним. После события старта следует
> однобайтовая (в режиме 7-битного адреса) или двухбайтовая (в режиме
> 10-битного адреса) информация об адресе, и для каждых 8-битных данных
> или адреса, отправленных хостом, слейву необходимо ответить
> подтверждением ACK, притянув шину SDA к низкому уровню, как показано
> на Рисунке 13-1.
>
> Рисунок 13-1 Временная диаграмма I2C
>
> Для корректной работы I2C необходимо подавать правильный тактовый
> сигнал, который должен быть минимум 2 МГц в стандартном режиме и 4 МГц
> в быстром режиме.
>
> На рисунке 13-2 представлена функциональная блок-схема модуля I2C.

**Noise**

**filter**

**Data**

**control**

**Data shift register**

**Data register**

**Comparator**

**PEC calculation**

**Own address register**

**Dual address register**

**PEC register**

**Noise**

**filter**

**Clock**

**control**

**Clock control**

**Register (CKCFGR)**

**Control registers**

**CTLR1&CTLR**

**2)**

**(**

**Status registers**

**(**

**2)**

**STAR1&STAR**

**Control**

**logic**

**SDA**

**SCL**

**SMBA**

**Interrupts**

**DMA requests & ACK**

## 13.3 Режим мастера (Master Mode)

> В режиме мастера модуль I2C управляет передачей данных и выдает сигнал
> синхронизации, а передача данных начинается с события начала и
> заканчивается событием окончания. Шаги для использования общения в
> режиме мастера следующие. Установка правильного тактового сигнала в
> регистре управления 2 (R16_I2Cx_CTLR2) и регистре контроля тактового
> сигнала (R16_I2Cx_CKCFGR). Установка соответствующего фронта в
> регистре фронтов (R16_I2Cx_RTR). Установка бита PE в регистре
> управления (R16_I2Cx_CTLR1) для запуска периферии. Установка бита
> START в регистре управления (R16_I2Cx_CTLR1) для генерации события
> начала.После установки бита START модуль I2C автоматически перейдет в
> основной режим, бит MSL будет установлен и событие начала будет
> сгенерировано. После генерации события начала будет установлен бит SB,
> и если установлен бит ITEVTEN (в R16_I2Cx_CTLR2), произойдет
> прерывание. В этот момент следует прочитать регистр статуса 1
> (R16_I2Cx_STAR1), а бит SB будет автоматически очищен после записи
> адреса в регистр данных.
>
> Если используется режим 10-битного адреса, то регистр записи данных
> отправляет заголовочную последовательность (заголовочная
> последовательность имеет вид 11110xx0b, где биты xx являются старшими
> двумя битами 10-битного адреса). После отправки заголовочной
> последовательности в регистре состояния будет установлен бит ADD10, и
> если был установлен бит ITEVTEN, будет сгенерировано прерывание. В
> этот момент следует прочитать регистр R16_I2Cx_STAR1 и очистить бит
> ADD10 после записи второго байта адреса в регистр данных.
>
> Затем запишите второй байт адреса в регистр данных для его отправки.
> После отправки второго байта адреса в регистре состояния будет
> установлен бит ADDR. Если уже установлен бит ITEVTEN, будет
> сгенерировано прерывание. В этот момент следует прочитать регистр
> R16_I2Cx_STAR1, а затем однократно прочитать регистр R16_I2Cx_STAR2,
> чтобы очистить бит ADDR;
>
> Если используется режим 7-битного адреса, то запишите байт адреса в
> регистр данных. После отправки байта адреса в регистре состояния
> установится бит ADDR. Если установлен бит ITEVTEN, то будет
> сгенерировано прерывание. В этом случае следует прочитать регистр
> R16_I2Cx_STAR1 и затем однократно прочитать регистр R16_I2Cx_STAR2 для
> очистки бита ADDR.
>
> В режиме 7-битного адреса первый отправляемый байт --- это байт
> адреса, первые 7 бит представляют адрес целевого ведомого устройства,
> 8-й бит определяет направление последующего сообщения: 0 означает, что
> ведущее устройство записывает данные в ведомое устройство, 1 означает,
> что ведущее устройство считывает информацию из ведомого устройства.
>
> В режиме 10-битного адреса, как показано на Рисунке 13-3, на этапе
> отправки адреса первый байт имеет формат 11110xx0, где xx --- это две
> старших цифры 10-битного адреса, а второй байт содержит младшие 8 бит
> 10-битного адреса. Если впоследствии предполагается перейти в режим
> передачи данных мастером, продолжайте отправлять данные; если
> планируется переход в режим приема данных мастером, необходимо
> повторно отправить условие начала, затем отправить байт в формате
> 11110xx1 и после этого перейти в режим приема данных мастером.
>
> Рисунок 13-3 Диаграмма отправки и получения данных мастером при
> 10-битном адресе

**S**

**1**

**1 1 1 0 X X**

**0**

**A**

**Address 7- 0**

**A**

**DATA**

**A**

**DATA**

**A**

**P**

**(**

**The upper 2 bits**

**of the address)**

**)**

**(**

**Write**

**The lower 8 bits of**

**the address**

**Transmitter**

**S**

**1**

**1 1 1 0 X X**

**0**

**A**

**Address 7- 0**

**A**

**DATA**

**A**

**DATA**

**A**

**P**

**The upper 2 bits**

**(**

**of the address)**

**(**

**Write**

**)**

**The lower 8 bits of**

**the address**

**S**

**1**

**1 1 1 0 X X**

**1**

**A**

**(**

**Read**

**)**

**Receiver**

> Режим передачи данных мастером

:

> Внутренний сдвиговый регистр ведущего устройства отправляет данные из
> регистра данных на линию SDA. Когда ведущее устройство получает
> подтверждение (ACK), в регистре состояния 1 (R16_I2Cx_STAR1)
> устанавливается бит TxE, и также генерируется прерывание, если
> установлены биты ITEVTEN и ITBUFEN. Запись данных в регистр данных
> очистит бит TxE.
>
> Если бит TxE установлен и новые данные не были записаны в регистр
> данных до отправки последних данных, то будет установлен бит BTF, и
> SCL останется низким до тех пор, пока он не будет очищен. Запись
> данных в регистр данных после чтения R16_I2Cx_STAR1 очистит бит BTF.

Рисунок 13-4 Диаграмма последовательности передачи данных передатчиком
мастера

  -----------------------------------------------------------------------------------------------------------------------------------------------------
                                                                                                                                                     
  --- --- --------- --------- --- ------ --------- ------- ------ -------- ------- --- ------- --- ------- ------ -------- ------- --- -------- --- ---
          7-бит                                                                                                                                      
          посылка                                                                                                                                   
          мастера                                                                                                                                   

      S             Address   A                    Data1   A      Data2            A               DataN   A               P                         

          EVT5                    EVT6   EVT8_1    EVT8           EVT8                 EVT8                       EVT8_2                             

          10-бит                                                                                                                                     
          посылка                                                                                                                                   
          мастера                                                                                                                                   

      S             Frame     A          Address   A                       Data1   A   Data2       A                       DataN   A            P    
                    header                                                                                                                          

          EVT5                    EVT9                     EVT6   EVT8_1   EVT8        EVT8                EVT8                        EVT8_2        

                                                                                                                                                     
  -----------------------------------------------------------------------------------------------------------------------------------------------------

> Описание:
>
> S=Старт (условие старта), Sr=повторный старт, P=Стоп (условие
> остановки), A=ответ, NA=отсутствие ответа, **EVTx**=событие
> (прерывание генерируется, когда **ITEVFEN**=1)
>
> EVT5: **SB**=1, чтение **SR1**, а затем запись адреса в регистр **DR**
> очищает событие.
>
> EVT6; **ADDR**=1, сначала читаем **SR1**, затем читаем **SR2**, чтобы
> очистить событие.
>
> EVT81: **TxE**=1, сдвиговый регистр пуст, регистр данных пуст, запись
> в регистр **DR**.
>
> EVT8: **TxE**=1, сдвиговый регистр не пустой, регистр данных пустой,
> запись в **DR** регистр очистит событие.
>
> EVT82: **TxE**=1, **BTF**=1, запрос на установку бита остановки. Биты
> **TxE** и **BTF** аппаратно очищаются при генерации условия остановки.
>
> EVT9: **ADDR10**=1, чтение **SR1** и последующая запись в **DR**
> очистят событие.
>
> *Примечание:*
>
> *1: События EVT5, EVT6, EVT9, EVT8_1 и EVT8_2 удлиняют низкий уровень
> SCL до конца соответствующей программной последовательности.*
>
> *2: Программная последовательность EVT8 должна быть завершена до
> окончания текущей передачи байта.*
>
> Режим приема мастером:
>
> Модуль I2C будет принимать данные с линии SDA и записывать их в
> регистр данных через сдвиговый регистр. После каждого байта, если
> установлен бит **ACK**, модуль I2C отправит ответ с низким уровнем, и
> будет установлен бит **RxNE**, и, если установлены биты **ITEVTEN** и
> **ITBUFEN**, будет сгенерировано прерывание. Если установлен бит
> **RxNE** и исходные данные не прочитаны до получения новых данных,
> будет установлен бит **BTF**, и SCL останется низким до тех пор, пока
> **BTF** не будет очищен. Чтение **R16_I2Cx_STAR1**, а затем чтение
> регистра данных очистит бит **BTF**.
>
> Figure 13-5 Receiver transmission sequence diagram

<table>
<colgroup>
<col style="width: 2%" />
<col style="width: 2%" />
<col style="width: 4%" />
<col style="width: 8%" />
<col style="width: 3%" />
<col style="width: 4%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 4%" />
<col style="width: 6%" />
<col style="width: 4%" />
<col style="width: 4%" />
<col style="width: 1%" />
<col style="width: 1%" />
<col style="width: 5%" />
<col style="width: 3%" />
<col style="width: 1%" />
<col style="width: 4%" />
<col style="width: 5%" />
<col style="width: 1%" />
<col style="width: 1%" />
<col style="width: 1%" />
<col style="width: 2%" />
<col style="width: 1%" />
<col style="width: 3%" />
<col style="width: 1%" />
<col style="width: 1%" />
<col style="width: 1%" />
<col style="width: 2%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th colspan="2" style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td colspan="6" style="text-align: left;">7-бит прием мастера</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: center;">S</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Address</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Data1</td>
<td style="text-align: center;">A(1)</td>
<td colspan="2" style="text-align: center;">Data2</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td colspan="2" style="text-align: center;"> </td>
<td style="text-align: center;">DataN</td>
<td colspan="2" style="text-align: center;">NA</td>
<td style="text-align: center;">P</td>
<td colspan="2" style="text-align: center;"> </td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT5</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT6</td>
<td style="text-align: center;">EVT6_1</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT7</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT7</td>
<td colspan="2" style="text-align: center;"></td>
<td style="text-align: center;">EVT8_2</td>
<td colspan="2" style="text-align: center;"></td>
<td style="text-align: center;">EVT7</td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td colspan="6" style="text-align: left;">10-бит прием мастера</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: center;">S</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Frame header</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Address</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT5</td>
<td style="text-align: left;"><table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
</tbody>
</table></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT9</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT6</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td colspan="2" style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Sr</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Frame header</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">Data1</td>
<td style="text-align: center;">A(1)</td>
<td colspan="2" style="text-align: center;">Data2</td>
<td colspan="2" style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td colspan="2" style="text-align: center;"> </td>
<td style="text-align: center;">DataN</td>
<td colspan="2" style="text-align: center;"> </td>
<td colspan="2" style="text-align: center;">NA</td>
<td colspan="2" style="text-align: center;">P</td>
<td colspan="2" style="text-align: center;"> </td>
<td colspan="2" style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT5</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT6</td>
<td style="text-align: center;">EVT6_1</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT7</td>
<td colspan="2" style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td colspan="2" style="text-align: center;">EVT2</td>
<td style="text-align: center;"></td>
<td colspan="2" style="text-align: center;">EVT7_1</td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: center;"></td>
<td colspan="2" style="text-align: center;">EVT2</td>
<td colspan="2" style="text-align: center;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td colspan="2" style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
</tr>
</tbody>
</table>

> Описание:
>
> S=Старт (условие старта), Sr=повторный старт, P=Стоп (условие
> остановки), A=ответ, NA=отсутствие ответа, **EVTx**=событие
> (прерывание генерируется, когда **ITEVFEN**=1)
>
> EVT5: **SB**=1, чтение **SR1**, а затем запись адреса в регистр **DR**
> очистит событие.
>
> EVT6: **ADDR**=1, сначала читаем **SR1**, затем читаем **SR2**, чтобы
> стереть это событие. В режиме приема мастером с 10-битным адресом
> после этого события следует установить START=1 в **CR2**.
>
> EVT61: Нет соответствующего флага события, и оно подходит только для
> приема 1 байта. Сразу после EVT6 (то есть после очистки **ADDR**),
> биты генерации условий ответа и остановки должны быть очищены.
>
> EVT7: **RxNE**=1, читайте регистр **DR**, чтобы очистить событие.
>
> EVT71: **RxNE**=1, прочтите регистр **DR** для очистки этого события.
> Установить **ACK**=0 и запрос на остановку.
>
> EVT9: **ADDR10**=1, чтение **SR1** и последующая запись в регистр
> **DR** удаляют это событие.
>
> Когда ведущее устройство заканчивает отправку данных, оно активно
> отправляет событие окончания, то есть устанавливает бит STOP, и I2C
> переключается в режим слейва. В режиме приема ведущему устройству
> необходимо отправить NAK на позицию ответа последнего бита данных, а
> после получения NACK ведомое устройство освобождает контроль над
> линиями SCL и SDA; ведущее устройство затем может отправить условие
> остановки/повторного старта. Обратите внимание, что модуль I2C
> автоматически переключается в режим ведомого устройства после
> генерации условия остановки.

## 13.4 Режим слейва (Slave Mode)

> Когда модуль I2C находится в режиме слейва, он распознает свой
> собственный адрес и широковещательный вызов. Программное обеспечение
> может контролировать, включена или отключена функция распознавания
> широковещательного вызова. Как только обнаружено событие начала,
> модуль I2C сравнивает данные SDA через сдвиговый регистр со своим
> собственным адресом (количество битов зависит от ENDUAL и ADDMODE) или
> широковещательным адресом (при установленной ENGC). Если обнаружено
> несоответствие, оно будет проигнорировано до появления нового события
> начала. Если совпадает с заголовком, генерируется сигнал ACK, и
> ожидается адрес второго байта; если адрес второго байта также
> совпадает или совпадает полный сегментный адрес в случае 7-битного
> адреса, то: сначала генерируется ответ ACK; устанавливается бит ADDR,
> и если бит ITEVTEN уже установлен, генерируются соответствующие
> пререрывание; если используется режим двойного адреса (установлен бит
> ENDUAL), необходимо также прочитать бит DUALF, чтобы определить, какой
> адрес вызывает хоста. По умолчанию используется режим слейвом приеме.
> Если последний бит полученной заголовочной последовательности равен 1,
> или последний бит 7-битового адреса равен 1 (в зависимости от того,
> была получена заголовочная последовательность впервые или обычный
> 7-битный адрес), модуль I2C перейдёт в режим передачи, а бит TRA
> указывает, находится ли он сейчас в режиме приема или передачи.
>
> Режим передачи слейвом:
>
> После очистки бита ADDR модуль I2C отправляет байты из регистра данных
> на линию SDA через сдвиговый регистр. После получения подтверждения
> ACK, устанавливается бит TxE, и генерируется прерывание, если
> установлены биты ITEVTEN и ITBUFEN. Если установлен бит TxE и новые
> данные не были записаны в регистр данных до окончания отправки
> следующих данных, будет установлен бит BTF. SCL остаётся низким до тех
> пор, пока BTF не будет очищен. Чтение регистра состояния 1
> (R16_I2Cx_STAR1) и последующая запись данных в регистр данных очистит
> бит BTF.
>
> Рисунок 13-6 Диаграмма последовательности передачи данных передатчика
> слейва

<table>
<colgroup>
<col style="width: 2%" />
<col style="width: 3%" />
<col style="width: 7%" />
<col style="width: 5%" />
<col style="width: 7%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 6%" />
<col style="width: 5%" />
<col style="width: 3%" />
<col style="width: 3%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
<th style="text-align: left;"> </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td colspan="6" style="text-align: left;">7-бит передача слейва</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: center;">S</td>
<td style="text-align: center;">Address</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Data1</td>
<td style="text-align: center;">A</td>
<td colspan="2" style="text-align: center;">Data2</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"> </td>
<td style="text-align: center;">DataN</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">P</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT1</td>
<td style="text-align: center;">EVT3_1</td>
<td style="text-align: center;">EVT3</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT3</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT3</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td colspan="2" style="text-align: center;">EVT3_2</td>
<td style="text-align: center;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td colspan="6" style="text-align: left;">10-бит передача слейва</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: center;">S</td>
<td style="text-align: center;">Frame header</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">Address</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"><table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;"></th>
</tr>
</thead>
<tbody>
</tbody>
</table></td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT9</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Sr</td>
<td style="text-align: center;">Frame header</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Data1</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"> </td>
<td style="text-align: center;">DataN</td>
<td style="text-align: center;">NA</td>
<td style="text-align: center;">P</td>
<td style="text-align: center;"></td>
<td style="text-align: left;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">EVT1</td>
<td style="text-align: center;">EVT3_1</td>
<td style="text-align: center;">EVT3</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">EVT3</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td colspan="2" style="text-align: center;">EVT7_1</td>
<td style="text-align: center;"> </td>
</tr>
<tr>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
<td style="text-align: left;"> </td>
</tr>
</tbody>
</table>

> Описание:
>
> S=Старт (условие старта), Sr=повторный старт, P=Остановка (условие
> остановки), A=Ответ, NA=Отказ, **EVTx**=Событие (прерывание
> генерируется, когда **ITEVFEN**=1)
>
> EVT1; **ADDR**=1, чтение **SR1**, а затем чтение **SR2** устранит
> событие.
>
> EVT31: **TxE**=1, сдвиговый регистр пуст, регистр данных пуст,
> напишите **DR**.
>
> EVT3: **TxE**=1, регистр сдвига не пуст, регистр данных пусто, запись
> **DR** очистит событие.
>
> EVT32: **AF**=1, записать \'0\' в бит **AF** регистра **SR1** для
> очистки бита **AF**.
>
> *Примечание:*
>
> *1: События EVT1 и EVT3_1 продлевают состояние низкого уровня SCL до
> завершения соответствующей программной последовательности.*
>
> *2: Программная последовательность EVT3 должна быть завершена до
> завершения текущего байта передачи.*
>
> Режим приема слейвом:
>
> После очистки бита **ADDR** модуль I2C сохраняет данные с SDA в
> регистр данных через сдвиговый регистр. После получения каждого байта
> модуль I2C устанавливает бит **ACK** и устанавливает бит **RxNE**, и
> генерирует прерывание, если установлены биты **ITEVTEN** и
> **ITBUFEN**. Если установлен бит **RxNE** и старые данные не были
> прочитаны до получения новых данных, то устанавливается бит **BTF**.
> SCL остается на низком уровне до тех пор, пока бит **BTF** не очищен.
> Чтение регистра состояния 1 (**R16_I2Cx_STAR1**) и чтение данных в
> регистре данных очистит бит **BTF**.
>
> Рисунок 13-7 Диаграмма последовательности передачи данных приемника

  ------------------------------------------------------------------------------------------------------------------------
                                                                                                                        
  --- --- --------- --- --------- ------- ------ ------- --- ------ ------ ------- ------- ------ ------ ------ ------ ---
          7-бит                                                                                                         
          прием                                                                                                        
          слейва                                                                                                       

      S   Address   A             Data1   A      Data2       A                     DataN   A      P                     

                        EVT1                     EVT2               EVT2                          EVT2          EVT4    

          10-бит                                                                                                        
          приема                                                                                                       
          слейва                                                                                                       

      S   Frame     A   Address   A              Data1   A                 DataN   A       P                            
          header                                                                                                       

                                          EVT1               EVT2                          EVT2          EVT4           

                                                                                                                        
  ------------------------------------------------------------------------------------------------------------------------

> Описание:
>
> S=Старт (условие старта), Sr=Повторный старт, P=Стоп (условие
> остановки), A=Ответ, NA=Отказ, EVTx=Событие (прерывание генерируется,
> когда ITEVFEN=1)
>
> EVT1; ADDR=1, чтение SR1, а затем чтение SR2 удаляет событие.
>
> EVT2: RxNE=1, чтении DR очищает событие.
>
> EVT4: STOPF=1, чтению SR1 и последующей записи в регистр CR1 очистит
> событие.
>
> *Примечание:*
>
> *1: Событие EVT1 увеличивает длительность низкого уровня SCL до
> завершения соответствующей программной последовательности.*
>
> *2: Программная последовательность EVT2 должна быть завершена до
> завершения текущего байта передачи.*
>
> Ведущее устройство сгенерирует условие остановки после передачи
> последнего байта данных. Когда модуль I2C обнаружит событие остановки,
> он установит бит STOPF, и если бит ITEVFEN установлен, он также
> сгенерирует прерывание. Пользователю необходимо прочитать регистр
> состояния (например, R16_I2Cx_STAR1) и затем записать в регистр
> управления (например, сбросить слово управления SWRST) для его
> очистки. (См. EVT4 на приведенном выше рисунке).

## 13.5 Условия возникновения ошибок

### 13.5.1 Ошибка шины (BERR) 

> Ошибка шины возникает, когда модуль I2C обнаруживает внешние события
> начала или остановки во время передачи адреса или данных. Когда
> возникает ошибка шины, устанавливается бит **BERR**, и генерируется
> прерывание, если установлен бит **ITERREN**. В режиме слейва данные
> отбрасываются, и оборудование освобождает шину. Если это сигнал
> старта, оборудование считает его сигналом перезапуска и ожидает
> сигнала адреса или остановки. Если сигнал остановки, оборудование
> продолжает функционировать как обычно, ожидая нормального сигнала
> остановки. В мастерском режиме, оборудование не отпускает шину, и
> пользовательский код решает, продолжить передачу или прервать её.

### 13.5.2 Ошибка подтверждения (AF) 

> Ошибка ответа возникает, когда модуль I2C обнаруживает байт данных, но
> не получает подтверждения. Когда возникает ошибка ответа:

-   Устанавливается бит AF.

-   Генерируется прерывание, если установлен бит ITERREN.

-   При возникновении ошибки AF, оборудование должно освободить шину,
    если модуль I2C работает в режиме слейва, и программное обеспечение
    должно сгенерировать событие остановки, если оно работает в
    мастер-режиме.

### 13.5.3 Потеря арбитража (ARLO) 

> Ошибка потери арбитража возникает, когда модуль I2C обнаруживает
> потерю арбитража. Когда возникает ошибка потери арбитража:

-   Устанавливается бит ARLO.

-   Генерируется прерывание, если установлен бит ITERREN.

-   Модуль I2C переходит в режим слейва и перестает отвечать на запросы,
    направленные на его адрес, если хозяин не инициировал новое событие
    старта.

### 13.5.4 Ошибка переполнения/недостаточного заполнения (OVR) 

### Ошибка переполнения

> В режиме слейва, если расширение тактовой частоты отключено и модуль
> I2C получает данные, возникает ошибка переполнения, если байт данных
> был принят, но последние полученные данные еще не были прочитаны. При
> возникновении ошибки переполнения последнее принятый байт
> отбрасывается, и отправляющий должен повторить передачу последнего
> байта.

### Ошибка недонаполнения

> В режиме слейва, если запрещено удлинение тактовой частоты и модуль
> I2C отправляет данные, возникает ошибка недонаполнения, если новые
> данные не были записаны в регистр данных до наступления следующего
> байтa clock edge. В случае ошибки недонаполненности, данные из
> предыдущего регистра данных отправляются дважды, и если возникает
> ошибка недоучёта, получатель должен отбрасывать повторные данные.
> Чтобы избежать ошибки недонаполнения, модуль I2C должен записать
> данные в регистр данных перед появлением первого растянутого края
> следующего байта.

## 13.6 Расширение тактовых импульсов

> Если расширение тактовых импульсов отключено, возникают риски ошибок
> переполнения/недостаточного заполнения. Однако, если расширение
> тактовой частоты включено:

-   В режиме передачи, если установлен бит **TxE** и бит **BTF**, сигнал
    SCL будет оставаться на низким уровне, ожидаемый пользователем для
    чтения регистра статуса и записи данных в регистр данных.

-   В режиме приема, если установлены биты **RxNE** и **BTF**, SCL
    останется на низким уровне после получения данных, ожидающегося
    чтения регистра статусов и данных пользователем. Активация
    расширения тактовых импульсов помогает предотвратить ошибки
    переполнения/недостаточно заполненного состояния.

> Видно, что включение расширения тактовых импульсов помогает избежать
> ошибок переполнения/недостаточного заполнения.

## 13.7 Шина SMBus 

## SMBus также является двухпроводным интерфейсом, который обычно используется между системой и управлением питанием. У SMBus и I2C много общего, например, SMBus использует тот же режим адресации с 7 битами, что и I2C, а следующие функции являются общими для SMBus и I2C:

## Режим связи \"ведущий-ведомый\", при котором хост предоставляет тактовый сигнал и поддерживает несколько ведущих устройств и подчиненных.

## Двухпроводная архитектура связи, с опциональной линией предупреждения для SMBus.

## Оба поддерживают формат адреса длиной 7 битов.

> Начало формы
>
> Также существуют различия между SMBus и I2C:

1)  I2C поддерживает скорости до 400 кГц, тогда как SMBus поддерживает
    до 100 кГц; кроме того, у SMBus есть ограничение минимальной
    скорости в 10 кГц.

2)  При низком уровне тактового сигнала SMBus более чем на 35 мс будет
    сообщаться о тайм-ауте, однако такого ограничения нет у I2C.

3)  U SMBus фиксированный логический уровень, тогда как у I2C он зависит
    от напряжения питания (VDD).

4)  U SMBus имеется протокол шины, которого нет у I2C.

> Кроме того, SMBus включает идентификацию устройств, протоколы
> разрешения адресов, уникальные идентификаторы устройств, напоминания
> SMBus и различные шинные протоколы, описанные в спецификации версии
> 2.0 SMBus. При использовании SMBus необходимо установить только бит
> SMBus в регистре управления, а биты **SMBTYPE** и **ENAARP** должны
> быть настроены по мере необходимости.

## 13.8 Прерывания 

> Каждый модуль I2C имеет два вектора прерываний: прерывания событий и
> прерывания ошибок. Оба типа прерываний поддерживают источники
> прерываний, указанные на Рисунке 13-4.
>
> Рисунок 13-4 Запрос прерывания I2C

## 13.9 Прямой доступ к памяти (DMA)

DMA может использоваться для отправки и получения больших объемов
данных. Бит **ITBUFEN** в регистре управления не должен быть установлен
при использовании DMA.

Начало формы

-   Передача с использованием DMA

РНачало формы

> ежим DMA активируется путем установки бита **DMAEN** в регистре
> **CTLR2**. Как только бит **TxE** установлен, данные будут загружены
> через DMA из заданной памяти в регистр данных I2C. Для выделения
> каналов для I2C требуются следующие настройки:

1.  Установите адрес регистра **I2Cx_DATAR** в регистр **DMA_PADDRx**, а
    адрес памяти -- в регистр **DMA_MADDRx** таким образом, чтобы после
    каждого события TxE данные отправлялись из памяти в регистр
    **I2Cx_DATAR**.

2.  Задайте необходимое количество байтов для передачи в регистре
    **DMA_CNTRx**. Это значение будет уменьшаться после каждого события
    TxE.

3.  Настройте приоритет канала с помощью битов **PL**\[0:1\] в регистре
    **DMA_CFGRx**.

4.  Установите бит **DIR** в регистре **DMA_CFGRx** и, в зависимости от
    требований приложения, настройте его для выдачи запроса на
    прерывание, когда вся передача будет выполнена наполовину или
    полностью.

5.  Активируйте канал, установив бит **EN** в регистре **DMA_CFGRx**.

> Начало формы
>
> Когда количество байтов передачи данных, установленных в контроллере
> DMA, завершено, контроллер DMA отправляет сигнал окончания передачи
> (EOT/EOT_1) на интерфейс I2C. Если разрешено прерывание, будет
> сгенерировано прерывание DMA.

-   Прием с использованием DMA

Режим приема DMA может быть выполнен после установки **DMAEN** в
регистре **CTLR2**. При использовании режима приема DMA, DMA передает
данные из регистра данных в предварительно заданную область памяти. Для
выделения каналов для I2C необходимы следующие шаги:

1.  Установите адрес регистра **I2Cx_DATAR** в регистр **DMA_PADDRx**, а
    адрес памяти -- в регистр **DMA_MADDRx** таким образом, чтобы после
    каждого события **RxNE** данные записывались в память из регистра
    **I2Cx_DATAR**.

2.  Задайте необходимое количество байтов для передачи в регистре
    **DMA_CNTRx**. Это значение будет уменьшаться после каждого события
    **RxNE**.

3.  Настройте приоритет канала с помощью битов **PL**\[0:1\] в регистре
    **DMA_CFGRx**.

4.  Сбросьте бит **DIR** в регистре **DMA_CFGRx**, и в зависимости от
    требований приложения можно настроить выдачу запроса на прерывание,
    когда передача данных будет выполнена наполовину или полностью.

5.  Установите бит **EN** в регистре **DMA_CFGRx** для активации канала.

Начало формы

Когда количество передач данных, установленное в контроллере DMA,
завершено, контроллер DMA отправляет сигнал окончания передачи
(EOT/EOT_1) на интерфейс I2C. Если прерывание разрешено, будет
сгенерировано прерывание DMA.

## 13.10 Проверка ошибок пакета 

> Контрольная сумма пакета (PEC) --- это дополнительный шаг проверки с
> использованием CRC8 для повышения надежности передачи, рассчитываемый
> для каждого бита последовательных данных с использованием следующего
> полинома.
>
> $$C = X8\  + X2\  + X + 1$$
>
> Расчёт PEC активируется битом ENPEC в регистре управления и
> выполняется для всех информационных байтов, включая адрес и биты
> чтения/записи. При передаче включение PEC добавляет байт результата
> расчёта CRC8 после последнего байта данных; в режиме приёма последний
> байт рассматривается как результат проверки CRC8, и если он не
> совпадает с результатом внутреннего расчёта, будет отправлен ответ
> NAK, а в случае основного приёмника, независимо от правильности
> результата проверки.

## 13.11 Описание регистров 

Таблица 13-1 Список регистров, связанных с I2C

### 13.11.1 I2C Control Register 1(I2C1_CTLR1) 

### 13.11.2 I2C Control Register 2(I2C1_CTLR2) 

### 

### 13.11.3 I2C Own Address Register 1(I2C1_OAR1) 

### 13.11.4 I2C Own Address Register 2(I2C1_OAR2) 

### 13.11.5 I2C Data Register (I2C_DATAR) 

### 13.11.6 I2C Status Register 1(I2C_STAR1) 

### 13.11.7 I2C Status Register 2(I2C_STAR2) 

### 13.11.8 I2C Clock Register (I2C1_CKCFGR) 

# Глава 14 Последовательный периферийный интерфейс (SPI) 

> SPI поддерживает взаимодействие данных в синхронном последовательном
> режиме по трём проводам, а также имеет линию выбора чипа для поддержки
> аппаратного переключения между режимами Master и Slave и поддерживает
> связь по одной линии данных.

## 14.1 Основные характеристики

-   Поддержка полнодуплексного синхронного последовательного режима

-   Поддержка полу-дуплексного режима с использованием одной линии

-   Поддержка режимов Master и Slave, многорежимного Slave

-   Поддерживаются структуры данных длиной 8 или 16 бит

-   Максимальная частота тактового сигнала может достигать половины от
    частоты FHCLK

-   Порядок передачи данных поддерживает передачу старшего (MSB) или
    младшего (LSB) бита первым

-   Поддерживается управление выводом NSS как аппаратное, так и
    программное

-   Аппаратная поддержка контрольной суммы CRC при передаче и приеме
    данных

-   Буфер передатчика поддерживает передачу данных через DMA

-   Возможность изменения фазы и полярности тактовых сигналов

> Начало формы

## 14.2 Описание функций

### 14.2.1 Обзор

> Рисунок 14-1 Блок-схема структуры SPIНачало формы
>
> ![](media/image104.png){width="5.444444444444445in"
> height="4.138888888888889in"}
>
> Как видно из Рисунка 14-1, четыре основных вывода, связанных с SPI,
> это MISO, MOSI, SCK и NSS. Вывод MISO является входным выводом данных,
> когда модуль SPI работает в режиме Master, и выходным выводом данных,
> когда он работает в режиме Slave. Вывод MOSI является выходным выводом
> данных при работе в режиме Master и входным выводом данных при работе
> в режиме Slave. Выводом SCK является тактовый вывод; тактовый сигнал
> всегда генерируется ведущим устройством, а ведомое устройство
> принимает тактовый сигнал и синхронизирует отправку и прием данных.
> Вывод NSS является выводом выбора чипа, который используется следующим
> образом.

1.  **Управление NSS программно**: Когда установлен бит **SSM**,
    внутренний сигнал **NSS** будет иметь высокий или низкий уровень,
    определяемый состоянием **SSI**. Этот случай обычно используется в
    режиме Master модуля SPI.

2.  **Управление NSS аппаратно**: При включении выхода **NSS**, то есть
    когда установлен бит **SSOE**, вывод **NSS** будет активно
    подтягиваться к низкому уровню, когда ведущий SPI начинает
    передавать данные наружу. Если не удается подтянуть вывод **NSS** к
    низкому уровню (что указывает на наличие другого ведущего устройства
    на шине, которое уже ведет коммуникацию), будет сгенерирована ошибка
    оборудования. Если бит **SSOE** не установлен, можно использовать
    режим с несколькими ведущими устройствами, и если этот вывод будет
    подтянут к низкому уровню извне, устройство принудительно перейдет в
    режим Slave, и бит **MSTR** автоматически сбросится.

> Начало формы
>
> Установка бита **CPHA** означает, что модуль выбирает данные по
> второму фронту тактового сигнала и фиксирует их, тогда как сброс бита
> **CPHA** указывает, что SPI-модуль выбирает данные по первому фронту
> тактового сигнала и также фиксирует их. Бит **CPOL** определяет,
> удерживается ли тактовый сигнал на высоком или низком уровне, когда
> нет передаваемых данных. Подробности представлены на рисунке 14-2
> ниже.

Рисунок 14-2 Режим SPIНачало формы

![](media/image105.png){width="6.1633005249343835in"
height="6.026505905511811in"}

> Ведущее устройство и ведомое должны быть настроены на одинаковый режим
> работы SPI, а бит **SPE** необходимо сбросить перед настройкой режима
> SPI. Бит **DEF** определяет, составляет ли длина отдельных данных
> **SP** 8 или 16 бит. Бит **LSBFIRST** управляет тем, начинается ли
> одно слово данных со старшего или младшего бита.

### 14.2.2 Режим мастера 

> При работе модуля SPI в режиме Master, последовательный тактовый
> сигнал генерируется на выводе SCK. Для настройки режима Master
> выполняются следующие шаги:

1.  **Настройка поля BR\[2:0\] регистра управления** для определения
    частоты тактового сигнала.

2.  **Конфигурация битов CPOL и CPHA** для выбора режима работы SPI.

3.  **Конфигурирование бита DEF** для задания длины слова данных (8 или
    16 бит).

4.  **Установить бит LSBFIRST** для указания формата кадра (передача
    сначала старшего или младшего бита).

5.  **Настроить вывод NSS**, например, установив бит **SSOE**, чтобы
    позволить аппаратуре управлять выводом **NSS**. Также возможно
    установить бит **SSM** и задать высокий уровень на выводе **NSS**
    путем установки бита **SSI**.

6.  **Убедиться, что вывод NSS находится в высоком состоянии**, прежде
    чем устанавливать бит **MSTR** и бит **SPE**.

> Когда требуется передать данные, достаточно записать данные в регистр
> данных. SPI параллельно перенесет данные из буфера передачи в
> сдвиговый регистр, после чего начнет передачу данных согласно
> установке бита **LSBFIRST**. Как только данные окажутся в сдвиговом
> регистре, флаг **TXE** установится. Если был предварительно установлен
> бит **TXEIE**, произойдет генерация прерывания. Чтобы поддерживать
> непрерывность потока данных, необходимо заполнить позицию флага
> **TXE** новыми данными в регистр данных.
>
> Когда приемник получает данные, по приходу последнего фронта выборки
> тактового импульса для данного слова данных, они будут переданы из
> сдвигового регистра в буфер приема параллельно, устанавливается флаг
> **RXNE** и, если ранее был установлен бит **RXNEIE**, происходит
> генерация прерывания. В этом случае следует как можно скорее считать
> данные из регистра данных, чтобы забрать их.Начало формы

### 14.2.3 Режим слейва 

> Когда модуль SPI работает в режиме Slave, вывод SCK используется для
> получения тактового сигнала от ведущего устройства, и его собственная
> настройка скорости передачи данных становится недействительной. Для
> конфигурации в режим Slave выполните следующие действия:

1.  **Настройте бит DEF** для установки длины бита данных.

2.  **Биты CPOL и CPHA** должны соответствовать режиму работы ведущего
    устройства.

3.  **Бит LSBFIRST** должен соответствовать формату кадра данных
    ведущего устройства;

4.  **Вывод NSS** должен находиться в низком состоянии при управлении
    аппаратурой. Если **NSS** управляется программно (установлен бит
    **SSM**), тогда убедитесь, что бит SSI сброшен.

5.  **Сбросьте бит MSTR** и установите бит SPE для включения режима SPI.

> Во время передачи данных, когда появляется первый фронт выборки у
> ведомого устройства на выводе **SCK**, оно начинает передачу. Процесс
> отправки заключается в перемещении данных из буфера передачи в регистр
> сдвига передачи. Когда данные из буфера передачи перемещаются в
> регистр сдвига, устанавливается флаг **TXE**, и если до этого был
> установлен бит **TXEIE**, генерируется прерывание.
>
> Во время приёма данных, после последнего фронта выборки тактового
> импульса, устанавливается бит **RXNE**, байты, принятые регистром
> сдвига, переносятся в буфер приёма, и операция чтения регистра данных
> позволяет получить данные из приёмного буфера. Если до установки
> **RXNE** был установлен **RXNEIE**, то генерируется прерывание.
>
> Начало формы

### 14.2.4 Полудуплексный режим (Simplex Mode)

> Интерфейс SPI может работать в полудуплексном режиме, где ведущее
> устройство использует вывод MOSI, а ведомое устройство --- вывод MISO
> для связи. При использовании полудуплексной связи нужно настроить бит
> **BIDIMODE** и использовать **BIDIOE** для управления направлением
> передачи.
>
> Установка бита **RXONLY** в обычном полнодуплексном режиме переводит
> модуль SPI в простой симплексный режим только для приема, освобождая
> вывод данных после установки **RXONLY**. SPI также может быть
> переведен в режим только передачи, игнорируя принимаемые данные.

### 14.2.5 Контрольная сумма CRC 

> Модуль SPI использует контрольную сумму CRC для обеспечения надежности
> полнодуплексной связи, причем для отправки и приема данных
> используются отдельные калькуляторы CRC. Полином для вычисления CRC
> определяется регистром полинома, и для ширины данных 8 бит и 16 бит
> соответственно применяются различные расчеты. Установка бита **CRCEN**
> активирует проверку контрольной суммы CRC и одновременно сбрасывает
> калькулятор CRC. После отправки последнего байта данных установка бита
> **CRCNEXT** приведет к отправке результата расчета **TXCRCR** после
> отправки текущего байта, в то время как бит **CRCERR** будет
> установлен, если последнее полученное значение регистра сдвига приема
> не совпадает с локально рассчитанным значением **RXCRCR**.
> Использование проверки контрольной суммы CRC требует настройки
> калькулятора полинома и установки бита **CRCEN** при конфигурировании
> режима работы SPI, а также установки бита **CRCNEXT** на последнем
> слове или полуслове для отправки CRC и выполнения проверки CRC для
> приема. Обратите внимание, что полином для расчета CRC должен быть
> единым как для отправки, так и для приема.Начало формы

### 14.2.6 Прямой доступ к памяти (DMA) 

> Модуль SPI поддерживает использование DMA для ускорения обмена
> данными, будь то заполнение буфера передачи с помощью DMA или
> своевременное получение данных из буфера приема посредством DMA. DMA
> будет своевременно забирать или отправлять данные, используя сигналы
> **RXNE** и **TXE**. DMA также может работать в симплексном режиме или
> режиме с проверкой CRC.
>
> Начало формы
>
> **14.2.7 Ошибки**

-   **Ошибка режима Master (MODF)**Когда SPI работает в режиме
    управления аппаратным обеспечением вывода NSS, происходит внешнее
    снижение уровня на выводе NSS; либо в режиме программного управления
    выводом NSS очищается бит SSI; либо очищается бит SPE, что приводит
    к отключению SPI; либо очищен бит MSTR, и SPI переходит в режим
    Slave. Если бит ERRIE уже установлен, также генерируется прерывание.
    Шаги для очистки бита MODF: Сначала выполните операцию чтения или
    записи в регистр R16_SPI1_STATR, затем запишите в регистр
    R16_SPI1_CTLR1.

-   **Переполнение**Если хост передает данные, а в буфере приема
    ведомого устройства остаются непрочитанные данные, возникает ошибка
    переполнения, устанавливается бит OVR, и если установлен бит ERRIE,
    генерируется прерывание. Ошибка переполнения должна перезапустить
    текущую передачу. Чтение регистра данных, а затем чтение регистра
    состояния позволит устранить эту ошибку.

-   **Ошибки CRC**При несоответствии принятого слова CRC и значения
    RXCRCR возникает ошибка CRC, и устанавливается бит CRCERR.Начало
    формы

### 14.2.8 Прерывания

> Модуль SPI поддерживает пять источников прерываний, среди которых
> события **TXE** и **RXNE** устанавливаются, когда установлены
> соответствующие биты **TXEIE** и **RXNEIE**. Помимо этих событий, три
> упомянутые выше ошибки (**MODF**, **OVR** и **CRCERR**) также могут
> генерировать прерывания, если включен бит **ERRIE**. В таком случае
> эти три ошибки вызовут генерацию ошибок прерывания.

## 14.3 Описание регистров

Таблица 14-1 Список регистров, связанных с SPI

### 14.3.1 SPI Control Register 1 (SPI_CTLR1) 

### 14.3.2 SPI Control Register 2 (SPI_CTLR2) 

### 14.3.3 SPI Status Register (SPI_STATR) 

### 14.3.4 SPI Data Register (SPI_DATAR) 

### 14.3.5 SPI1 Polynomial Register (SPI_CRCR) 

### 14.3.6 SPI1 Receive CRC Register (SPI_RCRCR) 

### 14.3.7 SPI1 Transmit CRC Register (SPI_TCRCR) 

### 14.3.8 SPI High-speed Control Register (SPI_HSCR) 

# Глава 15 Электронная подпись (ESIG)

> Электронная подпись содержит информацию об идентификации микросхемы:
> емкость области флеш-памяти и уникальный идентификатор. Она
> записывается производителем в системную область хранения памяти модуля
> на заводе и может быть прочитана с помощью SWD (SDI) или прикладного
> кода.

## 15.1 Описание функциональных возможностей

> Емкость Flash-памяти: Указывает текущий размер кристалла, доступный
> для использования пользовательскими приложениями. Уникальная
> идентификация: 96-битный двоичный код, уникален для любого
> микроконтроллера. Пользователь может только читать доступ, но не
> изменять его. Эта уникальная информация идентификации может
> использоваться в качестве пароля безопасности микроконтроллеров
> (продуктов), ключей шифрования и дешифровки, серийных номеров
> продуктов и т.д., для улучшения механизмов безопасности системы или
> для обозначения информации о личности. Все вышеперечисленное может
> быть доступно для чтения пользователем с использованием 8-, 16- или
> 32-битного доступа.

## 15.2 Описание регистров

Таблица 15-1 Список регистров, связанных с ESIG

### 15.2.1 Flash capacity register (ESIG_FLACAP) 

### 15.2.2 UID Register (ESIG_UNIID1) 

### 15.2.3 UID Register (ESIG_UNIID2) 

### 15.2.4 UID Register (ESIG_UNIID3) 

# Глава 16 Флеш-память и байты опций пользователя

## 16.1 Организация флеш-памяти

> Внутренняя флеш-память чипа организована следующим образом.
>
> Начало формы
>
> Таблица 16-1 Организация флеш-памяти
>
> *Примечания: Основная область памяти, указанная выше, используется для
> хранения приложений пользователя и защищена от записи блоками по 1
> Кбайт (16 страниц); за исключением области «слова конфигурационных
> настроек производителя», которая заблокирована заводским способом и
> недоступна пользователю, другие области доступны для операций
> пользователя при определенных условиях.*

## 16.2 Программирование и безопасность флеш-памяти

### 16.2.1 Два метода программирования/стирания

-   Стандартное программирование: Это режим программирования по
    умолчанию (совместимый режим). В этом режиме ЦПУ выполняет
    программирование отдельными двумя байтами и операции стирания и
    полного стирания отдельными блоками по 1 Кбайт.

-   Быстрое программирование: Этот метод использует операции со
    страницей (рекомендуется). После определенной последовательности
    разблокировки выполняется программирование и стирание блоков по 64
    байта, а также стирание блока размером 1Кбайт (стандартное полное
    стирание всего чипа также применимо для быстрого программирования).

### 16.2.2 Безопасность -- Предотвращение несанкционированного доступа (чтение, запись, стирание)

-   Защита страницы от записи

-   Защита от чтения

> Когда чип находится в состоянии защиты от чтения.

1)  Страницы основной памяти с 0 по 32 (2 Кбайт) автоматически находятся
    в состоянии защиты от записи, не контролируемой регистром
    **FLASH_WPR**; состояние без защиты от чтения, все страницы основной
    памяти контролируются регистром FLASH_WPR.

2)  Область загрузочного кода системы, режим SDI и область RAM не
    подлежат стиранию или программированию для основной памяти, за
    исключением полного стирания всего чипа. Области байтов опций
    пользователя могут быть стерты или запрограммированы. Если
    предпринята попытка снять защиту от чтения (запрограммировать слово
    пользователя), чип автоматически сотрет всю область пользователя.

> *Начало формы*
>
> *Примечание: Внутренний RC-генератор (HSI) должен быть включен во
> время выполнения операции программирования/стирания флеш-памяти.*

## 16.3 Описание регистров 

> Таблица 16-2 Список регистров, связанных с FLASH

### 16.3.1 Control Register (FLASH_ACTLR) 

### 16.3.2 FPEC Key Register (FLASH_KEYR) 

### 16.3.3 OBKEY Register (FLASH_OBKEYR) 

### 16.3.4 Status Register (FLASH_STATR) 

*Примечание: При выполнении операции программирования необходимо
убедиться, что бит **STRT** регистра **FLASH_CTLR** равен нулю.*

### 16.3.5 Configuration Register (FLASH\_ CTLR) 

### 16.3.6 Address Register (FLASH\_ ADDR) 

### 16.3.7 Option Byte Register (FLASH_OBR) 

*Примечание: **USER** и **RDPRT** загружаются из области байтов опций
пользователя после сброса системы.*

### 16.3.8 Write Protect Register (FLASH_WPR) 

> *Note: **WPR** is loaded from the user-option bytes area after a
> system reset.*

### 16.3.9 Extended Key Register (FLASH_MODEKEYR) 

### 16.3.10 BOOT Key Register (FLASH_BOOT_MODEKEYP) 

## 16.4 Последовательность операций с флеш-памятью

## Начало формы

### 16.4.1 Операции чтения 

Используя прямое обращение в общем адресном пространстве, любая операция
чтения данных размером 8/16/32 бита может получить доступ к содержимому
модуля флеш-памяти и получить соответствующие данные.

### 16.4.2 Деблокировка флешпамяти 

> После сброса системы, контроллер флеш-памяти (**FPEC**) и регистр
> **FLASH_CTLR** заблокированы и недоступны. Разблокировка модуля
> контроллера флеш-памяти возможна путём записи определённой
> последовательности в регистр **FLASH_KEYR**.

Последовательность разблокировки.

1.  Записать значение KEY1 = 0x45670123 в регистр **FLASH_KEYR** (шаг 1
    обязательно должен быть KEY1).

2.  Записать значение KEY2 = 0xCDEF89AB в регистр **FLASH_KEYR** (шаг 2
    обязательно должен быть KEY2).

Вышеуказанные операции должны выполняться последовательно и непрерывно,
иначе они будут считаться ошибочными операциями, которые заблокируют
модуль **FPEC** и регистры **FLASH_CTLR** и вызовут ошибки шины до
следующего сброса системы. Контроллер флеш-памяти (**FPEC**) и регистры
**FLASH_CTLR** могут быть снова заблокированы путем установки бита
\"**LOCK**\" регистра **FLASH_CTLR** в 1.

### 16.4.3 Стандартное программирование основной памяти 

> Стандартное программирование может осуществляться двумя байтами за
> раз. Когда бит PG регистра **FLASH_CTLR** установлен в \'1\', каждая
> половина слова (два байта), записываемая по адресу флеш-памяти,
> инициирует однократное программирование, а запись любых данных,
> отличных от половины слова, вызовет генерацию контроллером **FPEC**
> ошибки шины. Во время программирования бит **BSY** установлен в \'1\',
> а по завершении программирования бит **BSY** сбрасывается в \'0\', а
> бит **EOP** устанавливается в \'1\'.

*Примечание: Когда бит **BSY** установлен в \'1\', выполнение операции
записи в любой регистр будет запрещено.*

> *Начало формы*

*\
*\
Рисунок 16-1 Программирование FLASH

Прочитайте бит LOCK регистра FLASH_CTRL

Начало формы

BSY Бит = 1 ?

Выполнить операцию \"Разблокировка флеш-памяти\"

Установить FLASH_CTLR PG бит = 1

Запись полуслова (2 байта) по указанному адресу

Начало формы

Чтение EOP/WRPRTERR для оценки результата программирования Чтение адреса
для проверки записанных запрограммированных данных

Продолжить программирование

Конец, бит PG = 0

Бит LOCK = 1 ?

Да

Нет

Нет

Да

Да

Нет

1.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

2.  Установите бит **PG** регистра **FLASH_CTLR** в \'1\', чтобы
    включить стандартный режим программирования.

3.  Запишите половину слова, которую вы хотите запрограммировать, по
    заданному адресу флеш-памяти (четный адрес).

4.  Подождите, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что указывает на
    окончание программирования, и очистите бит **EOP** до нуля.

5.  Просмотрите регистр **FLASH_STATR**, чтобы узнать, была ли допущена
    ошибка, или прочтите контрольную сумму данных запрограммированного
    адреса.

6.  Продолжите программирование, повторив шаги 3-5, и завершите
    программирование, очистив бит **PG** до нуля.

Начало формы

### 16.4.4 Стандартное стирание основной памяти

> Флеш-память может быть стерта стандартными страницами (по 1 Кбайт) или
> целиком.
>
> Рисунок 16-2 Стирание страницы FLASH

Read the LOCK bit of

FLASH_CTRL

BSY bit=1

？

Perform \"Unlock Flash

Memory\" operation

Set FLASH_CTLR

的

PER bit=1

Set FLASH_CTLR STRT bit=1

Read out erase page data

verification

Continue

erasing?

Over

，

PEG bit=0

LOCK bit=1?

YES

NO

NO

YES

YES

NO

Write the erased page header

address in FLASH_ADDR register

(

)

erase 8 pages at a time

1.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

2.  Установите бит **PER** регистра **FLASH_CTLR** в \'1\', чтобы
    включить стандартный режим стирания страницы.

3.  Запишите адрес заголовка страницы выбранного стирания в регистр
    FLASH_ADDR.

4.  Установите бит **STRT** регистра **FLASH_CTLR** в \'1\', чтобы
    инициировать действие стирания.

5.  Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что указывает на
    завершение стирания, и очистите бит **EOP** до нуля.

6.  Прочтите данные стертых страниц для проверки.

7.  Продолжите стандартное стирание страницы, повторяя шаги 3-5, и
    закончите стирание, очистив бит **PEG** до нуля.

> Начало формы
>
> Рисунок 16-3 Полное стирание всего чипа FLASH

Read the LOCK bit of

FLASH_CTRL

BSY bit=1

？

Perform \"Unlock Flash

Memory\" operation

Set FLASH_CTLR MER bit=1

Set FLASH_CTLR STRT bit=1

Read out all pages of data to

verify

Over

，

MEG

bit=0

LOCK bit=1?

YES

NO

YES

NO

8.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

9.  Установите бит **MER** регистра **FLASH_CTLR** в \'1\', чтобы
    включить режим полного стирания чипа.

10. Установите бит **STRT** регистра **FLASH_CTLR** в \'1\', чтобы
    начать процесс стирания.

11. Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что указывает на
    завершение стирания, и очистите бит **EOP** до нуля.

12. Прочтите данные стертых страниц для проверки.

13. Очистите бит **MER** до нуля.

Начало формы

### 16.4.5 Разблокировка режима быстрого программирования

> Операция в режиме быстрого программирования может быть разблокирована
> путем записи последовательности в регистр **FLASH_MODEKEYR**. После
> разблокировки бит **FLOCK** регистра **FLASH_CTLR** будет очищен до 0,
> что указывает на возможность выполнения операций быстрого стирания и
> программирования. Регистр **FLASH_CTLR** снова блокируется программным
> обеспечением путем установки бита \"**FLOCK**\" в 1.
>
> Последовательность разблокировки.

1.  Запишите значение KEY1 = 0x45670123 в регистр FLASH_MODEKEYR.

2.  Запишите значение KEY2 = 0xCDEF89AB в регистр FLASH_MODEKEYR.

> Начало формы
>
> Эти операции должны выполняться последовательно и непрерывно, иначе
> они будут рассматриваться как неправильные операции, которые приведут
> к блокировке, и их нельзя будет разблокировать повторно до следующего
> сброса системы.
>
> *Примечание: Операции быстрого программирования требуют снятия
> блокировки уровней \"LOCK\" и \"FLOCK\".*

### 16.4.6 Быстрое программирование основной памяти

### Начало формы

Быстрое программирование по странице (64 байта).

1.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

2.  Проверьте бит **BSY** регистра **FLASH_STATR**, чтобы подтвердить
    отсутствие других выполняемых операций программирования.

3.  Проверьте бит **FLOCK** регистра **FLASH_CTLR**; если он равен 1,
    вам понадобится выполнить операцию \"разблокировки режима быстрого
    программирования\".

4.  Установите бит **FTPG** регистра **FLASH_CTLR**, чтобы включить
    функцию быстрого программирования.

5.  Установите бит **BUFRST** регистра **FLASH_CTLR**, чтобы выполнить
    операцию очистки внутреннего буфера объемом 64 байта.

6.  Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что указывает на
    завершение очистки, и очистите бит **EOP** до нуля.

7.  Начните запись четырех байтов данных по указанному адресу (4
    байта/операция), затем установите бит **BUFLOAD** регистра
    **FLASH_CTLR** и выполните загрузку в буфер.

8.  Дождитесь, пока бит **BYS** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что укажет на
    завершение загрузки, и очистите бит **EOP** до нуля.

9.  Повторяйте шаги 7-8 в общей сложности 16 раз, чтобы загрузить все 64
    байта данных в буфер (адреса операций в 16 циклах должны идти
    подряд).

10. Запишите первый адрес быстрой программируемой страницы в регистр
    FLASH_ADDR.

11. Установите бит **STRT** регистра **FLASH_CTLR** в \'1\', чтобы
    запустить быструю страницу программирования.

12. Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что свидетельствует о
    завершении программирования, и сбросьте бит **EOP** в ноль.

13. Запросите регистр **FLASH_STATR**, чтобы проверить наличие ошибок,
    или прочитайте контрольную сумму данных по запрограммированному
    адресу.

14. Вы можете продолжить быстрое программирование страницы, повторив
    шаги 5-13, и завершить программирование, сбросив бит **FTPG** до
    нуля.

Начало формы

Конец формы

### 

### 16.4.7 Быстрое стирание основной памяти

Быстрое стирание удаляет данные постранично (64 байта).

1.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

2.  Проверьте бит **FLOCK** регистра **FLASH_CTLR**; если он равен 1,
    вам придется выполнить операцию разблокировки режима быстрого
    программирования.

3.  Проверьте бит **BSY** регистра **FLASH_STATR**, чтобы убедиться, что
    никаких других операций программирования не проводится.

4.  Установите бит **FTER** регистра **FLASH_CTLR** в \'1\', чтобы
    включить функцию быстрого стирания страницы (64 байта).

5.  Запишите первый адрес быстро стираемой страницы в регистр
    **FLASH_ADDR**.

6.  Установите бит **STRT** регистра **FLASH_CTLR** в \'1\' для запуска
    быстрого стирания страницы (64 байта).

7.  Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что укажет на
    завершение стирания, и очистите бит **EOP** до нуля.

8.  Запросите регистр **FLASH_STATR**, чтобы проверить наличие ошибок,
    или прочитайте контрольную сумму данных по адресу стертых страниц.

9.  Вы можете продолжить быстрое стирание страницы, повторив шаги 5-8, и
    завершить стирание, сбросив бит **FTER** до нуля.

## 16.5 Байты опций пользователя

## Начало формы

> Байт опций пользователя фиксируется в FLASH и будет перезагружен в
> соответствующий регистр после сброса системы и может быть произвольно
> стерт и запрограммирован пользователем. Блок информации байтов опций
> пользователя состоит из восьми байтов (четыре байта для защиты от
> записи, один байт для защиты от чтения, один байт для параметров
> конфигурации и два байта для хранения пользовательских данных), и
> каждый бит имеет свой инверсный бит кода для проверки при загрузке.
> Далее описываются структура и смысл байтов опции.
>
> Таблица 16-3 Разделение формата байтов опций на 32 бита

\[

> Таблица 16-4 Структура информации байтов опций пользователя
>
> Начало формы

### 16.5.1 Разблокировка байтов опций пользователя

### Начало формы

> Операцию с байтами опций пользователя можно разблокировать, записав
> последовательность в регистр **FLASH_OBKEYR**. После разблокировки бит
> **OBWRE** регистра **FLASH_CTLR** будет установлен в 1, что указывает
> на то, что байты опций пользователя могут быть стерты и
> запрограммированы. Его можно снова заблокировать, сбросив бит
> \"**OBWRE**\" регистра **FLASH_CTLR** до 0 с помощью программного
> обеспечения.
>
> Последовательность разблокировки.

1.  Запишите значение KEY1 = 0x45670123 в регистр FLASH_OBKEYR.

2.  Запишите значение KEY2 = 0xCDEF89AB в регистр FLASH_OBKEYR.

> Начало формы
>
> *Примечание: Операции с байтами опций пользователя требуют снятия
> блокировки слоев \"**LOCK**\" и \"**OBWRE**\".*

### 16.5.2 Программирование байтов опций пользователя

> Поддерживается только стандартный метод программирования, при котором
> запись осуществляется половинами слов (по 2 байта) за раз. На
> практике, при программировании байтов опций пользователя **FPEC**
> использует только младший байт в половине слова и автоматически
> рассчитывает старший байт (старший байт является обратным младшему
> байту), а затем запускает операцию программирования, что гарантирует,
> что байт в байтах опций пользователя и его обратный код всегда верны.

10. Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

11. Проверьте бит **BSY** регистра **FLASH_STATR**, чтобы убедиться, что
    никакие другие операции программирования не проводятся.

12. Установите бит **OBPG** регистра **FLASH_CTLR** в \'1\', затем
    установите бит **STAT** регистра **FLASH_CTLR** в \'1\' для
    включения программирования байтов опций пользователя.

13. Установите бит **OBPG** в регистре **FLASH_CTLR** на \'1\'.

14. Запишите половину слова (2 байта), которую вы хотите
    запрограммировать, по указанному адресу.

15. Дождитесь, пока бит **BSY** станет равным \'0\' или бит **EOP**
    регистра **FLASH_STATR** станет равным \'1\', что указывает на
    завершение программирования, и очистите бит **EOP** до нуля.

16. Прочтите контрольную сумму данных по запрограммированному адресу.

17. Если вы продолжаете программирование, вы можете повторить шаги 5-7 и
    завершить программирование, сбросив бит **OBPG** до нуля.

> *Примечание: Когда параметр \"Защищено от чтения\" в выбранном слове
> изменяется на \"Не защищено\", автоматически выполняется полная
> очистка основной памяти. Если изменён другой параметр, отличный от
> \"защищенного от чтения\", операция полной очистки не произойдёт.*

### 16.5.3 Стирание байтов опций пользователя

### Начало формы

Полностью стирать область байтов опций пользователя размером 64 байта.

1.  Проверьте бит **LOCK** регистра **FLASH_CTLR**; если он равен 1, вам
    потребуется выполнить операцию \"Разблокировка флеш-памяти\".

2.  Проверьте бит **BSY** регистра **FLASH_STATR**, чтобы убедиться, что
    нет активных операций программирования.

3.  Проверьте бит **OBWRE** регистра **FLASH_CTLR**; если он равен 0,
    вам необходимо выполнить операцию разблокировки байтов опций
    пользователя.

4.  Установите бит **OBER** регистра **FLASH_CTLR** в \'1\', затем
    установите бит **STAT** регистра **FLASH_CTLR** в \'1\' для
    включения функции стирания байтов опций пользователя.

5.  Дождитесь, пока бит BSY станет равным \'0\' или бит **EOP** регистра
    **FLASH_STATR** станет равным \'1\', что указывает на завершение
    стирания, и очистите бит **EOP** до нуля.

6.  Прочтите и проверьте контрольную сумму данных по адресу стирания.

7.  Завершение операции стирания путем сброса бита **OBER** до нуля.

### 16.5.4 Снятие защиты от чтения

### Начало формы

Защищены ли данные флэш-памяти от чтения или нет, определяется байтом
опций пользователя. Прочитайте регистр **FLASH_OBR**, когда бит
**RDPRT** равен \'1\', это означает, что в данный момент флэш-память
находится в состоянии защиты от чтения, и работа флэш-памяти защищена
рядом защитных мер для защиты от считывания. Процедура снятия защиты от
чтении выглядит следующим образом.

1.  Стереть всю область байтов опций пользователя, в этот момент поле
    **RDPR** остается в силе, и защита от чтения сохраняется.

2.  Выполните программирование байтов опций пользователя и запишите
    правильный код **RDPR** 0xA5 для снятия защиты чтения с флэш-памяти.
    (Этот шаг сначала заставит систему автоматически выполнить полную
    операцию стирания флэш-памяти.)

3.  Выполняйте сброс питания для перезагрузки байта выбора (включая
    новый код **RDPR**), после чего снимается защита от чтения.

Начало формы

# Глава 17 Расширенная конфигурация

# Начало формы

## 17.1 Расширенная конфигурация

Система предоставляет расширенную конфигурационную единицу EXTEND
(регистр **EXTEND_CTR**). Эта единица использует тактовый сигнал HB и
выполняет сброс только при системном сбросе. Он включает следующие
основные функции управляющих битов:

1.  **Регулировка встроенного напряжения**: Поле **LDOTRIM** выбирает
    значение по умолчанию, которое можно изменить при настройке
    производительности и энергопотребления.

2.  **Мониторинг функции блокировки**: Включается поле **LKUPEN**, что
    открывает мониторинг ситуации блокировки системы. Как только
    произойдет ситуация блокировки, система выполнит программный сброс и
    установит флаг **LKUPRESET** в 1. После чтения можно записать 1,
    чтобы сбросить этот флажок.

3.  **Конфигурация усилителя**: Установите **OPA_EN** для включения OPA,
    настройте **OPA_PSEL** для выбора положительного входного контакта
    OPA и настройте **OPA_NSEL** для выбора отрицательного входного
    контакта OPA.

Начало формы

## 17.2 Описание регистров

## Начало формы

> Таблица 17-1 Список регистров, связанных с EXTEND

### 

### 17.2.1 Configure Extended Control Register (EXTEND_CTR) 

# Глава 18 Поддержка отладки (DBG)

## 18.1 Основные возможности

## Начало формы

Этот регистр позволяет настроить микроконтроллер в режиме отладки. Он
включает в себя:

-   Включенные счетчики независимого сторожевого таймера (IWDG)

-   Включенные счетчики оконного сторожевого таймера (WWDG)

-   Включенные счетчики таймера 1

-   Включенные счетчики таймера 2

Начало формы

## 

## 18.2 Описание регистра

### 18.2.1 Debug MCU Configuration Register (DBGMCU_CR) 
